import{a as Pt}from"./chunk-QTH6MER3.js";import{a as ct,b as pt,e as lt,g as Rt}from"./chunk-GXPKR22I.js";import{a as $t,b as wt}from"./chunk-4AD6ZYJB.js";import{f as Me,g as Le}from"./chunk-RDNZARDR.js";import{a as tt,b as nt,c as it,d as st,e as ot,h as kt,i as Mt}from"./chunk-XWISOVKN.js";import"./chunk-3DIISX7M.js";import"./chunk-6A3MULQJ.js";import{a as Dt}from"./chunk-I75JD2K7.js";import{B as se,C as oe,D as xt,E as At,F as Tt,G as Lt,b as ut,f as Te,g as ht,j as ke,m as le,n as Ee,x as gt,y as Ct,z as vt}from"./chunk-BQGWWMPT.js";import{a as bt}from"./chunk-WORSXEGE.js";import{f as It}from"./chunk-6LRQCBUO.js";import{a as yt}from"./chunk-UOIIL2R2.js";import{e as _t,p as pe}from"./chunk-JE6RMKPQ.js";import"./chunk-RXV77OBQ.js";import{A as Ie,c as _e,e as rt,f as he,g as ge,k as Ce,m as ve,p as Se,q as xe,y as at,z as Ae}from"./chunk-M3VKTN3S.js";import{a as ie}from"./chunk-USF5QQBL.js";import"./chunk-D2H555EG.js";import"./chunk-YHCR7GAG.js";import{i as St}from"./chunk-QWYAXZZX.js";import"./chunk-WNZFLLQC.js";import"./chunk-DVBPCEX4.js";import{b as Y,d as ft}from"./chunk-GH7I4V3C.js";import{a as dt}from"./chunk-M732YBIP.js";import{A as te,B as Q,O as ne,f as Je,r as Ze,s as be,t as et,u as ye}from"./chunk-RYYQAFJB.js";import{$b as F,Ab as U,Ac as E,Ba as He,Bc as K,Cc as R,Ec as Qe,F as V,Fc as Z,Gc as z,Hb as g,Hc as ee,Ib as Pe,Jb as C,Ka as je,Lb as ue,Lc as r,Mb as H,Mc as p,Nb as j,Nc as $,O as D,Ob as f,Pb as a,Qb as c,Rb as v,S as Be,W as Oe,X as P,Xc as Ye,Z as Ne,Zd as Fe,_ as k,a as $e,aa as Ve,bc as h,dc as _,fb as s,h as de,ha as X,i as we,ie as mt,j as De,je as w,lc as Ge,ma as y,mc as qe,nc as M,o as N,pc as J,qc as Ue,qd as fe,rc as d,sa as x,sc as L,t as b,ta as A,tc as u,td as G,u as S,ub as I,uc as W,ud as Xe,xc as We,yc as Ke,zb as me,zc as ze}from"./chunk-CHBP6U4G.js";var re=(()=>{class t{constructor(){this.settings=y(te),this.storageService=y(ie),this.studentsService=y(Me),this.studentId$=new De(1),this.lessonAbsences$=this.studentId$.pipe(k(this.loadLessonAbsences.bind(this)),P(1)),this.lessonIncidents$=this.studentId$.pipe(k(this.loadLessonIncidents.bind(this)),P(1)),this.lessonPresences$=this.getLessonPresences(),this.checkableAbsences$=this.getAbsences(this.settings.checkableAbsenceStateId),this.openAbsences$=this.getAbsences(this.settings.unconfirmedAbsenceStateId),this.excusedAbsences$=this.getAbsences(this.settings.excusedAbsenceStateId),this.unexcusedAbsences$=this.getAbsences(this.settings.unexcusedAbsenceStateId),this.incidents$=this.getAbsences(null),this.openLessonAbsences$=S([this.openAbsences$.pipe(V(Y)),this.lessonAbsences$]).pipe(b(oe(this.getLessonAbsences.bind(this))),P(1)),this.checkableLessonAbsences$=S([this.checkableAbsences$.pipe(V(Y)),this.lessonAbsences$]).pipe(b(oe(this.getLessonAbsences.bind(this))),P(1)),this.excusedLessonAbsences$=S([this.excusedAbsences$.pipe(V(Y)),this.lessonAbsences$]).pipe(b(oe(this.getLessonAbsences.bind(this))),P(1)),this.unexcusedLessonAbsences$=S([this.unexcusedAbsences$.pipe(V(Y)),this.lessonAbsences$]).pipe(b(oe(this.getLessonAbsences.bind(this))),P(1)),this.incidentsLessonAbsences$=S([this.incidents$.pipe(V(Y)),this.lessonIncidents$]).pipe(b(oe(this.getLessonIncidents.bind(this))),P(1)),this.counts$=this.getCounts();let e=this.storageService.getPayload()?.id_person;e&&this.studentId$.next(Number(e))}reset(){this.studentId$.pipe(D(1)).subscribe(e=>this.studentId$.next(e))}getLessonPresences(){return this.getCached(S([this.studentId$,this.lessonAbsences$,this.lessonIncidents$]).pipe(k(([e,n,i])=>this.loadTimetableEntries(e,n,i).pipe(b(o=>this.buildLessonPresences(n,i,o)))),b(vt)))}getAbsences(e){return this.getCached(this.lessonPresences$.pipe(b(n=>n?.filter(i=>i.ConfirmationStateId===e)||null)))}getLessonAbsences(e,n){let i=e.map(o=>o.LessonRef.Id);return n.filter(o=>i.includes(o.LessonRef.Id))}getLessonIncidents(e,n){let i=e.map(o=>o.LessonRef.Id);return n.filter(o=>i.includes(o.LessonRef.Id))}getCounts(){return S([this.getCount(this.checkableAbsences$),this.getCount(this.openAbsences$),this.getCount(this.excusedAbsences$),this.getCount(this.unexcusedAbsences$),this.getCount(this.incidents$)]).pipe(b(([e,n,i,o,l])=>({checkableAbsences:e,openAbsences:n,excusedAbsences:i,unexcusedAbsences:o,incidents:l,halfDays:null})))}getCached(e){return e.pipe(Ne(null),Oe({connector:()=>new De(1)}))}getCount(e){return e.pipe(b(n=>n?.length??null))}loadLessonAbsences(e){return this.studentsService.getLessonAbsences(e)}loadLessonIncidents(e){return this.studentsService.getLessonIncidents(e)}loadTimetableEntries(e,n,i){return this.studentsService.getTimetableEntries(e,{"filter.Id":`;${[...n,...i].map(o=>o.LessonRef.Id).join(";")}`})}buildLessonPresences(e,n,i){return[...e,...n].map(o=>this.buildLessonPresence(o,i)).filter(Y)}buildLessonPresence(e,n){let i=n.find(o=>o.Id===e.LessonRef.Id);return i?{Id:"",LessonRef:{Id:e.LessonRef.Id,HRef:e.LessonRef.HRef?e.LessonRef.HRef:null},StudentRef:e.StudentRef,EventRef:{Id:0,HRef:null},TypeRef:e.TypeRef,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:"ConfirmationStateId"in e?e.ConfirmationStateId:null,EventDesignation:i.EventDesignation,HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:i.From,LessonDateTimeTo:i.To,Comment:null,Date:i.From,Type:e.Type,StudentFullName:e.StudentFullName,StudyClassNumber:"",TeacherInformation:i.EventManagerInformation??null}:null}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275prov=X({token:t,factory:t.\u0275fac})}}return t})();var Re=(()=>{class t{constructor(){this.fb=y(at),this.router=y(et),this.toastService=y(dt),this.translate=y(mt),this.presenceTypesService=y(Te),this.updateService=y(ut),this.storageService=y(ie),this.settings=y(te),this.formGroup=this.createFormGroup(),this.saving$=new we(!1),this.submitted$=new we(!1),this.absenceTypes$=S([this.getConfirmationTypes(),this.getHalfDayType()]).pipe(b(([e,n])=>n?[...e,n]:e)),this.absenceTypeIdErrors$=bt(N(this.formGroup),this.submitted$,"absenceTypeId"),this.destroy$=new de}ngOnInit(){this.selectedLessonIds$.pipe(D(1),V(At)).subscribe(()=>this.navigateBack())}ngOnDestroy(){this.destroy$.next()}onSubmit(){if(this.submitted$.next(!0),this.formGroup.valid){let{absenceTypeId:e}=this.formGroup.value;this.save(e)}}cancel(){this.navigateBack()}getSelectedCount(){return this.selectedLessonIds$.pipe(b(e=>e.length))}getConfirmationTypes(){return this.presenceTypesService.confirmationTypes$.pipe(b(e=>e.filter(n=>n.IsAbsence&&n.Id!==this.settings.halfDayPresenceTypeId)))}getHalfDayType(){return N(null)}createFormGroup(){return this.fb.group({absenceTypeId:[null,rt.required]})}save(e){this.saving$.next(!0),this.selectedLessonIds$.pipe(D(1),k(n=>this.updateService.editLessonPresences(n,[Number(this.storageService.getPayload()?.id_person)],e)),Be(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.toastService.success(this.translate.instant("my-absences.confirm.save-success")),this.navigateBack()}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["ng-component"]],decls:0,vars:0,template:function(n,i){},encapsulation:2})}}return t})();var Kt=t=>({count:t}),zt=t=>({"border-top pt-3":t}),Qt=(t,m)=>m.Id;function Yt(t,m){if(t&1&&(a(0,"div",13),d(1),r(2,"translate"),c()),t&2){let e=m.$implicit;s(),u(" ",$(2,1,"global.validation-errors."+e.error,e.params)," ")}}function Xt(t,m){if(t&1&&(H(0,Yt,3,4,"div",13,ue),r(2,"async")),t&2){let e=_(2);j(p(2,0,e.absenceTypeIdErrors$))}}function Jt(t,m){if(t&1&&(a(0,"div",5),v(1,"input",11),r(2,"async"),a(3,"label",12),d(4),c(),g(5,Xt,3,2),r(6,"async"),c()),t&2){let e,n,i=m.$implicit,o=m.$index,l=_();f("ngClass",ee(12,zt,i.IsHalfDay)),s(),J("is-invalid",(((e=p(2,8,l.absenceTypeIdErrors$))==null?null:e.length)??0)>0),f("id","absence-type-"+o)("value",i.Id),s(2),f("for","absence-type-"+o),s(),u(" ",i.Designation," "),s(),C((((n=p(6,10,l.absenceTypes$))==null?null:n.length)??0)-1===o?5:-1)}}function Zt(t,m){t&1&&(a(0,"div",10)(1,"span",14),d(2,"Loading..."),c()())}var Ft=(()=>{class t extends Re{constructor(){super(),this.myAbsencesService=y(re),this.selectionService=y(se),this.titleKey="my-absences.confirm.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(b(e=>ne(Q(e.map(n=>n.lessonIds))))),this.confirmationStateId=this.settings.unconfirmedAbsencesRefreshTime}onSaveSuccess(){this.selectionService.clear(),this.myAbsencesService.reset(),super.onSaveSuccess()}navigateBack(){this.router.navigate(["/my-absences"])}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-confirm"]],features:[me],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,i){if(n&1){let o=F();a(0,"div",0)(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1),E(5),r(6,"async"),d(7),r(8,"translate"),c(),a(9,"form",2),h("ngSubmit",function(){return x(o),A(i.onSubmit())}),a(10,"div",3)(11,"label",4),d(12),r(13,"translate"),r(14,"addSpace"),c(),H(15,Jt,7,14,"div",5,Qt),r(17,"async"),c(),a(18,"div",6),d(19),r(20,"translate"),c(),a(21,"div",7)(22,"button",8),r(23,"async"),h("click",function(){return x(o),A(i.cancel())}),d(24),r(25,"translate"),c(),a(26,"button",9),r(27,"async"),d(28),r(29,"translate"),g(30,Zt,3,0,"div",10),r(31,"async"),c()()()()}if(n&2){s(2),L(p(3,11,i.titleKey));let o=p(6,13,i.getSelectedCount());s(5),u(" ",$(8,15,o===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",ee(37,Kt,o))," "),s(2),f("formGroup",i.formGroup),s(3),W("",p(13,18,"my-absences.confirm.choose-presence-type"),"",$(14,20,":",":")),s(3),j(p(17,23,i.absenceTypes$)),s(4),u(" ",p(20,25,"my-absences.confirm.remark")," "),s(3),f("disabled",p(23,27,i.saving$)),s(2),u(" ",p(25,29,"my-absences.confirm.cancel")," "),s(2),f("disabled",p(27,31,i.saving$)),s(2),u(" ",p(29,33,"my-absences.confirm.save")," "),s(2),C(p(31,35,i.saving$)?30:-1)}},dependencies:[Ae,Ce,_e,ve,he,ge,Ie,xe,Se,fe,G,w,Le],encapsulation:2,changeDetection:0})}}return t})();var ae=(()=>{class t extends gt{constructor(){super(...arguments),this.selectedIds$=this.selection$.pipe(b(Ct))}static{this.\u0275fac=(()=>{let e;return function(i){return(e||(e=je(t)))(i||t)}})()}static{this.\u0275prov=X({token:t,factory:t.\u0275fac})}}return t})();var ce=(()=>{class t extends wt{get preventAbsencesAfterStart(){if(this._preventAbsencesAfterStart==null){let e=this.storageService.getPayload()?.instance_id,n=this.settings.preventStudentAbsenceAfterLessonStart;this._preventAbsencesAfterStart=e?n.includes(e):!1}return this._preventAbsencesAfterStart}constructor(){super("/my-absences/report"),this.studentsService=y(Me),this.storageService=y(ie)}getInitialFilter(){return{dateFrom:null,dateTo:null}}isValidFilter(e){return!!(e.dateFrom||e.dateTo)}loadEntries(e,n,i){let o=this.buildRequestParamsFromFilter(e).set("sort","From.asc");return this.loadingService.load(this.loadTimetableEntries(o).pipe(b(l=>this.filterAbsencesAfterLessonStart(l)),k(l=>S([N(l),this.loadLessonAbsences(l),this.loadLessonDispensations(l)])),b(([l,T,q])=>this.buildLessonPresences(l,T,q)),b(l=>({offset:0,total:l.length,entries:l}))),$t)}filterAbsencesAfterLessonStart(e){return this.preventAbsencesAfterStart?e.filter(n=>n.From.getTime()>=new Date().getTime()):e}buildParamsFromFilter(e){let{dateFrom:n,dateTo:i}=e,o={};return n&&(o.dateFrom=pe(n,"yyyy-MM-dd")),i&&(o.dateTo=pe(i,"yyyy-MM-dd")),o}buildRequestParamsFromFilter(e){let n=new Je;return e.dateFrom&&(n=n.set("filter.From",`>${pe(ht(e.dateFrom,1),"yyyy-MM-dd")}`)),e.dateTo&&(n=n.set("filter.To",`<${pe(yt(e.dateTo,1),"yyyy-MM-dd")}`)),n}get studentId(){let e=this.storageService.getPayload()?.id_person;if(e==null)throw new Error("No student id available");return Number(e)}loadTimetableEntries(e){return this.studentsService.getTimetableEntries(this.studentId,e)}loadLessonAbsences(e){return e.length>0?this.studentsService.getLessonAbsences(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):N([])}loadLessonDispensations(e){return e.length>0?this.studentsService.getLessonDispensations(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):N([])}buildLessonPresences(e,n,i){return e.map(o=>this.buildLessonPresence(o,n,i))}buildLessonPresence(e,n,i){let o=n.find(q=>q.LessonRef.Id===e.Id),l=i.find(q=>q.LessonRef.Id===e.Id),T=this.buildLessonPresenceTypeRef(o,l);return{Id:"",LessonRef:{Id:e.Id,HRef:null},StudentRef:(o||l)?.StudentRef||{Id:this.studentId,HRef:null},EventRef:{Id:0,HRef:null},TypeRef:T,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:o?.ConfirmationStateId||l&&this.settings.excusedAbsenceStateId||null,EventDesignation:e.EventDesignation||"",HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:e.From||new Date,LessonDateTimeTo:e.To||new Date,Comment:null,Date:e.From||new Date,Type:(o||l)?.Type||null,StudentFullName:(o||l)?.StudentFullName||"",StudyClassNumber:"",TeacherInformation:e.EventManagerInformation??null}}buildLessonPresenceTypeRef(e,n){return e?$e({},e.TypeRef):n?$e({},n.TypeRef):{Id:null,HRef:null}}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275prov=X({token:t,factory:t.\u0275fac})}}return t})();var en=t=>({count:t}),tn=t=>({"border-top pt-3":t}),nn=(t,m)=>m.Id;function sn(t,m){if(t&1&&(a(0,"div",13),d(1),r(2,"translate"),c()),t&2){let e=m.$implicit;s(),u(" ",$(2,1,"global.validation-errors."+e.error,e.params)," ")}}function on(t,m){if(t&1&&(H(0,sn,3,4,"div",13,ue),r(2,"async")),t&2){let e=_(2);j(p(2,0,e.absenceTypeIdErrors$))}}function rn(t,m){if(t&1&&(a(0,"div",5),v(1,"input",11),r(2,"async"),a(3,"label",12),d(4),c(),g(5,on,3,2),r(6,"async"),c()),t&2){let e,n,i=m.$implicit,o=m.$index,l=_();f("ngClass",ee(12,tn,i.IsHalfDay)),s(),J("is-invalid",(((e=p(2,8,l.absenceTypeIdErrors$))==null?null:e.length)??0)>0),f("id","absence-type-"+o)("value",i.Id),s(2),f("for","absence-type-"+o),s(),u(" ",i.Designation," "),s(),C((((n=p(6,10,l.absenceTypes$))==null?null:n.length)??0)-1===o?5:-1)}}function an(t,m){t&1&&(a(0,"div",10)(1,"span",14),d(2,"Loading..."),c()())}var Et=(()=>{class t extends Re{constructor(){super(),this.state=y(ce),this.selectionService=y(ae),this.titleKey="my-absences.report.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(b(e=>ne(Q(e.map(n=>n.lessonIds))))),this.confirmationStateId=this.settings.checkableAbsenceStateId}getHalfDayType(){return this.presenceTypesService.getPresenceType(this.settings.halfDayPresenceTypeId).pipe(b(e=>e.Active?e:null))}onSaveSuccess(){this.selectionService.clear(),this.state.resetEntries(),super.onSaveSuccess()}navigateBack(){this.state.queryParams$.pipe(D(1)).subscribe(e=>{this.router.navigate(["/my-absences/report"],{queryParams:e})})}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-confirm"]],features:[me],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,i){if(n&1){let o=F();a(0,"div",0)(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1),E(5),r(6,"async"),d(7),r(8,"translate"),c(),a(9,"form",2),h("ngSubmit",function(){return x(o),A(i.onSubmit())}),a(10,"div",3)(11,"label",4),d(12),r(13,"translate"),r(14,"addSpace"),c(),H(15,rn,7,14,"div",5,nn),r(17,"async"),c(),a(18,"div",6),d(19),r(20,"translate"),c(),a(21,"div",7)(22,"button",8),r(23,"async"),h("click",function(){return x(o),A(i.cancel())}),d(24),r(25,"translate"),c(),a(26,"button",9),r(27,"async"),d(28),r(29,"translate"),g(30,an,3,0,"div",10),r(31,"async"),c()()()()}if(n&2){s(2),L(p(3,11,i.titleKey));let o=p(6,13,i.getSelectedCount());s(5),u(" ",$(8,15,o===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",ee(37,en,o))," "),s(2),f("formGroup",i.formGroup),s(3),W("",p(13,18,"my-absences.confirm.choose-presence-type"),"",$(14,20,":",":")),s(3),j(p(17,23,i.absenceTypes$)),s(4),u(" ",p(20,25,"my-absences.confirm.remark")," "),s(3),f("disabled",p(23,27,i.saving$)),s(2),u(" ",p(25,29,"my-absences.confirm.cancel")," "),s(2),f("disabled",p(27,31,i.saving$)),s(2),u(" ",p(29,33,"my-absences.confirm.save")," "),s(2),C(p(31,35,i.saving$)?30:-1)}},dependencies:[Ae,Ce,_e,ve,he,ge,Ie,xe,Se,fe,G,w,Le],encapsulation:2,changeDetection:0})}}return t})();var cn=()=>["/my-absences"],Ot=(()=>{class t{constructor(){this.filter={dateFrom:null,dateTo:null},this.filterChange=new He,this.minDate={year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate()}}updateDateFrom(e){this.filter.dateFrom=e,e&&(this.filter.dateTo=e)}show(){this.filterChange.emit({dateFrom:Bt(this.filter.dateFrom),dateTo:Bt(this.filter.dateTo)})}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-report-header"]],inputs:{filter:"filter"},outputs:{filterChange:"filterChange"},features:[Z([{provide:ct,useClass:lt},{provide:pt,useClass:Rt}])],decls:19,vars:18,consts:[[3,"link"],[1,"filters"],[1,"form-group"],[1,"form-label"],[3,"valueChange","minDate","value"],[1,"buttons"],["type","button",1,"btn","btn-primary",3,"click"]],template:function(n,i){n&1&&(v(0,"bkd-backlink",0),a(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1)(5,"div",2)(6,"label",3),d(7),r(8,"translate"),c(),a(9,"bkd-date-select",4),h("valueChange",function(l){return i.updateDateFrom(l)}),c()(),a(10,"div",2)(11,"label",3),d(12),r(13,"translate"),c(),a(14,"bkd-date-select",4),ze("valueChange",function(l){return Ke(i.filter.dateTo,l)||(i.filter.dateTo=l),l}),c()(),a(15,"div",5)(16,"button",6),h("click",function(){return i.show()}),d(17),r(18,"translate"),c()()()),n&2&&(f("link",z(17,cn)),s(2),L(p(3,9,"my-absences.report.title")),s(5),L(p(8,11,"my-absences.report.header.date-from")),s(2),f("minDate",i.minDate)("value",i.filter.dateFrom),s(3),L(p(13,13,"my-absences.report.header.date-to")),s(2),f("minDate",i.minDate),We("value",i.filter.dateTo),s(3),u(" ",p(18,15,"my-absences.report.header.show")," "))},dependencies:[Lt,Pt,w],styles:["[_nghost-%COMP%]{display:block;padding-bottom:1rem;border-bottom:1px solid #dee2e6}.filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.form-group[_ngcontent-%COMP%]{flex:1;min-width:20rem;max-width:40rem;margin-right:1rem;margin-bottom:.5rem}.buttons[_ngcontent-%COMP%]{flex:none;margin-top:1.625rem;margin-right:0}@media(max-width:575.98px){[_nghost-%COMP%]{padding-bottom:0}.buttons[_ngcontent-%COMP%]{width:100%;margin-top:1rem;margin-bottom:1rem}}"],changeDetection:0})}}return t})();function Bt(t){return t?_t(t):null}var pn=(t,m)=>m.Id;function ln(t,m){t&1&&v(0,"bkd-spinner")}function dn(t,m){if(t&1){let e=F();a(0,"div",8)(1,"input",9,2),r(3,"async"),h("change",function(){x(e);let i=_().$implicit,o=_(5);return A(o.selectionService.toggle(i))}),c()()}if(t&2){let e=_().$implicit,n=_(5);s(),f("checked",p(3,1,n.selectionService.isSelected$(e)))}}function mn(t,m){if(t&1&&(a(0,"div")(1,"i",13),d(2),c()()),t&2){_();let e=R(2);Ue(Qe("checkbox presence-category ",e.category)),s(2),L(e.icon)}}function un(t,m){if(t&1&&d(0),t&2){let e=_().$implicit;u(" , ",e.StudyClassNumber," ")}}function fn(t,m){if(t&1&&(a(0,"div",20),d(1),c()),t&2){_();let e=R(15);s(),u(" ",e," ")}}function bn(t,m){if(t&1){let e=F();a(0,"div",15,1),h("click",function(i){x(e);let o=M(1),l=_(5);return A(l.onRowClick(i,o))}),E(2),r(3,"async"),g(4,dn,4,3,"div",8)(5,mn,3,4,"div",16),a(6,"div",17),d(7),g(8,un,1,1),c(),a(9,"div",18),d(10),r(11,"date"),r(12,"date"),c(),a(13,"div",19),d(14),c(),E(15),r(16,"async"),g(17,fn,2,1,"div",20),a(18,"div",21),d(19),r(20,"date"),c(),a(21,"div",22),d(22),r(23,"bkdDaysDifference"),c(),a(24,"div",23),d(25),r(26,"date"),r(27,"bkdDaysDifference"),c()()}if(t&2){let e=m.$implicit,n=_(5);s(2);let i=K(p(3,11,n.getPresenceCategory(e)));s(2),C(i?5:4),s(3),u(" ",e.EventDesignation," "),s(),C(e.StudyClassNumber?8:-1),s(2),W(" ",$(11,14,e.LessonDateTimeFrom,"HH:mm"),"\u2013",$(12,17,e.LessonDateTimeTo,"HH:mm")," "),s(4),u(" ",e.TeacherInformation," "),s();let o=K(p(16,20,n.getPresenceTypeDesignation(e)));s(2),C(o?17:-1),s(2),u(" ",$(20,23,e.LessonDateTimeFrom,"dd.MM.yyyy")," "),s(3),u(" ",p(23,26,e.LessonDateTimeFrom)," "),s(3),W(" ",$(26,28,e.LessonDateTimeFrom,"dd.MM.yyyy"),", ",p(27,31,e.LessonDateTimeFrom)," ")}}function yn(t,m){if(t&1){let e=F();a(0,"div")(1,"div",7,0),h("click",function(i){x(e);let o=M(2),l=_(4);return A(l.onRowClick(i,o))}),a(3,"div",8)(4,"input",9),r(5,"async"),h("change",function(i){x(e);let o=_(4);return A(o.toggleAll(i.target==null?null:i.target.checked))}),c()(),a(6,"div",10),d(7),r(8,"translate"),c(),a(9,"div",11)(10,"a",12),r(11,"async"),a(12,"i",13),d(13,"edit"),c()()()(),H(14,bn,28,33,"div",14,pn),c()}if(t&2){let e,n=_(4),i=R(0);s(4),f("checked",p(5,4,n.allSelected$)),s(3),u(" ",p(8,6,"my-absences.report.list.all")," "),s(3),J("disabled",((e=p(11,8,n.selectionService.selection$))==null?null:e.length)===0),s(4),j(i)}}function _n(t,m){t&1&&v(0,"bkd-spinner",6)}function hn(t,m){if(t&1&&(a(0,"div",5),g(1,yn,16,10,"div"),g(2,_n,1,0,"bkd-spinner",6),c()),t&2){_(3);let e=R(0),n=R(2);s(),C(e&&e.length>0?1:-1),s(),C(n?2:-1)}}function gn(t,m){t&1&&(a(0,"p",4),d(1),r(2,"translate"),c()),t&2&&(s(),u(" ",p(2,1,"my-absences.report.no-entries")," "))}function Cn(t,m){if(t&1&&g(0,hn,3,2,"div",5)(1,gn,3,3,"p",4),t&2){_(2);let e=R(0),n=R(2);C(e&&e.length>0||n?0:1)}}function vn(t,m){if(t&1&&(g(0,ln,1,0,"bkd-spinner"),r(1,"async"),Pe(2,Cn,2,1)),t&2){let e=_();C(p(1,1,e.state.loading$)?0:2)}}function Sn(t,m){t&1&&(a(0,"p",4),d(1),r(2,"translate"),c()),t&2&&(s(),L(p(2,1,"my-absences.report.no-filter")))}var Nt=(()=>{class t{constructor(){this.state=y(ce),this.selectionService=y(ae),this.route=y(Ze),this.scrollPosition=y(Dt),this.presenceTypesService=y(Te),this.settings=y(te),this.filterFromParams$=this.route.queryParams.pipe(b(xn)),this.allSelected$=S([this.selectionService.selection$,this.state.entries$.pipe(k(e=>S(e.map(n=>this.getPresenceType(n)))))]).pipe(b(([e,n])=>e.length>0&&e.length===n.filter(ft(ke)).length)),this.destroy$=new de}ngOnInit(){this.filterFromParams$.pipe(D(1)).subscribe(e=>this.state.setFilter(e)),this.state.validFilter$.pipe(Ve(this.destroy$)).subscribe(()=>this.selectionService.clear())}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}getPresenceCategory(e){return this.getPresenceType(e).pipe(b(n=>ke(n)?e.ConfirmationStateId===this.settings.checkableAbsenceStateId?{category:le.Unapproved,icon:Ee(le.Unapproved)}:{category:le.Absent,icon:Ee(le.Absent)}:null))}getPresenceTypeDesignation(e){return this.presenceTypesService.displayedTypes$.pipe(b(n=>e.TypeRef.Id&&n.find(i=>i.Id===e.TypeRef.Id)?.Designation||null))}toggleAll(e){S([this.state.entries$.pipe(D(1)),this.presenceTypesService.presenceTypes$.pipe(D(1))]).subscribe(([n,i])=>{let o=i.filter(l=>ke(l)).map(l=>l.Id);this.selectionService.clear(e?n.filter(l=>l.TypeRef.Id==null||!o.includes(l.TypeRef.Id)):null)})}onRowClick(e,n){let i=n.querySelector('input[type="checkbox"]');i&&e.target!==i&&!e.target.closest(".buttons")&&i.click()}getPresenceType(e){return this.presenceTypesService.presenceTypes$.pipe(b(n=>e.TypeRef.Id&&n.find(i=>i.Id===e.TypeRef.Id)||null))}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-report-list"]],decls:9,vars:12,consts:[["all",""],["row",""],["checkbox",""],[3,"filterChange","filter"],[1,"mt-3"],[1,"py-3"],[1,"inline"],[1,"entries-all",3,"click"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"all"],[1,"buttons"],["routerLink","confirm",1,"edit","btn","btn-primary","btn-icon","me-2"],[1,"material-icons"],[1,"entry"],[1,"entry",3,"click"],[3,"class"],[1,"lesson-class"],[1,"time","pe-2"],[1,"teacher"],[1,"presence-type"],[1,"date"],[1,"days-ago"],[1,"date-days-ago"]],template:function(n,i){if(n&1){let o=F();E(0),r(1,"async"),E(2),r(3,"async"),a(4,"bkd-my-absences-report-header",3),r(5,"async"),h("filterChange",function(T){return x(o),A(i.state.setFilter(T))}),c(),g(6,vn,3,3),r(7,"async"),Pe(8,Sn,3,3,"p",4)}n&2&&(K(p(1,2,i.state.entries$)),s(2),K(p(3,5,i.state.loadingPage$)),s(2),f("filter",p(5,8,i.filterFromParams$)),s(2),C(p(7,10,i.state.isFilterValid$)?6:8))},dependencies:[Ot,ye,St,G,Xe,w,xt],styles:['.entries-all[_ngcontent-%COMP%]{padding:0 0 .5rem 1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox all buttons";grid-template-columns:min-content 1fr min-content}.entry[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox lesson-class time teacher" "checkbox presence-type date days-ago";grid-template-columns:min-content 2fr 1fr 2fr}.entry[_ngcontent-%COMP%]:first-child{padding-top:0}.entries-all[_ngcontent-%COMP%] + .entry[_ngcontent-%COMP%]{padding-top:1rem}.presence-category.absent[_ngcontent-%COMP%]{color:#ea161f}.presence-category.unapproved[_ngcontent-%COMP%]{color:#ffa814}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.3rem 1rem 0 0}.presence-category[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{display:block;font-size:16px}.entries-all[_ngcontent-%COMP%]   .checkbox[_ngcontent-%COMP%]{padding-top:.2rem}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.all[_ngcontent-%COMP%]{grid-area:all}.buttons[_ngcontent-%COMP%]{grid-area:buttons;display:flex}.lesson-class[_ngcontent-%COMP%]{grid-area:lesson-class;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.time[_ngcontent-%COMP%]{grid-area:time}.teacher[_ngcontent-%COMP%]{grid-area:teacher}.presence-type[_ngcontent-%COMP%]{color:#adb5bd;grid-area:presence-type}.date[_ngcontent-%COMP%]{grid-area:date}.days-ago[_ngcontent-%COMP%]{color:#adb5bd;grid-area:days-ago}.date-days-ago[_ngcontent-%COMP%]{grid-area:date-days-ago;display:none}@media(max-width:750px){.entry[_ngcontent-%COMP%]{grid-template-areas:"checkbox lesson-class" "checkbox teacher" "checkbox date-days-ago" "checkbox time" "checkbox presence-type";grid-template-columns:min-content 1fr}.date-days-ago[_ngcontent-%COMP%]{display:block}.date[_ngcontent-%COMP%], .days-ago[_ngcontent-%COMP%]{display:none}}'],changeDetection:0})}}return t})();function xn(t){return{dateFrom:t.dateFrom?Fe(t.dateFrom):null,dateTo:t.dateTo?Fe(t.dateTo):null}}var Vt=(()=>{class t{constructor(){}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-report"]],features:[Z([ce,ae])],decls:1,vars:0,template:function(n,i){n&1&&v(0,"router-outlet")},dependencies:[be],encapsulation:2,changeDetection:0})}}return t})();var An=["link"],In=()=>["/my-absences/report"],Ht=(()=>{class t{onClick(e){this.link().nativeElement.click()}constructor(){this.link=Ye.required("link")}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-report-link"]],viewQuery:function(n,i){n&1&&Ge(i.link,An,5),n&2&&qe()},hostBindings:function(n,i){n&1&&h("click",function(l){return i.onClick(l)})},decls:8,vars:5,consts:[["link",""],[1,"m-0"],[1,"btn","btn-link","p-0",3,"routerLink"],[1,"d-flex","align-items-center"],[1,"material-icons"]],template:function(n,i){n&1&&(a(0,"h5",1),d(1),r(2,"translate"),c(),a(3,"a",2,0)(5,"div",3)(6,"i",4),d(7,"keyboard_arrow_right"),c()()()),n&2&&(s(),u(" ",p(2,2,"my-absences.report.title"),`
`),s(2),f("routerLink",z(4,In)))},dependencies:[ye,w],styles:["[_nghost-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem;cursor:pointer}.btn[_ngcontent-%COMP%]{color:#000;text-decoration:none}"],changeDetection:0})}}return t})();var jt=()=>[];function Tn(t,m){}function kn(t,m){if(t&1&&d(0),t&2){_();let e=R(0);u(" (",e==null?null:e.checkableAbsences,") ")}}function Mn(t,m){if(t&1&&v(0,"bkd-student-dossier-absences",15),t&2){let e=_();f("absences$",e.myAbsencesService.checkableAbsences$)}}function Ln(t,m){if(t&1&&d(0),t&2){_();let e=R(0);u(" (",e==null?null:e.openAbsences,") ")}}function Rn(t,m){if(t&1&&(v(0,"bkd-student-dossier-absences",16),r(1,"translate"),r(2,"async")),t&2){let e=_();f("absences$",e.myAbsencesService.openAbsences$)("selectionService",e.absencesSelectionService)("defaultAbsenceSelectionMessage",p(1,4,"my-absences.show.default-absence-selection-message"))("reports",p(2,6,e.openAbsencesReports$)??z(8,jt))}}function $n(t,m){if(t&1&&d(0),t&2){_();let e=R(0);u(" (",e==null?null:e.excusedAbsences,") ")}}function wn(t,m){if(t&1&&v(0,"bkd-student-dossier-absences",15),t&2){let e=_();f("absences$",e.myAbsencesService.excusedAbsences$)}}function Dn(t,m){if(t&1&&d(0),t&2){_();let e=R(0);u(" (",e==null?null:e.unexcusedAbsences,") ")}}function Pn(t,m){if(t&1&&v(0,"bkd-student-dossier-absences",17),t&2){let e=_();f("absences$",e.myAbsencesService.unexcusedAbsences$)("displayPresenceType",!1)}}function Fn(t,m){if(t&1&&d(0),t&2){_();let e=R(0);u(" (",e==null?null:e.incidents,") ")}}function En(t,m){if(t&1&&v(0,"bkd-student-dossier-absences",15),t&2){let e=_();f("absences$",e.myAbsencesService.incidents$)}}var Gt=(()=>{class t{constructor(){this.reportsService=y(Mt),this.myAbsencesService=y(re),this.absencesSelectionService=y(se),this.openAbsencesReports$=this.loadOpenAbsencesReports(),this.allAbsencesReports$=this.loadAllAbsencesReports()}loadOpenAbsencesReports(){return S([this.absencesSelectionService.selectedWithoutPresenceType$,this.absencesSelectionService.selectedIds$]).pipe(k(([e,n])=>e.length===0&&n.length>0?this.getOpenAbsencesRecordIds(ne(Q(n.map(i=>i.lessonIds)))):N([])),k(e=>this.reportsService.getStudentConfirmationReports(e)),P(1))}loadAllAbsencesReports(){return S([this.myAbsencesService.openLessonAbsences$,this.myAbsencesService.checkableLessonAbsences$,this.myAbsencesService.excusedLessonAbsences$,this.myAbsencesService.unexcusedLessonAbsences$,this.myAbsencesService.incidentsLessonAbsences$]).pipe(b(e=>this.getAllAbsencesRecordIds(Q(e))),k(e=>this.reportsService.getMyAbsencesReports(e)),P(1))}getAllAbsencesRecordIds(e){return e.map(n=>`${n.LessonRef.Id}_${n.RegistrationId}`)}getOpenAbsencesRecordIds(e){return this.myAbsencesService.openLessonAbsences$.pipe(b(n=>n.filter(i=>e.includes(i.LessonRef.Id)).map(i=>`${i.LessonRef.Id}_${i.RegistrationId}`)))}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences-show"]],decls:70,vars:38,consts:[["checkableAbsences","ngbAccordionItem"],["openAbsences","ngbAccordionItem"],["excusedAbsences","ngbAccordionItem"],["unexcusedAbsences","ngbAccordionItem"],["incidents","ngbAccordionItem"],[1,"bkd-container","bkd-container-limited"],[1,"d-flex","justify-content-between","border-bottom","header"],[1,"ps-3"],[3,"reports"],["ngbAccordion",""],["ngbAccordionItem",""],["ngbAccordionHeader",""],["ngbAccordionCollapse",""],["ngbAccordionBody",""],[3,"click","opened"],[3,"absences$"],[3,"absences$","selectionService","defaultAbsenceSelectionMessage","reports"],[3,"absences$","displayPresenceType"]],template:function(n,i){if(n&1){let o=F();E(0),r(1,"async"),a(2,"div",5)(3,"h1"),d(4),r(5,"translate"),c(),a(6,"div",6)(7,"div"),d(8),r(9,"translate"),c(),a(10,"div",7),v(11,"bkd-reports-link",8),r(12,"async"),c()(),a(13,"div",9)(14,"div",10)(15,"div",11),v(16,"bkd-my-absences-report-link"),c(),a(17,"div",12)(18,"div",13),U(19,Tn,0,0,"ng-template"),c()()(),a(20,"div",10,0)(22,"div",11)(23,"bkd-student-dossier-entry-header",14),h("click",function(){x(o);let T=M(21);return A(T.toggle())}),d(24),r(25,"translate"),g(26,kn,1,1),c()(),a(27,"div",12)(28,"div",13),U(29,Mn,1,1,"ng-template"),c()()(),a(30,"div",10,1)(32,"div",11)(33,"bkd-student-dossier-entry-header",14),h("click",function(){x(o);let T=M(31);return A(T.toggle())}),d(34),r(35,"translate"),g(36,Ln,1,1),c()(),a(37,"div",12)(38,"div",13),U(39,Rn,3,9,"ng-template"),c()()(),a(40,"div",10,2)(42,"div",11)(43,"bkd-student-dossier-entry-header",14),h("click",function(){x(o);let T=M(41);return A(T.toggle())}),d(44),r(45,"translate"),g(46,$n,1,1),c()(),a(47,"div",12)(48,"div",13),U(49,wn,1,1,"ng-template"),c()()(),a(50,"div",10,3)(52,"div",11)(53,"bkd-student-dossier-entry-header",14),h("click",function(){x(o);let T=M(51);return A(T.toggle())}),d(54),r(55,"translate"),g(56,Dn,1,1),c()(),a(57,"div",12)(58,"div",13),U(59,Pn,1,2,"ng-template"),c()()(),a(60,"div",10,4)(62,"div",11)(63,"bkd-student-dossier-entry-header",14),h("click",function(){x(o);let T=M(61);return A(T.toggle())}),d(64),r(65,"translate"),g(66,Fn,1,1),c()(),a(67,"div",12)(68,"div",13),U(69,En,1,1,"ng-template"),c()()()()()}if(n&2){let o=M(21),l=M(31),T=M(41),q=M(51),Ut=M(61),O=K(p(1,18,i.myAbsencesService.counts$));s(4),L(p(5,21,"my-absences.title")),s(4),L(p(9,23,"my-absences.description")),s(3),f("reports",p(12,25,i.allAbsencesReports$)??z(37,jt)),s(12),f("opened",!o.collapsed),s(),u(" ",p(25,27,"shared.profile.checkable-absences")," "),s(2),C((O==null?null:O.checkableAbsences)!==null?26:-1),s(7),f("opened",!l.collapsed),s(),u(" ",p(35,29,"shared.profile.open-absences")," "),s(2),C((O==null?null:O.openAbsences)!==null?36:-1),s(7),f("opened",!T.collapsed),s(),u(" ",p(45,31,"shared.profile.excused-absences")," "),s(2),C((O==null?null:O.excusedAbsences)!==null?46:-1),s(7),f("opened",!q.collapsed),s(),u(" ",p(55,33,"shared.profile.unexcused-absences")," "),s(2),C((O==null?null:O.unexcusedAbsences)!==null?56:-1),s(7),f("opened",!Ut.collapsed),s(),u(" ",p(65,35,"shared.profile.incidents")," "),s(2),C((O==null?null:O.incidents)!==null?66:-1)}},dependencies:[It,ot,st,it,Ht,nt,tt,kt,Tt,G,w],styles:[".header[_ngcontent-%COMP%]{padding-bottom:1rem}"],changeDetection:0})}}return t})();var qt=(()=>{class t{constructor(){}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=I({type:t,selectors:[["bkd-my-absences"]],features:[Z([re,se])],decls:1,vars:0,template:function(n,i){n&1&&v(0,"router-outlet")},dependencies:[be],encapsulation:2,changeDetection:0})}}return t})();var bo=[{path:"",component:qt,children:[{path:"",component:Gt},{path:"confirm",component:Ft},{path:"report",component:Vt,children:[{path:"",component:Nt,data:{restoreScrollPositionFrom:["/my-absences/report/confirm"]}},{path:"confirm",component:Et}]}]}];export{bo as MY_ABSENCES_ROUTES};
