import{B as st,C as ot,b as Je,f as Ye,g as it,w as nt}from"./chunk-IG4JFLD5.js";import{a as ze}from"./chunk-I6B7SZW4.js";import{a as pe,b as P,c as Ze}from"./chunk-JQMOLUIY.js";import{a as z}from"./chunk-Y4QYVF5K.js";import{a as et}from"./chunk-QENSBOG3.js";import{e as ce,p as I}from"./chunk-QGDSASTQ.js";import{h as tt}from"./chunk-2QS7YZBA.js";import{a as We}from"./chunk-56A7FKFV.js";import{a as de,b as W,c as me}from"./chunk-XQRDISHK.js";import{a as Qe}from"./chunk-YNODG5RP.js";import{b as R}from"./chunk-EFJ6WEH7.js";import{b as _}from"./chunk-DQAQYQ7K.js";import{a as He}from"./chunk-LYDHS67M.js";import{d as D,h as Ie,q as Ee,s as De,t as Ae,x as ae,z as q}from"./chunk-ZXUJZ6KS.js";import{$d as we,Ae as qe,C as be,Cc as p,Cd as l,Dc as c,Dd as S,Ec as H,Ed as ke,Gb as k,H as T,Ib as B,Id as g,Kb as oe,Lb as G,Mb as M,Nb as C,Ob as d,Pb as f,Q as L,Qb as O,Rd as $,U as Se,Ub as Re,Ud as h,Vd as K,Wb as re,Xb as x,Xd as A,Yd as Be,_ as ie,a as U,b as j,ba as y,be as Pe,ce as Ve,da as N,db as a,de as Ue,gc as Te,he as je,ic as u,id as xe,j as ye,ja as ge,jc as Le,je as Ne,k as ee,kc as b,le as Ge,ma as ve,ne as Me,oa as m,ob as Ce,q as te,rc as w,sc as F,tc as X,ua as ne,v,va as se,ve as Oe,w as E,we as Fe,xc as $e,xe as Xe,yc as _e,ze as Ke}from"./chunk-GP622B77.js";function le(i,s){return i.pipe(v(r=>r.find(e=>e.Key===s)||null))}function Rt(i){return i.slice().sort((s,r)=>s.Value.localeCompare(r.Value))}function rt(i,s,r){let[e,t]=tt(r?.in,i,s);return+ce(e)==+ce(t)}var at=new ve("Confirm Absences Service");var dt=i=>({count:i}),mt=()=>["/edit-absences"],lt=(i,s)=>s.Id;function ft(i,s){if(i&1&&(d(0,"div",4),u(1),p(2,"translate"),f()),i&2){let r=s.$implicit;a(),b(" ",H(2,1,"global.validation-errors."+r.error,r.params)," ")}}function ut(i,s){if(i&1&&(d(0,"div",21),u(1),p(2,"translate"),f()),i&2){let r=s.$implicit;a(),b(" ",H(2,1,"global.validation-errors."+r.error,r.params)," ")}}function ht(i,s){if(i&1&&(G(0,ut,3,4,"div",21,oe),p(2,"async")),i&2){let r=x(4);M(c(2,0,r.absenceTypeIdErrors$))}}function yt(i,s){if(i&1&&(d(0,"div",16),O(1,"input",19),p(2,"async"),d(3,"label",20),u(4),f(),k(5,ht,3,2),p(6,"async"),f()),i&2){let r,e,t=s.$implicit,o=s.$index,n=x(3);a(),Te("is-invalid",(((r=c(2,7,n.absenceTypeIdErrors$))==null?null:r.length)??0)>0),C("id","absence-type-"+o)("value",t.Id),a(2),C("for","absence-type-"+o),a(),b(" ",t.Designation," "),a(),B((((e=c(6,9,n.absenceTypes$))==null?null:e.length)??0)-1===o?5:-1)}}function bt(i,s){if(i&1&&(G(0,yt,7,11,"div",16,lt),p(2,"async"),d(3,"div",17),u(4),p(5,"translate"),d(6,"a",18),u(7),p(8,"translate"),f()()),i&2){let r=x(2);M(c(2,3,r.absenceTypes$)),a(4),b(" ",c(5,5,"open-absences.edit.remark")," "),a(2),C("routerLink",$e(9,mt)),a(),b(" ",c(8,7,"edit-absences.title")," ")}}function St(i,s){i&1&&(d(0,"div",15)(1,"span",22),u(2,"Loading..."),f()())}function gt(i,s){if(i&1){let r=Re();d(0,"form",3),re("ngSubmit",function(){ne(r);let t=x();return se(t.onSubmit())}),G(1,ft,3,4,"div",4,oe),p(3,"async"),d(4,"div",5)(5,"div",6),O(6,"input",7),d(7,"label",8),u(8),f(),k(9,bt,9,10),f(),d(10,"div",9),O(11,"input",10),d(12,"label",11),u(13),f()()(),d(14,"div",12)(15,"button",13),p(16,"async"),re("click",function(){ne(r);let t=x();return se(t.cancel())}),u(17),p(18,"translate"),f(),d(19,"button",14),p(20,"async"),u(21),p(22,"translate"),k(23,St,3,0,"div",15),p(24,"async"),f()()()}if(i&2){let r=x(),e=X(0),t=X(2),o=X(4);C("formGroup",e),a(),M(c(3,11,r.formErrors$)),a(5),C("value",o.Key),a(2),b(" ",o.Value," "),a(),B(e.get("absenceTypeId")?9:-1),a(2),C("value",t.Key),a(2),b(" ",t.Value," "),a(2),C("disabled",c(16,13,r.saving$)),a(2),b(" ",c(18,15,"open-absences.edit.cancel")," "),a(2),C("disabled",c(20,17,r.saving$)),a(2),b(" ",c(22,19,"open-absences.edit.save")," "),a(2),B(c(24,21,r.saving$)?23:-1)}}var zt=(()=>{let s=class s{constructor(){this.fb=m(Oe),this.router=m(De),this.activatedRoute=m(Ee),this.toastService=m(He),this.translate=m(Ke),this.selectionService=m(st),this.dropDownItemsService=m(ze),this.presenceTypesService=m(Ye),this.updateService=m(Je),this.settings=m(q),this.openAbsencesEditService=m(at,{optional:!0}),this.formGroup$=this.selectionService.selectedWithoutPresenceType$.pipe(v(this.createFormGroup.bind(this)),ie(1)),this.saving$=new ee(!1),this.submitted$=new ee(!1),this.formErrors$=pe(this.formGroup$,this.submitted$),this.absenceTypeIdErrors$=pe(this.formGroup$,this.submitted$,"absenceTypeId"),this.confirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe(ie(1)),this.excusedState$=le(this.confirmationStates$,this.settings.excusedAbsenceStateId),this.unexcusedState$=le(this.confirmationStates$,this.settings.unexcusedAbsenceStateId),this.absenceTypes$=this.presenceTypesService.confirmationTypes$,this.destroy$=new ye}ngOnInit(){this.selectionService.selectedIds$.pipe(L(1)).subscribe(e=>{e.length===0&&this.navigateBack()}),Ze(this.formGroup$,"confirmationValue").pipe(N(this.destroy$)).subscribe(e=>{typeof e=="number"&&this.updateAbsenceTypeIdDisabled(e)}),E([P(this.formGroup$,"confirmationValue").pipe(T(_)),P(this.formGroup$,"absenceTypeId").pipe(T(_)),this.saving$]).pipe(N(this.destroy$)).subscribe(([e,t,o])=>{o?(e.disable(),t.disable()):(e.enable(),this.updateAbsenceTypeIdDisabled(e.value))}),E([P(this.formGroup$,"confirmationValue").pipe(T(_)),this.excusedState$.pipe(L(1),T(_))]).pipe(N(this.destroy$)).subscribe(([e,t])=>e.setValue(t.Key))}ngOnDestroy(){this.destroy$.next()}onSubmit(){this.submitted$.next(!0),this.formGroup$.pipe(L(1)).subscribe(e=>{if(e.valid){let{confirmationValue:t,absenceTypeId:o}=e.value;this.save(t,o)}})}cancel(){this.navigateBack()}getSelectedCount(){return this.selectionService.selectedLessons$.pipe(v(e=>e.length))}createFormGroup(e){return e.length>0?this.fb.group({confirmationValue:[null],absenceTypeId:[null,Pe.required]}):this.fb.group({confirmationValue:[null]})}updateAbsenceTypeIdDisabled(e){E([P(this.formGroup$,"absenceTypeId").pipe(L(1),T(_)),this.excusedState$.pipe(L(1),T(_))]).subscribe(([t,o])=>{e===o.Key?t.enable():t.disable()})}save(e,t){this.saving$.next(!0),E([this.selectionService.selectedIds$.pipe(L(1)),this.unexcusedState$.pipe(L(1),T(_))]).pipe(y(([o,n])=>E(o.map(({lessonIds:Y,personId:Z,presenceTypeId:V})=>this.updateService.confirmLessonPresences(Y,[Z],this.getNewAbsenceTypeId(V,e,Number(n.Key),t),e)))),Se(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}getNewAbsenceTypeId(e,t,o,n){if(!e)throw new Error("absence type id cannot be null");return t===o?this.settings.absencePresenceTypeId:e===this.settings.absencePresenceTypeId?n:e}onSaveSuccess(){this.openAbsencesEditService?.updateAfterConfirm&&this.openAbsencesEditService.updateAfterConfirm(),this.toastService.success(this.translate.instant("open-absences.edit.save-success")),this.navigateBack()}navigateBack(){this.router.navigate(this.openAbsencesEditService?.confirmBackLink||[".."],{relativeTo:this.activatedRoute,queryParams:this.openAbsencesEditService?.confirmBackLinkParams})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275cmp=Ce({type:s,selectors:[["bkd-confirm-absences"]],decls:16,vars:21,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"formGroup"],[3,"ngSubmit","formGroup"],[1,"alert","alert-danger"],[1,"form-group","pb-4"],[1,"form-check","mt-2","mb-3","pb-3","border-bottom"],["type","radio","id","excused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","excused",1,"form-check-label"],[1,"form-check","mt-3","mb-3","pb-3","border-bottom"],["type","radio","id","unexcused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","unexcused",1,"form-check-label"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],[1,"form-check","my-3"],[1,"remark"],[3,"routerLink"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback"],[1,"visually-hidden"]],template:function(t,o){if(t&1&&(w(0),p(1,"async"),w(2),p(3,"async"),w(4),p(5,"async"),d(6,"div",0)(7,"h1"),u(8),p(9,"translate"),f(),d(10,"div",1),w(11),p(12,"async"),u(13),p(14,"translate"),f(),k(15,gt,25,23,"form",2),f()),t&2){let n=F(c(1,3,o.formGroup$));a(2);let Y=F(c(3,6,o.unexcusedState$));a(2);let Z=F(c(5,9,o.excusedState$));a(4),Le(c(9,12,"open-absences.edit.title"));let V=c(12,14,o.getSelectedCount());a(5),b(" ",H(14,16,V===1?"open-absences.edit.lesson-selected":"open-absences.edit.lessons-selected",_e(19,dt,V))," "),a(2),B(n&&Y&&Z?15:-1)}},dependencies:[Fe,je,we,Ne,Ve,Ue,Xe,Ge,Me,Ae,xe,qe],encapsulation:2,changeDetection:0});let i=s;return i})();var pt=g({StudentRef:h,StudentFullName:l,TotalAbsences:S,TotalAbsencesUnconfirmed:S,TotalAbsencesValidExcuse:S,TotalAbsencesWithoutExcuse:S,TotalAbsencesUnchecked:S,TotalDispensations:S,TotalHalfDays:S,TotalIncidents:S});var fe=g({Id:l,LessonRef:h,StudentRef:h,EventRef:h,TypeRef:K,RegistrationRef:K,StudyClassRef:K,ConfirmationStateId:$(S),EventDesignation:l,HasStudyCourseConfirmationCode:ke,LessonDateTimeFrom:A,LessonDateTimeTo:A,Comment:$(l),Date:$(Be),Type:$(l),StudentFullName:l,StudyClassNumber:l,TeacherInformation:$(l)});var Q=g({LessonRef:h,EventRef:h,StudyClassNumber:l,StudentRef:h});var ue=g({LessonRef:h,EventRef:h,EventDesignation:l,StudyClassNumber:l,TeacherInformation:$(l),LessonDateTimeFrom:A,LessonDateTimeTo:A});var Li=(()=>{let s=class s extends Qe{constructor(){let e=m(Ie),t=m(q);super(e,t,fe,"LessonPresences"),this.storage=m(We),this.lessonPresenceRefCodec=g(ae(this.codec.props,["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"])),this.lessonPresenceIdCodec=g(ae(this.codec.props,["Id"]))}getLessonsByDate(e){let t={fields:Object.keys(ue.props).join(","),"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,sort:"LessonDateTimeFrom"},o={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:o}).pipe(y(R(ue)))}getLessonStudyClassesByDate(e){let t={fields:Object.keys(Q.props).join(","),"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,sort:"LessonDateTimeFrom"},o={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:o}).pipe(y(R(Q)))}getLessonStudyClassesByEvent(e){let t={"filter.EventRef":`=${e}`,sort:"LessonDateTimeFrom"},o={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:o}).pipe(y(R(Q)))}getListByLessons(e){if(e.length===0)return te([]);let o={"filter.LessonRef":`;${e.map(n=>n.LessonRef.Id).join(";")}`};return this.getList({params:o,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListByDateStudentClass(e,t,o){let n={"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,"filter.StudentRef":`=${t}`};return o!=null&&(n["filter.StudyClassRef"]=`=${o}`),this.getList({params:n,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListForToday(){return this.http.get(`${this.baseUrl}/Today`,{headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe(y(R(this.codec)))}getListOfUnconfirmed(e){return z(this.storage.getPayload()?.roles,"ClassTeacherRole")?be([this.getListOfUnconfirmedClassTeacher(e),this.getListOfUnconfirmedLessonTeacher(e)]).pipe(v(ot(nt))):z(this.storage.getPayload()?.roles,"LessonTeacherRole")?this.getListOfUnconfirmedLessonTeacher(e):z(this.storage.getPayload()?.roles,"AbsenceAdministratorRole")?this.getListOfUnconfirmedAbsenceAdministrator(e):te([])}getStatistics(e,t,o){let n=he([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]]);return n=vt(t,n),n=W(o,this.settings.paginationLimit,n),this.http.get(`${this.baseUrl}/Statistics`,{params:n,headers:me(),observe:"response"}).pipe(de(pt))}getLessonRefs(e){let t=he([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]]);return t=t.set("filter.TypeRef",">0"),t=t.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),t=t.set("limit","1500"),this.http.get(`${this.baseUrl}/`,{params:t}).pipe(y(R(this.lessonPresenceRefCodec)))}getRegistrationRefsByEventIds(e){let t=new D;return t.set("filter.EventRef",`;${e.join(";")}`),t=t.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),this.http.get(`${this.baseUrl}/`,{params:t}).pipe(y(R(this.lessonPresenceRefCodec)))}getFilteredList(e,t,o){let n=he([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]],new D({fromObject:o}));return e.teacher&&(n=n.set("filter.TeacherInformation",`~*${e.teacher}*`)),e.dateFrom&&e.dateTo&&rt(e.dateFrom,e.dateTo)?n=n.set("filter.LessonDateTimeFrom",`=${I(e.dateFrom,"yyyy-MM-dd")}`):(e.dateFrom&&(n=n.set("filter.LessonDateTimeFrom",`>${I(it(e.dateFrom,1),"yyyy-MM-dd")}`)),e.dateTo&&(n=n.set("filter.LessonDateTimeTo",`<${I(et(e.dateTo,1),"yyyy-MM-dd")}`))),e.weekdays&&(n=n.set("filter.WeekdayId",`;${e.weekdays.join(";")}`)),e.confirmationStates&&(n=n.set("filter.ConfirmationStateId",`;${e.confirmationStates.join(";")}`)),e.incidentTypes&&(n=n.set("filter.TypeRef",`;${e.incidentTypes.join(";")}`)),e.presenceTypes&&(n=n.set("filter.TypeRef",`;${e.presenceTypes.join(";")}`)),e.incidentTypes&&e.presenceTypes&&(n=n.set("filter.TypeRef",`;${e.presenceTypes.join(";")};${e.incidentTypes.join(";")}`)),this.http.get(`${this.baseUrl}/`,{params:W(t,this.settings.paginationLimit,n),headers:me(),observe:"response"}).pipe(de(fe))}hasLessonsLessonTeacher(){let e=new D().set("fields","Id");return this.http.get(`${this.baseUrl}/`,{params:W(0,1,e),headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe(y(R(this.lessonPresenceIdCodec)),v(t=>t.length>0))}checkableAbsencesCount(){return this.http.get(`${this.baseUrl}/`,{headers:{"X-Role-Restriction":"LessonTeacherRole"},params:{"filter.ConfirmationStateId":`;${this.settings.checkableAbsenceStateId}`,fields:"Id,ConfirmationStateId"}}).pipe(y(R(this.lessonPresenceIdCodec)),v(e=>e.length))}getListOfUnconfirmedLessonTeacher(e){return this.getList({headers:{"X-Role-Restriction":"LessonTeacherRole"},params:j(U({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=false"})})}getListOfUnconfirmedClassTeacher(e){return this.getList({headers:{"X-Role-Restriction":"ClassTeacherRole"},params:j(U({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=true"})})}getListOfUnconfirmedAbsenceAdministrator(e){return this.getList({headers:{"X-Role-Restriction":"AbsenceAdministratorRole"},params:j(U({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`})})}};s.\u0275fac=function(t){return new(t||s)},s.\u0275prov=ge({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();function he(i,s=new D){return i.reduce((r,[e,t])=>e&&t?r.set(`filter.${t}`,`=${e}`):r,s)}function vt(i,s=new D){return i?s.set("sort",`${String(i.primarySortKey)}.${i.ascending?"asc":"desc"}`):s}export{Rt as a,rt as b,at as c,zt as d,Li as e};
