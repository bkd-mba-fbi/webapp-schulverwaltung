import{a as Ft}from"./chunk-K2WHAXOA.js";import{b as Rt}from"./chunk-G4BBF67E.js";import{a as wt,b as Dt}from"./chunk-LMQAXXHO.js";import{f as Le,g as $e}from"./chunk-ASGMTRYE.js";import{c as Mt,d as Lt}from"./chunk-E3MRLVGK.js";import"./chunk-EXHTRNRL.js";import"./chunk-ZAGM2WJU.js";import{a as Pt}from"./chunk-D5RVOUSN.js";import{B as oe,C as re,D as At,E as It,F as kt,G as $t,b as ft,f as ke,g as gt,j as Me,m as de,n as Be,x as Ct,y as vt,z as St}from"./chunk-IG4JFLD5.js";import{a as yt}from"./chunk-JQMOLUIY.js";import{b as Tt}from"./chunk-TN3HRY7Y.js";import{a as ht}from"./chunk-QENSBOG3.js";import{e as _t,p as le}from"./chunk-QGDSASTQ.js";import"./chunk-2QS7YZBA.js";import{a as se}from"./chunk-56A7FKFV.js";import"./chunk-YHCR7GAG.js";import{i as xt}from"./chunk-YNODG5RP.js";import"./chunk-EFJ6WEH7.js";import{c as st,d as ot,e as rt,f as at,g as ct,h as pt,i as lt,l as dt}from"./chunk-HVLHLZKP.js";import{b as X,d as bt}from"./chunk-DQAQYQ7K.js";import{a as mt}from"./chunk-LYDHS67M.js";import{A as Y,N as ie,d as Ze,q as et,r as ye,s as tt,t as he,z as ne}from"./chunk-ZXUJZ6KS.js";import{$d as _e,Ae as D,Cc as a,Dc as d,Ec as w,Gb as C,H,Hb as Fe,Ia as je,Ib as v,Kb as fe,Lb as j,Mb as G,Nb as b,Ob as c,Pb as l,Pd as Ee,Q as P,Qb as S,Qc as Xe,U as Oe,Ub as E,Wb as g,Xb as _,Z as Ne,_ as F,a as we,aa as Ve,ba as M,be as nt,cc as qe,ce as ge,da as He,db as o,dc as Ue,de as Ce,ec as L,fd as be,gc as Z,hc as We,he as ve,ic as m,id as q,j as me,ja as J,jc as $,jd as Je,je as Se,k as De,kc as f,l as Pe,lc as K,le as xe,ne as Ae,oa as h,ob as T,oc as Ke,pc as ze,q as V,qc as Qe,rc as B,sb as ue,sc as z,tc as R,ua as A,ub as W,v as y,va as I,vc as Ye,ve as it,w as x,wb as Ge,wc as ee,we as Ie,xc as Q,xe as Te,yc as te,ze as ut}from"./chunk-GP622B77.js";var ae=(()=>{let i=class i{constructor(){this.settings=h(ne),this.storageService=h(se),this.studentsService=h(Le),this.studentId$=new Pe(1),this.lessonAbsences$=this.studentId$.pipe(M(this.loadLessonAbsences.bind(this)),F(1)),this.lessonIncidents$=this.studentId$.pipe(M(this.loadLessonIncidents.bind(this)),F(1)),this.lessonPresences$=this.getLessonPresences(),this.checkableAbsences$=this.getAbsences(this.settings.checkableAbsenceStateId),this.openAbsences$=this.getAbsences(this.settings.unconfirmedAbsenceStateId),this.excusedAbsences$=this.getAbsences(this.settings.excusedAbsenceStateId),this.unexcusedAbsences$=this.getAbsences(this.settings.unexcusedAbsenceStateId),this.incidents$=this.getAbsences(null),this.openLessonAbsences$=x([this.openAbsences$.pipe(H(X)),this.lessonAbsences$]).pipe(y(re(this.getLessonAbsences.bind(this))),F(1)),this.checkableLessonAbsences$=x([this.checkableAbsences$.pipe(H(X)),this.lessonAbsences$]).pipe(y(re(this.getLessonAbsences.bind(this))),F(1)),this.excusedLessonAbsences$=x([this.excusedAbsences$.pipe(H(X)),this.lessonAbsences$]).pipe(y(re(this.getLessonAbsences.bind(this))),F(1)),this.unexcusedLessonAbsences$=x([this.unexcusedAbsences$.pipe(H(X)),this.lessonAbsences$]).pipe(y(re(this.getLessonAbsences.bind(this))),F(1)),this.incidentsLessonAbsences$=x([this.incidents$.pipe(H(X)),this.lessonIncidents$]).pipe(y(re(this.getLessonIncidents.bind(this))),F(1)),this.counts$=this.getCounts();let e=this.storageService.getPayload()?.id_person;e&&this.studentId$.next(Number(e))}reset(){this.studentId$.pipe(P(1)).subscribe(e=>this.studentId$.next(e))}getLessonPresences(){return this.getCached(x([this.studentId$,this.lessonAbsences$,this.lessonIncidents$]).pipe(M(([e,n,s])=>this.loadTimetableEntries(e,n,s).pipe(y(p=>this.buildLessonPresences(n,s,p)))),y(St)))}getAbsences(e){return this.getCached(this.lessonPresences$.pipe(y(n=>n?.filter(s=>s.ConfirmationStateId===e)||null)))}getLessonAbsences(e,n){let s=e.map(p=>p.LessonRef.Id);return n.filter(p=>s.includes(p.LessonRef.Id))}getLessonIncidents(e,n){let s=e.map(p=>p.LessonRef.Id);return n.filter(p=>s.includes(p.LessonRef.Id))}getCounts(){return x([this.getCount(this.checkableAbsences$),this.getCount(this.openAbsences$),this.getCount(this.excusedAbsences$),this.getCount(this.unexcusedAbsences$),this.getCount(this.incidents$)]).pipe(y(([e,n,s,p,u])=>({checkableAbsences:e,openAbsences:n,excusedAbsences:s,unexcusedAbsences:p,incidents:u,halfDays:null})))}getCached(e){return e.pipe(Ve(null),Ne({connector:()=>new Pe(1)}))}getCount(e){return e.pipe(y(n=>n?.length??null))}loadLessonAbsences(e){return this.studentsService.getLessonAbsences(e)}loadLessonIncidents(e){return this.studentsService.getLessonIncidents(e)}loadTimetableEntries(e,n,s){return this.studentsService.getTimetableEntries(e,{"filter.Id":`;${[...n,...s].map(p=>p.LessonRef.Id).join(";")}`})}buildLessonPresences(e,n,s){return[...e,...n].map(p=>this.buildLessonPresence(p,s)).filter(X)}buildLessonPresence(e,n){let s=n.find(p=>p.Id===e.LessonRef.Id);return s?{Id:"",LessonRef:{Id:e.LessonRef.Id,HRef:e.LessonRef.HRef?e.LessonRef.HRef:null},StudentRef:e.StudentRef,EventRef:{Id:0,HRef:null},TypeRef:e.TypeRef,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:"ConfirmationStateId"in e?e.ConfirmationStateId:null,EventDesignation:s.EventDesignation,HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:s.From,LessonDateTimeTo:s.To,Comment:null,Date:s.From,Type:e.Type,StudentFullName:e.StudentFullName,StudyClassNumber:"",TeacherInformation:s.EventManagerInformation??null}:null}};i.\u0275fac=function(n){return new(n||i)},i.\u0275prov=J({token:i,factory:i.\u0275fac});let t=i;return t})();var Re=(()=>{let i=class i{constructor(){this.fb=h(it),this.router=h(tt),this.toastService=h(mt),this.translate=h(ut),this.presenceTypesService=h(ke),this.updateService=h(ft),this.storageService=h(se),this.settings=h(ne),this.formGroup=this.createFormGroup(),this.saving$=new De(!1),this.submitted$=new De(!1),this.absenceTypes$=x([this.getConfirmationTypes(),this.getHalfDayType()]).pipe(y(([e,n])=>n?[...e,n]:e)),this.absenceTypeIdErrors$=yt(V(this.formGroup),this.submitted$,"absenceTypeId"),this.destroy$=new me}ngOnInit(){this.selectedLessonIds$.pipe(P(1),H(It)).subscribe(()=>this.navigateBack())}ngOnDestroy(){this.destroy$.next()}onSubmit(){if(this.submitted$.next(!0),this.formGroup.valid){let{absenceTypeId:e}=this.formGroup.value;this.save(e)}}cancel(){this.navigateBack()}getSelectedCount(){return this.selectedLessonIds$.pipe(y(e=>e.length))}getConfirmationTypes(){return this.presenceTypesService.confirmationTypes$.pipe(y(e=>e.filter(n=>n.IsAbsence&&n.Id!==this.settings.halfDayPresenceTypeId)))}getHalfDayType(){return V(null)}createFormGroup(){return this.fb.group({absenceTypeId:[null,nt.required]})}save(e){this.saving$.next(!0),this.selectedLessonIds$.pipe(P(1),M(n=>this.updateService.editLessonPresences(n,[Number(this.storageService.getPayload()?.id_person)],e)),Oe(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.toastService.success(this.translate.instant("my-absences.confirm.save-success")),this.navigateBack()}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["ng-component"]],decls:0,vars:0,template:function(n,s){},encapsulation:2});let t=i;return t})();var zt=t=>({count:t}),Qt=t=>({"border-top pt-3":t}),Yt=(t,i)=>i.Id;function Xt(t,i){if(t&1&&(c(0,"div",13),m(1),a(2,"translate"),l()),t&2){let r=i.$implicit;o(),f(" ",w(2,1,"global.validation-errors."+r.error,r.params)," ")}}function Jt(t,i){if(t&1&&(j(0,Xt,3,4,"div",13,fe),a(2,"async")),t&2){let r=_(2);G(d(2,0,r.absenceTypeIdErrors$))}}function Zt(t,i){if(t&1&&(c(0,"div",5),S(1,"input",11),a(2,"async"),c(3,"label",12),m(4),l(),C(5,Jt,3,2),a(6,"async"),l()),t&2){let r,e,n=i.$implicit,s=i.$index,p=_();b("ngClass",te(12,Qt,n.IsHalfDay)),o(),Z("is-invalid",(((r=d(2,8,p.absenceTypeIdErrors$))==null?null:r.length)??0)>0),b("id","absence-type-"+s)("value",n.Id),o(2),b("for","absence-type-"+s),o(),f(" ",n.Designation," "),o(),v((((e=d(6,10,p.absenceTypes$))==null?null:e.length)??0)-1===s?5:-1)}}function en(t,i){t&1&&(c(0,"div",10)(1,"span",14),m(2,"Loading..."),l()())}var Et=(()=>{let i=class i extends Re{constructor(){super(),this.myAbsencesService=h(ae),this.selectionService=h(oe),this.titleKey="my-absences.confirm.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(y(e=>ie(Y(e.map(n=>n.lessonIds))))),this.confirmationStateId=this.settings.unconfirmedAbsencesRefreshTime}onSaveSuccess(){this.selectionService.clear(),this.myAbsencesService.reset(),super.onSaveSuccess()}navigateBack(){this.router.navigate(["/my-absences"])}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-confirm"]],features:[ue],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,s){if(n&1){let p=E();c(0,"div",0)(1,"h1"),m(2),a(3,"translate"),l(),c(4,"div",1),B(5),a(6,"async"),m(7),a(8,"translate"),l(),c(9,"form",2),g("ngSubmit",function(){return A(p),I(s.onSubmit())}),c(10,"div",3)(11,"label",4),m(12),a(13,"translate"),a(14,"addSpace"),l(),j(15,Zt,7,14,"div",5,Yt),a(17,"async"),l(),c(18,"div",6),m(19),a(20,"translate"),l(),c(21,"div",7)(22,"button",8),a(23,"async"),g("click",function(){return A(p),I(s.cancel())}),m(24),a(25,"translate"),l(),c(26,"button",9),a(27,"async"),m(28),a(29,"translate"),C(30,en,3,0,"div",10),a(31,"async"),l()()()()}if(n&2){o(2),$(d(3,11,s.titleKey));let p=d(6,13,s.getSelectedCount());o(5),f(" ",w(8,15,p===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",te(37,zt,p))," "),o(2),b("formGroup",s.formGroup),o(3),K("",d(13,18,"my-absences.confirm.choose-presence-type"),"",w(14,20,":",":")),o(3),G(d(17,23,s.absenceTypes$)),o(4),f(" ",d(20,25,"my-absences.confirm.remark")," "),o(3),b("disabled",d(23,27,s.saving$)),o(2),f(" ",d(25,29,"my-absences.confirm.cancel")," "),o(2),b("disabled",d(27,31,s.saving$)),o(2),f(" ",d(29,33,"my-absences.confirm.save")," "),o(2),v(d(31,35,s.saving$)?30:-1)}},dependencies:[Ie,ve,_e,Se,ge,Ce,Te,xe,Ae,be,q,D,$e],encapsulation:2,changeDetection:0});let t=i;return t})();var ce=(()=>{let i=class i extends Ct{constructor(){super(...arguments),this.selectedIds$=this.selection$.pipe(y(vt))}};i.\u0275fac=(()=>{let e;return function(s){return(e||(e=je(i)))(s||i)}})(),i.\u0275prov=J({token:i,factory:i.\u0275fac});let t=i;return t})();var pe=(()=>{let i=class i extends Dt{get preventAbsencesAfterStart(){if(this._preventAbsencesAfterStart==null){let e=this.storageService.getPayload()?.instance_id,n=this.settings.preventStudentAbsenceAfterLessonStart;this._preventAbsencesAfterStart=e?n.includes(e):!1}return this._preventAbsencesAfterStart}constructor(){super("/my-absences/report"),this.studentsService=h(Le),this.storageService=h(se)}getInitialFilter(){return{dateFrom:null,dateTo:null}}isValidFilter(e){return!!(e.dateFrom||e.dateTo)}loadEntries(e,n,s){let p=this.buildRequestParamsFromFilter(e).set("sort","From.asc");return this.loadingService.load(this.loadTimetableEntries(p).pipe(y(u=>this.filterAbsencesAfterLessonStart(u)),M(u=>x([V(u),this.loadLessonAbsences(u),this.loadLessonDispensations(u)])),y(([u,k,U])=>this.buildLessonPresences(u,k,U)),y(u=>({offset:0,total:u.length,entries:u}))),wt)}filterAbsencesAfterLessonStart(e){return this.preventAbsencesAfterStart?e.filter(n=>n.From.getTime()>=new Date().getTime()):e}buildParamsFromFilter(e){let{dateFrom:n,dateTo:s}=e,p={};return n&&(p.dateFrom=le(n,"yyyy-MM-dd")),s&&(p.dateTo=le(s,"yyyy-MM-dd")),p}buildRequestParamsFromFilter(e){let n=new Ze;return e.dateFrom&&(n=n.set("filter.From",`>${le(gt(e.dateFrom,1),"yyyy-MM-dd")}`)),e.dateTo&&(n=n.set("filter.To",`<${le(ht(e.dateTo,1),"yyyy-MM-dd")}`)),n}get studentId(){let e=this.storageService.getPayload()?.id_person;if(e==null)throw new Error("No student id available");return Number(e)}loadTimetableEntries(e){return this.studentsService.getTimetableEntries(this.studentId,e)}loadLessonAbsences(e){return e.length>0?this.studentsService.getLessonAbsences(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):V([])}loadLessonDispensations(e){return e.length>0?this.studentsService.getLessonDispensations(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):V([])}buildLessonPresences(e,n,s){return e.map(p=>this.buildLessonPresence(p,n,s))}buildLessonPresence(e,n,s){let p=n.find(U=>U.LessonRef.Id===e.Id),u=s.find(U=>U.LessonRef.Id===e.Id),k=this.buildLessonPresenceTypeRef(p,u);return{Id:"",LessonRef:{Id:e.Id,HRef:null},StudentRef:(p||u)?.StudentRef||{Id:this.studentId,HRef:null},EventRef:{Id:0,HRef:null},TypeRef:k,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:p?.ConfirmationStateId||u&&this.settings.excusedAbsenceStateId||null,EventDesignation:e.EventDesignation||"",HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:e.From||new Date,LessonDateTimeTo:e.To||new Date,Comment:null,Date:e.From||new Date,Type:(p||u)?.Type||null,StudentFullName:(p||u)?.StudentFullName||"",StudyClassNumber:"",TeacherInformation:e.EventManagerInformation??null}}buildLessonPresenceTypeRef(e,n){return e?we({},e.TypeRef):n?we({},n.TypeRef):{Id:null,HRef:null}}};i.\u0275fac=function(n){return new(n||i)},i.\u0275prov=J({token:i,factory:i.\u0275fac});let t=i;return t})();var tn=t=>({count:t}),nn=t=>({"border-top pt-3":t}),sn=(t,i)=>i.Id;function on(t,i){if(t&1&&(c(0,"div",13),m(1),a(2,"translate"),l()),t&2){let r=i.$implicit;o(),f(" ",w(2,1,"global.validation-errors."+r.error,r.params)," ")}}function rn(t,i){if(t&1&&(j(0,on,3,4,"div",13,fe),a(2,"async")),t&2){let r=_(2);G(d(2,0,r.absenceTypeIdErrors$))}}function an(t,i){if(t&1&&(c(0,"div",5),S(1,"input",11),a(2,"async"),c(3,"label",12),m(4),l(),C(5,rn,3,2),a(6,"async"),l()),t&2){let r,e,n=i.$implicit,s=i.$index,p=_();b("ngClass",te(12,nn,n.IsHalfDay)),o(),Z("is-invalid",(((r=d(2,8,p.absenceTypeIdErrors$))==null?null:r.length)??0)>0),b("id","absence-type-"+s)("value",n.Id),o(2),b("for","absence-type-"+s),o(),f(" ",n.Designation," "),o(),v((((e=d(6,10,p.absenceTypes$))==null?null:e.length)??0)-1===s?5:-1)}}function cn(t,i){t&1&&(c(0,"div",10)(1,"span",14),m(2,"Loading..."),l()())}var Bt=(()=>{let i=class i extends Re{constructor(){super(),this.state=h(pe),this.selectionService=h(ce),this.titleKey="my-absences.report.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(y(e=>ie(Y(e.map(n=>n.lessonIds))))),this.confirmationStateId=this.settings.checkableAbsenceStateId}getHalfDayType(){return this.presenceTypesService.getPresenceType(this.settings.halfDayPresenceTypeId).pipe(y(e=>e.Active?e:null))}onSaveSuccess(){this.selectionService.clear(),this.state.resetEntries(),super.onSaveSuccess()}navigateBack(){this.state.queryParams$.pipe(P(1)).subscribe(e=>{this.router.navigate(["/my-absences/report"],{queryParams:e})})}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-confirm"]],features:[ue],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,s){if(n&1){let p=E();c(0,"div",0)(1,"h1"),m(2),a(3,"translate"),l(),c(4,"div",1),B(5),a(6,"async"),m(7),a(8,"translate"),l(),c(9,"form",2),g("ngSubmit",function(){return A(p),I(s.onSubmit())}),c(10,"div",3)(11,"label",4),m(12),a(13,"translate"),a(14,"addSpace"),l(),j(15,an,7,14,"div",5,sn),a(17,"async"),l(),c(18,"div",6),m(19),a(20,"translate"),l(),c(21,"div",7)(22,"button",8),a(23,"async"),g("click",function(){return A(p),I(s.cancel())}),m(24),a(25,"translate"),l(),c(26,"button",9),a(27,"async"),m(28),a(29,"translate"),C(30,cn,3,0,"div",10),a(31,"async"),l()()()()}if(n&2){o(2),$(d(3,11,s.titleKey));let p=d(6,13,s.getSelectedCount());o(5),f(" ",w(8,15,p===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",te(37,tn,p))," "),o(2),b("formGroup",s.formGroup),o(3),K("",d(13,18,"my-absences.confirm.choose-presence-type"),"",w(14,20,":",":")),o(3),G(d(17,23,s.absenceTypes$)),o(4),f(" ",d(20,25,"my-absences.confirm.remark")," "),o(3),b("disabled",d(23,27,s.saving$)),o(2),f(" ",d(25,29,"my-absences.confirm.cancel")," "),o(2),b("disabled",d(27,31,s.saving$)),o(2),f(" ",d(29,33,"my-absences.confirm.save")," "),o(2),v(d(31,35,s.saving$)?30:-1)}},dependencies:[Ie,ve,_e,Se,ge,Ce,Te,xe,Ae,be,q,D,$e],encapsulation:2,changeDetection:0});let t=i;return t})();var pn=()=>["/my-absences"],Nt=(()=>{let i=class i{constructor(){this.filter={dateFrom:null,dateTo:null},this.filterChange=new Ge,this.minDate={year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate()}}updateDateFrom(e){this.filter.dateFrom=e,e&&(this.filter.dateTo=e)}show(){this.filterChange.emit({dateFrom:Ot(this.filter.dateFrom),dateTo:Ot(this.filter.dateTo)})}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-report-header"]],inputs:{filter:"filter"},outputs:{filterChange:"filterChange"},features:[ee([{provide:pt,useClass:dt},{provide:lt,useClass:Rt}])],decls:19,vars:18,consts:[[3,"link"],[1,"filters"],[1,"form-group"],[1,"form-label"],[3,"valueChange","minDate","value"],[1,"buttons"],["type","button",1,"btn","btn-primary",3,"click"]],template:function(n,s){n&1&&(S(0,"bkd-backlink",0),c(1,"h1"),m(2),a(3,"translate"),l(),c(4,"div",1)(5,"div",2)(6,"label",3),m(7),a(8,"translate"),l(),c(9,"bkd-date-select",4),g("valueChange",function(u){return s.updateDateFrom(u)}),l()(),c(10,"div",2)(11,"label",3),m(12),a(13,"translate"),l(),c(14,"bkd-date-select",4),Qe("valueChange",function(u){return ze(s.filter.dateTo,u)||(s.filter.dateTo=u),u}),l()(),c(15,"div",5)(16,"button",6),g("click",function(){return s.show()}),m(17),a(18,"translate"),l()()()),n&2&&(b("link",Q(17,pn)),o(2),$(d(3,9,"my-absences.report.title")),o(5),$(d(8,11,"my-absences.report.header.date-from")),o(2),b("minDate",s.minDate)("value",s.filter.dateFrom),o(3),$(d(13,13,"my-absences.report.header.date-to")),o(2),b("minDate",s.minDate),Ke("value",s.filter.dateTo),o(3),f(" ",d(18,15,"my-absences.report.header.show")," "))},dependencies:[$t,Ft,D],styles:["[_nghost-%COMP%]{display:block;padding-bottom:1rem;border-bottom:1px solid #dee2e6}.filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.form-group[_ngcontent-%COMP%]{flex:1;min-width:20rem;max-width:40rem;margin-right:1rem;margin-bottom:.5rem}.buttons[_ngcontent-%COMP%]{flex:none;margin-top:1.625rem;margin-right:0}@media (max-width: 575.98px){[_nghost-%COMP%]{padding-bottom:0}.buttons[_ngcontent-%COMP%]{width:100%;margin-top:1rem;margin-bottom:1rem}}"],changeDetection:0});let t=i;return t})();function Ot(t){return t?_t(t):null}var ln=(t,i)=>i.Id;function dn(t,i){t&1&&S(0,"bkd-spinner")}function mn(t,i){if(t&1){let r=E();c(0,"div",8)(1,"input",9,2),a(3,"async"),g("change",function(){A(r);let n=_().$implicit,s=_(5);return I(s.selectionService.toggle(n))}),l()()}if(t&2){let r=_().$implicit,e=_(5);o(),b("checked",d(3,1,e.selectionService.isSelected$(r)))}}function un(t,i){if(t&1&&(c(0,"div")(1,"i",13),m(2),l()()),t&2){_();let r=R(2);We(Ye("checkbox presence-category ",r.category)),o(2),$(r.icon)}}function fn(t,i){if(t&1&&m(0),t&2){let r=_().$implicit;f(" , ",r.StudyClassNumber," ")}}function bn(t,i){if(t&1&&(c(0,"div",20),m(1),l()),t&2){_();let r=R(15);o(),f(" ",r," ")}}function yn(t,i){if(t&1){let r=E();c(0,"div",15,1),g("click",function(n){A(r);let s=L(1),p=_(5);return I(p.onRowClick(n,s))}),B(2),a(3,"async"),C(4,mn,4,3,"div",8)(5,un,3,4,"div",16),c(6,"div",17),m(7),C(8,fn,1,1),l(),c(9,"div",18),m(10),a(11,"date"),a(12,"date"),l(),c(13,"div",19),m(14),l(),B(15),a(16,"async"),C(17,bn,2,1,"div",20),c(18,"div",21),m(19),a(20,"date"),l(),c(21,"div",22),m(22),a(23,"bkdDaysDifference"),l(),c(24,"div",23),m(25),a(26,"date"),a(27,"bkdDaysDifference"),l()()}if(t&2){let r=i.$implicit,e=_(5);o(2);let n=z(d(3,11,e.getPresenceCategory(r)));o(2),v(n?5:4),o(3),f(" ",r.EventDesignation," "),o(),v(r.StudyClassNumber?8:-1),o(2),K(" ",w(11,14,r.LessonDateTimeFrom,"HH:mm"),"\u2013",w(12,17,r.LessonDateTimeTo,"HH:mm")," "),o(4),f(" ",r.TeacherInformation," "),o();let s=z(d(16,20,e.getPresenceTypeDesignation(r)));o(2),v(s?17:-1),o(2),f(" ",w(20,23,r.LessonDateTimeFrom,"dd.MM.yyyy")," "),o(3),f(" ",d(23,26,r.LessonDateTimeFrom)," "),o(3),K(" ",w(26,28,r.LessonDateTimeFrom,"dd.MM.yyyy"),", ",d(27,31,r.LessonDateTimeFrom)," ")}}function hn(t,i){if(t&1){let r=E();c(0,"div")(1,"div",7,0),g("click",function(n){A(r);let s=L(2),p=_(4);return I(p.onRowClick(n,s))}),c(3,"div",8)(4,"input",9),a(5,"async"),g("change",function(n){A(r);let s=_(4);return I(s.toggleAll(n.target==null?null:n.target.checked))}),l()(),c(6,"div",10),m(7),a(8,"translate"),l(),c(9,"div",11)(10,"a",12),a(11,"async"),c(12,"i",13),m(13,"edit"),l()()()(),j(14,yn,28,33,"div",14,ln),l()}if(t&2){let r,e=_(4),n=R(0);o(4),b("checked",d(5,4,e.allSelected$)),o(3),f(" ",d(8,6,"my-absences.report.list.all")," "),o(3),Z("disabled",((r=d(11,8,e.selectionService.selection$))==null?null:r.length)===0),o(4),G(n)}}function _n(t,i){t&1&&S(0,"bkd-spinner",6)}function gn(t,i){if(t&1&&(c(0,"div",5),C(1,hn,16,10,"div"),C(2,_n,1,0,"bkd-spinner",6),l()),t&2){_(3);let r=R(0),e=R(2);o(),v(r&&r.length>0?1:-1),o(),v(e?2:-1)}}function Cn(t,i){t&1&&(c(0,"p",4),m(1),a(2,"translate"),l()),t&2&&(o(),f(" ",d(2,1,"my-absences.report.no-entries")," "))}function vn(t,i){if(t&1&&C(0,gn,3,2,"div",5)(1,Cn,3,3,"p",4),t&2){_(2);let r=R(0),e=R(2);v(r&&r.length>0||e?0:1)}}function Sn(t,i){if(t&1&&(C(0,dn,1,0,"bkd-spinner"),a(1,"async"),Fe(2,vn,2,1)),t&2){let r=_();v(d(1,1,r.state.loading$)?0:2)}}function xn(t,i){t&1&&(c(0,"p",4),m(1),a(2,"translate"),l()),t&2&&(o(),$(d(2,1,"my-absences.report.no-filter")))}var Vt=(()=>{let i=class i{constructor(){this.state=h(pe),this.selectionService=h(ce),this.route=h(et),this.scrollPosition=h(Pt),this.presenceTypesService=h(ke),this.settings=h(ne),this.filterFromParams$=this.route.queryParams.pipe(y(An)),this.allSelected$=x([this.selectionService.selection$,this.state.entries$.pipe(M(e=>x(e.map(n=>this.getPresenceType(n)))))]).pipe(y(([e,n])=>e.length>0&&e.length===n.filter(bt(Me)).length)),this.destroy$=new me}ngOnInit(){this.filterFromParams$.pipe(P(1)).subscribe(e=>this.state.setFilter(e)),this.state.validFilter$.pipe(He(this.destroy$)).subscribe(()=>this.selectionService.clear())}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}getPresenceCategory(e){return this.getPresenceType(e).pipe(y(n=>Me(n)?e.ConfirmationStateId===this.settings.checkableAbsenceStateId?{category:de.Unapproved,icon:Be(de.Unapproved)}:{category:de.Absent,icon:Be(de.Absent)}:null))}getPresenceTypeDesignation(e){return this.presenceTypesService.displayedTypes$.pipe(y(n=>e.TypeRef.Id&&n.find(s=>s.Id===e.TypeRef.Id)?.Designation||null))}toggleAll(e){x([this.state.entries$.pipe(P(1)),this.presenceTypesService.presenceTypes$.pipe(P(1))]).subscribe(([n,s])=>{let p=s.filter(u=>Me(u)).map(u=>u.Id);this.selectionService.clear(e?n.filter(u=>u.TypeRef.Id==null||!p.includes(u.TypeRef.Id)):null)})}onRowClick(e,n){let s=n.querySelector('input[type="checkbox"]');s&&e.target!==s&&!e.target.closest(".buttons")&&s.click()}getPresenceType(e){return this.presenceTypesService.presenceTypes$.pipe(y(n=>e.TypeRef.Id&&n.find(s=>s.Id===e.TypeRef.Id)||null))}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-report-list"]],decls:9,vars:12,consts:[["all",""],["row",""],["checkbox",""],[3,"filterChange","filter"],[1,"mt-3"],[1,"py-3"],[1,"inline"],[1,"entries-all",3,"click"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"all"],[1,"buttons"],["routerLink","confirm",1,"edit","btn","btn-primary","btn-icon","me-2"],[1,"material-icons"],[1,"entry"],[1,"entry",3,"click"],[3,"class"],[1,"lesson-class"],[1,"time","pe-2"],[1,"teacher"],[1,"presence-type"],[1,"date"],[1,"days-ago"],[1,"date-days-ago"]],template:function(n,s){if(n&1){let p=E();B(0),a(1,"async"),B(2),a(3,"async"),c(4,"bkd-my-absences-report-header",3),a(5,"async"),g("filterChange",function(k){return A(p),I(s.state.setFilter(k))}),l(),C(6,Sn,3,3),a(7,"async"),Fe(8,xn,3,3,"p",4)}n&2&&(z(d(1,2,s.state.entries$)),o(2),z(d(3,5,s.state.loadingPage$)),o(2),b("filter",d(5,8,s.filterFromParams$)),o(2),v(d(7,10,s.state.isFilterValid$)?6:8))},dependencies:[Nt,he,xt,q,Je,D,At],styles:['.entries-all[_ngcontent-%COMP%]{padding:0 0 .5rem 1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox all buttons";grid-template-columns:min-content 1fr min-content}.entry[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox lesson-class time teacher" "checkbox presence-type date days-ago";grid-template-columns:min-content 2fr 1fr 2fr}.entry[_ngcontent-%COMP%]:first-child{padding-top:0}.entries-all[_ngcontent-%COMP%] + .entry[_ngcontent-%COMP%]{padding-top:1rem}.presence-category.absent[_ngcontent-%COMP%]{color:#ea161f}.presence-category.unapproved[_ngcontent-%COMP%]{color:#ffa814}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.3rem 1rem 0 0}.presence-category[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{display:block;font-size:16px}.entries-all[_ngcontent-%COMP%]   .checkbox[_ngcontent-%COMP%]{padding-top:.2rem}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.all[_ngcontent-%COMP%]{grid-area:all}.buttons[_ngcontent-%COMP%]{grid-area:buttons;display:flex}.lesson-class[_ngcontent-%COMP%]{grid-area:lesson-class;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.time[_ngcontent-%COMP%]{grid-area:time}.teacher[_ngcontent-%COMP%]{grid-area:teacher}.presence-type[_ngcontent-%COMP%]{color:#adb5bd;grid-area:presence-type}.date[_ngcontent-%COMP%]{grid-area:date}.days-ago[_ngcontent-%COMP%]{color:#adb5bd;grid-area:days-ago}.date-days-ago[_ngcontent-%COMP%]{grid-area:date-days-ago;display:none}@media (max-width: 750px){.entry[_ngcontent-%COMP%]{grid-template-areas:"checkbox lesson-class" "checkbox teacher" "checkbox date-days-ago" "checkbox time" "checkbox presence-type";grid-template-columns:min-content 1fr}.date-days-ago[_ngcontent-%COMP%]{display:block}.date[_ngcontent-%COMP%], .days-ago[_ngcontent-%COMP%]{display:none}}'],changeDetection:0});let t=i;return t})();function An(t){return{dateFrom:t.dateFrom?Ee(t.dateFrom):null,dateTo:t.dateTo?Ee(t.dateTo):null}}var Ht=(()=>{let i=class i{constructor(){}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-report"]],features:[ee([pe,ce])],decls:1,vars:0,template:function(n,s){n&1&&S(0,"router-outlet")},dependencies:[ye],encapsulation:2,changeDetection:0});let t=i;return t})();var In=["link"],Tn=()=>["/my-absences/report"],jt=(()=>{let i=class i{onClick(){this.link().nativeElement.click()}constructor(){this.link=Xe.required("link")}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-report-link"]],viewQuery:function(n,s){n&1&&qe(s.link,In,5),n&2&&Ue()},hostBindings:function(n,s){n&1&&g("click",function(u){return s.onClick(u)})},decls:8,vars:5,consts:[["link",""],[1,"m-0"],[1,"btn","btn-link","p-0",3,"routerLink"],[1,"d-flex","align-items-center"],[1,"material-icons"]],template:function(n,s){n&1&&(c(0,"h5",1),m(1),a(2,"translate"),l(),c(3,"a",2,0)(5,"div",3)(6,"i",4),m(7,"keyboard_arrow_right"),l()()()),n&2&&(o(),f(" ",d(2,2,"my-absences.report.title"),`
`),o(2),b("routerLink",Q(4,Tn)))},dependencies:[he,D],styles:["[_nghost-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem;cursor:pointer}.btn[_ngcontent-%COMP%]{color:#000;text-decoration:none}"],changeDetection:0});let t=i;return t})();var Gt=()=>[];function kn(t,i){}function Mn(t,i){if(t&1&&m(0),t&2){_();let r=R(0);f(" (",r==null?null:r.checkableAbsences,") ")}}function Ln(t,i){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let r=_();b("absences$",r.myAbsencesService.checkableAbsences$)}}function $n(t,i){if(t&1&&m(0),t&2){_();let r=R(0);f(" (",r==null?null:r.openAbsences,") ")}}function Rn(t,i){if(t&1&&(S(0,"bkd-student-dossier-absences",16),a(1,"translate"),a(2,"async")),t&2){let r=_();b("absences$",r.myAbsencesService.openAbsences$)("selectionService",r.absencesSelectionService)("defaultAbsenceSelectionMessage",d(1,4,"my-absences.show.default-absence-selection-message"))("reports",d(2,6,r.openAbsencesReports$)??Q(8,Gt))}}function wn(t,i){if(t&1&&m(0),t&2){_();let r=R(0);f(" (",r==null?null:r.excusedAbsences,") ")}}function Dn(t,i){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let r=_();b("absences$",r.myAbsencesService.excusedAbsences$)}}function Pn(t,i){if(t&1&&m(0),t&2){_();let r=R(0);f(" (",r==null?null:r.unexcusedAbsences,") ")}}function Fn(t,i){if(t&1&&S(0,"bkd-student-dossier-absences",17),t&2){let r=_();b("absences$",r.myAbsencesService.unexcusedAbsences$)("displayPresenceType",!1)}}function En(t,i){if(t&1&&m(0),t&2){_();let r=R(0);f(" (",r==null?null:r.incidents,") ")}}function Bn(t,i){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let r=_();b("absences$",r.myAbsencesService.incidents$)}}var qt=(()=>{let i=class i{constructor(){this.reportsService=h(Lt),this.myAbsencesService=h(ae),this.absencesSelectionService=h(oe),this.openAbsencesReports$=this.loadOpenAbsencesReports(),this.allAbsencesReports$=this.loadAllAbsencesReports()}loadOpenAbsencesReports(){return x([this.absencesSelectionService.selectedWithoutPresenceType$,this.absencesSelectionService.selectedIds$]).pipe(M(([e,n])=>e.length===0&&n.length>0?this.getOpenAbsencesRecordIds(ie(Y(n.map(s=>s.lessonIds)))):V([])),M(e=>this.reportsService.getStudentConfirmationReports(e)),F(1))}loadAllAbsencesReports(){return x([this.myAbsencesService.openLessonAbsences$,this.myAbsencesService.checkableLessonAbsences$,this.myAbsencesService.excusedLessonAbsences$,this.myAbsencesService.unexcusedLessonAbsences$,this.myAbsencesService.incidentsLessonAbsences$]).pipe(y(e=>this.getAllAbsencesRecordIds(Y(e))),M(e=>this.reportsService.getMyAbsencesReports(e)),F(1))}getAllAbsencesRecordIds(e){return e.map(n=>`${n.LessonRef.Id}_${n.RegistrationId}`)}getOpenAbsencesRecordIds(e){return this.myAbsencesService.openLessonAbsences$.pipe(y(n=>n.filter(s=>e.includes(s.LessonRef.Id)).map(s=>`${s.LessonRef.Id}_${s.RegistrationId}`)))}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences-show"]],decls:70,vars:38,consts:[["checkableAbsences","ngbAccordionItem"],["openAbsences","ngbAccordionItem"],["excusedAbsences","ngbAccordionItem"],["unexcusedAbsences","ngbAccordionItem"],["incidents","ngbAccordionItem"],[1,"bkd-container","bkd-container-limited"],[1,"d-flex","justify-content-between","border-bottom","header"],[1,"ps-3"],[3,"reports"],["ngbAccordion",""],["ngbAccordionItem",""],["ngbAccordionHeader",""],["ngbAccordionCollapse",""],["ngbAccordionBody",""],[3,"click","opened"],[3,"absences$"],[3,"absences$","selectionService","defaultAbsenceSelectionMessage","reports"],[3,"absences$","displayPresenceType"]],template:function(n,s){if(n&1){let p=E();B(0),a(1,"async"),c(2,"div",5)(3,"h1"),m(4),a(5,"translate"),l(),c(6,"div",6)(7,"div"),m(8),a(9,"translate"),l(),c(10,"div",7),S(11,"bkd-reports-link",8),a(12,"async"),l()(),c(13,"div",9)(14,"div",10)(15,"div",11),S(16,"bkd-my-absences-report-link"),l(),c(17,"div",12)(18,"div",13),W(19,kn,0,0,"ng-template"),l()()(),c(20,"div",10,0)(22,"div",11)(23,"bkd-student-dossier-entry-header",14),g("click",function(){A(p);let k=L(21);return I(k.toggle())}),m(24),a(25,"translate"),C(26,Mn,1,1),l()(),c(27,"div",12)(28,"div",13),W(29,Ln,1,1,"ng-template"),l()()(),c(30,"div",10,1)(32,"div",11)(33,"bkd-student-dossier-entry-header",14),g("click",function(){A(p);let k=L(31);return I(k.toggle())}),m(34),a(35,"translate"),C(36,$n,1,1),l()(),c(37,"div",12)(38,"div",13),W(39,Rn,3,9,"ng-template"),l()()(),c(40,"div",10,2)(42,"div",11)(43,"bkd-student-dossier-entry-header",14),g("click",function(){A(p);let k=L(41);return I(k.toggle())}),m(44),a(45,"translate"),C(46,wn,1,1),l()(),c(47,"div",12)(48,"div",13),W(49,Dn,1,1,"ng-template"),l()()(),c(50,"div",10,3)(52,"div",11)(53,"bkd-student-dossier-entry-header",14),g("click",function(){A(p);let k=L(51);return I(k.toggle())}),m(54),a(55,"translate"),C(56,Pn,1,1),l()(),c(57,"div",12)(58,"div",13),W(59,Fn,1,2,"ng-template"),l()()(),c(60,"div",10,4)(62,"div",11)(63,"bkd-student-dossier-entry-header",14),g("click",function(){A(p);let k=L(61);return I(k.toggle())}),m(64),a(65,"translate"),C(66,En,1,1),l()(),c(67,"div",12)(68,"div",13),W(69,Bn,1,1,"ng-template"),l()()()()()}if(n&2){let p=L(21),u=L(31),k=L(41),U=L(51),Wt=L(61),N=z(d(1,18,s.myAbsencesService.counts$));o(4),$(d(5,21,"my-absences.title")),o(4),$(d(9,23,"my-absences.description")),o(3),b("reports",d(12,25,s.allAbsencesReports$)??Q(37,Gt)),o(12),b("opened",!p.collapsed),o(),f(" ",d(25,27,"shared.profile.checkable-absences")," "),o(2),v((N==null?null:N.checkableAbsences)!==null?26:-1),o(7),b("opened",!u.collapsed),o(),f(" ",d(35,29,"shared.profile.open-absences")," "),o(2),v((N==null?null:N.openAbsences)!==null?36:-1),o(7),b("opened",!k.collapsed),o(),f(" ",d(45,31,"shared.profile.excused-absences")," "),o(2),v((N==null?null:N.excusedAbsences)!==null?46:-1),o(7),b("opened",!U.collapsed),o(),f(" ",d(55,33,"shared.profile.unexcused-absences")," "),o(2),v((N==null?null:N.unexcusedAbsences)!==null?56:-1),o(7),b("opened",!Wt.collapsed),o(),f(" ",d(65,35,"shared.profile.incidents")," "),o(2),v((N==null?null:N.incidents)!==null?66:-1)}},dependencies:[Tt,ct,at,rt,jt,ot,st,Mt,kt,q,D],styles:[".header[_ngcontent-%COMP%]{padding-bottom:1rem}"],changeDetection:0});let t=i;return t})();var Ut=(()=>{let i=class i{constructor(){}};i.\u0275fac=function(n){return new(n||i)},i.\u0275cmp=T({type:i,selectors:[["bkd-my-absences"]],features:[ee([ae,oe])],decls:1,vars:0,template:function(n,s){n&1&&S(0,"router-outlet")},dependencies:[ye],encapsulation:2,changeDetection:0});let t=i;return t})();var yo=[{path:"",component:Ut,children:[{path:"",component:qt},{path:"confirm",component:Et},{path:"report",component:Ht,children:[{path:"",component:Vt,data:{restoreScrollPositionFrom:["/my-absences/report/confirm"]}},{path:"confirm",component:Bt}]}]}];export{yo as MY_ABSENCES_ROUTES};
