"use strict";(self.webpackChunkwebapp_schulverwaltung=self.webpackChunkwebapp_schulverwaltung||[]).push([[911],{9733:(j,b,n)=>{n.d(b,{k:()=>Q});var p=n(177),d=n(9417),S=n(5539),R=n(3955),y=n(4412),i=n(1413),v=n(4572),x=n(6354),g=n(4668),T=n(6697),O=n(6977),$=n(5964),f=n(5558),N=n(980),G=n(2809),M=n(5561),_=n(9728),I=n(8156),B=n(7887),P=n(1876),e=n(4438),A=n(5889),K=n(9366),W=n(8296),D=n(8413),X=n(9946);const k=(r,h,s)=>({formGroup:r,unexcusedState:h,excusedState:s}),U=r=>({count:r}),F=()=>["/edit-absences"];function m(r,h){if(1&r&&(e.j41(0,"div",4),e.EFF(1),e.nI1(2,"translate"),e.k0s()),2&r){const s=h.bkdLet;e.R7$(),e.SpI(" ",e.i5U(2,1,1===s?"open-absences.edit.lesson-selected":"open-absences.edit.lessons-selected",e.eq3(4,U,s))," ")}}function E(r,h){if(1&r&&(e.j41(0,"div",19),e.EFF(1),e.nI1(2,"translate"),e.k0s()),2&r){const s=h.$implicit;e.R7$(),e.SpI(" ",e.i5U(2,1,"global.validation-errors."+s.error,s.params)," ")}}function t(r,h){if(1&r&&(e.j41(0,"div",27),e.EFF(1),e.nI1(2,"translate"),e.k0s()),2&r){const s=h.$implicit;e.R7$(),e.SpI(" ",e.i5U(2,1,"global.validation-errors."+s.error,s.params)," ")}}function o(r,h){if(1&r&&(e.qex(0),e.DNE(1,t,3,4,"div",26),e.nI1(2,"async"),e.bVm()),2&r){const s=e.XpG(5);e.R7$(),e.Y8G("ngForOf",e.bMT(2,1,s.absenceTypeIdErrors$))}}function u(r,h){if(1&r&&(e.j41(0,"div",23),e.nrm(1,"input",24),e.nI1(2,"async"),e.j41(3,"label",25),e.EFF(4),e.k0s(),e.DNE(5,o,3,3,"ng-container",11),e.nI1(6,"async"),e.k0s()),2&r){let s,a;const l=h.$implicit,C=h.index,L=e.XpG(4);e.R7$(),e.AVh("is-invalid",(null!==(s=null==(s=e.bMT(2,7,L.absenceTypeIdErrors$))?null:s.length)&&void 0!==s?s:0)>0),e.Y8G("id","absence-type-"+C)("value",l.Id),e.R7$(2),e.Y8G("for","absence-type-"+C),e.R7$(),e.SpI(" ",l.Designation," "),e.R7$(),e.Y8G("ngIf",(null!==(a=null==(a=e.bMT(6,9,L.absenceTypes$))?null:a.length)&&void 0!==a?a:0)-1===C)}}function c(r,h){if(1&r&&(e.qex(0),e.DNE(1,u,7,11,"div",20),e.nI1(2,"async"),e.j41(3,"div",21),e.EFF(4),e.nI1(5,"translate"),e.j41(6,"a",22),e.EFF(7),e.nI1(8,"translate"),e.k0s()(),e.bVm()),2&r){const s=e.XpG(3);e.R7$(),e.Y8G("ngForOf",e.bMT(2,4,s.absenceTypes$)),e.R7$(3),e.SpI(" ",e.bMT(5,6,"open-absences.edit.remark")," "),e.R7$(2),e.Y8G("routerLink",e.lJ4(10,F)),e.R7$(),e.SpI(" ",e.bMT(8,8,"edit-absences.title")," ")}}function z(r,h){1&r&&(e.j41(0,"div",28)(1,"span",29),e.EFF(2,"Loading..."),e.k0s()())}function H(r,h){if(1&r){const s=e.RV6();e.j41(0,"form",5),e.bIt("ngSubmit",function(){e.eBV(s);const l=e.XpG(2);return e.Njj(l.onSubmit())}),e.DNE(1,E,3,4,"div",6),e.nI1(2,"async"),e.j41(3,"div",7)(4,"div",8),e.nrm(5,"input",9),e.j41(6,"label",10),e.EFF(7),e.k0s(),e.DNE(8,c,9,11,"ng-container",11),e.k0s(),e.j41(9,"div",12),e.nrm(10,"input",13),e.j41(11,"label",14),e.EFF(12),e.k0s()()(),e.j41(13,"div",15)(14,"button",16),e.nI1(15,"async"),e.bIt("click",function(){e.eBV(s);const l=e.XpG(2);return e.Njj(l.cancel())}),e.EFF(16),e.nI1(17,"translate"),e.k0s(),e.j41(18,"button",17),e.nI1(19,"async"),e.EFF(20),e.nI1(21,"translate"),e.DNE(22,z,3,0,"div",18),e.nI1(23,"async"),e.k0s()()()}if(2&r){const s=e.XpG().bkdLet,a=e.XpG();e.Y8G("formGroup",s.formGroup),e.R7$(),e.Y8G("ngForOf",e.bMT(2,12,a.formErrors$)),e.R7$(4),e.Y8G("value",s.excusedState.Key),e.R7$(2),e.SpI(" ",s.excusedState.Value," "),e.R7$(),e.Y8G("ngIf",s.formGroup.get("absenceTypeId")),e.R7$(2),e.Y8G("value",s.unexcusedState.Key),e.R7$(2),e.SpI(" ",s.unexcusedState.Value," "),e.R7$(2),e.Y8G("disabled",e.bMT(15,14,a.saving$)),e.R7$(2),e.SpI(" ",e.bMT(17,16,"open-absences.edit.cancel")," "),e.R7$(2),e.Y8G("disabled",e.bMT(19,18,a.saving$)),e.R7$(2),e.SpI(" ",e.bMT(21,20,"open-absences.edit.save")," "),e.R7$(2),e.Y8G("ngIf",e.bMT(23,22,a.saving$))}}function J(r,h){if(1&r&&(e.j41(0,"div",1)(1,"h1"),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.DNE(4,m,3,6,"div",2),e.nI1(5,"async"),e.DNE(6,H,24,24,"form",3),e.k0s()),2&r){const s=h.bkdLet,a=e.XpG();e.R7$(2),e.JRh(e.bMT(3,3,"open-absences.edit.title")),e.R7$(2),e.Y8G("bkdLet",e.bMT(5,5,a.getSelectedCount())),e.R7$(2),e.Y8G("ngIf",s.formGroup&&s.unexcusedState&&s.excusedState)}}let Q=(()=>{class r{constructor(s,a,l,C,L,Y,V,Z,w,q,ee){this.fb=s,this.router=a,this.activatedRoute=l,this.toastService=C,this.translate=L,this.selectionService=Y,this.dropDownItemsService=V,this.presenceTypesService=Z,this.updateService=w,this.settings=q,this.openAbsencesEditService=ee,this.formGroup$=this.selectionService.selectedWithoutPresenceType$.pipe((0,x.T)(this.createFormGroup.bind(this)),(0,g.t)(1)),this.saving$=new y.t(!1),this.submitted$=new y.t(!1),this.formErrors$=(0,I.v)(this.formGroup$,this.submitted$),this.absenceTypeIdErrors$=(0,I.v)(this.formGroup$,this.submitted$,"absenceTypeId"),this.confirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe((0,g.t)(1)),this.excusedState$=(0,M.c)(this.confirmationStates$,this.settings.excusedAbsenceStateId),this.unexcusedState$=(0,M.c)(this.confirmationStates$,this.settings.unexcusedAbsenceStateId),this.absenceTypes$=this.presenceTypesService.confirmationTypes$,this.destroy$=new i.B}ngOnInit(){this.selectionService.selectedIds$.pipe((0,T.s)(1)).subscribe(s=>{0===s.length&&this.navigateBack()}),(0,I.IK)(this.formGroup$,"confirmationValue").pipe((0,O.Q)(this.destroy$)).subscribe(s=>{"number"==typeof s&&this.updateAbsenceTypeIdDisabled(s)}),(0,v.z)([(0,I.Oi)(this.formGroup$,"confirmationValue").pipe((0,$.p)(_.TM)),(0,I.Oi)(this.formGroup$,"absenceTypeId").pipe((0,$.p)(_.TM)),this.saving$]).pipe((0,O.Q)(this.destroy$)).subscribe(([s,a,l])=>{l?(s.disable(),a.disable()):(s.enable(),this.updateAbsenceTypeIdDisabled(s.value))}),(0,v.z)([(0,I.Oi)(this.formGroup$,"confirmationValue").pipe((0,$.p)(_.TM)),this.excusedState$.pipe((0,T.s)(1),(0,$.p)(_.TM))]).pipe((0,O.Q)(this.destroy$)).subscribe(([s,a])=>s.setValue(a.Key))}ngOnDestroy(){this.destroy$.next()}onSubmit(){this.submitted$.next(!0),this.formGroup$.pipe((0,T.s)(1)).subscribe(s=>{if(s.valid){const{confirmationValue:a,absenceTypeId:l}=s.value;this.save(a,l)}})}cancel(){this.navigateBack()}getSelectedCount(){return this.selectionService.selectedLessons$.pipe((0,x.T)(s=>s.length))}createFormGroup(s){return this.fb.group(s.length>0?{confirmationValue:[null],absenceTypeId:[null,d.k0.required]}:{confirmationValue:[null]})}updateAbsenceTypeIdDisabled(s){(0,v.z)([(0,I.Oi)(this.formGroup$,"absenceTypeId").pipe((0,T.s)(1),(0,$.p)(_.TM)),this.excusedState$.pipe((0,T.s)(1),(0,$.p)(_.TM))]).subscribe(([a,l])=>{s===l.Key?a.enable():a.disable()})}save(s,a){this.saving$.next(!0),(0,v.z)([this.selectionService.selectedIds$.pipe((0,T.s)(1)),this.unexcusedState$.pipe((0,T.s)(1),(0,$.p)(_.TM))]).pipe((0,f.n)(([l,C])=>(0,v.z)(l.map(({lessonIds:L,personId:Y,presenceTypeId:V})=>this.updateService.confirmLessonPresences(L,[Y],this.getNewAbsenceTypeId(V,s,Number(C.Key),a),s)))),(0,N.j)(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}getNewAbsenceTypeId(s,a,l,C){if(!s)throw new Error("absence type id cannot be null");return a===l?this.settings.absencePresenceTypeId:s===this.settings.absencePresenceTypeId?C:s}onSaveSuccess(){this.openAbsencesEditService?.updateAfterConfirm&&this.openAbsencesEditService.updateAfterConfirm(),this.toastService.success(this.translate.instant("open-absences.edit.save-success")),this.navigateBack()}navigateBack(){this.router.navigate(this.openAbsencesEditService?.confirmBackLink||[".."],{relativeTo:this.activatedRoute,queryParams:this.openAbsencesEditService?.confirmBackLinkParams})}static#e=this.\u0275fac=function(a){return new(a||r)(e.rXU(d.ze),e.rXU(S.Ix),e.rXU(S.nX),e.rXU(A.f),e.rXU(R.c$),e.rXU(K.s),e.rXU(W.v),e.rXU(D._),e.rXU(X.T),e.rXU(G.yy),e.rXU(P.G,8))};static#t=this.\u0275cmp=e.VBU({type:r,selectors:[["bkd-confirm-absences"]],standalone:!0,features:[e.aNF],decls:4,vars:11,consts:[["class","bkd-container bkd-container-limited",4,"bkdLet"],[1,"bkd-container","bkd-container-limited"],["class","mb-3 pb-3 border-bottom",4,"bkdLet"],[3,"formGroup","ngSubmit",4,"ngIf"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],["class","alert alert-danger",4,"ngFor","ngForOf"],[1,"form-group","pb-4"],[1,"form-check","mt-2","mb-3","pb-3","border-bottom"],["type","radio","id","excused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","excused",1,"form-check-label"],[4,"ngIf"],[1,"form-check","mt-3","mb-3","pb-3","border-bottom"],["type","radio","id","unexcused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","unexcused",1,"form-check-label"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["class","spinner-border spinner-border-sm align-middle","role","status",4,"ngIf"],[1,"alert","alert-danger"],["class","form-check my-3",4,"ngFor","ngForOf"],[1,"remark"],[3,"routerLink"],[1,"form-check","my-3"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],["class","invalid-feedback",4,"ngFor","ngForOf"],[1,"invalid-feedback"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],[1,"visually-hidden"]],template:function(a,l){1&a&&(e.DNE(0,J,7,7,"div",0),e.nI1(1,"async"),e.nI1(2,"async"),e.nI1(3,"async")),2&a&&e.Y8G("bkdLet",e.sMw(7,k,e.bMT(1,1,l.formGroup$),e.bMT(2,3,l.unexcusedState$),e.bMT(3,5,l.excusedState$)))},dependencies:[B.N,p.bT,d.YN,d.qT,d.me,d.Fm,d.BC,d.cb,d.X1,d.j4,d.JD,p.pM,S.Wk,p.Jj,R.h,R.D9],changeDetection:0})}return r})()},9067:(j,b,n)=>{n.d(b,{g:()=>k});var p=n(1626),d=n(4903),S=n(5818),R=n(7165),y=n(906),i=n(5783),v=n(7673),x=n(7468),g=n(5558),T=n(6354),O=n(916),$=n(2809),f=n(5306);const N=i.NW({StudentRef:f.Or,StudentFullName:i.Yj,TotalAbsences:i.ai,TotalAbsencesUnconfirmed:i.ai,TotalAbsencesValidExcuse:i.ai,TotalAbsencesWithoutExcuse:i.ai,TotalAbsencesUnchecked:i.ai,TotalDispensations:i.ai,TotalHalfDays:i.ai,TotalIncidents:i.ai}),G=i.NW({Id:i.Yj,LessonRef:f.Or,StudentRef:f.Or,EventRef:f.Or,TypeRef:f.cO,RegistrationRef:f.cO,StudyClassRef:f.cO,ConfirmationStateId:(0,f.c$)(i.ai),EventDesignation:i.Yj,HasStudyCourseConfirmationCode:i.zM,LessonDateTimeFrom:f.iC,LessonDateTimeTo:f.iC,Comment:(0,f.c$)(i.Yj),Date:(0,f.c$)(f.DR),Type:(0,f.c$)(i.Yj),StudentFullName:i.Yj,StudyClassNumber:i.Yj,TeacherInformation:(0,f.c$)(i.Yj)}),M=i.NW({LessonRef:f.Or,EventRef:f.Or,EventDesignation:i.Yj,StudyClassNumber:i.Yj,TeacherInformation:(0,f.c$)(i.Yj),LessonDateTimeFrom:f.iC,LessonDateTimeTo:f.iC});var _=n(785),I=n(3382);function B(m){return E=>E.pipe((0,g.n)(t=>{const o=Number(t.headers.get("X-Pagination-Offset")),u=Number(t.headers.get("X-Pagination-Total"));return(0,_.k$)(m)(t.body).pipe((0,T.T)(c=>({offset:o,total:u,entries:c})))}))}function P(m,E,t=new p.Nl){return t.set("offset",String(m)).set("limit",String(E))}function e(m=new p.Lr){return m.set("X-Pagination-Total","on")}var A=n(4297),K=n(5437),W=n(6952),D=n(4438),X=n(4599);let k=(()=>{class m extends W.G{constructor(t,o,u){super(t,o,G,"LessonPresences"),this.storage=u,this.lessonPresenceRefCodec=i.NW((0,K.U)(this.codec.props,["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"])),this.lessonPresenceIdCodec=i.NW((0,K.U)(this.codec.props,["Id"]))}getLessonsByDate(t){const o={fields:Object.keys(M.props).join(","),"filter.LessonDateTimeFrom":`=${(0,d.GP)(t,"yyyy-MM-dd")}`,sort:"LessonDateTimeFrom"};return this.http.get(`${this.baseUrl}/`,{params:o,headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe((0,g.n)((0,_.k$)(M)))}getListByLessons(t){if(0===t.length)return(0,v.of)([]);const u={"filter.LessonRef":`;${t.map(c=>c.LessonRef.Id).join(";")}`};return this.getList({params:u,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListByDateStudentClass(t,o,u){const c={"filter.LessonDateTimeFrom":`=${(0,d.GP)(t,"yyyy-MM-dd")}`,"filter.StudentRef":`=${o}`};return null!=u&&(c["filter.StudyClassRef"]=`=${u}`),this.getList({params:c,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListForToday(){return this.http.get(`${this.baseUrl}/Today`,{headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe((0,g.n)((0,_.k$)(this.codec)))}getListOfUnconfirmed(t){return(0,A.h)(this.storage.getPayload()?.roles,"ClassTeacherRole")?(0,x.p)([this.getListOfUnconfirmedClassTeacher(t),this.getListOfUnconfirmedLessonTeacher(t)]).pipe((0,T.T)((0,I.i)(O.Ak))):(0,A.h)(this.storage.getPayload()?.roles,"LessonTeacherRole")?this.getListOfUnconfirmedLessonTeacher(t):(0,A.h)(this.storage.getPayload()?.roles,"AbsenceAdministratorRole")?this.getListOfUnconfirmedAbsenceAdministrator(t):(0,v.of)([])}getStatistics(t,o,u){let c=U([[t.student,"StudentRef"],[t.educationalEvent,"EventRef"],[t.studyClass,"StudyClassRef"]]);return c=function F(m,E=new p.Nl){return m?E.set("sort",`${m.key}.${m.ascending?"asc":"desc"}`):E}(o,c),c=P(u,this.settings.paginationLimit,c),this.http.get(`${this.baseUrl}/Statistics`,{params:c,headers:e(),observe:"response"}).pipe(B(N))}getLessonRefs(t){let o=U([[t.student,"StudentRef"],[t.educationalEvent,"EventRef"],[t.studyClass,"StudyClassRef"]]);return o=o.set("filter.TypeRef",">0"),o=o.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),o=o.set("limit","1500"),this.http.get(`${this.baseUrl}/`,{params:o}).pipe((0,g.n)((0,_.k$)(this.lessonPresenceRefCodec)))}getRegistrationRefsByEventIds(t){let o=new p.Nl;return o.set("filter.EventRef",`;${t.join(";")}`),o=o.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),this.http.get(`${this.baseUrl}/`,{params:o}).pipe((0,g.n)((0,_.k$)(this.lessonPresenceRefCodec)))}getFilteredList(t,o,u){let c=U([[t.student,"StudentRef"],[t.educationalEvent,"EventRef"],[t.studyClass,"StudyClassRef"]],new p.Nl({fromObject:u}));return t.teacher&&(c=c.set("filter.TeacherInformation",`~*${t.teacher}*`)),t.dateFrom&&t.dateTo&&(0,S.r)(t.dateFrom,t.dateTo)?c=c.set("filter.LessonDateTimeFrom",`=${(0,d.GP)(t.dateFrom,"yyyy-MM-dd")}`):(t.dateFrom&&(c=c.set("filter.LessonDateTimeFrom",`>${(0,d.GP)((0,R.e)(t.dateFrom,1),"yyyy-MM-dd")}`)),t.dateTo&&(c=c.set("filter.LessonDateTimeTo",`<${(0,d.GP)((0,y.f)(t.dateTo,1),"yyyy-MM-dd")}`))),t.confirmationStates&&(c=c.set("filter.ConfirmationStateId",`;${t.confirmationStates.join(";")}`)),t.incidentTypes&&(c=c.set("filter.TypeRef",`;${t.incidentTypes.join(";")}`)),t.presenceTypes&&(c=c.set("filter.TypeRef",`;${t.presenceTypes.join(";")}`)),t.incidentTypes&&t.presenceTypes&&(c=c.set("filter.TypeRef",`;${t.presenceTypes.join(";")};${t.incidentTypes.join(";")}`)),this.http.get(`${this.baseUrl}/`,{params:P(o,this.settings.paginationLimit,c),headers:e(),observe:"response"}).pipe(B(G))}hasLessonsLessonTeacher(){const t=(new p.Nl).set("fields","Id");return this.http.get(`${this.baseUrl}/`,{params:P(0,1,t),headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe((0,g.n)((0,_.k$)(this.lessonPresenceIdCodec)),(0,T.T)(o=>o.length>0))}checkableAbsencesCount(){return this.http.get(`${this.baseUrl}/`,{headers:{"X-Role-Restriction":"LessonTeacherRole"},params:{"filter.ConfirmationStateId":`;${this.settings.checkableAbsenceStateId}`,fields:"Id,ConfirmationStateId"}}).pipe((0,g.n)((0,_.k$)(this.lessonPresenceIdCodec)),(0,T.T)(t=>t.length))}getListOfUnconfirmedLessonTeacher(t){return this.getList({headers:{"X-Role-Restriction":"LessonTeacherRole"},params:{...t,"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=false"}})}getListOfUnconfirmedClassTeacher(t){return this.getList({headers:{"X-Role-Restriction":"ClassTeacherRole"},params:{...t,"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=true"}})}getListOfUnconfirmedAbsenceAdministrator(t){return this.getList({headers:{"X-Role-Restriction":"AbsenceAdministratorRole"},params:{...t,"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`}})}static#e=this.\u0275fac=function(o){return new(o||m)(D.KVO(p.Qq),D.KVO($.yy),D.KVO(X.n))};static#t=this.\u0275prov=D.jDH({token:m,factory:m.\u0275fac,providedIn:"root"})}return m})();function U(m,E=new p.Nl){return m.reduce((t,[o,u])=>o&&u?t.set(`filter.${u}`,`=${o}`):t,E)}},1876:(j,b,n)=>{n.d(b,{G:()=>d});const d=new(n(4438).nKC)("Confirm Absences Service")},5561:(j,b,n)=>{n.d(b,{c:()=>d,w:()=>S});var p=n(6354);function d(R,y){return R.pipe((0,p.T)(i=>i.find(v=>v.Key===y)||null))}function S(R){return R.slice().sort((y,i)=>y.Value.localeCompare(i.Value))}},5818:(j,b,n)=>{n.d(b,{r:()=>d});var p=n(3601);function d(R,y){return+(0,p.o)(R)==+(0,p.o)(y)}}}]);