import{a as Ft}from"./chunk-TAUZI65L.js";import{b as $t}from"./chunk-JQPDEPLD.js";import{a as wt,b as Pt}from"./chunk-IBCOIMBN.js";import{f as Fe,g as Ee}from"./chunk-T3RXR53P.js";import{c as Mt,d as Rt}from"./chunk-H7YIDIAV.js";import"./chunk-EZOKB4UX.js";import"./chunk-PEMYKIYW.js";import{a as Dt}from"./chunk-HTSSFHR3.js";import{B as me,C as ue,D as At,E as It,F as kt,G as Lt,b as de,f as Q,g as gt,j as De,m as he,n as je,x as vt,y as Ct,z as St}from"./chunk-O7RTLWUC.js";import{a as yt}from"./chunk-EYBOMBNL.js";import{b as Tt}from"./chunk-BEUB5I56.js";import{a as _t}from"./chunk-QENSBOG3.js";import{e as ht,p as _e}from"./chunk-PZTWULFF.js";import"./chunk-2QS7YZBA.js";import{a as V}from"./chunk-EM4LGRAI.js";import"./chunk-YHCR7GAG.js";import{i as xt}from"./chunk-GKIJ2K7S.js";import"./chunk-O456YFEK.js";import{c as at,d as ct,e as pt,f as lt,g as dt,h as mt,i as ut,l as ft}from"./chunk-BTSV5M6I.js";import{b as te,d as bt}from"./chunk-DQAQYQ7K.js";import{a as pe}from"./chunk-7UDVAURT.js";import{A as ee,N as ce,d as it,q as st,r as xe,s as re,t as Ae,y as ot,z}from"./chunk-C3LYZ6LV.js";import{$b as v,$d as Te,Ab as ve,Ac as oe,Ba as Ke,Cb as h,Ec as r,Fc as p,Ga as ze,Gc as P,H as q,Ib as b,Kb as ie,Mb as Ye,Md as He,Ob as C,Q as F,Qb as Ce,Rb as U,Sb as W,Tb as a,U as Ge,Ub as c,Vb as S,Yd as Ie,Z as qe,Zb as B,_ as E,_d as rt,a as Oe,aa as Ue,ac as _,ae as ke,ba as M,cd as Se,da as We,ee as Me,fd as K,gd as nt,ge as Re,ie as Le,j as ge,ja as ne,jb as s,jc as Xe,k as Ne,kc as Je,ke as $e,l as Ve,lc as R,mc as d,nc as L,ob as j,oc as f,pa as u,pc as X,q as H,rb as Qe,sc as Ze,se as ae,tc as et,te as we,uc as tt,ue as Pe,v as y,vc as O,w as x,wa as A,wb as T,wc as J,we as le,xa as I,xc as $,xe as D,yc as se,zc as Z}from"./chunk-6PRZEEKG.js";var fe=(()=>{class t{constructor(){this.settings=u(z),this.storageService=u(V),this.studentsService=u(Fe),this.studentId$=new Ve(1),this.lessonAbsences$=this.studentId$.pipe(M(this.loadLessonAbsences.bind(this)),E(1)),this.lessonIncidents$=this.studentId$.pipe(M(this.loadLessonIncidents.bind(this)),E(1)),this.lessonPresences$=this.getLessonPresences(),this.checkableAbsences$=this.getAbsences(this.settings.checkableAbsenceStateId),this.openAbsences$=this.getAbsences(this.settings.unconfirmedAbsenceStateId),this.excusedAbsences$=this.getAbsences(this.settings.excusedAbsenceStateId),this.unexcusedAbsences$=this.getAbsences(this.settings.unexcusedAbsenceStateId),this.incidents$=this.getAbsences(null),this.openLessonAbsences$=x([this.openAbsences$.pipe(q(te)),this.lessonAbsences$]).pipe(y(ue(this.getLessonAbsences.bind(this))),E(1)),this.checkableLessonAbsences$=x([this.checkableAbsences$.pipe(q(te)),this.lessonAbsences$]).pipe(y(ue(this.getLessonAbsences.bind(this))),E(1)),this.excusedLessonAbsences$=x([this.excusedAbsences$.pipe(q(te)),this.lessonAbsences$]).pipe(y(ue(this.getLessonAbsences.bind(this))),E(1)),this.unexcusedLessonAbsences$=x([this.unexcusedAbsences$.pipe(q(te)),this.lessonAbsences$]).pipe(y(ue(this.getLessonAbsences.bind(this))),E(1)),this.incidentsLessonAbsences$=x([this.incidents$.pipe(q(te)),this.lessonIncidents$]).pipe(y(ue(this.getLessonIncidents.bind(this))),E(1)),this.counts$=this.getCounts();let e=this.storageService.getPayload()?.id_person;e&&this.studentId$.next(Number(e))}reset(){this.studentId$.pipe(F(1)).subscribe(e=>this.studentId$.next(e))}getLessonPresences(){return this.getCached(x([this.studentId$,this.lessonAbsences$,this.lessonIncidents$]).pipe(M(([e,n,i])=>this.loadTimetableEntries(e,n,i).pipe(y(o=>this.buildLessonPresences(n,i,o)))),y(St)))}getAbsences(e){return this.getCached(this.lessonPresences$.pipe(y(n=>n?.filter(i=>i.ConfirmationStateId===e)||null)))}getLessonAbsences(e,n){let i=e.map(o=>o.LessonRef.Id);return n.filter(o=>i.includes(o.LessonRef.Id))}getLessonIncidents(e,n){let i=e.map(o=>o.LessonRef.Id);return n.filter(o=>i.includes(o.LessonRef.Id))}getCounts(){return x([this.getCount(this.checkableAbsences$),this.getCount(this.openAbsences$),this.getCount(this.excusedAbsences$),this.getCount(this.unexcusedAbsences$),this.getCount(this.incidents$)]).pipe(y(([e,n,i,o,l])=>({checkableAbsences:e,openAbsences:n,excusedAbsences:i,unexcusedAbsences:o,incidents:l,halfDays:null})))}getCached(e){return e.pipe(Ue(null),qe({connector:()=>new Ve(1)}))}getCount(e){return e.pipe(y(n=>n?.length??null))}loadLessonAbsences(e){return this.studentsService.getLessonAbsences(e)}loadLessonIncidents(e){return this.studentsService.getLessonIncidents(e)}loadTimetableEntries(e,n,i){return this.studentsService.getTimetableEntries(e,{"filter.Id":`;${[...n,...i].map(o=>o.LessonRef.Id).join(";")}`})}buildLessonPresences(e,n,i){return[...e,...n].map(o=>this.buildLessonPresence(o,i)).filter(te)}buildLessonPresence(e,n){let i=n.find(o=>o.Id===e.LessonRef.Id);return i?{Id:"",LessonRef:{Id:e.LessonRef.Id,HRef:e.LessonRef.HRef?e.LessonRef.HRef:null},StudentRef:e.StudentRef,EventRef:{Id:0,HRef:null},TypeRef:e.TypeRef,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:"ConfirmationStateId"in e?e.ConfirmationStateId:null,EventDesignation:i.EventDesignation,HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:i.From,LessonDateTimeTo:i.To,Comment:null,Date:i.From,Type:e.Type,StudentFullName:e.StudentFullName,StudyClassNumber:"",TeacherInformation:i.EventManagerInformation??null}:null}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275prov=ne({token:t,factory:t.\u0275fac})}}return t})();var Be=(()=>{class t{constructor(e,n,i,o,l,g,w,Y){this.fb=e,this.router=n,this.toastService=i,this.translate=o,this.presenceTypesService=l,this.updateService=g,this.storageService=w,this.settings=Y,this.formGroup=this.createFormGroup(),this.saving$=new Ne(!1),this.submitted$=new Ne(!1),this.absenceTypes$=x([this.getConfirmationTypes(),this.getHalfDayType()]).pipe(y(([G,k])=>k?[...G,k]:G)),this.absenceTypeIdErrors$=yt(H(this.formGroup),this.submitted$,"absenceTypeId"),this.destroy$=new ge}ngOnInit(){this.selectedLessonIds$.pipe(F(1),q(It)).subscribe(()=>this.navigateBack())}ngOnDestroy(){this.destroy$.next()}onSubmit(){if(this.submitted$.next(!0),this.formGroup.valid){let{absenceTypeId:e}=this.formGroup.value;this.save(e)}}cancel(){this.navigateBack()}getSelectedCount(){return this.selectedLessonIds$.pipe(y(e=>e.length))}getConfirmationTypes(){return this.presenceTypesService.confirmationTypes$.pipe(y(e=>e.filter(n=>n.IsAbsence&&n.Id!==this.settings.halfDayPresenceTypeId)))}getHalfDayType(){return H(null)}createFormGroup(){return this.fb.group({absenceTypeId:[null,rt.required]})}save(e){this.saving$.next(!0),this.selectedLessonIds$.pipe(F(1),M(n=>this.updateService.editLessonPresences(n,[Number(this.storageService.getPayload()?.id_person)],e)),Ge(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.toastService.success(this.translate.instant("my-absences.confirm.save-success")),this.navigateBack()}static{this.\u0275fac=function(n){return new(n||t)(j(ae),j(re),j(pe),j(le),j(Q),j(de),j(V),j(ot))}}static{this.\u0275cmp=T({type:t,selectors:[["ng-component"]],decls:0,vars:0,template:function(n,i){},encapsulation:2})}}return t})();var Kt=t=>({count:t}),zt=t=>({"border-top pt-3":t}),Qt=(t,m)=>m.Id;function Yt(t,m){if(t&1&&(a(0,"div",13),d(1),r(2,"translate"),c()),t&2){let e=m.$implicit;s(),f(" ",P(2,1,"global.validation-errors."+e.error,e.params)," ")}}function Xt(t,m){if(t&1&&(U(0,Yt,3,4,"div",13,Ce),r(2,"async")),t&2){let e=_(2);W(p(2,0,e.absenceTypeIdErrors$))}}function Jt(t,m){if(t&1&&(a(0,"div",5),S(1,"input",11),r(2,"async"),a(3,"label",12),d(4),c(),h(5,Xt,3,2),r(6,"async"),c()),t&2){let e,n,i=m.$implicit,o=m.$index,l=_();b("ngClass",oe(12,zt,i.IsHalfDay)),s(),ie("is-invalid",((e=(e=p(2,8,l.absenceTypeIdErrors$))==null?null:e.length)!==null&&e!==void 0?e:0)>0),b("id","absence-type-"+o)("value",i.Id),s(2),b("for","absence-type-"+o),s(),f(" ",i.Designation," "),s(),C(((n=(n=p(6,10,l.absenceTypes$))==null?null:n.length)!==null&&n!==void 0?n:0)-1===o?5:-1)}}function Zt(t,m){t&1&&(a(0,"div",10)(1,"span",14),d(2,"Loading..."),c()())}var Bt=(()=>{class t extends Be{constructor(){let e=u(ae),n=u(re),i=u(pe),o=u(le),l=u(Q),g=u(de),w=u(V),Y=u(z);super(e,n,i,o,l,g,w,Y),this.myAbsencesService=u(fe),this.selectionService=u(me),this.titleKey="my-absences.confirm.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(y(G=>ce(ee(G.map(k=>k.lessonIds))))),this.confirmationStateId=this.settings.unconfirmedAbsencesRefreshTime}onSaveSuccess(){this.selectionService.clear(),this.myAbsencesService.reset(),super.onSaveSuccess()}navigateBack(){this.router.navigate(["/my-absences"])}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-confirm"]],features:[ve],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,i){if(n&1){let o=B();a(0,"div",0)(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1),O(5),r(6,"async"),d(7),r(8,"translate"),c(),a(9,"form",2),v("ngSubmit",function(){return A(o),I(i.onSubmit())}),a(10,"div",3)(11,"label",4),d(12),r(13,"translate"),r(14,"addSpace"),c(),U(15,Jt,7,14,"div",5,Qt),r(17,"async"),c(),a(18,"div",6),d(19),r(20,"translate"),c(),a(21,"div",7)(22,"button",8),r(23,"async"),v("click",function(){return A(o),I(i.cancel())}),d(24),r(25,"translate"),c(),a(26,"button",9),r(27,"async"),d(28),r(29,"translate"),h(30,Zt,3,0,"div",10),r(31,"async"),c()()()()}if(n&2){s(2),L(p(3,11,i.titleKey));let o=p(6,13,i.getSelectedCount());s(5),f(" ",P(8,15,o===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",oe(37,Kt,o))," "),s(2),b("formGroup",i.formGroup),s(3),X("",p(13,18,"my-absences.confirm.choose-presence-type"),"",P(14,20,":",":"),""),s(3),W(p(17,23,i.absenceTypes$)),s(4),f(" ",p(20,25,"my-absences.confirm.remark")," "),s(3),b("disabled",p(23,27,i.saving$)),s(2),f(" ",p(25,29,"my-absences.confirm.cancel")," "),s(2),b("disabled",p(27,31,i.saving$)),s(2),f(" ",p(29,33,"my-absences.confirm.save")," "),s(2),C(p(31,35,i.saving$)?30:-1)}},dependencies:[we,Me,Ie,Re,Te,ke,Pe,Le,$e,Se,K,D,Ee],encapsulation:2,changeDetection:0})}}return t})();var be=(()=>{class t extends vt{constructor(){super(...arguments),this.selectedIds$=this.selection$.pipe(y(Ct))}static{this.\u0275fac=(()=>{let e;return function(i){return(e||(e=Ke(t)))(i||t)}})()}static{this.\u0275prov=ne({token:t,factory:t.\u0275fac})}}return t})();var ye=(()=>{class t extends Pt{get preventAbsencesAfterStart(){if(this._preventAbsencesAfterStart==null){let e=this.storageService.getPayload()?.instance_id,n=this.settings.preventStudentAbsenceAfterLessonStart;this._preventAbsencesAfterStart=e?n.includes(e):!1}return this._preventAbsencesAfterStart}constructor(){super("/my-absences/report"),this.studentsService=u(Fe),this.storageService=u(V)}getInitialFilter(){return{dateFrom:null,dateTo:null}}isValidFilter(e){return!!(e.dateFrom||e.dateTo)}loadEntries(e,n,i){let o=this.buildRequestParamsFromFilter(e).set("sort","From.asc");return this.loadingService.load(this.loadTimetableEntries(o).pipe(y(l=>this.filterAbsencesAfterLessonStart(l)),M(l=>x([H(l),this.loadLessonAbsences(l),this.loadLessonDispensations(l)])),y(([l,g,w])=>this.buildLessonPresences(l,g,w)),y(l=>({offset:0,total:l.length,entries:l}))),wt)}filterAbsencesAfterLessonStart(e){return this.preventAbsencesAfterStart?e.filter(n=>n.From.getTime()>=new Date().getTime()):e}buildParamsFromFilter(e){let{dateFrom:n,dateTo:i}=e,o={};return n&&(o.dateFrom=_e(n,"yyyy-MM-dd")),i&&(o.dateTo=_e(i,"yyyy-MM-dd")),o}buildRequestParamsFromFilter(e){let n=new it;return e.dateFrom&&(n=n.set("filter.From",`>${_e(gt(e.dateFrom,1),"yyyy-MM-dd")}`)),e.dateTo&&(n=n.set("filter.To",`<${_e(_t(e.dateTo,1),"yyyy-MM-dd")}`)),n}get studentId(){let e=this.storageService.getPayload()?.id_person;if(e==null)throw new Error("No student id available");return Number(e)}loadTimetableEntries(e){return this.studentsService.getTimetableEntries(this.studentId,e)}loadLessonAbsences(e){return e.length>0?this.studentsService.getLessonAbsences(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):H([])}loadLessonDispensations(e){return e.length>0?this.studentsService.getLessonDispensations(this.studentId,{"filter.Id":`;${e.map(n=>n.Id).join(";")}`}):H([])}buildLessonPresences(e,n,i){return e.map(o=>this.buildLessonPresence(o,n,i))}buildLessonPresence(e,n,i){let o=n.find(w=>w.LessonRef.Id===e.Id),l=i.find(w=>w.LessonRef.Id===e.Id),g=this.buildLessonPresenceTypeRef(o,l);return{Id:"",LessonRef:{Id:e.Id,HRef:null},StudentRef:(o||l)?.StudentRef||{Id:this.studentId,HRef:null},EventRef:{Id:0,HRef:null},TypeRef:g,RegistrationRef:{Id:0,HRef:null},StudyClassRef:{Id:0,HRef:null},ConfirmationStateId:o?.ConfirmationStateId||l&&this.settings.excusedAbsenceStateId||null,EventDesignation:e.EventDesignation||"",HasStudyCourseConfirmationCode:!1,LessonDateTimeFrom:e.From||new Date,LessonDateTimeTo:e.To||new Date,Comment:null,Date:e.From||new Date,Type:(o||l)?.Type||null,StudentFullName:(o||l)?.StudentFullName||"",StudyClassNumber:"",TeacherInformation:e.EventManagerInformation??null}}buildLessonPresenceTypeRef(e,n){return e?Oe({},e.TypeRef):n?Oe({},n.TypeRef):{Id:null,HRef:null}}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275prov=ne({token:t,factory:t.\u0275fac})}}return t})();var en=t=>({count:t}),tn=t=>({"border-top pt-3":t}),nn=(t,m)=>m.Id;function sn(t,m){if(t&1&&(a(0,"div",13),d(1),r(2,"translate"),c()),t&2){let e=m.$implicit;s(),f(" ",P(2,1,"global.validation-errors."+e.error,e.params)," ")}}function on(t,m){if(t&1&&(U(0,sn,3,4,"div",13,Ce),r(2,"async")),t&2){let e=_(2);W(p(2,0,e.absenceTypeIdErrors$))}}function rn(t,m){if(t&1&&(a(0,"div",5),S(1,"input",11),r(2,"async"),a(3,"label",12),d(4),c(),h(5,on,3,2),r(6,"async"),c()),t&2){let e,n,i=m.$implicit,o=m.$index,l=_();b("ngClass",oe(12,tn,i.IsHalfDay)),s(),ie("is-invalid",((e=(e=p(2,8,l.absenceTypeIdErrors$))==null?null:e.length)!==null&&e!==void 0?e:0)>0),b("id","absence-type-"+o)("value",i.Id),s(2),b("for","absence-type-"+o),s(),f(" ",i.Designation," "),s(),C(((n=(n=p(6,10,l.absenceTypes$))==null?null:n.length)!==null&&n!==void 0?n:0)-1===o?5:-1)}}function an(t,m){t&1&&(a(0,"div",10)(1,"span",14),d(2,"Loading..."),c()())}var Ot=(()=>{class t extends Be{constructor(){let e=u(ae),n=u(re),i=u(pe),o=u(le),l=u(Q),g=u(de),w=u(V),Y=u(z);super(e,n,i,o,l,g,w,Y),this.state=u(ye),this.selectionService=u(be),this.titleKey="my-absences.report.title",this.selectedLessonIds$=this.selectionService.selectedIds$.pipe(y(G=>ce(ee(G.map(k=>k.lessonIds))))),this.confirmationStateId=this.settings.checkableAbsenceStateId}getHalfDayType(){return this.presenceTypesService.getPresenceType(this.settings.halfDayPresenceTypeId).pipe(y(e=>e.Active?e:null))}onSaveSuccess(){this.selectionService.clear(),this.state.resetEntries(),super.onSaveSuccess()}navigateBack(){this.state.queryParams$.pipe(F(1)).subscribe(e=>{this.router.navigate(["/my-absences/report"],{queryParams:e})})}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-confirm"]],features:[ve],decls:32,vars:39,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"ngSubmit","formGroup"],[1,"form-group","mb-3","border-bottom"],[1,"form-label"],[1,"form-check","my-3",3,"ngClass"],[1,"remark"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback","mt-4"],[1,"visually-hidden"]],template:function(n,i){if(n&1){let o=B();a(0,"div",0)(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1),O(5),r(6,"async"),d(7),r(8,"translate"),c(),a(9,"form",2),v("ngSubmit",function(){return A(o),I(i.onSubmit())}),a(10,"div",3)(11,"label",4),d(12),r(13,"translate"),r(14,"addSpace"),c(),U(15,rn,7,14,"div",5,nn),r(17,"async"),c(),a(18,"div",6),d(19),r(20,"translate"),c(),a(21,"div",7)(22,"button",8),r(23,"async"),v("click",function(){return A(o),I(i.cancel())}),d(24),r(25,"translate"),c(),a(26,"button",9),r(27,"async"),d(28),r(29,"translate"),h(30,an,3,0,"div",10),r(31,"async"),c()()()()}if(n&2){s(2),L(p(3,11,i.titleKey));let o=p(6,13,i.getSelectedCount());s(5),f(" ",P(8,15,o===1?"my-absences.confirm.lesson-selected":"my-absences.confirm.lessons-selected",oe(37,en,o))," "),s(2),b("formGroup",i.formGroup),s(3),X("",p(13,18,"my-absences.confirm.choose-presence-type"),"",P(14,20,":",":"),""),s(3),W(p(17,23,i.absenceTypes$)),s(4),f(" ",p(20,25,"my-absences.confirm.remark")," "),s(3),b("disabled",p(23,27,i.saving$)),s(2),f(" ",p(25,29,"my-absences.confirm.cancel")," "),s(2),b("disabled",p(27,31,i.saving$)),s(2),f(" ",p(29,33,"my-absences.confirm.save")," "),s(2),C(p(31,35,i.saving$)?30:-1)}},dependencies:[we,Me,Ie,Re,Te,ke,Pe,Le,$e,Se,K,D,Ee],encapsulation:2,changeDetection:0})}}return t})();var cn=()=>["/my-absences"],Vt=(()=>{class t{constructor(){this.filter={dateFrom:null,dateTo:null},this.filterChange=new ze,this.minDate={year:new Date().getFullYear(),month:new Date().getMonth()+1,day:new Date().getDate()}}updateDateFrom(e){this.filter.dateFrom=e,e&&(this.filter.dateTo=e)}show(){this.filterChange.emit({dateFrom:Nt(this.filter.dateFrom),dateTo:Nt(this.filter.dateTo)})}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-report-header"]],inputs:{filter:"filter"},outputs:{filterChange:"filterChange"},features:[se([{provide:mt,useClass:ft},{provide:ut,useClass:$t}])],decls:19,vars:18,consts:[[3,"link"],[1,"filters"],[1,"form-group"],[1,"form-label"],[3,"valueChange","minDate","value"],[1,"buttons"],["type","button",1,"btn","btn-primary",3,"click"]],template:function(n,i){n&1&&(S(0,"bkd-backlink",0),a(1,"h1"),d(2),r(3,"translate"),c(),a(4,"div",1)(5,"div",2)(6,"label",3),d(7),r(8,"translate"),c(),a(9,"bkd-date-select",4),v("valueChange",function(l){return i.updateDateFrom(l)}),c()(),a(10,"div",2)(11,"label",3),d(12),r(13,"translate"),c(),a(14,"bkd-date-select",4),tt("valueChange",function(l){return et(i.filter.dateTo,l)||(i.filter.dateTo=l),l}),c()(),a(15,"div",5)(16,"button",6),v("click",function(){return i.show()}),d(17),r(18,"translate"),c()()()),n&2&&(b("link",Z(17,cn)),s(2),L(p(3,9,"my-absences.report.title")),s(5),L(p(8,11,"my-absences.report.header.date-from")),s(2),b("minDate",i.minDate)("value",i.filter.dateFrom),s(3),L(p(13,13,"my-absences.report.header.date-to")),s(2),b("minDate",i.minDate),Ze("value",i.filter.dateTo),s(3),f(" ",p(18,15,"my-absences.report.header.show")," "))},dependencies:[Lt,Ft,D],styles:["[_nghost-%COMP%]{display:block;padding-bottom:1rem;border-bottom:1px solid #dee2e6}.filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.form-group[_ngcontent-%COMP%]{flex:1;min-width:20rem;max-width:40rem;margin-right:1rem;margin-bottom:.5rem}.buttons[_ngcontent-%COMP%]{flex:none;margin-top:1.625rem;margin-right:0}@media (max-width: 575.98px){[_nghost-%COMP%]{padding-bottom:0}.buttons[_ngcontent-%COMP%]{width:100%;margin-top:1rem;margin-bottom:1rem}}"],changeDetection:0})}}return t})();function Nt(t){return t?ht(t):null}var pn=(t,m)=>m.Id;function ln(t,m){t&1&&S(0,"bkd-spinner")}function dn(t,m){if(t&1){let e=B();a(0,"div",8)(1,"input",9,2),r(3,"async"),v("change",function(){A(e);let i=_().$implicit,o=_(5);return I(o.selectionService.toggle(i))}),c()()}if(t&2){let e=_().$implicit,n=_(5);s(),b("checked",p(3,1,n.selectionService.isSelected$(e)))}}function mn(t,m){if(t&1&&(a(0,"div")(1,"i",13),d(2),c()()),t&2){_();let e=$(2);Ye("checkbox presence-category ",e.category,""),s(2),L(e.icon)}}function un(t,m){if(t&1&&d(0),t&2){let e=_().$implicit;f(" , ",e.StudyClassNumber," ")}}function fn(t,m){if(t&1&&(a(0,"div",20),d(1),c()),t&2){_();let e=$(15);s(),f(" ",e," ")}}function bn(t,m){if(t&1){let e=B();a(0,"div",15,1),v("click",function(i){A(e);let o=R(1),l=_(5);return I(l.onRowClick(i,o))}),O(2),r(3,"async"),h(4,dn,4,3,"div",8)(5,mn,3,4,"div",16),a(6,"div",17),d(7),h(8,un,1,1),c(),a(9,"div",18),d(10),r(11,"date"),r(12,"date"),c(),a(13,"div",19),d(14),c(),O(15),r(16,"async"),h(17,fn,2,1,"div",20),a(18,"div",21),d(19),r(20,"date"),c(),a(21,"div",22),d(22),r(23,"bkdDaysDifference"),c(),a(24,"div",23),d(25),r(26,"date"),r(27,"bkdDaysDifference"),c()()}if(t&2){let e=m.$implicit,n=_(5);s(2);let i=J(p(3,11,n.getPresenceCategory(e)));s(2),C(i?5:4),s(3),f(" ",e.EventDesignation," "),s(),C(e.StudyClassNumber?8:-1),s(2),X(" ",P(11,14,e.LessonDateTimeFrom,"HH:mm"),"\u2013",P(12,17,e.LessonDateTimeTo,"HH:mm")," "),s(4),f(" ",e.TeacherInformation," "),s();let o=J(p(16,20,n.getPresenceTypeDesignation(e)));s(2),C(o?17:-1),s(2),f(" ",P(20,23,e.LessonDateTimeFrom,"dd.MM.yyyy")," "),s(3),f(" ",p(23,26,e.LessonDateTimeFrom)," "),s(3),X(" ",P(26,28,e.LessonDateTimeFrom,"dd.MM.yyyy"),", ",p(27,31,e.LessonDateTimeFrom)," ")}}function yn(t,m){if(t&1){let e=B();a(0,"div")(1,"div",7,0),v("click",function(i){A(e);let o=R(2),l=_(4);return I(l.onRowClick(i,o))}),a(3,"div",8)(4,"input",9),r(5,"async"),v("change",function(i){A(e);let o=_(4);return I(o.toggleAll(i.target==null?null:i.target.checked))}),c()(),a(6,"div",10),d(7),r(8,"translate"),c(),a(9,"div",11)(10,"a",12),r(11,"async"),a(12,"i",13),d(13,"edit"),c()()()(),U(14,bn,28,33,"div",14,pn),c()}if(t&2){let e,n=_(4),i=$(0);s(4),b("checked",p(5,4,n.allSelected$)),s(3),f(" ",p(8,6,"my-absences.report.list.all")," "),s(3),ie("disabled",((e=p(11,8,n.selectionService.selection$))==null?null:e.length)===0),s(4),W(i)}}function _n(t,m){t&1&&S(0,"bkd-spinner",6)}function hn(t,m){if(t&1&&(a(0,"div",5),h(1,yn,16,10,"div")(2,_n,1,0,"bkd-spinner",6),c()),t&2){_(3);let e=$(0),n=$(2);s(),C(e&&e.length>0?1:-1),s(),C(n?2:-1)}}function gn(t,m){t&1&&(a(0,"p",4),d(1),r(2,"translate"),c()),t&2&&(s(),f(" ",p(2,1,"my-absences.report.no-entries")," "))}function vn(t,m){if(t&1&&h(0,hn,3,2,"div",5)(1,gn,3,3,"p",4),t&2){_(2);let e=$(0),n=$(2);C(e&&e.length>0||n?0:1)}}function Cn(t,m){if(t&1&&(h(0,ln,1,0,"bkd-spinner"),r(1,"async"),h(2,vn,2,1)),t&2){let e=_();C(p(1,1,e.state.loading$)?0:2)}}function Sn(t,m){t&1&&(a(0,"p",4),d(1),r(2,"translate"),c()),t&2&&(s(),L(p(2,1,"my-absences.report.no-filter")))}var Ht=(()=>{class t{constructor(){this.state=u(ye),this.selectionService=u(be),this.route=u(st),this.scrollPosition=u(Dt),this.presenceTypesService=u(Q),this.settings=u(z),this.filterFromParams$=this.route.queryParams.pipe(y(xn)),this.allSelected$=x([this.selectionService.selection$,this.state.entries$.pipe(M(e=>x(e.map(n=>this.getPresenceType(n)))))]).pipe(y(([e,n])=>e.length>0&&e.length===n.filter(bt(De)).length)),this.destroy$=new ge}ngOnInit(){this.filterFromParams$.pipe(F(1)).subscribe(e=>this.state.setFilter(e)),this.state.validFilter$.pipe(We(this.destroy$)).subscribe(()=>this.selectionService.clear())}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}getPresenceCategory(e){return this.getPresenceType(e).pipe(y(n=>De(n)?e.ConfirmationStateId===this.settings.checkableAbsenceStateId?{category:he.Unapproved,icon:je(he.Unapproved)}:{category:he.Absent,icon:je(he.Absent)}:null))}getPresenceTypeDesignation(e){return this.presenceTypesService.displayedTypes$.pipe(y(n=>e.TypeRef.Id&&n.find(i=>i.Id===e.TypeRef.Id)?.Designation||null))}toggleAll(e){x([this.state.entries$.pipe(F(1)),this.presenceTypesService.presenceTypes$.pipe(F(1))]).subscribe(([n,i])=>{let o=i.filter(l=>De(l)).map(l=>l.Id);this.selectionService.clear(e?n.filter(l=>l.TypeRef.Id==null||!o.includes(l.TypeRef.Id)):null)})}onRowClick(e,n){let i=n.querySelector('input[type="checkbox"]');i&&e.target!==i&&!e.target.closest(".buttons")&&i.click()}getPresenceType(e){return this.presenceTypesService.presenceTypes$.pipe(y(n=>e.TypeRef.Id&&n.find(i=>i.Id===e.TypeRef.Id)||null))}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-report-list"]],decls:9,vars:12,consts:[["all",""],["row",""],["checkbox",""],[3,"filterChange","filter"],[1,"mt-3"],[1,"py-3"],[1,"inline"],[1,"entries-all",3,"click"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"all"],[1,"buttons"],["routerLink","confirm",1,"edit","btn","btn-primary","btn-icon","me-2"],[1,"material-icons"],[1,"entry"],[1,"entry",3,"click"],[3,"class"],[1,"lesson-class"],[1,"time","pe-2"],[1,"teacher"],[1,"presence-type"],[1,"date"],[1,"days-ago"],[1,"date-days-ago"]],template:function(n,i){if(n&1){let o=B();O(0),r(1,"async"),O(2),r(3,"async"),a(4,"bkd-my-absences-report-header",3),r(5,"async"),v("filterChange",function(g){return A(o),I(i.state.setFilter(g))}),c(),h(6,Cn,3,3),r(7,"async"),h(8,Sn,3,3,"p",4)}n&2&&(J(p(1,2,i.state.entries$)),s(2),J(p(3,5,i.state.loadingPage$)),s(2),b("filter",p(5,8,i.filterFromParams$)),s(2),C(p(7,10,i.state.isFilterValid$)?6:8))},dependencies:[Vt,Ae,xt,K,nt,D,At],styles:['.entries-all[_ngcontent-%COMP%]{padding:0 0 .5rem 1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox all buttons";grid-template-columns:min-content 1fr min-content}.entry[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox lesson-class time teacher" "checkbox presence-type date days-ago";grid-template-columns:min-content 2fr 1fr 2fr}.entry[_ngcontent-%COMP%]:first-child{padding-top:0}.entries-all[_ngcontent-%COMP%] + .entry[_ngcontent-%COMP%]{padding-top:1rem}.presence-category.absent[_ngcontent-%COMP%]{color:#ea161f}.presence-category.unapproved[_ngcontent-%COMP%]{color:#ffa814}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.3rem 1rem 0 0}.presence-category[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{display:block;font-size:16px}.entries-all[_ngcontent-%COMP%]   .checkbox[_ngcontent-%COMP%]{padding-top:.2rem}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.all[_ngcontent-%COMP%]{grid-area:all}.buttons[_ngcontent-%COMP%]{grid-area:buttons;display:flex}.lesson-class[_ngcontent-%COMP%]{grid-area:lesson-class;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.time[_ngcontent-%COMP%]{grid-area:time}.teacher[_ngcontent-%COMP%]{grid-area:teacher}.presence-type[_ngcontent-%COMP%]{color:#adb5bd;grid-area:presence-type}.date[_ngcontent-%COMP%]{grid-area:date}.days-ago[_ngcontent-%COMP%]{color:#adb5bd;grid-area:days-ago}.date-days-ago[_ngcontent-%COMP%]{grid-area:date-days-ago;display:none}@media (max-width: 750px){.entry[_ngcontent-%COMP%]{grid-template-areas:"checkbox lesson-class" "checkbox teacher" "checkbox date-days-ago" "checkbox time" "checkbox presence-type";grid-template-columns:min-content 1fr}.date-days-ago[_ngcontent-%COMP%]{display:block}.date[_ngcontent-%COMP%], .days-ago[_ngcontent-%COMP%]{display:none}}'],changeDetection:0})}}return t})();function xn(t){return{dateFrom:t.dateFrom?He(t.dateFrom):null,dateTo:t.dateTo?He(t.dateTo):null}}var jt=(()=>{class t{constructor(){}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-report"]],features:[se([ye,be])],decls:1,vars:0,template:function(n,i){n&1&&S(0,"router-outlet")},dependencies:[xe],encapsulation:2,changeDetection:0})}}return t})();var An=["link"],In=()=>["/my-absences/report"],Gt=(()=>{class t{onClick(){this.link().nativeElement.click()}constructor(){this.link=Qe.required("link")}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-report-link"]],viewQuery:function(n,i){n&1&&Xe(i.link,An,5),n&2&&Je()},hostBindings:function(n,i){n&1&&v("click",function(l){return i.onClick(l)})},decls:8,vars:5,consts:[["link",""],[1,"m-0"],[1,"btn","btn-link","p-0",3,"routerLink"],[1,"d-flex","align-items-center"],[1,"material-icons"]],template:function(n,i){n&1&&(a(0,"h5",1),d(1),r(2,"translate"),c(),a(3,"a",2,0)(5,"div",3)(6,"i",4),d(7,"keyboard_arrow_right"),c()()()),n&2&&(s(),f(" ",p(2,2,"my-absences.report.title"),`
`),s(2),b("routerLink",Z(4,In)))},dependencies:[Ae,D],styles:["[_nghost-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem;cursor:pointer}.btn[_ngcontent-%COMP%]{color:#000;text-decoration:none}"],changeDetection:0})}}return t})();var qt=()=>[];function Tn(t,m){}function kn(t,m){if(t&1&&d(0),t&2){_();let e=$(0);f(" (",e==null?null:e.checkableAbsences,") ")}}function Mn(t,m){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let e=_();b("absences$",e.myAbsencesService.checkableAbsences$)}}function Rn(t,m){if(t&1&&d(0),t&2){_();let e=$(0);f(" (",e==null?null:e.openAbsences,") ")}}function Ln(t,m){if(t&1&&(S(0,"bkd-student-dossier-absences",16),r(1,"translate"),r(2,"async")),t&2){let e,n=_();b("absences$",n.myAbsencesService.openAbsences$)("selectionService",n.absencesSelectionService)("defaultAbsenceSelectionMessage",p(1,4,"my-absences.show.default-absence-selection-message"))("reports",(e=p(2,6,n.openAbsencesReports$))!==null&&e!==void 0?e:Z(8,qt))}}function $n(t,m){if(t&1&&d(0),t&2){_();let e=$(0);f(" (",e==null?null:e.excusedAbsences,") ")}}function wn(t,m){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let e=_();b("absences$",e.myAbsencesService.excusedAbsences$)}}function Pn(t,m){if(t&1&&d(0),t&2){_();let e=$(0);f(" (",e==null?null:e.unexcusedAbsences,") ")}}function Dn(t,m){if(t&1&&S(0,"bkd-student-dossier-absences",17),t&2){let e=_();b("absences$",e.myAbsencesService.unexcusedAbsences$)("displayPresenceType",!1)}}function Fn(t,m){if(t&1&&d(0),t&2){_();let e=$(0);f(" (",e==null?null:e.incidents,") ")}}function En(t,m){if(t&1&&S(0,"bkd-student-dossier-absences",15),t&2){let e=_();b("absences$",e.myAbsencesService.incidents$)}}var Ut=(()=>{class t{constructor(){this.reportsService=u(Rt),this.myAbsencesService=u(fe),this.absencesSelectionService=u(me),this.openAbsencesReports$=this.loadOpenAbsencesReports(),this.allAbsencesReports$=this.loadAllAbsencesReports()}loadOpenAbsencesReports(){return x([this.absencesSelectionService.selectedWithoutPresenceType$,this.absencesSelectionService.selectedIds$]).pipe(M(([e,n])=>e.length===0&&n.length>0?this.getOpenAbsencesRecordIds(ce(ee(n.map(i=>i.lessonIds)))):H([])),M(e=>this.reportsService.getStudentConfirmationReports(e)),E(1))}loadAllAbsencesReports(){return x([this.myAbsencesService.openLessonAbsences$,this.myAbsencesService.checkableLessonAbsences$,this.myAbsencesService.excusedLessonAbsences$,this.myAbsencesService.unexcusedLessonAbsences$,this.myAbsencesService.incidentsLessonAbsences$]).pipe(y(e=>this.getAllAbsencesRecordIds(ee(e))),M(e=>this.reportsService.getMyAbsencesReports(e)),E(1))}getAllAbsencesRecordIds(e){return e.map(n=>`${n.LessonRef.Id}_${n.RegistrationId}`)}getOpenAbsencesRecordIds(e){return this.myAbsencesService.openLessonAbsences$.pipe(y(n=>n.filter(i=>e.includes(i.LessonRef.Id)).map(i=>`${i.LessonRef.Id}_${i.RegistrationId}`)))}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences-show"]],decls:70,vars:38,consts:[["checkableAbsences","ngbAccordionItem"],["openAbsences","ngbAccordionItem"],["excusedAbsences","ngbAccordionItem"],["unexcusedAbsences","ngbAccordionItem"],["incidents","ngbAccordionItem"],[1,"bkd-container","bkd-container-limited"],[1,"d-flex","justify-content-between","border-bottom","header"],[1,"ps-3"],[3,"reports"],["ngbAccordion",""],["ngbAccordionItem",""],["ngbAccordionHeader",""],["ngbAccordionCollapse",""],["ngbAccordionBody",""],[3,"click","opened"],[3,"absences$"],[3,"absences$","selectionService","defaultAbsenceSelectionMessage","reports"],[3,"absences$","displayPresenceType"]],template:function(n,i){if(n&1){let o=B();O(0),r(1,"async"),a(2,"div",5)(3,"h1"),d(4),r(5,"translate"),c(),a(6,"div",6)(7,"div"),d(8),r(9,"translate"),c(),a(10,"div",7),S(11,"bkd-reports-link",8),r(12,"async"),c()(),a(13,"div",9)(14,"div",10)(15,"div",11),S(16,"bkd-my-absences-report-link"),c(),a(17,"div",12)(18,"div",13),h(19,Tn,0,0,"ng-template"),c()()(),a(20,"div",10,0)(22,"div",11)(23,"bkd-student-dossier-entry-header",14),v("click",function(){A(o);let g=R(21);return I(g.toggle())}),d(24),r(25,"translate"),h(26,kn,1,1),c()(),a(27,"div",12)(28,"div",13),h(29,Mn,1,1,"ng-template"),c()()(),a(30,"div",10,1)(32,"div",11)(33,"bkd-student-dossier-entry-header",14),v("click",function(){A(o);let g=R(31);return I(g.toggle())}),d(34),r(35,"translate"),h(36,Rn,1,1),c()(),a(37,"div",12)(38,"div",13),h(39,Ln,3,9,"ng-template"),c()()(),a(40,"div",10,2)(42,"div",11)(43,"bkd-student-dossier-entry-header",14),v("click",function(){A(o);let g=R(41);return I(g.toggle())}),d(44),r(45,"translate"),h(46,$n,1,1),c()(),a(47,"div",12)(48,"div",13),h(49,wn,1,1,"ng-template"),c()()(),a(50,"div",10,3)(52,"div",11)(53,"bkd-student-dossier-entry-header",14),v("click",function(){A(o);let g=R(51);return I(g.toggle())}),d(54),r(55,"translate"),h(56,Pn,1,1),c()(),a(57,"div",12)(58,"div",13),h(59,Dn,1,2,"ng-template"),c()()(),a(60,"div",10,4)(62,"div",11)(63,"bkd-student-dossier-entry-header",14),v("click",function(){A(o);let g=R(61);return I(g.toggle())}),d(64),r(65,"translate"),h(66,Fn,1,1),c()(),a(67,"div",12)(68,"div",13),h(69,En,1,1,"ng-template"),c()()()()()}if(n&2){let o,l=R(21),g=R(31),w=R(41),Y=R(51),G=R(61),k=J(p(1,18,i.myAbsencesService.counts$));s(4),L(p(5,21,"my-absences.title")),s(4),L(p(9,23,"my-absences.description")),s(3),b("reports",(o=p(12,25,i.allAbsencesReports$))!==null&&o!==void 0?o:Z(37,qt)),s(12),b("opened",!l.collapsed),s(),f(" ",p(25,27,"shared.profile.checkable-absences")," "),s(2),C((k==null?null:k.checkableAbsences)!==null?26:-1),s(7),b("opened",!g.collapsed),s(),f(" ",p(35,29,"shared.profile.open-absences")," "),s(2),C((k==null?null:k.openAbsences)!==null?36:-1),s(7),b("opened",!w.collapsed),s(),f(" ",p(45,31,"shared.profile.excused-absences")," "),s(2),C((k==null?null:k.excusedAbsences)!==null?46:-1),s(7),b("opened",!Y.collapsed),s(),f(" ",p(55,33,"shared.profile.unexcused-absences")," "),s(2),C((k==null?null:k.unexcusedAbsences)!==null?56:-1),s(7),b("opened",!G.collapsed),s(),f(" ",p(65,35,"shared.profile.incidents")," "),s(2),C((k==null?null:k.incidents)!==null?66:-1)}},dependencies:[Tt,dt,lt,pt,Gt,ct,at,Mt,kt,K,D],styles:[".header[_ngcontent-%COMP%]{padding-bottom:1rem}"],changeDetection:0})}}return t})();var Wt=(()=>{class t{constructor(){}static{this.\u0275fac=function(n){return new(n||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bkd-my-absences"]],features:[se([fe,me])],decls:1,vars:0,template:function(n,i){n&1&&S(0,"router-outlet")},dependencies:[xe],encapsulation:2,changeDetection:0})}}return t})();var Io=[{path:"",component:Wt,children:[{path:"",component:Ut},{path:"confirm",component:Bt},{path:"report",component:jt,children:[{path:"",component:Ht,data:{restoreScrollPositionFrom:["/my-absences/report/confirm"]}},{path:"confirm",component:Ot}]}]}];export{Io as MY_ABSENCES_ROUTES};
