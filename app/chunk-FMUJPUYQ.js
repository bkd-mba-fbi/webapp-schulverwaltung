import{a as ze}from"./chunk-SKUS47ZU.js";import{a as W}from"./chunk-Y4QYVF5K.js";import{D as st,b as Je,f as Ye,g as et,h as it,y as nt}from"./chunk-KQORGECX.js";import{a as ae,b as w,c as Ze,d as ot}from"./chunk-K42F6AEW.js";import{e as pe,o as I}from"./chunk-NC6UEGAF.js";import{h as tt}from"./chunk-SL67CYEF.js";import{a as Qe}from"./chunk-HQSONWXM.js";import{x as _}from"./chunk-RXRYDGZR.js";import{a as He}from"./chunk-F4XODHS2.js";import{$ as d,$a as G,Bc as Ee,Dc as Ae,Eb as P,Ec as De,Ed as Oe,F as T,Fb as X,Fd as Xe,Gb as F,Gd as Fe,Ia as ve,Ib as Le,J as be,Jb as $e,M as te,Mc as m,Nb as a,Nc as g,Ob as p,Oc as ke,P as f,Pa as k,Pb as H,R as j,Rd as Ke,Sa as C,Sc as S,Sd as qe,Ta as Ce,Ud as We,Wd as v,X as ge,Xa as B,Z as Se,Za as se,Zc as $,_a as M,a as V,ab as c,ad as h,b as U,bb as l,bd as K,cb as O,dd as D,ea as ie,ed as Be,f as he,fa as ne,fd as re,g as Z,gb as Re,gc as _e,hd as q,ib as oe,jb as x,kd as Pe,l as ee,lc as xe,mc as L,md as we,n as y,nd as Ne,o as A,od as Ve,qc as Ie,s as ye,sd as Ue,ud as je,vb as u,wb as Te,wd as Me,x as R,xb as b,xd as Ge,ya as r}from"./chunk-NEW5VGRB.js";function ce(i,o){return i.pipe(y(e=>e.find(t=>t.Key===o)||null))}function Rt(i){return i.slice().sort((o,e)=>o.Value.localeCompare(e.Value))}function rt(i,o,e){let[t,n]=tt(e?.in,i,o);return+pe(t)==+pe(n)}var at=new Se("Confirm Absences Service");var dt=(i,o)=>o.Id,mt=i=>({count:i}),lt=()=>["/edit-absences"];function ft(i,o){if(i&1&&(c(0,"div",4),u(1),a(2,"translate"),l()),i&2){let e=o.$implicit;r(),b(" ",H(2,1,"global.validation-errors."+e.error,e.params)," ")}}function ut(i,o){if(i&1&&(c(0,"div",21),u(1),a(2,"translate"),l()),i&2){let e=o.$implicit;r(),b(" ",H(2,1,"global.validation-errors."+e.error,e.params)," ")}}function ht(i,o){if(i&1&&(M(0,ut,3,4,"div",21,se),a(2,"async")),i&2){let e=x(4);G(p(2,0,e.absenceTypeIdErrors$))}}function yt(i,o){if(i&1&&(c(0,"div",16),O(1,"input",19),a(2,"async"),c(3,"label",20),u(4),l(),k(5,ht,3,2),a(6,"async"),l()),i&2){let e,t,n=o.$implicit,s=o.$index,E=x(3);r(),Ce("is-invalid",((e=(e=p(2,7,E.absenceTypeIdErrors$))==null?null:e.length)!==null&&e!==void 0?e:0)>0),C("id","absence-type-"+s)("value",n.Id),r(2),C("for","absence-type-"+s),r(),b(" ",n.Designation," "),r(),B(((t=(t=p(6,9,E.absenceTypes$))==null?null:t.length)!==null&&t!==void 0?t:0)-1===s?5:-1)}}function bt(i,o){if(i&1&&(M(0,yt,7,11,"div",16,dt),a(2,"async"),c(3,"div",17),u(4),a(5,"translate"),c(6,"a",18),u(7),a(8,"translate"),l()()),i&2){let e=x(2);G(p(2,3,e.absenceTypes$)),r(4),b(" ",p(5,5,"open-absences.edit.remark")," "),r(2),C("routerLink",Le(9,lt)),r(),b(" ",p(8,7,"edit-absences.title")," ")}}function gt(i,o){i&1&&(c(0,"div",15)(1,"span",22),u(2,"Loading..."),l()())}function St(i,o){if(i&1){let e=Re();c(0,"form",3),oe("ngSubmit",function(){ie(e);let n=x();return ne(n.onSubmit())}),M(1,ft,3,4,"div",4,se),a(3,"async"),c(4,"div",5)(5,"div",6),O(6,"input",7),c(7,"label",8),u(8),l(),k(9,bt,9,10),l(),c(10,"div",9),O(11,"input",10),c(12,"label",11),u(13),l()()(),c(14,"div",12)(15,"button",13),a(16,"async"),oe("click",function(){ie(e);let n=x();return ne(n.cancel())}),u(17),a(18,"translate"),l(),c(19,"button",14),a(20,"async"),u(21),a(22,"translate"),k(23,gt,3,0,"div",15),a(24,"async"),l()()()}if(i&2){let e=x(),t=F(0),n=F(2),s=F(4);C("formGroup",t),r(),G(p(3,11,e.formErrors$)),r(5),C("value",s.Key),r(2),b(" ",s.Value," "),r(),B(t.get("absenceTypeId")?9:-1),r(2),C("value",n.Key),r(2),b(" ",n.Value," "),r(2),C("disabled",p(16,13,e.saving$)),r(2),b(" ",p(18,15,"open-absences.edit.cancel")," "),r(2),C("disabled",p(20,17,e.saving$)),r(2),b(" ",p(22,19,"open-absences.edit.save")," "),r(2),B(p(24,21,e.saving$)?23:-1)}}var zt=(()=>{class i{constructor(){this.fb=d(Oe),this.router=d(Ae),this.activatedRoute=d(Ee),this.toastService=d(He),this.translate=d(Ke),this.selectionService=d(st),this.dropDownItemsService=d(ze),this.presenceTypesService=d(Ye),this.updateService=d(Je),this.settings=d(q),this.openAbsencesEditService=d(at,{optional:!0}),this.formGroup$=this.selectionService.selectedWithoutPresenceType$.pipe(y(this.createFormGroup.bind(this)),te(1)),this.saving$=new Z(!1),this.submitted$=new Z(!1),this.formErrors$=ae(this.formGroup$,this.submitted$),this.absenceTypeIdErrors$=ae(this.formGroup$,this.submitted$,"absenceTypeId"),this.confirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe(te(1)),this.excusedState$=ce(this.confirmationStates$,this.settings.excusedAbsenceStateId),this.unexcusedState$=ce(this.confirmationStates$,this.settings.unexcusedAbsenceStateId),this.absenceTypes$=this.presenceTypesService.confirmationTypes$,this.destroy$=new he}ngOnInit(){this.selectionService.selectedIds$.pipe(T(1)).subscribe(e=>{e.length===0&&this.navigateBack()}),Ze(this.formGroup$,"confirmationValue").pipe(j(this.destroy$)).subscribe(e=>{typeof e=="number"&&this.updateAbsenceTypeIdDisabled(e)}),A([w(this.formGroup$,"confirmationValue").pipe(R(_)),w(this.formGroup$,"absenceTypeId").pipe(R(_)),this.saving$]).pipe(j(this.destroy$)).subscribe(([e,t,n])=>{n?(e.disable(),t.disable()):(e.enable(),this.updateAbsenceTypeIdDisabled(e.value))}),A([w(this.formGroup$,"confirmationValue").pipe(R(_)),this.excusedState$.pipe(T(1),R(_))]).pipe(j(this.destroy$)).subscribe(([e,t])=>e.setValue(t.Key))}ngOnDestroy(){this.destroy$.next()}onSubmit(){this.submitted$.next(!0),this.formGroup$.pipe(T(1)).subscribe(e=>{if(e.valid){let{confirmationValue:t,absenceTypeId:n}=e.value;this.save(t,n)}})}cancel(){this.navigateBack()}getSelectedCount(){return this.selectionService.selectedLessons$.pipe(y(e=>e.length))}createFormGroup(e){return e.length>0?this.fb.group({confirmationValue:[null],absenceTypeId:[null,we.required]}):this.fb.group({confirmationValue:[null]})}updateAbsenceTypeIdDisabled(e){A([w(this.formGroup$,"absenceTypeId").pipe(T(1),R(_)),this.excusedState$.pipe(T(1),R(_))]).subscribe(([t,n])=>{e===n.Key?t.enable():t.disable()})}save(e,t){this.saving$.next(!0),A([this.selectionService.selectedIds$.pipe(T(1)),this.unexcusedState$.pipe(T(1),R(_))]).pipe(f(([n,s])=>A(n.map(({lessonIds:E,personId:Y,presenceTypeId:N})=>this.updateService.confirmLessonPresences(E,[Y],this.getNewAbsenceTypeId(N,e,Number(s.Key),t),e)))),be(()=>this.saving$.next(!1))).subscribe(this.onSaveSuccess.bind(this))}getNewAbsenceTypeId(e,t,n,s){if(!e)throw new Error("absence type id cannot be null");return t===n?this.settings.absencePresenceTypeId:e===this.settings.absencePresenceTypeId?s:e}onSaveSuccess(){this.openAbsencesEditService?.updateAfterConfirm&&this.openAbsencesEditService.updateAfterConfirm(),this.toastService.success(this.translate.instant("open-absences.edit.save-success")),this.navigateBack()}navigateBack(){this.router.navigate(this.openAbsencesEditService?.confirmBackLink||[".."],{relativeTo:this.activatedRoute,queryParams:this.openAbsencesEditService?.confirmBackLinkParams})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=ve({type:i,selectors:[["bkd-confirm-absences"]],decls:16,vars:21,consts:[[1,"bkd-container","bkd-container-limited"],[1,"mb-3","pb-3","border-bottom"],[3,"formGroup"],[3,"ngSubmit","formGroup"],[1,"alert","alert-danger"],[1,"form-group","pb-4"],[1,"form-check","mt-2","mb-3","pb-3","border-bottom"],["type","radio","id","excused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","excused",1,"form-check-label"],[1,"form-check","mt-3","mb-3","pb-3","border-bottom"],["type","radio","id","unexcused","formControlName","confirmationValue",1,"form-check-input",3,"value"],["for","unexcused",1,"form-check-label"],[1,"d-flex","justify-content-end"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],["type","submit",1,"btn","btn-primary","ms-2",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","align-middle"],[1,"form-check","my-3"],[1,"remark"],[3,"routerLink"],["type","radio","formControlName","absenceTypeId",1,"form-check-input",3,"id","value"],[1,"form-check-label",3,"for"],[1,"invalid-feedback"],[1,"visually-hidden"]],template:function(t,n){if(t&1&&(P(0),a(1,"async"),P(2),a(3,"async"),P(4),a(5,"async"),c(6,"div",0)(7,"h1"),u(8),a(9,"translate"),l(),c(10,"div",1),P(11),a(12,"async"),u(13),a(14,"translate"),l(),k(15,St,25,23,"form",2),l()),t&2){let s=X(p(1,3,n.formGroup$));r(2);let E=X(p(3,6,n.unexcusedState$));r(2);let Y=X(p(5,9,n.excusedState$));r(4),Te(p(9,12,"open-absences.edit.title"));let N=p(12,14,n.getSelectedCount());r(5),b(" ",H(14,16,N===1?"open-absences.edit.lesson-selected":"open-absences.edit.lessons-selected",$e(19,mt,N))," "),r(2),B(s&&E&&Y?15:-1)}},dependencies:[Xe,Ue,Pe,je,Ne,Ve,Fe,Me,Ge,De,_e,qe],encapsulation:2,changeDetection:0})}}return i})();var pt=S({StudentRef:h,StudentFullName:m,TotalAbsences:g,TotalAbsencesUnconfirmed:g,TotalAbsencesValidExcuse:g,TotalAbsencesWithoutExcuse:g,TotalAbsencesUnchecked:g,TotalDispensations:g,TotalHalfDays:g,TotalIncidents:g});var de=S({Id:m,LessonRef:h,StudentRef:h,EventRef:h,TypeRef:K,RegistrationRef:K,StudyClassRef:K,ConfirmationStateId:$(g),EventDesignation:m,HasStudyCourseConfirmationCode:ke,LessonDateTimeFrom:D,LessonDateTimeTo:D,Comment:$(m),Date:$(Be),Type:$(m),StudentFullName:m,StudyClassNumber:m,TeacherInformation:$(m)});var J=S({LessonRef:h,EventRef:h,StudyClassNumber:m,StudentRef:h});var me=S({LessonRef:h,EventRef:h,EventDesignation:m,StudyClassNumber:m,TeacherInformation:$(m),LessonDateTimeFrom:D,LessonDateTimeTo:D});function le(i){return o=>o.pipe(f(e=>{let t=Number(e.headers.get("X-Pagination-Offset")),n=Number(e.headers.get("X-Pagination-Total"));return v(i)(e.body).pipe(y(s=>({offset:t,total:n,entries:s})))}))}function Q(i,o,e=new L){return e.set("offset",String(i)).set("limit",String(o))}function fe(i=new xe){return i.set("X-Pagination-Total","on")}var Ii=(()=>{class i extends Qe{constructor(){let e=d(Ie),t=d(q);super(e,t,de,"LessonPresences"),this.storage=d(We),this.lessonPresenceRefCodec=S(re(this.codec.props,["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"])),this.lessonPresenceIdCodec=S(re(this.codec.props,["Id"]))}getLessonsByDate(e){let t={fields:Object.keys(me.props).join(","),"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,sort:"LessonDateTimeFrom"},n={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:n}).pipe(f(v(me)))}getLessonStudyClassesByDate(e){let t={fields:Object.keys(J.props).join(","),"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,sort:"LessonDateTimeFrom"},n={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:n}).pipe(f(v(J)))}getLessonStudyClassesByEvent(e){let t={"filter.EventRef":`=${e}`,sort:"LessonDateTimeFrom"},n={"X-Role-Restriction":"LessonTeacherRole"};return this.http.get(`${this.baseUrl}/`,{params:t,headers:n}).pipe(f(v(J)))}getListByLessons(e){if(e.length===0)return ee([]);let n={"filter.LessonRef":`;${e.map(s=>s.LessonRef.Id).join(";")}`};return this.getList({params:n,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListByDateStudentClass(e,t,n){let s={"filter.LessonDateTimeFrom":`=${I(e,"yyyy-MM-dd")}`,"filter.StudentRef":`=${t}`};return n!=null&&(s["filter.StudyClassRef"]=`=${n}`),this.getList({params:s,headers:{"X-Role-Restriction":"LessonTeacherRole"}})}getListForToday(){return this.http.get(`${this.baseUrl}/Today`,{headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe(f(v(this.codec)))}getListOfUnconfirmed(e){return W(this.storage.getPayload()?.roles,"ClassTeacherRole")?ye([this.getListOfUnconfirmedClassTeacher(e),this.getListOfUnconfirmedLessonTeacher(e)]).pipe(y(ot(nt))):W(this.storage.getPayload()?.roles,"LessonTeacherRole")?this.getListOfUnconfirmedLessonTeacher(e):W(this.storage.getPayload()?.roles,"AbsenceAdministratorRole")?this.getListOfUnconfirmedAbsenceAdministrator(e):ee([])}getStatistics(e,t,n){let s=ue([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]]);return s=vt(t,s),s=Q(n,this.settings.paginationLimit,s),this.http.get(`${this.baseUrl}/Statistics`,{params:s,headers:fe(),observe:"response"}).pipe(le(pt))}getLessonRefs(e){let t=ue([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]]);return t=t.set("filter.TypeRef",">0"),t=t.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),t=t.set("limit","1500"),this.http.get(`${this.baseUrl}/`,{params:t}).pipe(f(v(this.lessonPresenceRefCodec)))}getRegistrationRefsByEventIds(e){let t=new L;return t.set("filter.EventRef",`;${e.join(";")}`),t=t.set("fields",["LessonRef","RegistrationRef","StudentRef","EventRef","StudyClassRef","TypeRef"].join(",")),this.http.get(`${this.baseUrl}/`,{params:t}).pipe(f(v(this.lessonPresenceRefCodec)))}getFilteredList(e,t,n){let s=ue([[e.student,"StudentRef"],[e.educationalEvent,"EventRef"],[e.studyClass,"StudyClassRef"]],new L({fromObject:n}));return e.teacher&&(s=s.set("filter.TeacherInformation",`~*${e.teacher}*`)),e.dateFrom&&e.dateTo&&rt(e.dateFrom,e.dateTo)?s=s.set("filter.LessonDateTimeFrom",`=${I(e.dateFrom,"yyyy-MM-dd")}`):(e.dateFrom&&(s=s.set("filter.LessonDateTimeFrom",`>${I(it(e.dateFrom,1),"yyyy-MM-dd")}`)),e.dateTo&&(s=s.set("filter.LessonDateTimeTo",`<${I(et(e.dateTo,1),"yyyy-MM-dd")}`))),e.weekdays&&(s=s.set("filter.WeekdayId",`;${e.weekdays.join(";")}`)),e.confirmationStates&&(s=s.set("filter.ConfirmationStateId",`;${e.confirmationStates.join(";")}`)),e.incidentTypes&&(s=s.set("filter.TypeRef",`;${e.incidentTypes.join(";")}`)),e.presenceTypes&&(s=s.set("filter.TypeRef",`;${e.presenceTypes.join(";")}`)),e.incidentTypes&&e.presenceTypes&&(s=s.set("filter.TypeRef",`;${e.presenceTypes.join(";")};${e.incidentTypes.join(";")}`)),this.http.get(`${this.baseUrl}/`,{params:Q(t,this.settings.paginationLimit,s),headers:fe(),observe:"response"}).pipe(le(de))}hasLessonsLessonTeacher(){let e=new L().set("fields","Id");return this.http.get(`${this.baseUrl}/`,{params:Q(0,1,e),headers:{"X-Role-Restriction":"LessonTeacherRole"}}).pipe(f(v(this.lessonPresenceIdCodec)),y(t=>t.length>0))}checkableAbsencesCount(){return this.http.get(`${this.baseUrl}/`,{headers:{"X-Role-Restriction":"LessonTeacherRole"},params:{"filter.ConfirmationStateId":`;${this.settings.checkableAbsenceStateId}`,fields:"Id,ConfirmationStateId"}}).pipe(f(v(this.lessonPresenceIdCodec)),y(e=>e.length))}getListOfUnconfirmedLessonTeacher(e){return this.getList({headers:{"X-Role-Restriction":"LessonTeacherRole"},params:U(V({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=false"})})}getListOfUnconfirmedClassTeacher(e){return this.getList({headers:{"X-Role-Restriction":"ClassTeacherRole"},params:U(V({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`,"filter.HasStudyCourseConfirmationCode":"=true"})})}getListOfUnconfirmedAbsenceAdministrator(e){return this.getList({headers:{"X-Role-Restriction":"AbsenceAdministratorRole"},params:U(V({},e),{"filter.ConfirmationStateId":`=${this.settings.unconfirmedAbsenceStateId}`})})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=ge({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function ue(i,o=new L){return i.reduce((e,[t,n])=>t&&n?e.set(`filter.${n}`,`=${t}`):e,o)}function vt(i,o=new L){return i?o.set("sort",`${i.key}.${i.ascending?"asc":"desc"}`):o}export{Rt as a,rt as b,at as c,zt as d,Ii as e};
