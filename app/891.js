"use strict";(self.webpackChunkwebapp_schulverwaltung=self.webpackChunkwebapp_schulverwaltung||[]).push([[891],{7891:(Re,A,r)=>{r.r(A),r.d(A,{PRESENCE_CONTROL_ROUTES:()=>un});var F=r(6407),h=r(177),g=r(3955),O=r(4412),f=r(4572),E=r(7468),l=r(6354),P=r(6697),v=r(5558),z=r(2637),R=r(1517),S=r(7887),k=r(3382),N=r(7721),Z=r(8268),e=r(4438);let y=(()=>{class s extends Z.A{static#e=this.\u0275fac=(()=>{let t;return function(o){return(t||(t=e.xGo(s)))(o||s)}})();static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac})}return s})();function De(s,c){return[...s].sort(function p(s){return(c,t)=>{switch(s.primarySortKey){case"name":{const n=c.name.localeCompare(t.name);return s.ascending?-1*n:n}case"group":{const n=(c.detail.Value||"").localeCompare(t.detail.Value||"");return s.ascending?-1*n:n}}}}(c))}function _(s,c){return s.map(t=>function T(s,c){return{id:s.IdPerson,name:c.find(t=>t.StudentRef.Id===s.IdPerson)?.StudentFullName||"",group:s.Value,detail:s}}(t,c))}function ge(s,c){return s.find(t=>t.VssId===c.subscriptionDetailGroupId)}var C=r(9417),b=r(1324);function Fe(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",5)(1,"input",6),e.bIt("change",function(){const o=e.eBV(t).$implicit,i=e.XpG();return e.Njj(i.onSelectionChange(o))}),e.k0s(),e.j41(2,"label",7),e.EFF(3),e.k0s()()}if(2&s){const t=c.$implicit,n=c.index,o=e.XpG();e.R7$(),e.Mz_("id","group-",n,""),e.Y8G("checked",t.id===o.selected.id)("value",t.id),e.R7$(),e.Mz_("for","group-",n,""),e.R7$(),e.SpI(" ",t.label," ")}}var X=function(s){return s.Select="select",s.Assign="assign",s}(X||{});let je=(()=>{class s{constructor(t,n){this.activeModal=t,this.translate=n,this.groupOptions=[]}ngOnInit(){this.title=`presence-control.groups.${this.dialogMode}.title`;const t=this.createEmtpyOption();this.groupOptions=this.createGroupOptions(this.subscriptionDetailsDefinitions),this.groupOptions.unshift(t),this.selected=this.groupOptions.find(n=>n.id===this.group)||t}createEmtpyOption(){return{id:null,label:this.translate.instant(this.dialogMode===X.Select?"presence-control.groups.all":"presence-control.groups.none")}}createGroupOptions(t){return t.DropdownItems?t.DropdownItems.map(n=>({id:n.Key,label:`${this.translate.instant("presence-control.groups.group")} ${n.Value}`})):[]}getSelectedGroup(){return this.selected}onSelectionChange(t){this.selected=t}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(b.Lw),e.rXU(g.c$))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-group-dialog"]],inputs:{dialogMode:"dialogMode",subscriptionDetailsDefinitions:"subscriptionDetailsDefinitions",group:"group"},standalone:!0,features:[e.aNF],decls:13,vars:10,consts:[[1,"modal-body"],["class","form-check",4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],[1,"form-check"],["type","radio","name","groups",1,"form-check-input",3,"change","id","checked","value"],[1,"form-check-label",3,"for"]],template:function(n,o){1&n&&(e.j41(0,"div",0)(1,"p"),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.j41(4,"form"),e.DNE(5,Fe,4,7,"div",1),e.k0s()(),e.j41(6,"div",2)(7,"button",3),e.bIt("click",function(){return o.activeModal.dismiss()}),e.EFF(8),e.nI1(9,"translate"),e.k0s(),e.j41(10,"button",4),e.bIt("click",function(){return o.activeModal.close(o.getSelectedGroup())}),e.EFF(11),e.nI1(12,"translate"),e.k0s()()),2&n&&(e.R7$(2),e.SpI(" ",e.bMT(3,4,o.title)," "),e.R7$(3),e.Y8G("ngForOf",o.groupOptions),e.R7$(3),e.SpI(" ",e.bMT(9,6,"presence-control.groups.cancel")," "),e.R7$(3),e.SpI(" ",e.bMT(12,8,"presence-control.groups.save")," "))},dependencies:[C.YN,C.qT,C.cb,C.cV,h.pM,g.h,g.D9]})}return s})();var x=r(5539),xe=r(3601),Ge=r(4903),q=r(977),ee=r(3460),$=r(1413),G=r(7786),w=r(7673),we=r(1584),te=r(3294),M=r(4668),he=r(5245),D=r(6977),ne=r(5964),j=r(2809),Y=r(6914),se=r(172),Ue=r(2930),me=r(1037),oe=r(2055);function Ae(s){return{Id:s?s.Id:null,HRef:null}}var fe=r(7233);function ie(s){return c=>c.reduce((t,n)=>t+(n.presenceCategory===s?1:0),0)}var re=r(3515),_e=r(9067),be=r(6611),Xe=r(785),ve=r(6952),H=r(1626);let Ye=(()=>{class s extends ve.G{constructor(t,n){super(t,n,be.a,"LessonTeachers")}loadOtherTeachersLessonAbsences(t,n,o){let i=`${this.baseUrl}/except/${t}/LessonAbsences?expand=LessonRef`;return n&&n.length>0&&(i=i.concat("&filter.StudentRef=;"+n.join(";"))),this.http.get(i,{params:o}).pipe((0,v.n)((0,Xe.k$)(be.a)))}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(H.Qq),e.KVO(j.yy))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var ce=r(8413),Ce=r(5529),ae=r(2771),le=r(9172),He=r(5400),Ke=r(1015);let Pe=(()=>{class s extends ve.G{constructor(t,n){super(t,n,Ke.t,"SubscriptionDetails")}getListForEvent(t){return this.getList({params:{IdEvent:String(t)}})}update(t,n){return this.http.put(`${this.baseUrl}/${n.Id}`,{IdPerson:n.IdPerson,EventId:n.EventId,Value:t}).pipe((0,l.T)(()=>{}))}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(H.Qq),e.KVO(j.yy))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var K=r(2673);const ye="presence-control-group";let W=(()=>{class s{constructor(t,n,o,i,a){this.userSettings=t,this.eventService=n,this.subscriptionDetailsService=o,this.loadingService=i,this.settings=a,this.selectGroup$=new $.B,this.selectedLesson$=new ae.m,this.lessonPresences$=new ae.m,this.reloadSubscriptionDetails$=new $.B,this.defaultGroup=null,this.savedGroup$=this.selectedLesson$.pipe((0,v.n)(d=>this.userSettings.getPresenceControlGroupView().pipe((0,l.T)(m=>this.findGroupByLesson(m,d))))),this.group$=(0,G.h)(this.selectGroup$,this.savedGroup$).pipe((0,le.Z)(this.defaultGroup),(0,M.t)(1)),this.loading$=this.loadingService.loading(ye),this.subscriptionDetailsDefinitions$=this.selectedLesson$.pipe((0,l.T)(d=>d?.getEventIds()||[]),(0,v.n)(d=>(0,E.p)(d.map(m=>this.eventService.getSubscriptionDetailsDefinitions(m)))),(0,M.t)(1)),this.groupsAvailability$=this.subscriptionDetailsDefinitions$.pipe((0,l.T)(d=>d.every(m=>ge(m,this.settings))),(0,M.t)(1)),this.subscriptionDetails$=(0,f.z)([this.selectedLesson$,this.groupsAvailability$,this.reloadSubscriptionDetails$.pipe((0,l.T)(()=>!1),(0,le.Z)(!0))]).pipe((0,v.n)(([d,m,I])=>d&&m?this.loadSubscriptionDetailsForLesson(d,I):(0,w.of)([])),(0,l.T)(d=>function Le(s,c){return s.filter(t=>t.VssId===c.subscriptionDetailGroupId)}(d,this.settings)),(0,M.t)(1)),this.subscriptionDetailPersonIds$=(0,f.z)([this.group$,this.subscriptionDetails$]).pipe((0,l.T)(([d,m])=>m.filter(I=>I.Value===d).map(I=>I.IdPerson)),(0,le.Z)([]))}selectGroup(t){this.selectGroup$.next(t)}setSelectedLesson(t){this.selectedLesson$.next(t)}setLessonPresences(t){this.lessonPresences$.next(t)}getSubscriptionDetailsDefinitions(){return this.subscriptionDetailsDefinitions$.pipe((0,l.T)(Ce.A),(0,l.T)(t=>ge(t,this.settings)))}getSubscriptionDetailsForStudents(){return(0,f.z)([this.subscriptionDetails$,this.lessonPresences$]).pipe((0,l.T)((0,k.i)(_)))}reloadSubscriptionDetails(){this.reloadSubscriptionDetails$.next(void 0)}loadSubscriptionDetailsForLesson(t,n=!0){return this.loadingService.load((0,E.p)((0,ee.A)(t.getEventIds()).map(o=>this.subscriptionDetailsService.getListForEvent(o))),n?void 0:ye).pipe((0,l.T)(Ce.A))}findGroupByLesson(t,n){return t.find(i=>i.eventId===n?.getEventIds()[0])?.group||this.defaultGroup}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(re.A),e.KVO(He.z),e.KVO(Pe),e.KVO(K.U),e.KVO(j.yy))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac})}return s})();var We=r(8296),Je=r(4599);const ze=Object.values(Y.H_);let L=(()=>{class s{constructor(t,n,o,i,a,d,m,I,ue,V){this.userSettings=t,this.lessonPresencesService=n,this.lessonTeacherService=o,this.presenceTypesService=i,this.groupService=a,this.dropDownItemsService=d,this.loadingService=m,this.storageService=I,this.settings=ue,this.location=V,this.selectedDateSubject$=new O.t(new Date),this.selectedDate$=this.selectedDateSubject$.asObservable().pipe((0,l.T)(xe.o),(0,te.F)(q.A)),this.viewModeSubject$=new $.B,this.viewMode$=(0,G.h)(this.viewModeSubject$,this.userSettings.getPresenceControlViewMode().pipe((0,P.s)(1))),this.lessons$=this.selectedDate$.pipe((0,v.n)(u=>this.loadLessonsByDate(u)),(0,M.t)(1)),this.selectLessonId$=new $.B,this.selectLesson$=this.selectLessonId$.pipe((0,v.n)(u=>this.getLessonById(u))),this.selectedLesson$=(0,f.z)([(0,se.i7)(this.selectLesson$.pipe((0,te.F)((u,B)=>(0,q.A)(u,B))),(0,se.$m)(this.settings.lessonPresencesRefreshTime)),this.lessons$]).pipe((0,l.T)(([u,B])=>B.find(gn=>gn.id===u.id)?u:null),(0,M.t)(1)),this.studyClassCount$=this.selectedLesson$.pipe((0,l.T)(u=>u?.lessons.length||0)),this.updateLessonPresences$=new $.B,this.reloadLessonPresences$=new $.B,this.lessonPresences$=(0,G.h)((0,se.Qr)(this.selectedLesson$,this.reloadLessonPresences$).pipe((0,v.n)(u=>u?this.loadLessonPresencesByLesson(u):(0,w.of)([]))),this.updateLessonPresences$).pipe((0,M.t)(1)),this.presenceTypes$=this.loadPresenceTypes().pipe((0,M.t)(1)),this.reloadStudentIdsWithUnconfirmedAbsences$=new $.B,this.studentIdsWithUnconfirmedAbsences$=(0,G.h)(this.selectedDate$,this.selectedLesson$.pipe((0,he.i)(1)),this.reloadStudentIdsWithUnconfirmedAbsences$).pipe((0,v.n)(()=>this.loadStudentIdsWithUnconfirmedAbsences()),(0,M.t)(1)),this.loading$=this.loadingService.loading$,this.absenceConfirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe((0,M.t)(1)),this.studentIds$=this.lessonPresences$.pipe((0,l.T)(u=>(0,ee.A)(u.map(B=>B.StudentRef.Id))),(0,M.t)(1)),this.otherTeachersAbsences$=this.studentIds$.pipe((0,te.F)(q.A),(0,v.n)(u=>u.length>0?this.lessonTeacherService.loadOtherTeachersLessonAbsences(this.getMyself(),u):(0,w.of)([])),(0,M.t)(1)),this.groupsAvailability$=this.groupService.groupsAvailability$,this.presenceControlEntries$=(0,f.z)([this.selectedLesson$,this.lessonPresences$,this.presenceTypes$,this.absenceConfirmationStates$,this.otherTeachersAbsences$]).pipe((0,l.T)((0,k.i)(fe.aW))),this.presenceControlEntriesByGroup$=(0,f.z)([this.groupService.group$,this.presenceControlEntries$,this.groupService.subscriptionDetailPersonIds$]).pipe((0,l.T)((0,k.i)(Ue.r)),(0,M.t)(1)),this.presentCount$=this.presenceControlEntriesByGroup$.pipe((0,l.T)(ie("present"))),this.absentCount$=this.presenceControlEntriesByGroup$.pipe((0,l.T)(ie("absent"))),this.unapprovedCount$=this.presenceControlEntriesByGroup$.pipe((0,l.T)(ie("unapproved"))),this.absentPrecedingCount$=this.presenceControlEntriesByGroup$.pipe((0,l.T)(s=>s.reduce((c,t)=>c+(t.precedingAbsences&&t.precedingAbsences.length>0?1:0),0))),this.queryParamsString$=(0,f.z)([this.selectedDate$,this.selectedLesson$,this.viewMode$]).pipe((0,l.T)((0,k.i)(this.buildQueryParams.bind(this))),(0,l.T)(N.hD)),this.destroy$=new $.B,this.queryParamsString$.pipe((0,D.Q)(this.destroy$)).subscribe(u=>{this.location.replaceState("/presence-control",u),this.confirmBackLinkParams={returnparams:u}}),this.viewMode$.pipe((0,he.i)(1),(0,v.n)(u=>this.userSettings.savePresenceControlViewMode(u)),(0,D.Q)(this.destroy$)).subscribe(),this.selectedLesson$.pipe((0,D.Q)(this.destroy$)).subscribe(u=>{this.groupService.setSelectedLesson(u)}),this.lessonPresences$.pipe((0,D.Q)(this.destroy$)).subscribe(u=>this.groupService.setLessonPresences(u))}ngOnDestroy(){this.destroy$.next()}setDate(t){this.selectedDateSubject$.next(t)}setLessonId(t){this.selectLessonId$.next(t)}setViewMode(t){this.viewModeSubject$.next(t)}updateLessonPresencesTypes(t){(0,f.z)([this.lessonPresences$.pipe((0,P.s)(1)),this.presenceTypes$.pipe((0,P.s)(1))]).pipe((0,l.T)(([n,o])=>function Ve(s,c,t,n){return s.map(o=>{const i=c.find(a=>function Be(s,c){return s.LessonRef.Id===c.LessonRef.Id&&s.StudentRef.Id===c.StudentRef.Id}(a.presence,o));if(i){let a;return a=!i.newPresenceTypeId&&o.Comment?t.find(d=>d.IsComment)||null:t.find(d=>d.Id===i.newPresenceTypeId)||null,{...o,TypeRef:Ae(a),Date:null,Type:a?a.Designation:null,ConfirmationStateId:(0,oe.Eu)(a,n)}}return o})}(n,t,o,this.settings))).subscribe(n=>this.updateLessonPresences$.next(n))}getNextPresenceType(t){return this.presenceTypes$.pipe((0,P.s)(1),(0,l.T)(n=>t.getNextPresenceType(n)))}hasUnconfirmedAbsences(t){return this.studentIdsWithUnconfirmedAbsences$.pipe((0,l.T)(n=>n.includes(t.lessonPresence.StudentRef.Id)))}updateAfterConfirm(){this.reloadLessonPresences$.next(),this.reloadStudentIdsWithUnconfirmedAbsences$.next()}loadLessonPresencesByLesson(t){return this.loadingService.load(this.lessonPresencesService.getListByLessons(t.lessons))}loadLessonsByDate(t){return this.loadingService.load(this.lessonPresencesService.getLessonsByDate(t)).pipe((0,l.T)(me.XB))}loadPresenceTypes(){return this.loadingService.load(this.presenceTypesService.presenceTypes$)}loadStudentIdsWithUnconfirmedAbsences(){return(0,we.O)(0,this.settings.unconfirmedAbsencesRefreshTime||-1).pipe((0,v.n)(()=>this.lessonPresencesService.getListOfUnconfirmed()),(0,l.T)(t=>(0,ee.A)(t.map(n=>n.StudentRef.Id))))}buildQueryParams(t,n,o){const i={date:(0,Ge.GP)(t,"yyyy-MM-dd"),viewMode:o};return n&&(i.lesson=String(n.id)),i}getLessonById(t){const n=String(t);return this.lessons$.pipe((0,l.T)(o=>n&&o.find(i=>i.id===n)||(0,me.m2)(o)),(0,ne.p)(Boolean))}getMyself(){const t=this.storageService.getPayload();return Number(t?.holder_id||t?.id_person)}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(re.A),e.KVO(_e.g),e.KVO(Ye),e.KVO(ce._),e.KVO(W),e.KVO(We.v),e.KVO(K.U),e.KVO(Je.n),e.KVO(j.yy),e.KVO(h.aZ))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac})}return s})();var de=r(5889),pe=r(855);const Qe=(s,c,t,n)=>({sortCriteria:s,sortedEntries:c,selection:t,group:n}),Ze=()=>["/presence-control"];function qe(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",14),e.bIt("click",function(){const o=e.eBV(t).$implicit,i=e.XpG(2);return e.Njj(i.toggleSort(o))}),e.EFF(1),e.nI1(2,"translate"),e.j41(3,"span",15),e.EFF(4),e.k0s()()}if(2&s){const t=c.$implicit,n=e.XpG().bkdLet,o=e.XpG();e.Y8G("className",t),e.R7$(),e.SpI(" ",e.bMT(2,3,"presence-control.groups.list.header."+t)," "),e.R7$(3),e.JRh(o.getSortDirectionCharacter(n.sortCriteria,t))}}function et(s,c){1&s&&e.nrm(0,"bkd-spinner",23)}function tt(s,c){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"div",17)(2,"div",18)(3,"input",19,1),e.nI1(5,"async"),e.bIt("change",function(){const o=e.eBV(t).$implicit,i=e.XpG(3);return e.Njj(i.selectionService.toggle(o))}),e.k0s()(),e.j41(6,"div",20),e.EFF(7),e.k0s(),e.j41(8,"div",21)(9,"span"),e.EFF(10),e.k0s(),e.DNE(11,et,1,0,"bkd-spinner",22),e.nI1(12,"async"),e.k0s()(),e.bVm()}if(2&s){const t=c.$implicit,n=e.XpG(3);e.R7$(3),e.Y8G("checked",e.bMT(5,4,n.selectionService.isSelected$(t))),e.R7$(4),e.SpI(" ",t.name," "),e.R7$(3),e.JRh(t.group?t.group:""),e.R7$(),e.Y8G("ngIf",e.bMT(12,6,n.groupService.loading$))}}function nt(s,c){if(1&s&&(e.qex(0),e.DNE(1,tt,13,8,"ng-container",16),e.bVm()),2&s){const t=e.XpG().bkdLet;e.R7$(),e.Y8G("ngForOf",t.sortedEntries)}}function st(s,c){1&s&&e.nrm(0,"bkd-spinner")}function ot(s,c){if(1&s){const t=e.RV6();e.j41(0,"div"),e.nrm(1,"bkd-backlink",3),e.nI1(2,"async"),e.j41(3,"h1"),e.EFF(4),e.nI1(5,"translate"),e.k0s(),e.j41(6,"div",4)(7,"div",5)(8,"span",6),e.EFF(9),e.nI1(10,"translate"),e.k0s(),e.j41(11,"button",7),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.selectGroup())}),e.EFF(12),e.nI1(13,"translate"),e.nI1(14,"translate"),e.k0s()(),e.j41(15,"a",8),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.assignGroup())}),e.j41(16,"i",9),e.EFF(17,"edit"),e.k0s()()(),e.j41(18,"div",10)(19,"div",11),e.DNE(20,qe,5,5,"div",12),e.k0s(),e.DNE(21,nt,2,1,"ng-container",13),e.nI1(22,"async"),e.DNE(23,st,1,0,"ng-template",null,0,e.C5r),e.k0s()()}if(2&s){const t=c.bkdLet,n=e.sdS(24),o=e.XpG();e.R7$(),e.Y8G("link",e.lJ4(22,Ze))("params",e.bMT(2,10,o.backlinkQueryParams$)),e.R7$(3),e.JRh(e.bMT(5,12,"presence-control.groups.title")),e.R7$(5),e.JRh(e.bMT(10,14,"presence-control.groups.show")),e.R7$(3),e.SpI(" ",t.group?e.bMT(13,16,"presence-control.groups.group")+" "+t.group:e.bMT(14,18,"presence-control.groups.all")," "),e.R7$(3),e.AVh("disabled",0===t.selection.length),e.R7$(5),e.Y8G("ngForOf",o.primarySortKeys),e.R7$(),e.Y8G("ngIf",!1===e.bMT(22,20,o.state.loading$))("ngIfElse",n)}}let it=(()=>{class s{constructor(t,n,o,i,a,d,m,I,ue){this.route=t,this.state=n,this.selectionService=o,this.groupService=i,this.userSettings=a,this.subscriptionDetailService=d,this.toastService=m,this.translate=I,this.modalService=ue,this.primarySortKeys=["name","group"],this.backlinkQueryParams$=this.route.queryParams.pipe((0,l.T)(({returnparams:V})=>V),(0,l.T)(N.JO)),this.eventIds$=this.state.selectedLesson$.pipe((0,l.T)(V=>V?.getEventIds()||[])),this.sortCriteriaSubject$=new O.t({primarySortKey:"name",ascending:!1}),this.sortCriteria$=this.sortCriteriaSubject$.asObservable(),this.sortedEntries$=(0,f.z)([this.groupService.getSubscriptionDetailsForStudents(),this.sortCriteria$]).pipe((0,l.T)((0,k.i)(De))),this.selected=[]}ngOnInit(){this.selectionService.selection$.subscribe(t=>this.selected=t)}selectGroup(){this.openGroupModal(X.Select,this.selectCallback.bind(this))}assignGroup(){this.openGroupModal(X.Assign,this.assignCallback.bind(this))}openGroupModal(t,n){(0,f.z)([this.groupService.getSubscriptionDetailsDefinitions(),this.groupService.group$]).pipe((0,P.s)(1)).subscribe(([o,i])=>{const a=this.modalService.open(je);a.componentInstance.dialogMode=t,a.componentInstance.subscriptionDetailsDefinitions=o,a.componentInstance.group=i,a.result.then(d=>{n(d)},()=>{})})}selectCallback(t){(0,f.z)([this.eventIds$,this.userSettings.getPresenceControlGroupView()]).pipe((0,P.s)(1),(0,v.n)(([n,o])=>this.userSettings.savePresenceControlGroupView(function Q(s,c,t){const n=c.map(i=>({eventId:i,group:s})),o=t.map(i=>n.find(a=>a.eventId===i.eventId)||i);return[...new Set([...o,...n])].filter(i=>null!==i.group)}(t.id,n,o))),(0,l.T)(()=>t.id)).subscribe(n=>this.groupService.selectGroup(n))}assignCallback(t){(0,E.p)(this.selected.map(n=>this.subscriptionDetailService.update(t.id,n.detail))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.groupService.reloadSubscriptionDetails(),this.selectionService.clear(),this.toastService.success(this.translate.instant("presence-control.groups.notifications.save-success"))}getSortDirectionCharacter(t,n){return t.primarySortKey!==n?"":t.ascending?"\u2193":"\u2191"}toggleSort(t){this.sortCriteriaSubject$.pipe((0,P.s)(1)).subscribe(n=>{this.sortCriteriaSubject$.next(n.primarySortKey===t?{primarySortKey:t,ascending:!n.ascending}:{primarySortKey:t,ascending:"name"===t})})}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(x.nX),e.rXU(L),e.rXU(y),e.rXU(W),e.rXU(re.A),e.rXU(Pe),e.rXU(de.f),e.rXU(g.c$),e.rXU(pe.y))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-group"]],standalone:!0,features:[e.Jv_([y]),e.aNF],decls:5,vars:14,consts:[["loading",""],["checkbox",""],[4,"bkdLet"],[3,"link","params"],[1,"group-header","mb-2","d-flex","justify-content-between"],[1,"d-flex","align-items-baseline"],[1,"ps-3"],["type","button",1,"show","btn","btn-link",3,"click"],["aria-label","edit",1,"btn","btn-primary","btn-icon","me-2",3,"click"],[1,"material-icons"],[1,"group-list"],[1,"group-list-header"],[3,"className","click",4,"ngFor","ngForOf"],[4,"ngIf","ngIfElse"],[3,"click","className"],[1,"sort-direction"],[4,"ngFor","ngForOf"],[1,"group-list-entry"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"name","pe-2"],[1,"group","d-flex","justify-content-between"],["class","inline small",4,"ngIf"],[1,"inline","small"]],template:function(n,o){1&n&&(e.DNE(0,ot,25,23,"div",2),e.nI1(1,"async"),e.nI1(2,"async"),e.nI1(3,"async"),e.nI1(4,"async")),2&n&&e.Y8G("bkdLet",e.ziG(9,Qe,e.bMT(1,1,o.sortCriteria$),e.bMT(2,3,o.sortedEntries$),e.bMT(3,5,o.selectionService.selection$),e.bMT(4,7,o.groupService.group$)))},dependencies:[S.N,z.P,h.pM,h.bT,R.t,h.Jj,g.h,g.D9],styles:['[_nghost-%COMP%]{display:block}.group-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:#000;font-weight:300;text-decoration:underline;padding-left:.5rem}.group-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{text-decoration-color:#ea161f}.group-list-header[_ngcontent-%COMP%]{cursor:pointer;padding:1rem;display:grid;grid-template-areas:"name group";grid-template-columns:3fr 2fr;border-top:1px solid #dee2e6;border-bottom:2px solid #dee2e6}.group-list-entry[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox name group";grid-template-columns:min-content 3fr 2fr}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.3rem 1rem 0 0}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.name[_ngcontent-%COMP%]{grid-area:name;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.group[_ngcontent-%COMP%]{grid-area:group}@media (max-width: 750px){.group-list[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.group-list-header[_ngcontent-%COMP%]{grid-template-columns:3fr 1fr}.group-list-entry[_ngcontent-%COMP%]{grid-template-columns:min-content 3fr 1fr}}'],changeDetection:0})}return s})();var rt=r(6834),ct=r(8358),Me=r(4273);function lt(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",3)(1,"input",4),e.bIt("change",function(){const o=e.eBV(t).$implicit;return e.Njj(o.selected=!o.selected)}),e.k0s(),e.j41(2,"label",5)(3,"i"),e.EFF(4),e.k0s(),e.j41(5,"div",6),e.EFF(6),e.nI1(7,"date"),e.nI1(8,"date"),e.k0s()()()}if(2&s){const t=c.$implicit,n=c.index,o=e.XpG();e.R7$(),e.Mz_("id","lesson-presence-",n,""),e.Y8G("checked",t.selected),e.R7$(),e.AVh("fw-bold",o.isCurrentLesson(t)),e.Mz_("for","lesson-presence-",n,""),e.R7$(),e.ZvI("",t.entry.presenceCategory," material-icons pe-2"),e.R7$(),e.JRh(t.entry.presenceCategoryIcon),e.R7$(2),e.E5c(" ",e.i5U(7,14,t.entry.lessonPresence.LessonDateTimeFrom,"HH:mm"),"\u2013",e.i5U(8,17,t.entry.lessonPresence.LessonDateTimeTo,"HH:mm")," ",t.entry.lessonPresence.EventDesignation," ")}}function dt(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",7)(1,"button",8),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.activeModal.close())}),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.j41(4,"button",9),e.bIt("click",function(){const o=e.eBV(t).bkdLet,i=e.XpG();return e.Njj(i.activeModal.close(o))}),e.EFF(5),e.nI1(6,"translate"),e.k0s()()}if(2&s){const t=c.bkdLet;e.R7$(2),e.SpI(" ",e.bMT(3,3,"presence-control.block-lesson.cancel")," "),e.R7$(2),e.Y8G("disabled",0===t.length),e.R7$(),e.SpI(" ",e.bMT(6,5,"presence-control.block-lesson.save")," ")}}let pt=(()=>{class s{constructor(t){this.activeModal=t,this.blockLessonOptions=[]}ngOnInit(){this.blockLessonOptions=this.buildLessonPresenceOptions()}getSelectedEntries(){return this.blockLessonOptions.filter(({selected:t})=>t).map(({entry:t})=>t)}isCurrentLesson(t){return function at(s,c){return+(0,Me.a)(s)==+(0,Me.a)(c)}(t.entry.lessonPresence.LessonDateTimeFrom,this.entry.lessonPresence.LessonDateTimeFrom)}buildLessonPresenceOptions(){return this.blockPresenceControlEntries.map(t=>({entry:t,selected:this.entry.confirmationState===t.confirmationState}))}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(b.Lw))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-block-lesson-component"]],inputs:{entry:"entry",blockPresenceControlEntries:"blockPresenceControlEntries"},standalone:!0,features:[e.aNF],decls:7,vars:5,consts:[[1,"modal-body"],["class","form-check",4,"ngFor","ngForOf"],["class","modal-footer",4,"bkdLet"],[1,"form-check"],["type","checkbox",1,"form-check-input",3,"change","id","checked"],[1,"form-check-label","d-flex",3,"for"],[1,"d-block","text-truncate"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click","disabled"]],template:function(n,o){1&n&&(e.j41(0,"div",0)(1,"p"),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.j41(4,"form"),e.DNE(5,lt,9,20,"div",1),e.k0s()(),e.DNE(6,dt,7,7,"div",2)),2&n&&(e.R7$(2),e.SpI(" ",e.bMT(3,3,"presence-control.block-lesson.text")," "),e.R7$(3),e.Y8G("ngForOf",o.blockLessonOptions),e.R7$(),e.Y8G("bkdLet",o.getSelectedEntries()))},dependencies:[C.YN,C.qT,C.cb,C.cV,h.pM,S.N,h.vh,g.h,g.D9],styles:[".checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.absent[_ngcontent-%COMP%]{color:#ea161f}.present[_ngcontent-%COMP%]{color:#3d8608}.unapproved[_ngcontent-%COMP%]{color:#ffa814}"]})}return s})();var ut=r(1433);function $e(s){return`blockLesson${s.lessonPresence.Id}`}let Ie=(()=>{class s{constructor(t,n,o,i){this.state=t,this.lessonPresencesService=n,this.loadingService=o,this.settings=i}getBlockLessonPresenceControlEntries(t){return(0,f.z)([this.state.lessons$.pipe((0,P.s)(1)),this.loadChangeableLessonPresences(t),this.state.presenceTypes$.pipe((0,P.s)(1)),this.state.absenceConfirmationStates$.pipe((0,P.s)(1)),this.state.otherTeachersAbsences$.pipe((0,P.s)(1))]).pipe((0,l.T)(([n,o,i,a,d])=>this.filterBlockLessonPresences(t,o).map(m=>(0,fe.FO)(n.find(I=>I.id===m.LessonRef.Id.toString()),m,i,a,d))))}filterBlockLessonPresences(t,n){return[...n].sort((o,i)=>o.LessonDateTimeFrom>i.LessonDateTimeFrom?1:-1).reduce((o,i)=>this.isWithinBlockTime(i,o[o.length-1])?(o.push(i),o):o.find(d=>d.Id===t.lessonPresence.Id)?o:[i],[])}isWithinBlockTime(t,n){return!n||t.LessonDateTimeFrom.getTime()-n.LessonDateTimeTo.getTime()<=18e5}loadChangeableLessonPresences(t){return(0,f.z)([this.loadLessonPresences(t),this.state.presenceTypes$.pipe((0,P.s)(1))]).pipe((0,l.T)(([n,o])=>n.filter(i=>(0,oe.ED)(i,o.find(a=>a.Id===i.TypeRef.Id)||null,this.settings))))}loadLessonPresences(t){return this.loadingService.load(this.lessonPresencesService.getListByDateStudentClass(t.lessonPresence.LessonDateTimeFrom,t.lessonPresence.StudentRef.Id,t.lessonPresence.StudyClassRef.Id??void 0).pipe((0,l.T)(n=>n.filter(o=>o.TeacherInformation===t.lessonPresence.TeacherInformation))),$e(t))}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(L),e.KVO(_e.g),e.KVO(K.U),e.KVO(j.yy))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac})}return s})();var ht=r(8676);function mt(s,c){if(1&s&&(e.j41(0,"div"),e.EFF(1),e.nI1(2,"date"),e.nI1(3,"date"),e.nI1(4,"addSpace"),e.k0s()),2&s){const t=c.$implicit;e.R7$(),e.SjE(" ",e.i5U(2,5,t.LessonRef.From,"HH:mm"),"\u2013",e.i5U(3,8,t.LessonRef.To,"HH:mm")," ",t.LessonRef.EventDesignation,"",e.i5U(4,11,":",":")," ",t.Type," ")}}let ft=(()=>{class s{constructor(t){this.activeModal=t}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(b.Lw))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-preceding-absence"]],inputs:{precedingAbsences:"precedingAbsences"},standalone:!0,features:[e.aNF],decls:9,vars:7,consts:[[1,"modal-body"],[4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"]],template:function(n,o){1&n&&(e.j41(0,"div",0)(1,"p"),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.DNE(4,mt,5,14,"div",1),e.k0s(),e.j41(5,"div",2)(6,"button",3),e.bIt("click",function(){return o.activeModal.dismiss()}),e.EFF(7),e.nI1(8,"translate"),e.k0s()()),2&n&&(e.R7$(2),e.SpI(" ",e.bMT(3,3,"presence-control.preceding-absence.text")," "),e.R7$(2),e.Y8G("ngForOf",o.precedingAbsences),e.R7$(3),e.SpI(" ",e.bMT(8,5,"presence-control.preceding-absence.cancel")," "))},dependencies:[h.pM,h.vh,g.h,g.D9,ht.c]})}return s})();const _t=s=>["student",s,"absences"],bt=s=>["/presence-control/student",s,"absences"];function vt(s,c){if(1&s&&(e.nrm(0,"bkd-avatar",9),e.nI1(1,"async")),2&s){const t=e.XpG();e.Y8G("studentId",e.bMT(1,3,t.studentId$))("link",e.eq3(5,bt,t.entry.lessonPresence.StudentRef.Id.toString()))("linkParams",t.profileReturnParams)}}function Ct(s,c){if(1&s&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&s){const t=e.XpG(2);e.R7$(),e.JRh(null==t.entry.presenceType?null:t.entry.presenceType.Designation)}}function Pt(s,c){if(1&s){const t=e.RV6();e.j41(0,"button",10),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.updatePresenceType(o.entry))}),e.DNE(1,Ct,2,1,"span",11),e.k0s()}if(2&s){const t=e.XpG();e.R7$(),e.Y8G("ngIf",!(null!=t.entry.presenceType&&t.entry.presenceType.IsIncident))}}function yt(s,c){1&s&&e.nrm(0,"bkd-spinner",16)}function Mt(s,c){if(1&s){const t=e.RV6();e.j41(0,"button",12),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.updatePresenceType(o.entry))}),e.j41(1,"div",13)(2,"i",14),e.EFF(3),e.k0s(),e.DNE(4,yt,1,0,"bkd-spinner",15),e.k0s()()}if(2&s){const t=c.bkdLet,n=e.XpG();e.Y8G("disabled",t),e.R7$(2),e.AVh("invisible",t),e.R7$(),e.JRh(n.entry.presenceCategoryIcon),e.R7$(),e.Y8G("ngIf",t)}}function $t(s,c){if(1&s){const t=e.RV6();e.j41(0,"button",17),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.showPrecedingAbsences(o.entry))}),e.j41(1,"i",18),e.EFF(2,"info"),e.k0s()()}}function It(s,c){if(1&s&&(e.j41(0,"span",19),e.EFF(1),e.k0s()),2&s){const t=e.XpG();e.R7$(),e.SpI(" ",t.entry.lessonPresence.StudyClassNumber," ")}}function Tt(s,c){if(1&s){const t=e.RV6();e.j41(0,"a",20),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.updateIncident(o.entry))}),e.j41(1,"i",14),e.EFF(2,"edit"),e.k0s(),e.j41(3,"span"),e.EFF(4),e.nI1(5,"translate"),e.k0s()()}if(2&s){const t=e.XpG();e.R7$(4),e.JRh(e.bMT(5,1,(null==t.entry.presenceType?null:t.entry.presenceType.IsIncident)&&(null==t.entry.presenceType?null:t.entry.presenceType.Designation)||"presence-control.entry.incident"))}}let Ot=(()=>{class s{get classNames(){return[this.entry.presenceCategory,this.viewMode].join(" ")}constructor(t,n,o,i){this.toastService=t,this.translate=n,this.modalService=o,this.loadingService=i,this.hasUnconfirmedAbsences=!1,this.showClassName=!1,this.togglePresenceType=new e.bkB,this.changeIncident=new e.bkB,this.entry$=new ae.m(1),this.studentId$=this.entry$.pipe((0,l.T)(({lessonPresence:a})=>a.StudentRef.Id)),this.loading$=this.entry$.pipe((0,v.n)(a=>this.loadingService.loading($e(a))))}ngOnChanges(t){t.entry&&this.entry$.next(t.entry.currentValue)}get isListViewMode(){return this.viewMode===Y.H_.List}updatePresenceType(t){t.canChangePresenceType?this.togglePresenceType.emit(t):this.toastService.warning(this.translate.instant("presence-control.entry.update-warning"))}updateIncident(t){t.canChangeIncident&&this.changeIncident.emit(t)}showPrecedingAbsences(t){this.modalService.open(ft).componentInstance.precedingAbsences=t.precedingAbsences}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(de.f),e.rXU(g.c$),e.rXU(pe.y),e.rXU(K.U))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-entry"]],hostVars:2,hostBindings:function(n,o){2&n&&e.HbH(o.classNames)},inputs:{entry:"entry",hasUnconfirmedAbsences:"hasUnconfirmedAbsences",viewMode:"viewMode",showClassName:"showClassName",profileReturnParams:"profileReturnParams"},outputs:{togglePresenceType:"togglePresenceType",changeIncident:"changeIncident"},standalone:!0,features:[e.OA$,e.aNF],decls:13,vars:16,consts:[["class","avatar large",3,"studentId","link","linkParams",4,"ngIf"],["type","button","class","presence-category designation btn btn-link",3,"click",4,"ngIf"],["type","button","class","presence-category status btn btn-link",3,"disabled","click",4,"bkdLet"],["type","button","class","previously-absent d-flex btn btn-link",3,"click",4,"ngIf"],[1,"student-info",3,"routerLink","queryParams"],[1,"student-name","text-truncate"],["class","study-class text-truncate",4,"ngIf"],[1,"unconfirmed-absences"],["class","incident btn btn-link",3,"click",4,"ngIf"],[1,"avatar","large",3,"studentId","link","linkParams"],["type","button",1,"presence-category","designation","btn","btn-link",3,"click"],[4,"ngIf"],["type","button",1,"presence-category","status","btn","btn-link",3,"click","disabled"],[1,"position-relative"],[1,"material-icons"],["class","inline small",4,"ngIf"],[1,"inline","small"],["type","button",1,"previously-absent","d-flex","btn","btn-link",3,"click"],[1,"material-icons-outlined"],[1,"study-class","text-truncate"],[1,"incident","btn","btn-link",3,"click"]],template:function(n,o){1&n&&(e.DNE(0,vt,2,7,"bkd-avatar",0)(1,Pt,2,1,"button",1)(2,Mt,5,5,"button",2),e.nI1(3,"async"),e.DNE(4,$t,3,0,"button",3),e.j41(5,"a",4)(6,"span",5),e.EFF(7),e.k0s(),e.DNE(8,It,2,1,"span",6),e.j41(9,"span",7),e.EFF(10),e.nI1(11,"translate"),e.k0s()(),e.DNE(12,Tt,6,3,"a",8)),2&n&&(e.Y8G("ngIf",!o.isListViewMode),e.R7$(),e.Y8G("ngIf",o.entry.showDesignation),e.R7$(),e.Y8G("bkdLet",e.bMT(3,10,o.loading$)),e.R7$(2),e.Y8G("ngIf",(null==o.entry.precedingAbsences?null:o.entry.precedingAbsences.length)||!1),e.R7$(),e.Y8G("routerLink",e.eq3(14,_t,o.entry.lessonPresence.StudentRef.Id))("queryParams",o.profileReturnParams),e.R7$(2),e.JRh(o.entry.lessonPresence.StudentFullName),e.R7$(),e.Y8G("ngIf",o.isListViewMode&&o.showClassName),e.R7$(2),e.SpI(" ",o.hasUnconfirmedAbsences?e.bMT(11,12,"presence-control.entry.unconfirmed-absences"):""," "),e.R7$(2),e.Y8G("ngIf",o.entry.canChangeIncident))},dependencies:[h.bT,ut.f,S.N,R.t,x.Wk,h.Jj,g.h,g.D9],styles:['[_nghost-%COMP%]{padding:2rem 1rem;background-color:#fff;display:grid;grid-template-areas:"avatar status designation previously-absent" "avatar student-info student-info student-info" "avatar incident incident incident";grid-template-columns:min-content min-content 3fr min-content}[_nghost-%COMP%] > *[_ngcontent-%COMP%]{align-self:center}.presence-category[_ngcontent-%COMP%]{text-decoration:none}.presence-category[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{top:.1875rem}.absent[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#ea161f}.present[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#3d8608}.unapproved[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#ffa814}.presence-category[_ngcontent-%COMP%]   bkd-spinner[_ngcontent-%COMP%]{color:#000;position:absolute;top:4px;left:5px}.designation[_ngcontent-%COMP%], .student-info[_ngcontent-%COMP%], a.incident[_ngcontent-%COMP%], .incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.avatar[_ngcontent-%COMP%]{grid-area:avatar;margin-right:1.5rem}.status[_ngcontent-%COMP%]{grid-area:status}.status[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:2rem}.designation[_ngcontent-%COMP%]{grid-area:designation;text-align:left;line-height:2.375rem}.previously-absent[_ngcontent-%COMP%]{grid-area:previously-absent;text-decoration:none;color:#00000080;justify-self:end}.student-info[_ngcontent-%COMP%]{grid-area:student-info;display:flex;flex-direction:column;text-decoration:none}.student-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{text-decoration:underline}.student-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child:hover{text-decoration-color:#ea161f}.unconfirmed-absences[_ngcontent-%COMP%]{color:#ea161f;font-size:.875rem;line-height:1}.study-class[_ngcontent-%COMP%]{font-size:.875rem;line-height:1}.incident[_ngcontent-%COMP%]{color:#00000080;padding-right:1.5rem;grid-area:incident;display:flex;text-decoration:none}.incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{text-decoration:underline}.incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:hover{text-decoration-color:#ea161f}.incident[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{margin-right:.3em}.grid[_nghost-%COMP%]   .status[_ngcontent-%COMP%], .grid[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{align-self:start;margin-left:-1.5rem;margin-top:-.375rem}.grid[_nghost-%COMP%]   .incident[_ngcontent-%COMP%]{align-self:end;margin-left:-1.5rem;margin-bottom:-.375rem}.grid[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-right:0;align-self:start}.grid[_nghost-%COMP%]   .unconfirmed-absences[_ngcontent-%COMP%]{height:.875rem}.list[_nghost-%COMP%]{grid-template-areas:"student-info status incidentordesignation previously-absent";grid-template-columns:3fr min-content 4fr 3em;padding:.5rem 1rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{justify-self:start}.list[_nghost-%COMP%]   .student-name[_ngcontent-%COMP%]{line-height:1;margin-bottom:.5rem}.list[_nghost-%COMP%]   .incident[_ngcontent-%COMP%], .list[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{grid-area:incidentordesignation}.list[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-right:0}@media (max-width: 750px){.list[_nghost-%COMP%]{grid-template-areas:"student-info student-info student-info previously-absent" "status incidentordesignation incidentordesignation incidentordesignation";grid-template-columns:min-content 1fr 1fr min-content;row-gap:1rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.list[_nghost-%COMP%]   .student-name[_ngcontent-%COMP%]{margin-top:.5rem}.list[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{align-self:start}}']})}return s})();var St=r(1964),J=r(9728),kt=r(853),Et=r(2239);const Rt=(s,c)=>({"btn-link":s,"btn-danger":c}),Dt=s=>["groups",s],Lt=s=>({returnparams:s});function Ft(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",22),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(null==o.lessonDropdown?null:o.lessonDropdown.toggle())}),e.EFF(1),e.nI1(2,"date"),e.j41(3,"span",23),e.EFF(4),e.nI1(5,"date"),e.k0s()()}if(2&s){const t=e.XpG();e.R7$(),e.SpI(" ",e.i5U(2,2,t.selectedLesson.LessonDateTimeFrom,"HH:mm"),"\u2013"),e.R7$(3),e.JRh(e.i5U(5,5,t.selectedLesson.LessonDateTimeTo,"HH:mm"))}}function jt(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",29),e.bIt("click",function(){const o=e.eBV(t).$implicit,i=e.XpG(2);return e.Njj(i.selectLessonChange.emit(o))}),e.j41(1,"div",30)(2,"div"),e.EFF(3),e.nI1(4,"date"),e.nI1(5,"date"),e.k0s(),e.j41(6,"div",26),e.EFF(7),e.k0s(),e.j41(8,"div",26),e.EFF(9),e.k0s()()()}if(2&s){const t=c.$implicit,n=e.XpG(2);e.AVh("active",t.id===n.selectedLesson.id),e.R7$(3),e.Lme(" ",e.i5U(4,6,t.LessonDateTimeFrom,"HH:mm"),"\u2013",e.i5U(5,9,t.LessonDateTimeTo,"HH:mm")," "),e.R7$(4),e.JRh(t.eventDesignations),e.R7$(2),e.JRh(t.studyClassNumbers)}}function xt(s,c){if(1&s&&(e.j41(0,"div",24)(1,"div",25)(2,"div",26),e.EFF(3),e.k0s(),e.j41(4,"div",26),e.EFF(5),e.k0s()(),e.j41(6,"div",27),e.DNE(7,jt,10,12,"div",28),e.k0s()()),2&s){const t=e.XpG();e.R7$(3),e.JRh(t.selectedLesson.eventDesignations),e.R7$(2),e.JRh(t.selectedLesson.studyClassNumbers),e.R7$(2),e.Y8G("ngForOf",t.lessons)}}function Gt(s,c){if(1&s){const t=e.RV6();e.j41(0,"bkd-caret",31),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(null==o.lessonDropdown?null:o.lessonDropdown.toggle())}),e.k0s()}if(2&s){const t=e.XpG();e.Y8G("expanded",(null==t.lessonDropdown?null:t.lessonDropdown.isOpen())||!1)}}function wt(s,c){if(1&s&&(e.j41(0,"a",32),e.nI1(1,"async"),e.nI1(2,"async"),e.nI1(3,"async"),e.j41(4,"i",33),e.EFF(5,"groups"),e.k0s()()),2&s){const t=e.XpG();e.Y8G("ngClass",e.l_i(9,Rt,!1===e.bMT(1,3,t.isGroupSelected$),e.bMT(2,5,t.isGroupSelected$)))("routerLink",e.eq3(12,Dt,t.selectedLesson.id))("queryParams",e.eq3(14,Lt,e.bMT(3,7,t.state.queryParamsString$)))}}function Ut(s,c){if(1&s){const t=e.RV6();e.j41(0,"button",34),e.bIt("click",function(){const o=e.eBV(t).$implicit,i=e.XpG();return e.Njj(i.viewModeChange.emit(o.viewMode))}),e.j41(1,"i",33),e.EFF(2),e.k0s()()}if(2&s){const t=c.$implicit,n=e.XpG();e.AVh("btn-outline-secondary",t.viewMode===n.viewMode)("btn-link",t.viewMode!==n.viewMode)("active",t.viewMode===n.viewMode),e.Y8G("disabled",!n.selectedLesson),e.R7$(2),e.JRh(t.icon)}}const Vt=b.tg.prototype._positionMenu;b.tg.prototype._positionMenu=function(...c){const t=Vt.apply(this,c);if("lesson-dropdown"===this._anchor.nativeElement.id){const n=this._bodyContainer||this._menu.nativeElement,o=n.style.transform?.match(/translate\(([0-9-.]+)px, ([0-9-.]+)px\)/);o&&parseFloat(o[1])<0&&(n.style.transform=`translate(0px, ${o[2]}px)`)}return t};let Bt=(()=>{class s{constructor(t,n,o){this.state=t,this.groupService=n,this.presentCount=null,this.absentCount=null,this.unapprovedCount=null,this.absentPrecedingCount=null,this.search="",this.selectLessonChange=new e.bkB,this.selectDateChange=new e.bkB,this.searchChange=new e.bkB,this.viewModeChange=new e.bkB,this.viewModeOptions=[{viewMode:Y.H_.List,icon:"list"},{viewMode:Y.H_.Grid,icon:"view_module"}],this.isGroupSelected$=this.groupService.group$.pipe((0,l.T)(J.TM)),o.popperOptions=i=>({...i,modifiers:i.modifiers?.map(a=>("offset"===a.name&&(a.options={offset:({placement:d,reference:m,popper:I})=>"bottom-start"===d?[(window.innerWidth-I.width)/2-m.x,0]:[]}),a))})}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(L),e.rXU(W),e.rXU(b.YB))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-header"]],viewQuery:function(n,o){if(1&n&&e.GBs(b.tg,5),2&n){let i;e.mGM(i=e.lsd())&&(o.lessonDropdown=i.first)}},inputs:{selectedLesson:"selectedLesson",lessons:"lessons",presentCount:"presentCount",absentCount:"absentCount",unapprovedCount:"unapprovedCount",absentPrecedingCount:"absentPrecedingCount",viewMode:"viewMode",selectDate:"selectDate",search:"search"},outputs:{selectLessonChange:"selectLessonChange",selectDateChange:"selectDateChange",searchChange:"searchChange",viewModeChange:"viewModeChange"},standalone:!0,features:[e.Jv_([b.YB,{provide:b.dn,useClass:b.Ae},{provide:b.tN,useClass:St.m}]),e.aNF],decls:40,vars:20,consts:[["d","ngbDatepicker"],[1,"navigation"],[1,"lesson-date"],["type","button",1,"btn","btn-link",3,"click"],[1,"material-icons"],["positionTarget",".lesson-date-input","ngbDatepicker","","placement","bottom-start",1,"lesson-date-input",3,"ngModelChange","ngModel"],["class","lesson-time",3,"click",4,"ngIf"],["ngbDropdown","","class","lesson-description","container","body","display","dynamic","placement","bottom",4,"ngIf"],["class","dropdown-caret",3,"expanded","click",4,"ngIf"],[1,"states"],[1,"state","present"],[1,"count"],[1,"state","absent"],[1,"state","unapproved"],[1,"state","previously-absent"],[1,"material-icons-outlined"],[1,"search-and-views"],[1,"search",3,"valueChange","value","disabled","placeholder","label"],[1,"group-and-views","d-flex","align-items-center"],["type","button","class","group btn me-2 me-sm-4",3,"ngClass","routerLink","queryParams",4,"ngIf"],[1,"views"],["type","button","class","view btn btn-primary btn-icon",3,"disabled","btn-outline-secondary","btn-link","active","click",4,"ngFor","ngForOf"],[1,"lesson-time",3,"click"],[1,"lesson-time-to"],["ngbDropdown","","container","body","display","dynamic","placement","bottom",1,"lesson-description"],["id","lesson-dropdown","ngbDropdownToggle",""],[1,"text-truncate"],["ngbDropdownMenu","","aria-labelledby","lesson-dropdown"],["ngbDropdownItem","",3,"active","click",4,"ngFor","ngForOf"],["ngbDropdownItem","",3,"click"],[1,"lesson-entry"],[1,"dropdown-caret",3,"click","expanded"],["type","button",1,"group","btn","me-2","me-sm-4",3,"ngClass","routerLink","queryParams"],[1,"material-icons","align-middle"],["type","button",1,"view","btn","btn-primary","btn-icon",3,"click","disabled"]],template:function(n,o){if(1&n){const i=e.RV6();e.j41(0,"div",1)(1,"div",2)(2,"button",3),e.bIt("click",function(){e.eBV(i);const d=e.sdS(6);return e.Njj(d.toggle())}),e.j41(3,"i",4),e.EFF(4,"calendar_today"),e.k0s()(),e.j41(5,"input",5,0),e.bIt("ngModelChange",function(d){return e.eBV(i),e.Njj(o.selectDateChange.emit(d))}),e.k0s()(),e.DNE(7,Ft,6,8,"div",6)(8,xt,8,3,"div",7)(9,Gt,1,1,"bkd-caret",8),e.k0s(),e.j41(10,"div",9)(11,"div",10)(12,"i",4),e.EFF(13,"check_circle"),e.k0s(),e.j41(14,"span",11),e.EFF(15),e.k0s()(),e.j41(16,"div",12)(17,"i",4),e.EFF(18,"cancel"),e.k0s(),e.j41(19,"span",11),e.EFF(20),e.k0s()(),e.j41(21,"div",13)(22,"i",4),e.EFF(23,"help"),e.k0s(),e.j41(24,"span",11),e.EFF(25),e.k0s()(),e.j41(26,"div",14)(27,"i",15),e.EFF(28,"info"),e.k0s(),e.j41(29,"span",11),e.EFF(30),e.k0s()()(),e.j41(31,"div",16)(32,"bkd-resettable-input",17),e.nI1(33,"translate"),e.nI1(34,"translate"),e.bIt("valueChange",function(d){return e.eBV(i),e.Njj(o.searchChange.emit(d))}),e.k0s(),e.j41(35,"div",18),e.DNE(36,wt,6,16,"a",19),e.nI1(37,"async"),e.j41(38,"div",20),e.DNE(39,Ut,3,8,"button",21),e.k0s()()()}2&n&&(e.R7$(5),e.Y8G("ngModel",o.selectDate),e.R7$(2),e.Y8G("ngIf",o.selectedLesson),e.R7$(),e.Y8G("ngIf",o.selectedLesson),e.R7$(),e.Y8G("ngIf",o.lessons.length>0),e.R7$(6),e.JRh(null!==o.presentCount?o.presentCount:"?"),e.R7$(5),e.JRh(null!==o.absentCount?o.absentCount:"?"),e.R7$(5),e.JRh(null!==o.unapprovedCount?o.unapprovedCount:"?"),e.R7$(5),e.JRh(null!==o.absentPrecedingCount?o.absentPrecedingCount:"?"),e.R7$(2),e.Y8G("value",o.search)("disabled",!o.selectedLesson)("placeholder",e.bMT(33,14,"presence-control.header.search-by-name"))("label",e.bMT(34,16,"presence-control.header.search")),e.R7$(4),e.Y8G("ngIf",e.bMT(37,18,o.selectedLesson&&o.state.groupsAvailability$)),e.R7$(3),e.Y8G("ngForOf",o.viewModeOptions))},dependencies:[b.cw,C.YN,C.me,C.BC,C.vS,h.bT,b.tg,b.do,b.U0,h.pM,b._H,kt.h,Et.B,h.YU,x.Wk,h.Jj,h.vh,g.h,g.D9],styles:['[_nghost-%COMP%]{display:flex;flex-direction:column;padding:.75rem 0}.navigation[_ngcontent-%COMP%]{display:grid;grid-template-areas:". date time dropdown-caret" ". description description dropdown-caret";grid-template-columns:1fr auto auto 1fr;align-items:center}.lesson-date[_ngcontent-%COMP%]{grid-area:date;justify-self:end;display:flex;align-items:center;justify-content:flex-end}.lesson-date[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:0 .5ch 0 0}.lesson-date[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#000;position:relative}.lesson-date-input[_ngcontent-%COMP%]{font-weight:600;background:transparent;border:none;width:11ch}.lesson-time[_ngcontent-%COMP%]{grid-area:time;cursor:pointer}.lesson-description[_ngcontent-%COMP%]{grid-area:description;overflow:hidden;text-align:center;cursor:pointer}.dropdown-toggle[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.dropdown-toggle[_ngcontent-%COMP%]:after{display:none}.dropdown-caret[_ngcontent-%COMP%]{grid-area:dropdown-caret;line-height:100%;text-align:left;color:#000}.dropdown-menu[_ngcontent-%COMP%]{width:50ch;padding:0;box-shadow:2px 2px 3px -1px #0003}@media (max-width: 800px){.dropdown-menu[_ngcontent-%COMP%]{width:100vw}}.dropdown-item[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6}.states[_ngcontent-%COMP%]{margin:.75rem 0;display:flex;justify-content:center}.state[_ngcontent-%COMP%]{margin-right:7%;display:flex}.state[_ngcontent-%COMP%]:last-child{margin-right:0}@media (min-width: 1000px){.state[_ngcontent-%COMP%]{margin-right:4rem}}.state.present[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#3d8608}.state.absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#ea161f}.state.unapproved[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#ffa814}.state.previously-absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#00000080}.state[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{margin-left:.3em;margin-top:1px}.search-and-views[_ngcontent-%COMP%]{padding-top:.75rem;display:flex;justify-content:space-between;border-top:1px solid #dee2e6}.search[_ngcontent-%COMP%]{flex:auto;max-width:300px;margin-right:1rem}.views[_ngcontent-%COMP%]{display:flex}.view[_ngcontent-%COMP%]{color:#4e4e4ef2;background-color:#fff}.view.active[_ngcontent-%COMP%]{color:#fff;background-color:#4e4e4ef2;border:none}.group[_ngcontent-%COMP%], .view[_ngcontent-%COMP%]{text-decoration:none;padding-left:0;padding-right:0;aspect-ratio:1/1;width:calc(.75rem + 2 * var(--bs-border-width) + 1.625rem);border-radius:50%}.group.btn-link[_ngcontent-%COMP%]{color:#000}@media (max-width: 380px){[_nghost-%COMP%]{padding-left:.5rem;padding-right:.5rem}#search-addon[_ngcontent-%COMP%]{padding-left:.5rem;padding-right:.5rem}}@media (max-width: 365px){.lesson-time[_ngcontent-%COMP%]{line-height:1}.lesson-time-to[_ngcontent-%COMP%]{display:block}.dropdown-caret[_ngcontent-%COMP%]{padding-left:0}}']})}return s})();function At(s,c){if(1&s){const t=e.RV6();e.j41(0,"div",5)(1,"input",6),e.bIt("change",function(){const o=e.eBV(t).$implicit,i=e.XpG();return e.Njj(i.onSelectionChange(o))}),e.k0s(),e.j41(2,"label",7),e.EFF(3),e.k0s()()}if(2&s){const t=c.$implicit,n=c.index,o=e.XpG();e.R7$(),e.Mz_("id","incident-",n,""),e.Y8G("checked",t.id===o.selected.id)("value",t.id),e.R7$(),e.Mz_("for","incident-",n,""),e.R7$(),e.SpI(" ",t.label," ")}}let Nt=(()=>{class s{constructor(t,n){this.activeModal=t,this.translate=n,this.incidentOptions=[]}ngOnInit(){const t=this.createIncidentOption();this.incidentOptions=this.incidentTypes.map(n=>this.createIncidentOption(n)),this.incidentOptions.unshift(t),this.selected=this.incidentOptions.find(n=>n.id===this.incident?.Id)||t}createIncidentOption(t){return{id:t?t.Id:null,label:t?t.Designation:this.translate.instant("presence-control.incident.no-incident")}}onSelectionChange(t){this.selected=t}getSelectedIncident(){return this.incidentTypes.find(t=>t.Id===this.selected?.id)||null}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(b.Lw),e.rXU(g.c$))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-incident"]],inputs:{incident:"incident",incidentTypes:"incidentTypes"},standalone:!0,features:[e.aNF],decls:13,vars:10,consts:[[1,"modal-body"],["class","form-check",4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],[1,"form-check"],["type","radio","name","incident",1,"form-check-input",3,"change","id","checked","value"],[1,"form-check-label",3,"for"]],template:function(n,o){1&n&&(e.j41(0,"div",0)(1,"p"),e.EFF(2),e.nI1(3,"translate"),e.k0s(),e.j41(4,"form"),e.DNE(5,At,4,7,"div",1),e.k0s()(),e.j41(6,"div",2)(7,"button",3),e.bIt("click",function(){return o.activeModal.dismiss()}),e.EFF(8),e.nI1(9,"translate"),e.k0s(),e.j41(10,"button",4),e.bIt("click",function(){return o.activeModal.close(o.getSelectedIncident())}),e.EFF(11),e.nI1(12,"translate"),e.k0s()()),2&n&&(e.R7$(2),e.SpI(" ",e.bMT(3,4,"presence-control.incident.text")," "),e.R7$(3),e.Y8G("ngForOf",o.incidentOptions),e.R7$(3),e.SpI(" ",e.bMT(9,6,"presence-control.incident.cancel")," "),e.R7$(3),e.SpI(" ",e.bMT(12,8,"presence-control.incident.save")," "))},dependencies:[C.YN,C.qT,C.cb,C.cV,h.pM,g.h,g.D9],styles:["form[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:first-child{border-bottom:1px solid #dee2e6;padding-bottom:1rem;margin-bottom:1rem}"]})}return s})();var Xt=r(2816),Yt=r(7647),Te=r(152),Ht=r(274),Kt=r(9437),Oe=r(1803),Se=r(5421),Wt=r(9946),U=function(s){return s.AddUpdateAction="ADD",s.RemoveUpdateAction="REMOVE",s}(U||{});let ke=(()=>{class s{constructor(t,n,o,i,a){this.toastService=t,this.translate=n,this.restService=o,this.presenceTypesService=i,this.settings=a,this.destroy$=new $.B,this.action$=new $.B,this.pendingUpdates$=this.action$.pipe((0,Xt.S)(this.reduceUpdates.bind(this),[]),(0,Yt.u)()),this.revertUpdates$=new $.B,this.performUpdates$=this.pendingUpdates$.pipe((0,Te.B)(100),(0,ne.p)((0,J.AU)(Se.VP)),(0,Ht.H)(this.performUpdates.bind(this))),this.stateUpdates$=(0,G.h)(this.pendingUpdates$,this.revertUpdates$).pipe((0,Te.B)(20),(0,ne.p)((0,J.AU)(Se.VP))),this.performUpdates$.pipe((0,D.Q)(this.destroy$)).subscribe()}ngOnDestroy(){this.destroy$.next()}updatePresenceType(t,n=null){this.dispatchAddUpdate(t.lessonPresence,n)}performUpdates(t){const n=this.groupUpdates(t);return(0,f.z)(Object.keys(n).reduce((o,i)=>{const a=n[i];return Object.keys(a).forEach(d=>{o.push(this.performUpdateForGroup(a[d]))}),o},[])).pipe((0,l.T)(()=>n))}performUpdateForGroup(t){return t.forEach(n=>this.dispatchRemoveUpdate(n.presence)),this.performLessonPresencesUpdatesByIds(t[0].presence.LessonRef.Id,t.map(n=>n.presence.StudentRef.Id),t[0].newPresenceTypeId).pipe((0,Kt.W)(n=>this.revertUpdatesAfterError(t,n)))}performLessonPresencesUpdatesByIds(t,n,o=null){return o?(o?this.presenceTypesService.getPresenceType(o):(0,w.of)(null)).pipe((0,v.n)(a=>this.restService.editLessonPresences([t],n,a?.Id,(0,oe.Eu)(a,this.settings)||void 0,{context:(new H._y).set(Oe.Q,{disableErrorHandling:!0})}))):this.restService.removeLessonPresences([t],n,{context:(new H._y).set(Oe.Q,{disableErrorHandling:!0})})}revertUpdatesAfterError(t,n){return console.error("Bulk-update of lesson presences failed"),console.error(n),this.toastService.error(this.translate.instant("shared.lesson-presences-update.error")),this.revertUpdates$.next(t.map(o=>({...o,newPresenceTypeId:o.presence.TypeRef.Id}))),(0,w.of)(void 0)}groupUpdates(t){return t.reduce((n,o)=>{const i=String(o.newPresenceTypeId&&o.newPresenceTypeId);return n[i]||(n[i]={}),Array.isArray(n[i][o.presence.LessonRef.Id])||(n[i][o.presence.LessonRef.Id]=[]),n[i][o.presence.LessonRef.Id].push(o),n},{})}reduceUpdates(t,n){switch(n.type){case U.AddUpdateAction:{const{presence:o,newPresenceTypeId:i}=n.payload,a=t.findIndex(Ee(o));return-1===a?[...t,{presence:o,newPresenceTypeId:i}]:[...t.slice(0,a),{presence:t[a].presence,newPresenceTypeId:i},...t.slice(a+1)]}case U.RemoveUpdateAction:return t.filter((0,J.AU)(Ee(n.payload)));default:return t}}dispatchAddUpdate(t,n){this.action$.next({type:U.AddUpdateAction,payload:{presence:t,newPresenceTypeId:n}})}dispatchRemoveUpdate(t){this.action$.next({type:U.RemoveUpdateAction,payload:t})}static#e=this.\u0275fac=function(n){return new(n||s)(e.KVO(de.f),e.KVO(g.c$),e.KVO(Wt.T),e.KVO(ce._),e.KVO(j.yy))};static#t=this.\u0275prov=e.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function Ee(s){return c=>c.presence.LessonRef.Id===s.LessonRef.Id&&c.presence.StudentRef.Id===s.StudentRef.Id}var Qt=r(1769);const Zt=(s,c,t)=>({lesson:s,lessons:c,entries:t}),qt=s=>({returnparams:s});function en(s,c){if(1&s){const t=e.RV6();e.j41(0,"bkd-presence-control-entry",7),e.nI1(1,"async"),e.nI1(2,"async"),e.nI1(3,"async"),e.nI1(4,"async"),e.bIt("togglePresenceType",function(o){e.eBV(t);const i=e.XpG(5);return e.Njj(i.togglePresenceType(o))})("changeIncident",function(o){e.eBV(t);const i=e.XpG(5);return e.Njj(i.changeIncident(o))}),e.k0s()}if(2&s){let t;const n=c.$implicit,o=e.XpG(5);e.Y8G("entry",n)("hasUnconfirmedAbsences",e.bMT(1,5,o.state.hasUnconfirmedAbsences(n)))("viewMode",e.bMT(2,7,o.state.viewMode$))("showClassName",(null!==(t=e.bMT(3,9,o.state.studyClassCount$))&&void 0!==t?t:0)>1)("profileReturnParams",e.eq3(13,qt,e.bMT(4,11,o.state.queryParamsString$)))}}function tn(s,c){if(1&s&&(e.qex(0),e.j41(1,"div"),e.nI1(2,"async"),e.DNE(3,en,5,15,"bkd-presence-control-entry",6),e.k0s(),e.bVm()),2&s){const t=e.XpG(3).bkdLet,n=e.XpG();e.R7$(),e.ZvI("default-entries entries view-mode-",e.bMT(2,4,n.state.viewMode$),""),e.R7$(2),e.Y8G("ngForOf",t.entries)}}function nn(s,c){1&s&&(e.j41(0,"p",8),e.EFF(1),e.nI1(2,"translate"),e.k0s()),2&s&&(e.R7$(),e.SpI(" ",e.bMT(2,1,"presence-control.no-lesson-presences")," "))}function sn(s,c){if(1&s&&(e.qex(0),e.DNE(1,tn,4,6,"ng-container",4)(2,nn,3,3,"ng-template",null,2,e.C5r),e.bVm()),2&s){const t=e.sdS(3),n=e.XpG(2).bkdLet;e.R7$(),e.Y8G("ngIf",(null==n.entries?null:n.entries.length)>0)("ngIfElse",t)}}function on(s,c){1&s&&(e.j41(0,"p",8),e.EFF(1),e.nI1(2,"translate"),e.k0s()),2&s&&(e.R7$(),e.JRh(e.bMT(2,1,"presence-control.no-lessons")))}function rn(s,c){if(1&s){const t=e.RV6();e.qex(0),e.j41(1,"bkd-presence-control-header",5),e.nI1(2,"async"),e.nI1(3,"async"),e.nI1(4,"async"),e.nI1(5,"async"),e.nI1(6,"async"),e.nI1(7,"async"),e.nI1(8,"async"),e.bIt("searchChange",function(o){e.eBV(t);const i=e.XpG(2);return e.Njj(i.search$.next(o))})("viewModeChange",function(o){e.eBV(t);const i=e.XpG(2);return e.Njj(i.state.setViewMode(o))})("selectDateChange",function(o){e.eBV(t);const i=e.XpG(2);return e.Njj(i.state.setDate(o))})("selectLessonChange",function(o){e.eBV(t);const i=e.XpG(2);return e.Njj(i.state.setLessonId(o.id))}),e.k0s(),e.DNE(9,sn,4,2,"ng-container",4)(10,on,3,3,"ng-template",null,1,e.C5r),e.bVm()}if(2&s){const t=e.sdS(11),n=e.XpG().bkdLet,o=e.XpG();e.R7$(),e.Y8G("selectedLesson",n.lesson)("lessons",n.lessons)("presentCount",e.bMT(2,11,o.state.presentCount$))("absentCount",e.bMT(3,13,o.state.absentCount$))("unapprovedCount",e.bMT(4,15,o.state.unapprovedCount$))("absentPrecedingCount",e.bMT(5,17,o.state.absentPrecedingCount$))("viewMode",e.bMT(6,19,o.state.viewMode$))("selectDate",e.bMT(7,21,o.state.selectedDate$))("search",e.bMT(8,23,o.search$)),e.R7$(8),e.Y8G("ngIf",n.lesson)("ngIfElse",t)}}function cn(s,c){1&s&&e.nrm(0,"bkd-spinner")}function an(s,c){if(1&s&&(e.qex(0),e.DNE(1,rn,12,25,"ng-container",4),e.nI1(2,"async"),e.DNE(3,cn,1,0,"ng-template",null,0,e.C5r),e.bVm()),2&s){const t=e.sdS(4),n=e.XpG();e.R7$(),e.Y8G("ngIf",!1===e.bMT(2,2,n.state.loading$))("ngIfElse",t)}}let ln=(()=>{class s{constructor(t,n,o,i,a,d,m){this.state=t,this.blockLessons=n,this.lessonPresencesUpdateService=o,this.presenceTypesService=i,this.modalService=a,this.scrollPosition=d,this.route=m,this.search$=new O.t(""),this.entries$=(0,f.z)([this.state.presenceControlEntriesByGroup$,this.search$]).pipe((0,l.T)((0,k.i)(ct.x)),(0,M.t)(1)),this.destroy$=new $.B}ngOnInit(){this.route.queryParams.pipe((0,D.Q)(this.destroy$)).subscribe(this.restoreStateFromParams.bind(this))}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}doTogglePresenceType(t){t.forEach(n=>this.state.getNextPresenceType(n).subscribe(o=>this.lessonPresencesUpdateService.updatePresenceType(n,o?o.Id:null)))}togglePresenceType(t){this.blockLessons.getBlockLessonPresenceControlEntries(t).pipe((0,P.s)(1)).subscribe(n=>{if(1===n.length)this.doTogglePresenceType([n[0]]);else{const o=this.modalService.open(pt);o.componentInstance.entry=t,o.componentInstance.blockPresenceControlEntries=n,o.result.then(i=>{i&&this.doTogglePresenceType(i)},()=>{})}})}updateIncident(t,n){this.lessonPresencesUpdateService.updatePresenceType(t,n)}changeIncident(t){this.presenceTypesService.incidentTypes$.subscribe(n=>{const o=this.modalService.open(Nt);o.componentInstance.incident=n.find(i=>i.Id===t.presenceType?.Id)||null,o.componentInstance.incidentTypes=n,o.result.then(i=>{this.updateIncident(t,i?.Id||null)},()=>{})})}restoreStateFromParams(t){t.date&&this.state.setDate((0,rt.cv)(t.date));const n=String(t.lesson);n&&this.state.setLessonId(n),t.viewMode&&ze.includes(t.viewMode)&&this.state.setViewMode(t.viewMode)}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(L),e.rXU(Ie),e.rXU(ke),e.rXU(ce._),e.rXU(pe.y),e.rXU(Qt.W),e.rXU(x.nX))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control-list"]],standalone:!0,features:[e.aNF],decls:7,vars:14,consts:[["loading",""],["noLessons",""],["noLessonPresences",""],[4,"bkdLet"],[4,"ngIf","ngIfElse"],[3,"searchChange","viewModeChange","selectDateChange","selectLessonChange","selectedLesson","lessons","presentCount","absentCount","unapprovedCount","absentPrecedingCount","viewMode","selectDate","search"],[3,"entry","hasUnconfirmedAbsences","viewMode","showClassName","profileReturnParams","togglePresenceType","changeIncident",4,"ngFor","ngForOf"],[3,"togglePresenceType","changeIncident","entry","hasUnconfirmedAbsences","viewMode","showClassName","profileReturnParams"],[1,"mt-3"]],template:function(n,o){1&n&&(e.j41(0,"h1"),e.EFF(1),e.nI1(2,"translate"),e.k0s(),e.DNE(3,an,5,4,"ng-container",3),e.nI1(4,"async"),e.nI1(5,"async"),e.nI1(6,"async")),2&n&&(e.R7$(),e.JRh(e.bMT(2,2,"presence-control.title")),e.R7$(2),e.Y8G("bkdLet",e.sMw(10,Zt,e.bMT(4,4,o.state.selectedLesson$),e.bMT(5,6,o.state.lessons$),e.bMT(6,8,o.entries$))))},dependencies:[S.N,h.bT,Bt,h.pM,Ot,R.t,h.Jj,g.h,g.D9],styles:["bkd-presence-control-entry[_ngcontent-%COMP%]{border-bottom:1px solid #dee2e6}.entries.view-mode-grid[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%}@media (min-width: 400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%;border-right:1px solid #dee2e6}}@media (min-width: 800px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:50%;border-right:1px solid #dee2e6}}@media (min-width: 1200px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:33.3333333333%;border-right:1px solid #dee2e6}}@media (min-width: 1600px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:25%;border-right:1px solid #dee2e6}}@media (min-width: 2000px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:20%;border-right:1px solid #dee2e6}}@media (min-width: 2400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:16.6666666667%;border-right:1px solid #dee2e6}}[_nghost-%COMP%]{display:block;overflow:hidden;width:100%}.entries.view-mode-grid[_ngcontent-%COMP%]{width:calc(100% + 1px)}"],changeDetection:0})}return s})();var dn=r(1876),pn=r(9366);const un=[{path:"",component:(()=>{class s{constructor(t,n){this.state=t,this.lessonPresencesUpdateService=n,this.destroy$=new $.B}ngOnInit(){this.lessonPresencesUpdateService.stateUpdates$.pipe((0,D.Q)(this.destroy$)).subscribe(t=>this.state.updateLessonPresencesTypes(t))}ngOnDestroy(){this.destroy$.next()}static#e=this.\u0275fac=function(n){return new(n||s)(e.rXU(L),e.rXU(ke))};static#t=this.\u0275cmp=e.VBU({type:s,selectors:[["bkd-presence-control"]],standalone:!0,features:[e.Jv_([L,Ie,W,pn.s,{provide:dn.G,useExisting:L}]),e.aNF],decls:1,vars:0,template:function(n,o){1&n&&e.nrm(0,"router-outlet")},dependencies:[x.n3],changeDetection:0})}return s})(),children:[{path:"",component:ln,data:{restoreScrollPositionFrom:["/presence-control/student/:id/addresses","/presence-control/student/:id/absences","/presence-control/student/:id/grades"]}},F.R,{path:"groups/:id",component:it}]}]},1769:(Re,A,r)=>{r.d(A,{W:()=>N});var F=r(5539),h=r(1413),g=r(7673),O=r(5964),f=r(6354),E=r(6697),l=r(1397),P=r(5558),v=r(7799),z=r(4668),R=r(6977),S=r(4438),k=r(177);let N=(()=>{class y{constructor(p,_){this.router=p,this.viewportScroller=_,this.scrollPositions={},this.previousRoute=null,this.currentRoute=this.getInitialActivatedRouteSnapshot(),this.currentScrollPosition=[0,0],this.destroy$=new h.B,this.activationEnd$=this.router.events.pipe((0,O.p)(Q)),this.navigationEnd$=this.router.events.pipe((0,O.p)(e)),this.navigationStart$=this.router.events.pipe((0,O.p)(Z)),this.scrollPosition$=this.navigationStart$.pipe((0,f.T)(this.getScrollPosition.bind(this))),this.route$=this.activationEnd$.pipe((0,E.s)(1)).pipe((0,l.Z)(T=>[(0,g.of)(T),this.navigationEnd$.pipe((0,P.n)(()=>this.activationEnd$.pipe((0,E.s)(1))))]),(0,v.w)(),(0,f.T)(T=>T.snapshot),(0,z.t)(1)),this.scrollPosition$.pipe((0,R.Q)(this.destroy$)).subscribe(T=>this.currentScrollPosition=T),this.route$.pipe((0,R.Q)(this.destroy$)).subscribe(T=>{this.previousRoute=this.currentRoute,this.currentRoute=T})}ngOnDestroy(){this.destroy$.next()}restore(){if(!this.currentRoute||!this.requiresStoring(this.currentRoute))return;if(this.previousRoute&&this.shouldStoreFor(this.currentRoute,this.previousRoute)){const _=this.getPath(this.currentRoute);this.scrollToPosition(this.scrollPositions[_]||[0,0])}const p=this.currentRoute;this.route$.pipe((0,E.s)(1),(0,R.Q)(this.destroy$),(0,O.p)(_=>this.shouldStoreFor(p,_))).subscribe(()=>{const _=this.getPath(p);this.scrollPositions[_]=this.currentScrollPosition})}getScrollPosition(){return this.viewportScroller.getScrollPosition()}scrollToPosition(p){this.viewportScroller.scrollToPosition(p)}getPath(p){return p?"/"+p.pathFromRoot.map(_=>_.routeConfig&&_.routeConfig.path).filter(_=>_).join("/"):"/"}requiresStoring(p){return!!(p&&p.routeConfig&&p.routeConfig.data&&Array.isArray(p.routeConfig.data.restoreScrollPositionFrom)&&p.routeConfig.data.restoreScrollPositionFrom.length>0)}shouldStoreFor(p,_){return(p&&p.routeConfig&&p.routeConfig.data&&Array.isArray(p.routeConfig.data.restoreScrollPositionFrom)?p.routeConfig.data.restoreScrollPositionFrom:[]).includes(this.getPath(_))}getInitialActivatedRouteSnapshot(){let p=this.router.routerState.snapshot.root;for(;p.firstChild;)p=p.firstChild;return p}static#e=this.\u0275fac=function(_){return new(_||y)(S.KVO(F.Ix),S.KVO(k.Xr))};static#t=this.\u0275prov=S.jDH({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})();function Q(y){return y instanceof F._d}function Z(y){return y instanceof F.Z}function e(y){return y instanceof F.wF}}}]);