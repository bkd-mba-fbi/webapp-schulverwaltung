import{a as hn,b as Cn}from"./chunk-IJVTE2WS.js";import{a as de,b as xe}from"./chunk-NTSKCSYH.js";import{b as _n}from"./chunk-CYCJMWN3.js";import{a as vn}from"./chunk-45QOVAJI.js";import{a as bn,b as Pn}from"./chunk-32LHGY5Z.js";import{a as fn}from"./chunk-BF6ERICZ.js";import{e as un}from"./chunk-TFMLVR5Z.js";import{q as mn,v as Se}from"./chunk-LLGOVPQJ.js";import{a as at}from"./chunk-2H6IFZM2.js";import{b as Kt,e as Ke}from"./chunk-SH3IV7KW.js";import{a as nn}from"./chunk-OBH3S2C7.js";import"./chunk-Y4QYVF5K.js";import"./chunk-OFB4XAK2.js";import{a as Sn}from"./chunk-UA2MEY3S.js";import{a as yn}from"./chunk-QGBUBRBN.js";import{a as ct,d as dn}from"./chunk-TKH5QF5L.js";import{a as rn}from"./chunk-WACRWBCS.js";import{a as sn,b as an}from"./chunk-MIRGHONI.js";import"./chunk-YUHFF3NM.js";import{A as Yt,B as Zt,H as en,L as tn,P as ye,Q as on,S as st,U as gn,g as zt,p as Jt,u as Xt,v as We}from"./chunk-3RYIB53E.js";import{j as rt,l as ae}from"./chunk-NL5E3FC5.js";import{b as ce}from"./chunk-YD3RJIHU.js";import{a as Qe,b as Pe,f as cn,g as pn,h as ln}from"./chunk-KK2SHN2W.js";import{f as Ft,g as At,h as Ne,i as Gt,j as Rt,k as Ut,m as Nt,n as Ht,o as Le,p as se,u as Qt,w as qe}from"./chunk-AP373D4K.js";import{a as be}from"./chunk-B6WYZ7BT.js";import{$c as Bt,Ab as D,B as ft,Bb as Oe,Bd as He,C as ht,Cb as ie,Cd as De,D as tt,Db as $t,F as E,Gb as p,Gd as qt,H as Ve,Ha as $,Hb as d,Ib as q,Id as J,Jd as F,K as Ct,Kd as A,L as _t,Ld as Wt,M as B,Ma as x,N as nt,Na as X,O as Fe,Oa as yt,Oc as Et,P as k,Pa as Ae,R as Q,Ra as T,Sb as Ot,Ta as Pt,Ua as j,Va as V,Wa as a,Wb as Lt,X as U,Xa as c,Ya as K,Yc as W,Zb as oe,_,_b as he,a as me,aa as L,ab as S,b as ue,cb as C,cd as jt,db as g,dd as Ce,ec as it,ed as _e,f as O,g as ge,gc as Ge,gd as Vt,h as ke,ha as vt,hb as Y,hd as ve,ia as v,ja as b,jb as St,kb as xt,l as ee,lb as wt,ma as bt,mb as It,n as u,nb as l,o as M,ob as w,pb as y,qa as ne,qb as Mt,rb as kt,rc as Re,s as Te,sb as Tt,sc as Dt,u as gt,uc as Ue,ud as re,w as te,wa as r,wb as N,wd as ot,x as $e,xa as h,xb as Z,yb as z,zb as fe}from"./chunk-IFJN5CDK.js";function xn(n,s){return+rt(n)==+rt(s)}function wn(n,s,e){let t=s.map(o=>({eventId:o,group:n})),i=e.map(o=>t.find(m=>m.eventId===o.eventId)||o);return[...new Set([...i,...t])].filter(o=>o.group!==null)}var ze=(()=>{class n extends en{static{this.\u0275fac=(()=>{let e;return function(i){return(e||(e=bt(n)))(i||n)}})()}static{this.\u0275prov=U({token:n,factory:n.\u0275fac})}}return n})();function In(n,s){return[...n].sort(Yn(s))}function Yn(n){return(s,e)=>{switch(n.primarySortKey){case"name":{let t=s.name.localeCompare(e.name);return n.ascending?t*-1:t}case"group":{let t=(s.detail.Value||"").localeCompare(e.detail.Value||"");return n.ascending?t*-1:t}}}}function Mn(n,s){return n.map(e=>Zn(e,s))}function Zn(n,s){return{id:n.IdPerson,name:s.find(e=>e.StudentRef.Id===n.IdPerson)?.StudentFullName||"",group:n.Value,detail:n}}function kn(n,s){return n.filter(e=>e.VssId===s.subscriptionDetailGroupId)}function pt(n,s){return n.find(e=>e.VssId===s.subscriptionDetailGroupId)}var ei=(n,s)=>s.id;function ti(n,s){if(n&1){let e=S();a(0,"div",1)(1,"input",5),C("change",function(){let i=v(e).$implicit,o=g();return b(o.onSelectionChange(i))}),c(),a(2,"label",6),l(3),c()()}if(n&2){let e=s.$implicit,t=s.$index,i=g();r(),Y("id","group-",t,""),x("checked",e.id===i.selected.id)("value",e.id),r(),Y("for","group-",t,""),r(),y(" ",e.label," ")}}var Ee=function(n){return n.Select="select",n.Assign="assign",n}(Ee||{}),Tn=(()=>{class n{constructor(e,t){this.activeModal=e,this.translate=t,this.groupOptions=[]}ngOnInit(){this.title=`presence-control.groups.${this.dialogMode}.title`;let e=this.createEmtpyOption();this.groupOptions=this.createGroupOptions(this.subscriptionDetailsDefinitions),this.groupOptions.unshift(e),this.selected=this.groupOptions.find(t=>t.id===this.group)||e}createEmtpyOption(){let e=this.dialogMode===Ee.Select?"presence-control.groups.all":"presence-control.groups.none";return{id:null,label:this.translate.instant(e)}}createGroupOptions(e){return e.DropdownItems?e.DropdownItems.map(t=>({id:t.Key,label:`${this.translate.instant("presence-control.groups.group")} ${t.Value}`})):[]}getSelectedGroup(){return this.selected}onSelectionChange(e){this.selected=e}static{this.\u0275fac=function(t){return new(t||n)(h(se),h(J))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-group-dialog"]],inputs:{dialogMode:"dialogMode",subscriptionDetailsDefinitions:"subscriptionDetailsDefinitions",group:"group"},standalone:!0,features:[D],decls:14,vars:9,consts:[[1,"modal-body"],[1,"form-check"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","radio","name","groups",1,"form-check-input",3,"change","id","checked","value"],[1,"form-check-label",3,"for"]],template:function(t,i){t&1&&(a(0,"div",0)(1,"p"),l(2),p(3,"translate"),c(),a(4,"form"),j(5,ti,4,7,"div",1,ei),c()(),a(7,"div",2)(8,"button",3),C("click",function(){return i.activeModal.dismiss()}),l(9),p(10,"translate"),c(),a(11,"button",4),C("click",function(){return i.activeModal.close(i.getSelectedGroup())}),l(12),p(13,"translate"),c()()),t&2&&(r(2),y(" ",d(3,3,i.title)," "),r(3),V(i.groupOptions),r(4),y(" ",d(10,5,"presence-control.groups.cancel")," "),r(3),y(" ",d(13,7,"presence-control.groups.save")," "))},dependencies:[re,ve,Ce,_e,A,F]})}}return n})();function $n(n,s,e,t){return n.map(i=>{let o=s.find(m=>ni(m.presence,i));if(o){let m;return!o.newPresenceTypeId&&i.Comment?m=e.find(f=>f.IsComment)||null:m=e.find(f=>f.Id===o.newPresenceTypeId)||null,ue(me({},i),{TypeRef:ii(m),Date:null,Type:m?m.Designation:null,ConfirmationStateId:We(m,t)})}return i})}function ni(n,s){return n.LessonRef.Id===s.LessonRef.Id&&n.StudentRef.Id===s.StudentRef.Id}function ii(n){return{Id:n?n.Id:null,HRef:null}}function Xe(n){return s=>s.reduce((e,t)=>e+(t.presenceCategory===n?1:0),0)}function On(){return n=>n.reduce((s,e)=>s+(e.precedingAbsences&&e.precedingAbsences.length>0?1:0),0)}var Ln=(()=>{class n extends Qe{constructor(e,t){super(e,t,ct,"LessonTeachers")}loadOtherTeachersLessonAbsences(e,t,i){let o=`${this.baseUrl}/except/${e}/LessonAbsences?expand=LessonRef`;return t&&t.length>0&&(o=o.concat("&filter.StudentRef=;"+t.join(";"))),this.http.get(o,{params:i}).pipe(k(qt(ct)))}static{this.\u0275fac=function(t){return new(t||n)(_(Ge),_(W))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var Ye=(()=>{class n extends Qe{constructor(e,t){super(e,t,mn,"SubscriptionDetails")}getListForEvent(e){return this.getList({params:{IdEvent:String(e)}})}update(e,t){let i={IdPerson:t.IdPerson,EventId:t.EventId,Value:e};return this.http.put(`${this.baseUrl}/${t.Id}`,i).pipe(u(()=>{}))}static{this.\u0275fac=function(t){return new(t||n)(_(Ge),_(W))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var En="presence-control-group",le=(()=>{class n{constructor(e,t,i,o,m){this.userSettings=e,this.eventService=t,this.subscriptionDetailsService=i,this.loadingService=o,this.settings=m,this.selectGroup$=new O,this.selectedLesson$=new ke,this.lessonPresences$=new ke,this.reloadSubscriptionDetails$=new O,this.defaultGroup=null,this.savedGroup$=this.selectedLesson$.pipe(k(f=>this.userSettings.getPresenceControlGroupView().pipe(u(I=>this.findGroupByLesson(I,f))))),this.group$=te(this.selectGroup$,this.savedGroup$).pipe(Fe(this.defaultGroup),B(1)),this.loading$=this.loadingService.loading(En),this.subscriptionDetailsDefinitions$=this.selectedLesson$.pipe(u(f=>f?.getEventIds()||[]),k(f=>Te(f.map(I=>this.eventService.getSubscriptionDetailsDefinitions(I)))),B(1)),this.groupsAvailability$=this.subscriptionDetailsDefinitions$.pipe(u(f=>f.every(I=>pt(I,this.settings))),B(1)),this.subscriptionDetails$=M([this.selectedLesson$,this.groupsAvailability$,this.reloadSubscriptionDetails$.pipe(u(()=>!1),Fe(!0))]).pipe(k(([f,I,G])=>f&&I?this.loadSubscriptionDetailsForLesson(f,G):ee([])),u(f=>kn(f,this.settings)),B(1)),this.subscriptionDetailPersonIds$=M([this.group$,this.subscriptionDetails$]).pipe(u(([f,I])=>I.filter(G=>G.Value===f).map(G=>G.IdPerson)),Fe([]))}selectGroup(e){this.selectGroup$.next(e)}setSelectedLesson(e){this.selectedLesson$.next(e)}setLessonPresences(e){this.lessonPresences$.next(e)}getSubscriptionDetailsDefinitions(){return this.subscriptionDetailsDefinitions$.pipe(u(ot),u(e=>pt(e,this.settings)))}getSubscriptionDetailsForStudents(){return M([this.subscriptionDetails$,this.lessonPresences$]).pipe(u(ae(Mn)))}reloadSubscriptionDetails(){this.reloadSubscriptionDetails$.next(void 0)}loadSubscriptionDetailsForLesson(e,t=!0){return this.loadingService.load(Te(De(e.getEventIds()).map(i=>this.subscriptionDetailsService.getListForEvent(i))),t?void 0:En).pipe(u(ot))}findGroupByLesson(e,t){return e.find(o=>o.eventId===t?.getEventIds()[0])?.group||this.defaultGroup}static{this.\u0275fac=function(t){return new(t||n)(_(xe),_(vn),_(Ye),_(ce),_(W))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac})}}return n})();var Vn=Object.values(de),H=(()=>{class n{constructor(e,t,i,o,m,f,I,G,we,Ie){this.userSettings=e,this.lessonPresencesService=t,this.lessonTeacherService=i,this.presenceTypesService=o,this.groupService=m,this.dropDownItemsService=f,this.loadingService=I,this.storageService=G,this.settings=we,this.location=Ie,this.selectedDateSubject$=new ge(new Date),this.selectedDate$=this.selectedDateSubject$.asObservable().pipe(u(P=>zt(P)),Ve(He)),this.viewModeSubject$=new O,this.viewMode$=te(this.viewModeSubject$,this.userSettings.getPresenceControlViewMode().pipe(E(1))),this.lessons$=this.selectedDate$.pipe(k(P=>this.loadLessonsByDate(P)),B(1)),this.selectLessonId$=new O,this.selectLesson$=this.selectLessonId$.pipe(k(P=>this.getLessonById(P))),this.selectedLesson$=M([cn(this.selectLesson$.pipe(Ve((P,Me)=>He(P,Me))),pn(this.settings.lessonPresencesRefreshTime)),this.lessons$]).pipe(u(([P,Me])=>Me.find(Jn=>Jn.id===P.id)?P:null),B(1)),this.studyClassCount$=this.selectedLesson$.pipe(u(P=>P?.lessons.length||0)),this.updateLessonPresences$=new O,this.reloadLessonPresences$=new O,this.lessonPresences$=te(ln(this.selectedLesson$,this.reloadLessonPresences$).pipe(k(P=>P?this.loadLessonPresencesByLesson(P):ee([]))),this.updateLessonPresences$).pipe(B(1)),this.presenceTypes$=this.loadPresenceTypes().pipe(B(1)),this.reloadStudentIdsWithUnconfirmedAbsences$=new O,this.studentIdsWithUnconfirmedAbsences$=te(this.selectedDate$,this.selectedLesson$.pipe(nt(1)),this.reloadStudentIdsWithUnconfirmedAbsences$).pipe(k(()=>this.loadStudentIdsWithUnconfirmedAbsences()),B(1)),this.loading$=this.loadingService.loading$,this.absenceConfirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe(B(1)),this.studentIds$=this.lessonPresences$.pipe(u(P=>De(P.map(Me=>Me.StudentRef.Id))),B(1)),this.otherTeachersAbsences$=this.studentIds$.pipe(Ve(He),k(P=>P.length>0?this.lessonTeacherService.loadOtherTeachersLessonAbsences(this.getMyself(),P):ee([])),B(1)),this.groupsAvailability$=this.groupService.groupsAvailability$,this.presenceControlEntries$=M([this.selectedLesson$,this.lessonPresences$,this.presenceTypes$,this.absenceConfirmationStates$,this.otherTeachersAbsences$]).pipe(u(ae(Yt))),this.presenceControlEntriesByGroup$=M([this.groupService.group$,this.presenceControlEntries$,this.groupService.subscriptionDetailPersonIds$]).pipe(u(ae(_n)),B(1)),this.presentCount$=this.presenceControlEntriesByGroup$.pipe(u(Xe("present"))),this.absentCount$=this.presenceControlEntriesByGroup$.pipe(u(Xe("absent"))),this.unapprovedCount$=this.presenceControlEntriesByGroup$.pipe(u(Xe("unapproved"))),this.absentPrecedingCount$=this.presenceControlEntriesByGroup$.pipe(u(On())),this.queryParamsString$=M([this.selectedDate$,this.selectedLesson$,this.viewMode$]).pipe(u(ae(this.buildQueryParams.bind(this))),u(an)),this.destroy$=new O,this.queryParamsString$.pipe(Q(this.destroy$)).subscribe(P=>{this.location.replaceState("/presence-control",P),this.confirmBackLinkParams={returnparams:P}}),this.viewMode$.pipe(nt(1),k(P=>this.userSettings.savePresenceControlViewMode(P)),Q(this.destroy$)).subscribe(),this.selectedLesson$.pipe(Q(this.destroy$)).subscribe(P=>{this.groupService.setSelectedLesson(P)}),this.lessonPresences$.pipe(Q(this.destroy$)).subscribe(P=>this.groupService.setLessonPresences(P))}ngOnDestroy(){this.destroy$.next()}setDate(e){this.selectedDateSubject$.next(e)}setLessonId(e){this.selectLessonId$.next(e)}setViewMode(e){this.viewModeSubject$.next(e)}updateLessonPresencesTypes(e){M([this.lessonPresences$.pipe(E(1)),this.presenceTypes$.pipe(E(1))]).pipe(u(([t,i])=>$n(t,e,i,this.settings))).subscribe(t=>this.updateLessonPresences$.next(t))}getNextPresenceType(e){return this.presenceTypes$.pipe(E(1),u(t=>e.getNextPresenceType(t)))}hasUnconfirmedAbsences(e){return this.studentIdsWithUnconfirmedAbsences$.pipe(u(t=>t.includes(e.lessonPresence.StudentRef.Id)))}updateAfterConfirm(){this.reloadLessonPresences$.next(),this.reloadStudentIdsWithUnconfirmedAbsences$.next()}loadLessonPresencesByLesson(e){return this.loadingService.load(this.lessonPresencesService.getListByLessons(e.lessons))}loadLessonsByDate(e){return this.loadingService.load(this.lessonPresencesService.getLessonsByDate(e)).pipe(u(hn))}loadPresenceTypes(){return this.loadingService.load(this.presenceTypesService.presenceTypes$)}loadStudentIdsWithUnconfirmedAbsences(){return gt(0,this.settings.unconfirmedAbsencesRefreshTime||-1).pipe(k(()=>this.lessonPresencesService.getListOfUnconfirmed()),u(e=>De(e.map(t=>t.StudentRef.Id))))}buildQueryParams(e,t,i){let o={date:Jt(e,"yyyy-MM-dd"),viewMode:i};return t&&(o.lesson=String(t.id)),o}getLessonById(e){let t=String(e);return this.lessons$.pipe(u(i=>t&&i.find(o=>o.id===t)||Cn(i)),$e(Boolean))}getMyself(){let e=this.storageService.getPayload();return Number(e?.holder_id||e?.id_person)}static{this.\u0275fac=function(t){return new(t||n)(_(xe),_(Ke),_(Ln),_(ye),_(le),_(nn),_(ce),_(Wt),_(W),_(Ot))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac})}}return n})();var ci=(n,s)=>s.id,pi=()=>[],li=()=>["/presence-control"];function di(n,s){if(n&1&&(a(0,"span",12),l(1),c()),n&2){let e=g().$implicit,t=g(),i=z(0);r(),w(t.getSortDirectionCharacter(i,e))}}function mi(n,s){if(n&1){let e=S();a(0,"div",11),C("click",function(){let i=v(e).$implicit,o=g();return b(o.toggleSort(i))}),l(1),p(2,"translate"),$(3,di,2,1,"span",12),c()}if(n&2){let e=s.$implicit;g();let t=z(0);x("className",e),r(),y(" ",d(2,3,"presence-control.groups.list.header."+e)," "),r(2),T(t?3:-1)}}function ui(n,s){n&1&&K(0,"bkd-spinner")}function gi(n,s){n&1&&K(0,"bkd-spinner",18)}function fi(n,s){if(n&1){let e=S();a(0,"div",13)(1,"div",14)(2,"input",15,0),p(4,"async"),C("change",function(){let i=v(e).$implicit,o=g(2);return b(o.selectionService.toggle(i))}),c()(),a(5,"div",16),l(6),c(),a(7,"div",17)(8,"span"),l(9),c(),$(10,gi,1,0,"bkd-spinner",18),p(11,"async"),c()()}if(n&2){let e=s.$implicit,t=g(2);r(2),x("checked",d(4,4,t.selectionService.isSelected$(e))),r(4),y(" ",e.name," "),r(3),w(e.group?e.group:""),r(),T(d(11,6,t.groupService.loading$)?10:-1)}}function hi(n,s){if(n&1&&j(0,fi,12,8,"div",13,ci),n&2){g();let e=z(2);V(e)}}var Gn=(()=>{class n{constructor(e,t,i,o,m,f,I,G,we){this.route=e,this.state=t,this.selectionService=i,this.groupService=o,this.userSettings=m,this.subscriptionDetailService=f,this.toastService=I,this.translate=G,this.modalService=we,this.primarySortKeys=["name","group"],this.backlinkQueryParams$=this.route.queryParams.pipe(u(({returnparams:Ie})=>Ie),u(sn)),this.eventIds$=this.state.selectedLesson$.pipe(u(Ie=>Ie?.getEventIds()||[])),this.sortCriteriaSubject$=new ge({primarySortKey:"name",ascending:!1}),this.sortCriteria$=this.sortCriteriaSubject$.asObservable(),this.sortedEntries$=M([this.groupService.getSubscriptionDetailsForStudents(),this.sortCriteria$]).pipe(u(ae(In))),this.selected=[]}ngOnInit(){this.selectionService.selection$.subscribe(e=>this.selected=e)}selectGroup(){this.openGroupModal(Ee.Select,this.selectCallback.bind(this))}assignGroup(){this.openGroupModal(Ee.Assign,this.assignCallback.bind(this))}openGroupModal(e,t){M([this.groupService.getSubscriptionDetailsDefinitions(),this.groupService.group$]).pipe(E(1)).subscribe(([i,o])=>{let m=this.modalService.open(Tn);m.componentInstance.dialogMode=e,m.componentInstance.subscriptionDetailsDefinitions=i,m.componentInstance.group=o,m.result.then(f=>{t(f)},()=>{})})}selectCallback(e){M([this.eventIds$,this.userSettings.getPresenceControlGroupView()]).pipe(E(1),k(([t,i])=>this.userSettings.savePresenceControlGroupView(wn(e.id,t,i))),u(()=>e.id)).subscribe(t=>this.groupService.selectGroup(t))}assignCallback(e){Te(this.selected.map(t=>this.subscriptionDetailService.update(e.id,t.detail))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.groupService.reloadSubscriptionDetails(),this.selectionService.clear(),this.toastService.success(this.translate.instant("presence-control.groups.notifications.save-success"))}getSortDirectionCharacter(e,t){return e.primarySortKey!==t?"":e.ascending?"\u2193":"\u2191"}toggleSort(e){this.sortCriteriaSubject$.pipe(E(1)).subscribe(t=>{t.primarySortKey===e?this.sortCriteriaSubject$.next({primarySortKey:e,ascending:!t.ascending}):this.sortCriteriaSubject$.next({primarySortKey:e,ascending:e==="name"})})}static{this.\u0275fac=function(t){return new(t||n)(h(Re),h(H),h(ze),h(le),h(xe),h(Ye),h(be),h(J),h(Se))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-group"]],standalone:!0,features:[fe([ze]),D],decls:33,vars:32,consts:[["checkbox",""],[3,"link","params"],[1,"group-header","mb-2","d-flex","justify-content-between"],[1,"d-flex","align-items-baseline"],[1,"ps-3"],["type","button",1,"show","btn","btn-link",3,"click"],["aria-label","edit",1,"btn","btn-primary","btn-icon","me-2",3,"click"],[1,"material-icons"],[1,"group-list"],[1,"group-list-header"],[3,"className"],[3,"click","className"],[1,"sort-direction"],[1,"group-list-entry"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"name","pe-2"],[1,"group","d-flex","justify-content-between"],[1,"inline","small"]],template:function(t,i){if(t&1){let o=S();N(0),p(1,"async"),N(2),p(3,"async"),N(4),p(5,"async"),N(6),p(7,"async"),a(8,"div"),K(9,"bkd-backlink",1),p(10,"async"),a(11,"h1"),l(12),p(13,"translate"),c(),a(14,"div",2)(15,"div",3)(16,"span",4),l(17),p(18,"translate"),c(),a(19,"button",5),C("click",function(){return v(o),b(i.selectGroup())}),l(20),p(21,"translate"),p(22,"translate"),c()(),a(23,"a",6),C("click",function(){return v(o),b(i.assignGroup())}),a(24,"i",7),l(25,"edit"),c()()(),a(26,"div",8)(27,"div",9),j(28,mi,4,5,"div",10,Pt),c(),$(30,ui,1,0,"bkd-spinner"),p(31,"async"),$(32,hi,2,0),c()()}if(t&2){let o;Z(d(1,8,i.sortCriteria$)),r(2),Z(d(3,11,i.sortedEntries$));let m=(o=d(5,14,i.selectionService.selection$))!==null&&o!==void 0?o:Oe(30,pi),f=d(7,16,i.groupService.group$);r(7),x("link",Oe(31,li))("params",d(10,18,i.backlinkQueryParams$)),r(3),w(d(13,20,"presence-control.groups.title")),r(5),w(d(18,22,"presence-control.groups.show")),r(3),y(" ",f?d(21,24,"presence-control.groups.group")+" "+f:d(22,26,"presence-control.groups.all")," "),r(3),X("disabled",m.length===0),r(5),V(i.primarySortKeys),r(2),T(d(31,28,i.state.loading$)?30:32)}},dependencies:[gn,Pe,oe,A,F],styles:['[_nghost-%COMP%]{display:block}.group-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:#000;font-weight:300;text-decoration:underline;padding-left:.5rem}.group-header[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{text-decoration-color:#ea161f}.group-list-header[_ngcontent-%COMP%]{cursor:pointer;padding:1rem;display:grid;grid-template-areas:"name group";grid-template-columns:3fr 2fr;border-top:1px solid #dee2e6;border-bottom:2px solid #dee2e6}.group-list-entry[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6;display:grid;grid-template-areas:"checkbox name group";grid-template-columns:min-content 3fr 2fr}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.3rem 1rem 0 0}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.name[_ngcontent-%COMP%]{grid-area:name;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.group[_ngcontent-%COMP%]{grid-area:group}@media (max-width: 750px){.group-list[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.group-list-header[_ngcontent-%COMP%]{grid-template-columns:3fr 1fr}.group-list-entry[_ngcontent-%COMP%]{grid-template-columns:min-content 3fr 1fr}}'],changeDetection:0})}}return n})();var Ci=(n,s)=>s.entry.id;function _i(n,s){if(n&1){let e=S();a(0,"div",1)(1,"input",5),C("change",function(){let i=v(e).$implicit;return b(i.selected=!i.selected)}),c(),a(2,"label",6)(3,"i"),l(4),c(),a(5,"div",7),l(6),p(7,"date"),p(8,"date"),c()()()}if(n&2){let e=s.$implicit,t=s.$index,i=g();r(),Y("id","lesson-presence-",t,""),x("checked",e.selected),r(),X("fw-bold",i.isCurrentLesson(e)),Y("for","lesson-presence-",t,""),r(),Ae("",e.entry.presenceCategory," material-icons pe-2"),r(),w(e.entry.presenceCategoryIcon),r(2),kt(" ",q(7,14,e.entry.lessonPresence.LessonDateTimeFrom,"HH:mm"),"\u2013",q(8,17,e.entry.lessonPresence.LessonDateTimeTo,"HH:mm")," ",e.entry.lessonPresence.EventDesignation," ")}}var Rn=(()=>{class n{constructor(e){this.activeModal=e,this.blockLessonOptions=[]}ngOnInit(){this.blockLessonOptions=this.buildLessonPresenceOptions()}getSelectedEntries(){return this.blockLessonOptions.filter(({selected:e})=>e).map(({entry:e})=>e)}isCurrentLesson(e){return xn(e.entry.lessonPresence.LessonDateTimeFrom,this.entry.lessonPresence.LessonDateTimeFrom)}buildLessonPresenceOptions(){return this.blockPresenceControlEntries.map(e=>({entry:e,selected:this.entry.confirmationState===e.confirmationState}))}static{this.\u0275fac=function(t){return new(t||n)(h(se))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-block-lesson-component"]],inputs:{entry:"entry",blockPresenceControlEntries:"blockPresenceControlEntries"},standalone:!0,features:[D],decls:15,vars:11,consts:[[1,"modal-body"],[1,"form-check"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click","disabled"],["type","checkbox",1,"form-check-input",3,"change","id","checked"],[1,"form-check-label","d-flex",3,"for"],[1,"d-block","text-truncate"]],template:function(t,i){if(t&1){let o=S();a(0,"div",0)(1,"p"),l(2),p(3,"translate"),c(),a(4,"form"),j(5,_i,9,20,"div",1,Ci),c()(),N(7),a(8,"div",2)(9,"button",3),C("click",function(){return v(o),b(i.activeModal.close())}),l(10),p(11,"translate"),c(),a(12,"button",4),C("click",function(){v(o);let f=z(7);return b(i.activeModal.close(f))}),l(13),p(14,"translate"),c()()}if(t&2){r(2),y(" ",d(3,4,"presence-control.block-lesson.text")," "),r(3),V(i.blockLessonOptions),r(2);let o=Z(i.getSelectedEntries());r(3),y(" ",d(11,7,"presence-control.block-lesson.cancel")," "),r(2),x("disabled",o.length===0),r(),y(" ",d(14,9,"presence-control.block-lesson.save")," ")}},dependencies:[re,ve,Ce,_e,he,A,F],styles:[".checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.absent[_ngcontent-%COMP%]{color:#ea161f}.present[_ngcontent-%COMP%]{color:#3d8608}.unapproved[_ngcontent-%COMP%]{color:#ffa814}"]})}}return n})();var vi=30;function ut(n){return`blockLesson${n.lessonPresence.Id}`}var Ze=(()=>{class n{constructor(e,t,i,o){this.state=e,this.lessonPresencesService=t,this.loadingService=i,this.settings=o}getBlockLessonPresenceControlEntries(e){return M([this.state.lessons$.pipe(E(1)),this.loadChangeableLessonPresences(e),this.state.presenceTypes$.pipe(E(1)),this.state.absenceConfirmationStates$.pipe(E(1)),this.state.otherTeachersAbsences$.pipe(E(1))]).pipe(u(([t,i,o,m,f])=>this.filterBlockLessonPresences(e,i).map(I=>Zt(t.find(G=>G.id===I.LessonRef.Id.toString()),I,o,m,f))))}filterBlockLessonPresences(e,t){return[...t].sort((i,o)=>i.LessonDateTimeFrom>o.LessonDateTimeFrom?1:-1).reduce((i,o)=>{let m=i[i.length-1];return this.isWithinBlockTime(o,m)?(i.push(o),i):i.find(f=>f.Id===e.lessonPresence.Id)?i:[o]},[])}isWithinBlockTime(e,t){return t?e.LessonDateTimeFrom.getTime()-t.LessonDateTimeTo.getTime()<=vi*60*1e3:!0}loadChangeableLessonPresences(e){return M([this.loadLessonPresences(e),this.state.presenceTypes$.pipe(E(1))]).pipe(u(([t,i])=>t.filter(o=>Xt(o,i.find(m=>m.Id===o.TypeRef.Id)||null,this.settings))))}loadLessonPresences(e){return this.loadingService.load(this.lessonPresencesService.getListByDateStudentClass(e.lessonPresence.LessonDateTimeFrom,e.lessonPresence.StudentRef.Id,e.lessonPresence.StudyClassRef.Id??void 0).pipe(u(t=>t.filter(i=>i.TeacherInformation===e.lessonPresence.TeacherInformation))),ut(e))}static{this.\u0275fac=function(t){return new(t||n)(_(H),_(Ke),_(ce),_(W))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac})}}return n})();var yi=(n,s)=>s.Id;function Pi(n,s){if(n&1&&(a(0,"div"),l(1),p(2,"date"),p(3,"date"),p(4,"addSpace"),c()),n&2){let e=s.$implicit;r(),Tt(" ",q(2,5,e.LessonRef.From,"HH:mm"),"\u2013",q(3,8,e.LessonRef.To,"HH:mm")," ",e.LessonRef.EventDesignation,"",q(4,11,":",":")," ",e.Type," ")}}var Un=(()=>{class n{constructor(e){this.activeModal=e}static{this.\u0275fac=function(t){return new(t||n)(h(se))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-preceding-absence"]],inputs:{precedingAbsences:"precedingAbsences"},standalone:!0,features:[D],decls:10,vars:6,consts:[[1,"modal-body"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"]],template:function(t,i){t&1&&(a(0,"div",0)(1,"p"),l(2),p(3,"translate"),c(),j(4,Pi,5,14,"div",null,yi),c(),a(6,"div",1)(7,"button",2),C("click",function(){return i.activeModal.dismiss()}),l(8),p(9,"translate"),c()()),t&2&&(r(2),y(" ",d(3,2,"presence-control.preceding-absence.text")," "),r(2),V(i.precedingAbsences),r(4),y(" ",d(9,4,"presence-control.preceding-absence.cancel")," "))},dependencies:[he,A,F,dn]})}}return n})();var Si=n=>["student",n,"absences"],xi=n=>["/presence-control/student",n,"absences"];function wi(n,s){if(n&1&&(K(0,"bkd-avatar",0),p(1,"async")),n&2){let e=g();x("studentId",d(1,3,e.studentId$))("link",ie(5,xi,e.entry.lessonPresence.StudentRef.Id.toString()))("linkParams",e.profileReturnParams)}}function Ii(n,s){if(n&1&&(a(0,"span"),l(1),c()),n&2){let e=g(2);r(),w(e.entry.presenceType==null?null:e.entry.presenceType.Designation)}}function Mi(n,s){if(n&1){let e=S();a(0,"button",12),C("click",function(){v(e);let i=g();return b(i.updatePresenceType(i.entry))}),$(1,Ii,2,1,"span"),c()}if(n&2){let e=g();r(),T(e.entry.presenceType!=null&&e.entry.presenceType.IsIncident?-1:1)}}function ki(n,s){n&1&&K(0,"bkd-spinner",5)}function Ti(n,s){if(n&1){let e=S();a(0,"button",13),C("click",function(){v(e);let i=g();return b(i.showPrecedingAbsences(i.entry))}),a(1,"i",14),l(2,"info"),c()()}}function $i(n,s){if(n&1&&(a(0,"span",9),l(1),c()),n&2){let e=g();r(),y(" ",e.entry.lessonPresence.StudyClassNumber," ")}}function Oi(n,s){if(n&1){let e=S();a(0,"a",15),C("click",function(){v(e);let i=g();return b(i.updateIncident(i.entry))}),a(1,"i",4),l(2,"edit"),c(),a(3,"span"),l(4),p(5,"translate"),c()()}if(n&2){let e=g();r(4),w(d(5,1,(e.entry.presenceType==null?null:e.entry.presenceType.IsIncident)&&(e.entry.presenceType==null?null:e.entry.presenceType.Designation)||"presence-control.entry.incident"))}}var Nn=(()=>{class n{get classNames(){return[this.entry.presenceCategory,this.viewMode].join(" ")}constructor(e,t,i,o){this.toastService=e,this.translate=t,this.modalService=i,this.loadingService=o,this.hasUnconfirmedAbsences=!1,this.showClassName=!1,this.togglePresenceType=new ne,this.changeIncident=new ne,this.entry$=new ke(1),this.studentId$=this.entry$.pipe(u(({lessonPresence:m})=>m.StudentRef.Id)),this.loading$=this.entry$.pipe(k(m=>this.loadingService.loading(ut(m))))}ngOnChanges(e){e.entry&&this.entry$.next(e.entry.currentValue)}get isListViewMode(){return this.viewMode===de.List}updatePresenceType(e){e.canChangePresenceType?this.togglePresenceType.emit(e):this.toastService.warning(this.translate.instant("presence-control.entry.update-warning"))}updateIncident(e){e.canChangeIncident&&this.changeIncident.emit(e)}showPrecedingAbsences(e){let t=this.modalService.open(Un);t.componentInstance.precedingAbsences=e.precedingAbsences}static{this.\u0275fac=function(t){return new(t||n)(h(be),h(J),h(Se),h(ce))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-entry"]],hostVars:2,hostBindings:function(t,i){t&2&&yt(i.classNames)},inputs:{entry:"entry",hasUnconfirmedAbsences:"hasUnconfirmedAbsences",viewMode:"viewMode",showClassName:"showClassName",profileReturnParams:"profileReturnParams"},outputs:{togglePresenceType:"togglePresenceType",changeIncident:"changeIncident"},standalone:!0,features:[vt,D],decls:18,vars:20,consts:[[1,"avatar","large",3,"studentId","link","linkParams"],["type","button",1,"presence-category","designation","btn","btn-link"],["type","button",1,"presence-category","status","btn","btn-link",3,"click","disabled"],[1,"position-relative"],[1,"material-icons"],[1,"inline","small"],["type","button",1,"previously-absent","d-flex","btn","btn-link"],[1,"student-info",3,"routerLink","queryParams"],[1,"student-name","text-truncate"],[1,"study-class","text-truncate"],[1,"unconfirmed-absences"],[1,"incident","btn","btn-link"],["type","button",1,"presence-category","designation","btn","btn-link",3,"click"],["type","button",1,"previously-absent","d-flex","btn","btn-link",3,"click"],[1,"material-icons-outlined"],[1,"incident","btn","btn-link",3,"click"]],template:function(t,i){if(t&1){let o=S();$(0,wi,2,7,"bkd-avatar",0)(1,Mi,2,1,"button",1),N(2),p(3,"async"),a(4,"button",2),C("click",function(){return v(o),b(i.updatePresenceType(i.entry))}),a(5,"div",3)(6,"i",4),l(7),c(),$(8,ki,1,0,"bkd-spinner",5),c()(),$(9,Ti,3,0,"button",6),a(10,"a",7)(11,"span",8),l(12),c(),$(13,$i,2,1,"span",9),a(14,"span",10),l(15),p(16,"translate"),c()(),$(17,Oi,6,3,"a",11)}if(t&2){T(i.isListViewMode?-1:0),r(),T(i.entry.showDesignation?1:-1);let o=d(3,14,i.loading$);r(3),x("disabled",o),r(2),X("invisible",o),r(),w(i.entry.presenceCategoryIcon),r(),T(o?8:-1),r(),T(i.entry.precedingAbsences!=null&&i.entry.precedingAbsences.length?9:-1),r(),x("routerLink",ie(18,Si,i.entry.lessonPresence.StudentRef.Id))("queryParams",i.profileReturnParams),r(2),w(i.entry.lessonPresence.StudentFullName),r(),T(i.isListViewMode&&i.showClassName?13:-1),r(2),y(" ",i.hasUnconfirmedAbsences?d(16,16,"presence-control.entry.unconfirmed-absences"):""," "),r(2),T(i.entry.canChangeIncident?17:-1)}},dependencies:[un,Pe,Ue,oe,A,F],styles:['[_nghost-%COMP%]{padding:2rem 1rem;background-color:#fff;display:grid;grid-template-areas:"avatar status designation previously-absent" "avatar student-info student-info student-info" "avatar incident incident incident";grid-template-columns:min-content min-content 3fr min-content}[_nghost-%COMP%] > *[_ngcontent-%COMP%]{align-self:center}.presence-category[_ngcontent-%COMP%]{text-decoration:none}.presence-category[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{top:.1875rem}.absent[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#ea161f}.present[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#3d8608}.unapproved[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#ffa814}.presence-category[_ngcontent-%COMP%]   bkd-spinner[_ngcontent-%COMP%]{color:#000;position:absolute;top:4px;left:5px}.designation[_ngcontent-%COMP%], .student-info[_ngcontent-%COMP%], a.incident[_ngcontent-%COMP%], .incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.avatar[_ngcontent-%COMP%]{grid-area:avatar;margin-right:1.5rem}.status[_ngcontent-%COMP%]{grid-area:status}.status[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:2rem}.designation[_ngcontent-%COMP%]{grid-area:designation;text-align:left;line-height:2.375rem}.previously-absent[_ngcontent-%COMP%]{grid-area:previously-absent;text-decoration:none;color:#00000080;justify-self:end}.student-info[_ngcontent-%COMP%]{grid-area:student-info;display:flex;flex-direction:column;text-decoration:none}.student-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child{text-decoration:underline}.student-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:first-child:hover{text-decoration-color:#ea161f}.unconfirmed-absences[_ngcontent-%COMP%]{color:#ea161f;font-size:.875rem;line-height:1}.study-class[_ngcontent-%COMP%]{font-size:.875rem;line-height:1}.incident[_ngcontent-%COMP%]{color:#00000080;padding-right:1.5rem;grid-area:incident;display:flex;text-decoration:none}.incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{text-decoration:underline}.incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:hover{text-decoration-color:#ea161f}.incident[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{margin-right:.3em}.grid[_nghost-%COMP%]   .status[_ngcontent-%COMP%], .grid[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{align-self:start;margin-left:-1.5rem;margin-top:-.375rem}.grid[_nghost-%COMP%]   .incident[_ngcontent-%COMP%]{align-self:end;margin-left:-1.5rem;margin-bottom:-.375rem}.grid[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-right:0;align-self:start}.grid[_nghost-%COMP%]   .unconfirmed-absences[_ngcontent-%COMP%]{height:.875rem}.list[_nghost-%COMP%]{grid-template-areas:"student-info status incidentordesignation previously-absent";grid-template-columns:3fr min-content 4fr 3em;padding:.5rem 1rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{justify-self:start}.list[_nghost-%COMP%]   .student-name[_ngcontent-%COMP%]{line-height:1;margin-bottom:.5rem}.list[_nghost-%COMP%]   .incident[_ngcontent-%COMP%], .list[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{grid-area:incidentordesignation}.list[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-right:0}@media (max-width: 750px){.list[_nghost-%COMP%]{grid-template-areas:"student-info student-info student-info previously-absent" "status incidentordesignation incidentordesignation incidentordesignation";grid-template-columns:min-content 1fr 1fr min-content;row-gap:1rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.list[_nghost-%COMP%]   .student-name[_ngcontent-%COMP%]{margin-top:.5rem}.list[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{align-self:start}}']})}}return n})();var Li=(n,s)=>s.viewMode,Di=(n,s)=>s.id,Ei=(n,s)=>({"btn-link":n,"btn-danger":s}),Bi=n=>["groups",n],ji=n=>({returnparams:n});function Vi(n,s){if(n&1){let e=S();a(0,"div",22),C("click",function(){v(e);let i=g();return b(i.lessonDropdown==null?null:i.lessonDropdown.toggle())}),l(1),p(2,"date"),a(3,"span",23),l(4),p(5,"date"),c()()}if(n&2){let e=g();r(),y(" ",q(2,2,e.selectedLesson.LessonDateTimeFrom,"HH:mm"),"\u2013"),r(3),w(q(5,5,e.selectedLesson.LessonDateTimeTo,"HH:mm"))}}function Fi(n,s){if(n&1){let e=S();a(0,"div",28),C("click",function(){let i=v(e).$implicit,o=g(2);return b(o.selectLessonChange.emit(i))}),a(1,"div",29)(2,"div"),l(3),p(4,"date"),p(5,"date"),c(),a(6,"div",25),l(7),c(),a(8,"div",25),l(9),c()()()}if(n&2){let e=s.$implicit,t=g(2);X("active",e.id===t.selectedLesson.id),r(3),Mt(" ",q(4,6,e.LessonDateTimeFrom,"HH:mm"),"\u2013",q(5,9,e.LessonDateTimeTo,"HH:mm")," "),r(4),y(" ",e.eventDesignations," "),r(2),y(" ",e.studyClassNumbers," ")}}function Ai(n,s){if(n&1&&(a(0,"div",7)(1,"div",24)(2,"div",25),l(3),c(),a(4,"div",25),l(5),c()(),a(6,"div",26),j(7,Fi,10,12,"div",27,Di),c()()),n&2){let e=g();r(3),w(e.selectedLesson.eventDesignations),r(2),w(e.selectedLesson.studyClassNumbers),r(2),V(e.lessons)}}function Gi(n,s){if(n&1){let e=S();a(0,"bkd-caret",30),C("click",function(){v(e);let i=g();return b(i.lessonDropdown==null?null:i.lessonDropdown.toggle())}),c()}if(n&2){let e=g();x("expanded",(e.lessonDropdown==null?null:e.lessonDropdown.isOpen())||!1)}}function Ri(n,s){if(n&1&&(a(0,"a",19),p(1,"async"),p(2,"async"),p(3,"async"),a(4,"i",31),l(5,"groups"),c()()),n&2){let e=g();x("ngClass",$t(9,Ei,d(1,3,e.isGroupSelected$)===!1,d(2,5,e.isGroupSelected$)))("routerLink",ie(12,Bi,e.selectedLesson.id))("queryParams",ie(14,ji,d(3,7,e.state.queryParamsString$)))}}function Ui(n,s){if(n&1){let e=S();a(0,"button",32),C("click",function(){let i=v(e).$implicit,o=g();return b(o.viewModeChange.emit(i.viewMode))}),a(1,"i",31),l(2),c()()}if(n&2){let e=s.$implicit,t=g();X("btn-outline-secondary",e.viewMode===t.viewMode)("btn-link",e.viewMode!==t.viewMode)("active",e.viewMode===t.viewMode),x("disabled",!t.selectedLesson),r(2),w(e.icon)}}var Ni=Le.prototype._positionMenu;Le.prototype._positionMenu=function(...s){let e=Ni.apply(this,s);if(this._anchor.nativeElement.id==="lesson-dropdown"){let t=this._bodyContainer||this._menu.nativeElement,i=t.style.transform?.match(/translate\(([0-9-.]+)px, ([0-9-.]+)px\)/);i&&parseFloat(i[1])<0&&(t.style.transform=`translate(0px, ${i[2]}px)`)}return e};var Hn=(()=>{class n{constructor(e,t,i){this.state=e,this.groupService=t,this.presentCount=null,this.absentCount=null,this.unapprovedCount=null,this.absentPrecedingCount=null,this.search="",this.selectLessonChange=new ne,this.selectDateChange=new ne,this.searchChange=new ne,this.viewModeChange=new ne,this.viewModeOptions=[{viewMode:de.List,icon:"list"},{viewMode:de.Grid,icon:"view_module"}],this.isGroupSelected$=this.groupService.group$.pipe(u(Qt)),i.popperOptions=o=>ue(me({},o),{modifiers:o.modifiers?.map(m=>(m.name==="offset"&&(m.options={offset:({placement:f,reference:I,popper:G})=>f==="bottom-start"?[(window.innerWidth-G.width)/2-I.x,0]:[]}),m))})}static{this.\u0275fac=function(t){return new(t||n)(h(H),h(le),h(Ne))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-header"]],viewQuery:function(t,i){if(t&1&&St(Le,5),t&2){let o;xt(o=wt())&&(i.lessonDropdown=o.first)}},inputs:{selectedLesson:"selectedLesson",lessons:"lessons",presentCount:"presentCount",absentCount:"absentCount",unapprovedCount:"unapprovedCount",absentPrecedingCount:"absentPrecedingCount",viewMode:"viewMode",selectDate:"selectDate",search:"search"},outputs:{selectLessonChange:"selectLessonChange",selectDateChange:"selectDateChange",searchChange:"searchChange",viewModeChange:"viewModeChange"},standalone:!0,features:[fe([Ne,{provide:Ft,useClass:Rt},{provide:At,useClass:yn}]),D],decls:41,vars:19,consts:[["d","ngbDatepicker"],[1,"navigation"],[1,"lesson-date"],["type","button",1,"btn","btn-link",3,"click"],[1,"material-icons"],["positionTarget",".lesson-date-input","ngbDatepicker","","placement","bottom-start",1,"lesson-date-input",3,"ngModelChange","ngModel"],[1,"lesson-time"],["ngbDropdown","","container","body","display","dynamic","placement","bottom",1,"lesson-description"],[1,"dropdown-caret",3,"expanded"],[1,"states"],[1,"state","present"],[1,"count"],[1,"state","absent"],[1,"state","unapproved"],[1,"state","previously-absent"],[1,"material-icons-outlined"],[1,"search-and-views"],[1,"search",3,"valueChange","value","disabled","placeholder","label"],[1,"group-and-views","d-flex","align-items-center"],["type","button",1,"group","btn","me-2","me-sm-4",3,"ngClass","routerLink","queryParams"],[1,"views"],["type","button",1,"view","btn","btn-primary","btn-icon",3,"disabled","btn-outline-secondary","btn-link","active"],[1,"lesson-time",3,"click"],[1,"lesson-time-to"],["id","lesson-dropdown","ngbDropdownToggle",""],[1,"text-truncate"],["ngbDropdownMenu","","aria-labelledby","lesson-dropdown"],["ngbDropdownItem","",3,"active"],["ngbDropdownItem","",3,"click"],[1,"lesson-entry"],[1,"dropdown-caret",3,"click","expanded"],[1,"material-icons","align-middle"],["type","button",1,"view","btn","btn-primary","btn-icon",3,"click","disabled"]],template:function(t,i){if(t&1){let o=S();a(0,"div",1)(1,"div",2)(2,"button",3),C("click",function(){v(o);let f=It(6);return b(f.toggle())}),a(3,"i",4),l(4,"calendar_today"),c()(),a(5,"input",5,0),C("ngModelChange",function(f){return v(o),b(i.selectDateChange.emit(f))}),c()(),$(7,Vi,6,8,"div",6)(8,Ai,9,2,"div",7)(9,Gi,1,1,"bkd-caret",8),c(),a(10,"div",9)(11,"div",10)(12,"i",4),l(13,"check_circle"),c(),a(14,"span",11),l(15),c()(),a(16,"div",12)(17,"i",4),l(18,"cancel"),c(),a(19,"span",11),l(20),c()(),a(21,"div",13)(22,"i",4),l(23,"help"),c(),a(24,"span",11),l(25),c()(),a(26,"div",14)(27,"i",15),l(28,"info"),c(),a(29,"span",11),l(30),c()()(),a(31,"div",16)(32,"bkd-resettable-input",17),p(33,"translate"),p(34,"translate"),C("valueChange",function(f){return v(o),b(i.searchChange.emit(f))}),c(),a(35,"div",18),$(36,Ri,6,16,"a",19),p(37,"async"),a(38,"div",20),j(39,Ui,3,8,"button",21,Li),c()()()}t&2&&(r(5),x("ngModel",i.selectDate),r(2),T(i.selectedLesson?7:-1),r(),T(i.selectedLesson?8:-1),r(),T(i.lessons.length>0?9:-1),r(6),w(i.presentCount!==null?i.presentCount:"?"),r(5),w(i.absentCount!==null?i.absentCount:"?"),r(5),w(i.unapprovedCount!==null?i.unapprovedCount:"?"),r(5),w(i.absentPrecedingCount!==null?i.absentPrecedingCount:"?"),r(2),x("value",i.search)("disabled",!i.selectedLesson)("placeholder",d(33,13,"presence-control.header.search-by-name"))("label",d(34,15,"presence-control.header.search")),r(4),T(d(37,17,i.selectedLesson&&i.state.groupsAvailability$)?36:-1),r(3),V(i.viewModeOptions))},dependencies:[Gt,re,Bt,jt,Vt,Le,Ht,Nt,Ut,rn,Pn,Lt,Ue,oe,he,A,F],styles:['[_nghost-%COMP%]{display:flex;flex-direction:column;padding:.75rem 0}.navigation[_ngcontent-%COMP%]{display:grid;grid-template-areas:". date time dropdown-caret" ". description description dropdown-caret";grid-template-columns:1fr auto auto 1fr;align-items:center}.lesson-date[_ngcontent-%COMP%]{grid-area:date;justify-self:end;display:flex;align-items:center;justify-content:flex-end}.lesson-date[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:0 .5ch 0 0}.lesson-date[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#000;position:relative}.lesson-date-input[_ngcontent-%COMP%]{font-weight:600;background:transparent;border:none;width:11ch}.lesson-time[_ngcontent-%COMP%]{grid-area:time;cursor:pointer}.lesson-description[_ngcontent-%COMP%]{grid-area:description;overflow:hidden;text-align:center;cursor:pointer}.dropdown-toggle[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.dropdown-toggle[_ngcontent-%COMP%]:after{display:none}.dropdown-caret[_ngcontent-%COMP%]{grid-area:dropdown-caret;line-height:100%;text-align:left;color:#000}.dropdown-menu[_ngcontent-%COMP%]{width:50ch;padding:0;box-shadow:2px 2px 3px -1px #0003}@media (max-width: 800px){.dropdown-menu[_ngcontent-%COMP%]{width:100vw}}.dropdown-item[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #dee2e6}.states[_ngcontent-%COMP%]{margin:.75rem 0;display:flex;justify-content:center}.state[_ngcontent-%COMP%]{margin-right:7%;display:flex}.state[_ngcontent-%COMP%]:last-child{margin-right:0}@media (min-width: 1000px){.state[_ngcontent-%COMP%]{margin-right:4rem}}.state.present[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#3d8608}.state.absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#ea161f}.state.unapproved[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#ffa814}.state.previously-absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#00000080}.state[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{margin-left:.3em;margin-top:1px}.search-and-views[_ngcontent-%COMP%]{padding-top:.75rem;display:flex;justify-content:space-between;border-top:1px solid #dee2e6}.search[_ngcontent-%COMP%]{flex:auto;max-width:300px;margin-right:1rem}.views[_ngcontent-%COMP%]{display:flex}.view[_ngcontent-%COMP%]{color:#4e4e4ef2;background-color:#fff}.view.active[_ngcontent-%COMP%]{color:#fff;background-color:#4e4e4ef2;border:none}.group[_ngcontent-%COMP%], .view[_ngcontent-%COMP%]{text-decoration:none;padding-left:0;padding-right:0;aspect-ratio:1/1;width:calc(.75rem + 2 * var(--bs-border-width) + 1.625rem);border-radius:50%}.group.btn-link[_ngcontent-%COMP%]{color:#000}@media (max-width: 380px){[_nghost-%COMP%]{padding-left:.5rem;padding-right:.5rem}#search-addon[_ngcontent-%COMP%]{padding-left:.5rem;padding-right:.5rem}}@media (max-width: 365px){.lesson-time[_ngcontent-%COMP%]{line-height:1}.lesson-time-to[_ngcontent-%COMP%]{display:block}.dropdown-caret[_ngcontent-%COMP%]{padding-left:0}}']})}}return n})();var Hi=(n,s)=>s.id;function qi(n,s){if(n&1){let e=S();a(0,"div",1)(1,"input",5),C("change",function(){let i=v(e).$implicit,o=g();return b(o.onSelectionChange(i))}),c(),a(2,"label",6),l(3),c()()}if(n&2){let e=s.$implicit,t=s.$index,i=g();r(),Y("id","incident-",t,""),x("checked",e.id===i.selected.id)("value",e.id),r(),Y("for","incident-",t,""),r(),y(" ",e.label," ")}}var qn=(()=>{class n{constructor(e,t){this.activeModal=e,this.translate=t,this.incidentOptions=[]}ngOnInit(){let e=this.createIncidentOption();this.incidentOptions=this.incidentTypes.map(t=>this.createIncidentOption(t)),this.incidentOptions.unshift(e),this.selected=this.incidentOptions.find(t=>t.id===this.incident?.Id)||e}createIncidentOption(e){return{id:e?e.Id:null,label:e?e.Designation:this.translate.instant("presence-control.incident.no-incident")}}onSelectionChange(e){this.selected=e}getSelectedIncident(){return this.incidentTypes.find(e=>e.Id===this.selected?.id)||null}static{this.\u0275fac=function(t){return new(t||n)(h(se),h(J))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-incident"]],inputs:{incident:"incident",incidentTypes:"incidentTypes"},standalone:!0,features:[D],decls:14,vars:9,consts:[[1,"modal-body"],[1,"form-check"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],["type","radio","name","incident",1,"form-check-input",3,"change","id","checked","value"],[1,"form-check-label",3,"for"]],template:function(t,i){t&1&&(a(0,"div",0)(1,"p"),l(2),p(3,"translate"),c(),a(4,"form"),j(5,qi,4,7,"div",1,Hi),c()(),a(7,"div",2)(8,"button",3),C("click",function(){return i.activeModal.dismiss()}),l(9),p(10,"translate"),c(),a(11,"button",4),C("click",function(){return i.activeModal.close(i.getSelectedIncident())}),l(12),p(13,"translate"),c()()),t&2&&(r(2),y(" ",d(3,3,"presence-control.incident.text")," "),r(3),V(i.incidentOptions),r(4),y(" ",d(10,5,"presence-control.incident.cancel")," "),r(3),y(" ",d(13,7,"presence-control.incident.save")," "))},dependencies:[re,ve,Ce,_e,A,F],styles:["form[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:first-child{border-bottom:1px solid #dee2e6;padding-bottom:1rem;margin-bottom:1rem}"]})}}return n})();var Wi=20,Qi=100,je=function(n){return n.AddUpdateAction="ADD",n.RemoveUpdateAction="REMOVE",n}(je||{}),et=(()=>{class n{constructor(e,t,i,o,m){this.toastService=e,this.translate=t,this.restService=i,this.presenceTypesService=o,this.settings=m,this.destroy$=new O,this.action$=new O,this.pendingUpdates$=this.action$.pipe(Ct(this.reduceUpdates.bind(this),[]),_t()),this.revertUpdates$=new O,this.performUpdates$=this.pendingUpdates$.pipe(tt(Qi),$e(qe(st)),ht(this.performUpdates.bind(this))),this.stateUpdates$=te(this.pendingUpdates$,this.revertUpdates$).pipe(tt(Wi),$e(qe(st))),this.performUpdates$.pipe(Q(this.destroy$)).subscribe()}ngOnDestroy(){this.destroy$.next()}updatePresenceType(e,t=null){this.dispatchAddUpdate(e.lessonPresence,t)}performUpdates(e){let t=this.groupUpdates(e);return M(Object.keys(t).reduce((i,o)=>{let m=t[o];return Object.keys(m).forEach(f=>{let I=m[f];i.push(this.performUpdateForGroup(I))}),i},[])).pipe(u(()=>t))}performUpdateForGroup(e){return e.forEach(t=>this.dispatchRemoveUpdate(t.presence)),this.performLessonPresencesUpdatesByIds(e[0].presence.LessonRef.Id,e.map(t=>t.presence.StudentRef.Id),e[0].newPresenceTypeId).pipe(ft(t=>this.revertUpdatesAfterError(e,t)))}performLessonPresencesUpdatesByIds(e,t,i=null){return i?(i?this.presenceTypesService.getPresenceType(i):ee(null)).pipe(k(m=>this.restService.editLessonPresences([e],t,m?.Id,We(m,this.settings)||void 0,{context:new it().set(at,{disableErrorHandling:!0})}))):this.restService.removeLessonPresences([e],t,{context:new it().set(at,{disableErrorHandling:!0})})}revertUpdatesAfterError(e,t){return console.error("Bulk-update of lesson presences failed"),console.error(t),this.toastService.error(this.translate.instant("shared.lesson-presences-update.error")),this.revertUpdates$.next(e.map(i=>ue(me({},i),{newPresenceTypeId:i.presence.TypeRef.Id}))),ee(void 0)}groupUpdates(e){return e.reduce((t,i)=>{let o=String(i.newPresenceTypeId&&i.newPresenceTypeId);return t[o]||(t[o]={}),Array.isArray(t[o][i.presence.LessonRef.Id])||(t[o][i.presence.LessonRef.Id]=[]),t[o][i.presence.LessonRef.Id].push(i),t},{})}reduceUpdates(e,t){switch(t.type){case je.AddUpdateAction:{let{presence:i,newPresenceTypeId:o}=t.payload,m=e.findIndex(Wn(i));return m===-1?[...e,{presence:i,newPresenceTypeId:o}]:[...e.slice(0,m),{presence:e[m].presence,newPresenceTypeId:o},...e.slice(m+1)]}case je.RemoveUpdateAction:return e.filter(qe(Wn(t.payload)));default:return e}}dispatchAddUpdate(e,t){this.action$.next({type:je.AddUpdateAction,payload:{presence:e,newPresenceTypeId:t}})}dispatchRemoveUpdate(e){this.action$.next({type:je.RemoveUpdateAction,payload:e})}static{this.\u0275fac=function(t){return new(t||n)(_(be),_(J),_(on),_(ye),_(W))}}static{this.\u0275prov=U({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();function Wn(n){return s=>s.presence.LessonRef.Id===n.LessonRef.Id&&s.presence.StudentRef.Id===n.StudentRef.Id}var Ki=(n,s)=>s.id,zi=()=>[],Ji=n=>({returnparams:n});function Xi(n,s){n&1&&K(0,"bkd-spinner")}function Yi(n,s){n&1&&(a(0,"p",1),l(1),p(2,"translate"),c()),n&2&&(r(),w(d(2,1,"presence-control.no-lessons")))}function Zi(n,s){n&1&&(a(0,"p",1),l(1),p(2,"translate"),c()),n&2&&(r(),y(" ",d(2,1,"presence-control.no-lesson-presences")," "))}function eo(n,s){if(n&1){let e=S();a(0,"bkd-presence-control-entry",4),p(1,"async"),p(2,"async"),p(3,"async"),p(4,"async"),C("togglePresenceType",function(i){v(e);let o=g(3);return b(o.togglePresenceType(i))})("changeIncident",function(i){v(e);let o=g(3);return b(o.changeIncident(i))}),c()}if(n&2){let e,t=s.$implicit,i=g(3);x("entry",t)("hasUnconfirmedAbsences",d(1,5,i.state.hasUnconfirmedAbsences(t)))("viewMode",d(2,7,i.state.viewMode$))("showClassName",((e=d(3,9,i.state.studyClassCount$))!==null&&e!==void 0?e:0)>1)("profileReturnParams",ie(13,Ji,d(4,11,i.state.queryParamsString$)))}}function to(n,s){if(n&1&&(a(0,"div"),p(1,"async"),j(2,eo,5,15,"bkd-presence-control-entry",3,Ki),c()),n&2){let e=g(2),t=z(4);Ae("default-entries entries view-mode-",d(1,3,e.state.viewMode$),""),r(2),V(t)}}function no(n,s){if(n&1){let e=S();a(0,"bkd-presence-control-header",0),p(1,"async"),p(2,"async"),p(3,"async"),p(4,"async"),p(5,"async"),p(6,"async"),p(7,"async"),C("searchChange",function(i){v(e);let o=g();return b(o.search$.next(i))})("viewModeChange",function(i){v(e);let o=g();return b(o.state.setViewMode(i))})("selectDateChange",function(i){v(e);let o=g();return b(o.state.setDate(i))})("selectLessonChange",function(i){v(e);let o=g();return b(o.state.setLessonId(i.id))}),c(),$(8,Yi,3,3,"p",1)(9,Zi,3,3,"p",1)(10,to,4,5,"div",2)}if(n&2){let e=g(),t=z(0),i=z(2),o=z(4);x("selectedLesson",t)("lessons",i)("presentCount",d(1,10,e.state.presentCount$))("absentCount",d(2,12,e.state.absentCount$))("unapprovedCount",d(3,14,e.state.unapprovedCount$))("absentPrecedingCount",d(4,16,e.state.absentPrecedingCount$))("viewMode",d(5,18,e.state.viewMode$))("selectDate",d(6,20,e.state.selectedDate$))("search",d(7,22,e.search$)),r(8),T(t?o.length===0?9:10:8)}}var io=["studentFullName"],Kn=(()=>{class n{constructor(e,t,i,o,m,f,I){this.state=e,this.blockLessons=t,this.lessonPresencesUpdateService=i,this.presenceTypesService=o,this.modalService=m,this.scrollPosition=f,this.route=I,this.search$=new ge(""),this.entries$=M([this.state.presenceControlEntriesByGroup$,this.search$]).pipe(u(([G,we])=>bn(G,io,we)),B(1)),this.destroy$=new O}ngOnInit(){this.route.queryParams.pipe(Q(this.destroy$)).subscribe(this.restoreStateFromParams.bind(this))}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}doTogglePresenceType(e){e.forEach(t=>this.state.getNextPresenceType(t).subscribe(i=>this.lessonPresencesUpdateService.updatePresenceType(t,i?i.Id:null)))}togglePresenceType(e){this.blockLessons.getBlockLessonPresenceControlEntries(e).pipe(E(1)).subscribe(t=>{if(t.length===1){let i=t[0];this.doTogglePresenceType([i])}else{let i=this.modalService.open(Rn);i.componentInstance.entry=e,i.componentInstance.blockPresenceControlEntries=t,i.result.then(o=>{o&&this.doTogglePresenceType(o)},()=>{})}})}updateIncident(e,t){this.lessonPresencesUpdateService.updatePresenceType(e,t)}changeIncident(e){this.presenceTypesService.incidentTypes$.subscribe(t=>{let i=this.modalService.open(qn);i.componentInstance.incident=t.find(o=>o.Id===e.presenceType?.Id)||null,i.componentInstance.incidentTypes=t,i.result.then(o=>{this.updateIncident(e,o?.Id||null)},()=>{})})}restoreStateFromParams(e){e.date&&this.state.setDate(Et(e.date));let t=String(e.lesson);t&&this.state.setLessonId(t),e.viewMode&&Vn.includes(e.viewMode)&&this.state.setViewMode(e.viewMode)}static{this.\u0275fac=function(t){return new(t||n)(h(H),h(Ze),h(et),h(ye),h(Se),h(Sn),h(Re))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control-list"]],standalone:!0,features:[D],decls:12,vars:16,consts:[[3,"searchChange","viewModeChange","selectDateChange","selectLessonChange","selectedLesson","lessons","presentCount","absentCount","unapprovedCount","absentPrecedingCount","viewMode","selectDate","search"],[1,"mt-3"],[3,"class"],[3,"entry","hasUnconfirmedAbsences","viewMode","showClassName","profileReturnParams"],[3,"togglePresenceType","changeIncident","entry","hasUnconfirmedAbsences","viewMode","showClassName","profileReturnParams"]],template:function(t,i){if(t&1&&(N(0),p(1,"async"),N(2),p(3,"async"),N(4),p(5,"async"),a(6,"h1"),l(7),p(8,"translate"),c(),$(9,Xi,1,0,"bkd-spinner"),p(10,"async"),$(11,no,11,24)),t&2){let o;Z(d(1,2,i.state.selectedLesson$)),r(2),Z(d(3,5,i.state.lessons$)),r(2),Z((o=d(5,8,i.entries$))!==null&&o!==void 0?o:Oe(15,zi)),r(3),w(d(8,11,"presence-control.title")),r(2),T(d(10,13,i.state.loading$)?9:11)}},dependencies:[Hn,Nn,Pe,oe,A,F],styles:["bkd-presence-control-entry[_ngcontent-%COMP%]{border-bottom:1px solid #dee2e6}.entries.view-mode-grid[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%}@media (min-width: 400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%;border-right:1px solid #dee2e6}}@media (min-width: 800px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:50%;border-right:1px solid #dee2e6}}@media (min-width: 1200px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:33.3333333333%;border-right:1px solid #dee2e6}}@media (min-width: 1600px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:25%;border-right:1px solid #dee2e6}}@media (min-width: 2000px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:20%;border-right:1px solid #dee2e6}}@media (min-width: 2400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:16.6666666667%;border-right:1px solid #dee2e6}}[_nghost-%COMP%]{display:block;overflow:hidden;width:100%}.entries.view-mode-grid[_ngcontent-%COMP%]{width:calc(100% + 1px)}"],changeDetection:0})}}return n})();var zn=(()=>{class n{constructor(e,t){this.state=e,this.lessonPresencesUpdateService=t,this.destroy$=new O}ngOnInit(){this.lessonPresencesUpdateService.stateUpdates$.pipe(Q(this.destroy$)).subscribe(e=>this.state.updateLessonPresencesTypes(e))}ngOnDestroy(){this.destroy$.next()}static{this.\u0275fac=function(t){return new(t||n)(h(H),h(et))}}static{this.\u0275cmp=L({type:n,selectors:[["bkd-presence-control"]],standalone:!0,features:[fe([H,Ze,le,tn,{provide:Kt,useExisting:H}]),D],decls:1,vars:0,template:function(t,i){t&1&&K(0,"router-outlet")},dependencies:[Dt],changeDetection:0})}}return n})();var Ns=[{path:"",component:zn,children:[{path:"",component:Kn,data:{restoreScrollPositionFrom:["/presence-control/student/:id/addresses","/presence-control/student/:id/absences","/presence-control/student/:id/grades"]}},fn,{path:"groups/:id",component:Gn}]}];export{Ns as PRESENCE_CONTROL_ROUTES};
