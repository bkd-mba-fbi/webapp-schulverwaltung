"use strict";(self.webpackChunkwebapp_schulverwaltung=self.webpackChunkwebapp_schulverwaltung||[]).push([[0],{1e3:(Ue,H,c)=>{c.r(H),c.d(H,{PresenceControlModule:()=>_n});var R=c(9121),S=c(5357),X=c(9698),A=c(1135),g=c(9841),I=c(4128),ee=c(4813),l=c(4004),y=c(5698),f=c(3900),w=c(9718),$=c(6478),G=c(7832),z=c(331),se=c(4343),e=c(5e3);let _=(()=>{class n extends se.z{}return n.\u0275fac=function(){let o;return function(s){return(o||(o=e.n5z(n)))(s||n)}}(),n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac}),n})();function oe(n,o){return[...n].sort(function p(n){return(o,t)=>{switch(n.primarySortKey){case"name":const s=o.name.localeCompare(t.name);return n.ascending?-1*s:s;case"group":const r=(o.detail.Value||"").localeCompare(t.detail.Value||"");return n.ascending?-1*r:r}}}(o))}function v(n,o){return n.map(t=>function O(n,o){var t;return{id:n.IdPerson,name:(null===(t=o.find(s=>s.StudentRef.Id===n.IdPerson))||void 0===t?void 0:t.StudentFullName)||"",group:n.Value,detail:n}}(t,o))}function ve(n,o){return n.find(t=>t.VssId===o.subscriptionDetailGroupId)}var m=c(1504),b=c(8995),T=c(3075),h=c(9808);function Fe(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",5),e.TgZ(1,"input",6),e.NdJ("change",function(){const i=e.CHM(t).$implicit;return e.oxw().onSelectionChange(i)}),e.qZA(),e.TgZ(2,"label",7),e._uU(3),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=o.index,r=e.oxw();e.xp6(1),e.MGl("id","group-",s,""),e.Q6J("checked",t.id===r.selected.id)("value",t.id),e.xp6(1),e.MGl("for","group-",s,""),e.xp6(1),e.hij(" ",t.label," ")}}var k=(()=>{return(n=k||(k={})).Select="select",n.Assign="assign",k;var n})();let Re=(()=>{class n{constructor(t,s){this.activeModal=t,this.translate=s,this.groupOptions=[]}ngOnInit(){this.title=`presence-control.groups.${this.dialogMode}.title`;const t=this.createEmtpyOption();this.groupOptions=this.createGroupOptions(this.subscriptionDetail),this.groupOptions.unshift(t),this.selected=this.groupOptions.find(s=>s.id===this.group)||t}createEmtpyOption(){return{id:null,label:this.translate.instant(this.dialogMode===k.Select?"presence-control.groups.all":"presence-control.groups.none")}}createGroupOptions(t){return t.DropdownItems?t.DropdownItems.map(s=>({id:s.Key,label:`${this.translate.instant("presence-control.groups.group")} ${s.Value}`})):[]}getSelectedGroup(){return this.selected}onSelectionChange(t){this.selected=t}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(m.Kz),e.Y36(b.sK))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-group-dialog"]],inputs:{dialogMode:"dialogMode",subscriptionDetail:"subscriptionDetail",group:"group"},decls:13,vars:10,consts:[[1,"modal-body"],["class","form-group form-check",4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],[1,"form-group","form-check"],["type","radio","name","groups",1,"form-check-input",3,"id","checked","value","change"],[1,"form-check-label",3,"for"]],template:function(t,s){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"p"),e._uU(2),e.ALo(3,"translate"),e.qZA(),e.TgZ(4,"form"),e.YNc(5,Fe,4,5,"div",1),e.qZA(),e.qZA(),e.TgZ(6,"div",2),e.TgZ(7,"button",3),e.NdJ("click",function(){return s.activeModal.dismiss()}),e._uU(8),e.ALo(9,"translate"),e.qZA(),e.TgZ(10,"button",4),e.NdJ("click",function(){return s.activeModal.close(s.getSelectedGroup())}),e._uU(11),e.ALo(12,"translate"),e.qZA(),e.qZA()),2&t&&(e.xp6(2),e.hij(" ",e.lcZ(3,4,s.title)," "),e.xp6(3),e.Q6J("ngForOf",s.groupOptions),e.xp6(3),e.hij(" ",e.lcZ(9,6,"presence-control.groups.cancel")," "),e.xp6(3),e.hij(" ",e.lcZ(12,8,"presence-control.groups.save")," "))},directives:[T._Y,T.JL,T.F,h.sg],pipes:[b.X$],styles:[""]}),n})();var Ce=c(2641),re=c(833),ke=c(634),Ne=c(1854),je=c(6569),M=c(7579),j=c(6451),Je=c(5963),ie=c(1884),P=c(4782),Q=c(8675),_e=c(6590),D=c(2722),Pe=c(8189),V=c(9300),U=c(8029),ye=c(876),J=c(2786),qe=c(7746),E=c(4012);function be(n,o){return null===n&&null===o||null!==n&&null!==o&&n.TeacherInformation===o.TeacherInformation&&n.LessonDateTimeFrom.getTime()===o.LessonDateTimeFrom.getTime()&&n.LessonDateTimeTo.getTime()===o.LessonDateTimeTo.getTime()}class Ye{constructor(o,t,s){this.TeacherInformation=o,this.LessonDateTimeFrom=t,this.LessonDateTimeTo=s,this.lessons=[]}addLesson(o){this.lessons.some(t=>(0,E.In)(t,o))||(this.lessons.push(o),this.updateId(),this.updateStudyClassNumbers(),this.updateEventDesignations())}getIds(){return[...new Set(this.lessons.map(o=>o.LessonRef.Id))]}getEventIds(){return[...new Set(this.lessons.map(o=>o.EventRef.Id))]}updateId(){this.id=[...new Set(this.lessons.map(o=>o.LessonRef.Id).sort())].join("-")}updateStudyClassNumbers(){this.studyClassNumbers=[...new Set(this.lessons.map(o=>o.StudyClassNumber).sort((o,t)=>o.localeCompare(t)))].join(", ")}updateEventDesignations(){this.eventDesignations=[...new Set(this.lessons.map(o=>o.EventDesignation).sort())].join(", ")}}var q=c(953);function He(n,o){(0,re.Z)(2,arguments);var t=(0,q.Z)(n),s=(0,q.Z)(o);return t.getTime()<s.getTime()}function ze(n,o){(0,re.Z)(2,arguments);var t=(0,q.Z)(n).getTime(),s=(0,q.Z)(o.start).getTime(),r=(0,q.Z)(o.end).getTime();if(!(s<=r))throw new RangeError("Invalid interval");return t>=s&&t<=r}function Qe(n){return function Ke(n){return n.reduce((o,t)=>o.some(s=>(0,E.In)(s,t))?o:[...o,t],[])}(n).reduce((o,t,s)=>{const r=o.find(a=>be(a,t));if(r)return r.addLesson((0,E.$J)(t)),o;const i=function Be(n){const o=new Ye(n.TeacherInformation,n.LessonDateTimeFrom,n.LessonDateTimeTo);return o.addLesson(n),o}((0,E.$J)(t));return[...o,i]},[]).sort(E.kM)}function Ve(n){if(0===n.length)return null;const o=new Date;if(n=[...n].sort(E.kM),(0,Ce.Z)(o,n[0].LessonDateTimeFrom)){for(const t of n)if(He(o,t.LessonDateTimeFrom)||ze(o,{start:t.LessonDateTimeFrom,end:t.LessonDateTimeTo}))return t;return n[n.length-1]}return n[0]}var ce=c(5803);function et(n){return{Id:n?n.Id:null,HRef:null}}function ae(n){return o=>o.reduce((t,s)=>t+(s.presenceCategory===n?1:0),0)}var le=c(1306),nt=c(7129),K=c(2671),Te=c(6766),W=c(520);let st=(()=>{class n extends K.v{constructor(t,s){super(t,s,Te.C,"LessonTeachers")}loadOtherTeachersLessonAbsences(t,s,r){let i=`${this.baseUrl}/except/${t}/LessonAbsences?expand=LessonRef`;return s&&s.length>0&&(i=i.concat("&filter.StudentRef=;"+s.join(";"))),this.http.get(i,{params:r}).pipe((0,f.w)((0,J.Y0)(Te.C)))}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(W.eN),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var de=c(6501),ot=c(5644),pe=c(4707),xe=c(1008),x=c(9928),Le=c(5030);const rt=x.dt({Key:x.Z_,Value:x.Z_}),ue=x.dt({Id:x.Z_,SubscriptionId:x.pk,VssId:x.pk,EventId:x.pk,DropdownItems:(0,Le.Wx)(x.IX(rt)),IdPerson:x.pk,ShowAsRadioButtons:x.O7,Value:(0,Le.Wx)(x.Z_)});let it=(()=>{class n extends K.v{constructor(t,s){super(t,s,ue,"Events")}getSubscriptionDetails(t){return this.http.get(`${this.baseUrl}/${t}/SubscriptionDetails`).pipe((0,f.w)((0,J.Y0)(this.codec)))}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(W.eN),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})(),ct=(()=>{class n extends K.v{constructor(t,s){super(t,s,ue,"Subscriptions")}getListByRegistrationId(t){return this.http.get(`${this.baseUrl}/${t}/SubscriptionDetails`).pipe((0,f.w)((0,J.Y0)(this.codec)))}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(W.eN),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var Me=c(2024);let ge=(()=>{class n{constructor(t,s,r,i,a){this.settingsService=t,this.eventService=s,this.subscriptionService=r,this.loadingService=i,this.settings=a,this.selectGroup$=new M.x,this.selectedLesson$=new pe.t,this.lessonPresences$=new pe.t,this.reloadSubscriptionDetails$=new M.x,this.defaultGroup=null,this.savedGroupViews$=this.loadSavedGroupViews(),this.savedGroup$=this.selectedLesson$.pipe((0,f.w)(d=>this.savedGroupViews$.pipe((0,l.U)(u=>this.findGroupByLesson(u,d))))),this.group$=(0,j.T)(this.selectGroup$,this.savedGroup$).pipe((0,Q.O)(this.defaultGroup),(0,P.d)(1)),this.subscriptionsDetailsByEvents$=this.selectedLesson$.pipe((0,l.U)(d=>(null==d?void 0:d.getEventIds())||[]),(0,f.w)(d=>(0,I.D)(d.map(u=>this.eventService.getSubscriptionDetails(u)))),(0,P.d)(1)),this.groupsAvailability$=this.subscriptionsDetailsByEvents$.pipe((0,l.U)(d=>d.every(u=>ve(u,this.settings))),(0,P.d)(1)),this.selectedLessonRegistrationIds$=(0,g.a)([this.selectedLesson$,this.lessonPresences$]).pipe((0,l.U)(([d,u])=>u.filter(Z=>null==d?void 0:d.getIds().includes(Z.LessonRef.Id))),(0,l.U)(d=>d.map(u=>u.RegistrationRef.Id).filter(u=>u))),this.subscriptionsDetailsByRegistrations$=(0,g.a)([this.selectedLessonRegistrationIds$,this.groupsAvailability$,this.reloadSubscriptionDetails$.pipe((0,Q.O)(void 0))]).pipe((0,f.w)(([d,u])=>(0,I.D)(d.map(Z=>u?this.loadSubscriptionDetails(Z):[])))),this.subscriptionDetails$=this.subscriptionsDetailsByRegistrations$.pipe((0,l.U)(xe.Z),(0,l.U)(d=>function Ee(n,o){return n.filter(t=>t.VssId===o.subscriptionDetailGroupId)}(d,this.settings)),(0,P.d)(1)),this.subscriptionDetailPersonIds$=(0,g.a)([this.group$,this.subscriptionDetails$]).pipe((0,l.U)(([d,u])=>u.filter(Z=>Z.Value===d).map(Z=>Z.IdPerson)),(0,Q.O)([]))}selectGroup(t){this.selectGroup$.next(t)}setSelectedLesson(t){this.selectedLesson$.next(t)}setLessonPresences(t){this.lessonPresences$.next(t)}getSubscriptionDetailForGroupEvent(){return this.subscriptionsDetailsByEvents$.pipe((0,l.U)(xe.Z),(0,l.U)(t=>ve(t,this.settings)))}getSubscriptionDetailsForStudents(){return(0,g.a)([this.subscriptionDetails$,this.lessonPresences$]).pipe((0,l.U)((0,$.h)(v)))}reloadSubscriptionDetails(){this.reloadSubscriptionDetails$.next(void 0)}loadSubscriptionDetails(t){return this.loadingService.load(this.subscriptionService.getListByRegistrationId(t))}loadSavedGroupViews(){return this.settingsService.getUserSettingsCst().pipe((0,l.U)(t=>t.Settings),(0,Pe.J)(),(0,V.h)(t=>"presenceControlGroupView"===t.Key),(0,l.U)(t=>JSON.parse(t.Value)),(0,f.w)((0,J.Y0)(ye.N)),(0,_e.d)([]))}findGroupByLesson(t,s){const r=t.find(i=>i.eventId===(null==s?void 0:s.getEventIds()[0]));return(null==r?void 0:r.group)||this.defaultGroup}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(le.j),e.LFG(it),e.LFG(ct),e.LFG(Me.b),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac}),n})();var at=c(7639),L=(()=>{return(n=L||(L={})).Grid="grid",n.List="list",L;var n})();const lt=Object.keys(L).map(n=>L[n]);let N=(()=>{class n{constructor(t,s,r,i,a,d,u,Z,fe,B){this.settingsService=t,this.lessonPresencesService=s,this.lessonTeacherService=r,this.presenceTypesService=i,this.personsService=a,this.groupService=d,this.dropDownItemsService=u,this.loadingService=Z,this.settings=fe,this.location=B,this.selectedDateSubject$=new A.X(new Date),this.selectLesson$=new M.x,this.viewModeSubject$=new M.x,this.updateLessonPresences$=new M.x,this.lessonPresences$=(0,j.T)(this.selectedDateSubject$.pipe((0,ie.x)(Ne.Z),(0,f.w)(this.loadLessonPresencesByDate.bind(this))),this.updateLessonPresences$).pipe((0,P.d)(1)),this.presenceTypes$=this.loadPresenceTypes().pipe((0,P.d)(1)),this.lessons$=this.lessonPresences$.pipe((0,l.U)(Qe),(0,P.d)(1)),this.currentLesson$=this.lessons$.pipe((0,l.U)(Ve),(0,ie.x)(be)),this.studentIdsWithUnconfirmedAbsences$=this.selectedDateSubject$.pipe((0,f.w)(()=>this.loadStudentIdsWithUnconfirmedAbsences()),(0,P.d)(1)),this.loading$=this.loadingService.loading$,this.selectedLesson$=(0,j.T)(this.currentLesson$,this.selectLesson$).pipe((0,P.d)(1)),this.absenceConfirmationStates$=this.dropDownItemsService.getAbsenceConfirmationStates().pipe((0,P.d)(1)),this.selectedLessonStudentIds$=(0,g.a)([this.selectLesson$,this.lessonPresences$]).pipe((0,l.U)(([C,Y])=>Y.filter(Pn=>Pn.LessonRef.Id===Number(null==C?void 0:C.id))),(0,l.U)(C=>C.map(Y=>Y.StudentRef.Id)),(0,P.d)(1)),this.otherTeachersAbsences$=(0,g.a)([this.personsService.getMyself(),this.selectedLessonStudentIds$.pipe((0,Q.O)([]))]).pipe((0,f.w)(([C,Y])=>this.lessonTeacherService.loadOtherTeachersLessonAbsences(C.Id,Y)),(0,P.d)(1)),this.groupsAvailability$=this.groupService.groupsAvailability$,this.selectedPresenceControlEntries$=(0,g.a)([this.selectedLesson$,this.lessonPresences$,this.presenceTypes$,this.absenceConfirmationStates$,this.otherTeachersAbsences$]).pipe((0,l.U)((0,$.h)(E.bL))),this.selectedPresenceControlEntriesByGroup$=(0,g.a)([this.groupService.group$,this.selectedPresenceControlEntries$,this.groupService.subscriptionDetailPersonIds$]).pipe((0,l.U)((0,$.h)(qe.C)),(0,P.d)(1)),this.presentCount$=this.selectedPresenceControlEntriesByGroup$.pipe((0,l.U)(ae("present"))),this.absentCount$=this.selectedPresenceControlEntriesByGroup$.pipe((0,l.U)(ae("absent"))),this.unapprovedCount$=this.selectedPresenceControlEntriesByGroup$.pipe((0,l.U)(ae("unapproved"))),this.absentPrecedingCount$=this.selectedPresenceControlEntriesByGroup$.pipe((0,l.U)(n=>n.reduce((o,t)=>o+(t.precedingAbsences&&t.precedingAbsences.length>0?1:0),0))),this.viewMode$=(0,j.T)(this.viewModeSubject$,this.getSavedViewMode().pipe((0,y.q)(1),(0,_e.d)(L.Grid))),this.selectedDate$=this.selectedDateSubject$.asObservable(),this.queryParamsString$=(0,g.a)([this.selectedDate$,this.selectedLesson$,this.viewMode$]).pipe((0,l.U)((0,$.h)(this.buildQueryParams.bind(this))),(0,l.U)(G.tW)),this.destroy$=new M.x,this.queryParamsString$.pipe((0,D.R)(this.destroy$)).subscribe(C=>{this.location.replaceState("/presence-control",C),this.confirmBackLinkParams={returnparams:C}}),this.viewModeSubject$.pipe((0,D.R)(this.destroy$),(0,ie.x)(),(0,f.w)(C=>this.updateSavedViewMode(C))).subscribe(),this.selectedLesson$.pipe((0,D.R)(this.destroy$)).subscribe(C=>this.groupService.setSelectedLesson(C)),this.lessonPresences$.pipe((0,D.R)(this.destroy$)).subscribe(C=>this.groupService.setLessonPresences(C))}ngOnDestroy(){this.destroy$.next()}setDate(t){this.selectedDateSubject$.next(t)}setLesson(t){this.selectLesson$.next(t)}setViewMode(t){this.viewModeSubject$.next(t)}updateLessonPresencesTypes(t){(0,g.a)([this.lessonPresences$.pipe((0,y.q)(1)),this.presenceTypes$.pipe((0,y.q)(1))]).pipe((0,l.U)(([s,r])=>function We(n,o,t,s){return n.map(r=>{const i=o.find(a=>function Xe(n,o){return n.LessonRef.Id===o.LessonRef.Id&&n.StudentRef.Id===o.StudentRef.Id}(a.presence,r));if(i){let a;return a=!i.newPresenceTypeId&&r.Comment?t.find(d=>d.IsComment)||null:t.find(d=>d.Id===i.newPresenceTypeId)||null,Object.assign(Object.assign({},r),{TypeRef:et(a),Date:null,Type:a?a.Designation:null,ConfirmationStateId:(0,ce.LO)(a,s)})}return r})}(s,t,r,this.settings))).subscribe(s=>this.updateLessonPresences$.next(s))}getNextPresenceType(t){return this.presenceTypes$.pipe((0,y.q)(1),(0,l.U)(s=>t.getNextPresenceType(s)))}hasUnconfirmedAbsences(t){return this.studentIdsWithUnconfirmedAbsences$.pipe((0,l.U)(s=>s.includes(t.lessonPresence.StudentRef.Id)))}getBlockLessonPresences(t){return(0,g.a)([this.lessonPresences$.pipe((0,y.q)(1)),this.presenceTypes$.pipe((0,y.q)(1))]).pipe((0,l.U)(([s,r])=>s.filter(i=>i.TeacherInformation===t.lessonPresence.TeacherInformation&&i.StudentRef.Id===t.lessonPresence.StudentRef.Id&&(0,ce.NF)(i,r.find(a=>a.Id===i.TypeRef.Id)||null,this.settings)).sort((i,a)=>i.LessonDateTimeFrom>a.LessonDateTimeFrom?1:-1).reduce((i,a)=>this.isPartOfBlock(a,i[i.length-1])?(i.push(a),i):i.find(u=>u.Id===t.lessonPresence.Id)?i:[a],[])))}isPartOfBlock(t,s){return!s||t.LessonDateTimeFrom.getTime()-s.LessonDateTimeTo.getTime()<=18e5}loadLessonPresencesByDate(t){return this.loadingService.load(function Ge(n){return(0,re.Z)(1,arguments),(0,Ce.Z)(n,Date.now())}(t)?this.lessonPresencesService.getListForToday():this.lessonPresencesService.getListByDate(t))}loadPresenceTypes(){return this.loadingService.load(this.presenceTypesService.presenceTypes$)}loadStudentIdsWithUnconfirmedAbsences(){return(0,Je.H)(0,this.settings.unconfirmedAbsencesRefreshTime||-1).pipe((0,f.w)(()=>this.lessonPresencesService.getListOfUnconfirmed()),(0,l.U)(t=>(0,je.Z)(t.map(s=>s.StudentRef.Id))))}buildQueryParams(t,s,r){const i={date:(0,ke.Z)(t,"yyyy-MM-dd"),viewMode:r};return s&&(i.lesson=String(s.id)),i}getSavedViewMode(){return this.settingsService.getUserSettingsCst().pipe((0,l.U)(t=>t.Settings),(0,Pe.J)(),(0,V.h)(t=>"presenceControlViewMode"===t.Key),(0,y.q)(1),(0,l.U)(t=>JSON.parse(t.Value)),(0,f.w)((0,J.Jx)(ye.Py)),(0,l.U)(t=>this.getViewModeForString(t.presenceControl)),(0,P.d)())}getViewModeForString(t){return t===L.List?L.List:L.Grid}updateSavedViewMode(t){const r={Key:"presenceControlViewMode",Value:JSON.stringify({presenceControl:t})},i=Object.assign({},(0,z.kl)());return i.Settings.push(r),this.settingsService.updateUserSettingsCst(i)}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(le.j),e.LFG(nt.q),e.LFG(st),e.LFG(de.c),e.LFG(ot.J),e.LFG(ge),e.LFG(at.R),e.LFG(Me.b),e.LFG(U.L),e.LFG(h.Ye))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac}),n})(),dt=(()=>{class n extends K.v{constructor(t,s){super(t,s,ue,"SubscriptionDetails")}update(t,s){return this.http.put(`${this.baseUrl}/${s.Id}`,{IdPerson:s.IdPerson,EventId:s.EventId,Value:t}).pipe((0,w.h)(void 0))}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(W.eN),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var he=c(2290),Ze=c(1104),Se=c(2925);function pt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",15),e.NdJ("click",function(){const i=e.CHM(t).$implicit;return e.oxw(2).toggleSort(i)}),e._uU(1),e.ALo(2,"translate"),e.TgZ(3,"span",16),e._uU(4),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=e.oxw().erzLet,r=e.oxw();e.Q6J("className",t),e.xp6(1),e.hij(" ",e.lcZ(2,3,"presence-control.groups.list.header."+t)," "),e.xp6(3),e.Oqu(r.getSortDirectionCharacter(s.sortCriteria,t))}}function ut(n,o){if(1&n){const t=e.EpF();e.ynx(0),e.TgZ(1,"div",18),e.TgZ(2,"div",19),e.TgZ(3,"input",20,21),e.NdJ("change",function(){const i=e.CHM(t).$implicit;return e.oxw(3).selectionService.toggle(i)}),e.ALo(5,"async"),e.qZA(),e.qZA(),e.TgZ(6,"div",22),e._uU(7),e.qZA(),e.TgZ(8,"div",23),e._uU(9),e.qZA(),e.qZA(),e.BQk()}if(2&n){const t=o.$implicit,s=e.oxw(3);e.xp6(3),e.Q6J("checked",e.lcZ(5,3,s.selectionService.isSelected$(t))),e.xp6(4),e.hij(" ",t.name," "),e.xp6(2),e.hij(" ",t.group?t.group:""," ")}}function gt(n,o){if(1&n&&(e.ynx(0),e.YNc(1,ut,10,5,"ng-container",17),e.BQk()),2&n){const t=e.oxw().erzLet;e.xp6(1),e.Q6J("ngForOf",t.sortedEntries)}}function ht(n,o){1&n&&e._UZ(0,"erz-spinner")}const mt=function(){return["/presence-control"]},ft=function(){return["name","group"]};function vt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div"),e.TgZ(1,"a",1),e.ALo(2,"async"),e.TgZ(3,"div",2),e.TgZ(4,"i",3),e._uU(5,"navigate_before"),e.qZA(),e.TgZ(6,"span",4),e._uU(7),e.ALo(8,"translate"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(9,"div",5),e.TgZ(10,"div",6),e.TgZ(11,"span",7),e._uU(12),e.ALo(13,"translate"),e.qZA(),e.TgZ(14,"button",8),e.NdJ("click",function(){return e.CHM(t),e.oxw().selectGroup()}),e._uU(15),e.ALo(16,"translate"),e.ALo(17,"translate"),e.qZA(),e.qZA(),e.TgZ(18,"a",9),e.NdJ("click",function(){return e.CHM(t),e.oxw().assignGroup()}),e.TgZ(19,"i",3),e._uU(20,"edit"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(21,"div",10),e.TgZ(22,"div",11),e.YNc(23,pt,5,5,"div",12),e.qZA(),e.YNc(24,gt,2,1,"ng-container",13),e.ALo(25,"async"),e.YNc(26,ht,1,0,"ng-template",null,14,e.W1O),e.qZA(),e.qZA()}if(2&n){const t=o.erzLet,s=e.MAs(27),r=e.oxw();e.xp6(1),e.Q6J("routerLink",e.DdM(22,mt))("queryParams",e.lcZ(2,10,r.backlinkQueryParams$)),e.xp6(6),e.Oqu(e.lcZ(8,12,"presence-control.groups.title")),e.xp6(5),e.Oqu(e.lcZ(13,14,"presence-control.groups.show")),e.xp6(3),e.hij(" ",t.group?e.lcZ(16,16,"presence-control.groups.group")+" "+t.group:e.lcZ(17,18,"presence-control.groups.all")," "),e.xp6(3),e.ekj("disabled",0===t.selection.length),e.xp6(5),e.Q6J("ngForOf",e.DdM(23,ft)),e.xp6(1),e.Q6J("ngIf",!1===e.lcZ(25,20,r.state.loading$))("ngIfElse",s)}}const Ct=function(n,o,t,s){return{sortCriteria:n,sortedEntries:o,selection:t,group:s}};let _t=(()=>{class n{constructor(t,s,r,i,a,d,u,Z,fe){this.route=t,this.state=s,this.selectionService=r,this.groupService=i,this.settingsService=a,this.subscriptionDetailService=d,this.toastr=u,this.translate=Z,this.modalService=fe,this.backlinkQueryParams$=this.route.queryParams.pipe((0,ee.j)("returnparams"),(0,l.U)(G.dD)),this.eventIds$=this.state.selectedLesson$.pipe((0,l.U)(B=>(null==B?void 0:B.getEventIds())||[])),this.sortCriteriaSubject$=new A.X({primarySortKey:"name",ascending:!1}),this.sortCriteria$=this.sortCriteriaSubject$.asObservable(),this.sortedEntries$=(0,g.a)([this.groupService.getSubscriptionDetailsForStudents(),this.sortCriteria$]).pipe((0,l.U)((0,$.h)(oe))),this.selected=[]}ngOnInit(){this.selectionService.selection$.subscribe(t=>this.selected=t)}selectGroup(){this.openGroupModal(k.Select,this.selectCallback.bind(this))}assignGroup(){this.openGroupModal(k.Assign,this.assignCallback.bind(this))}openGroupModal(t,s){(0,g.a)([this.groupService.getSubscriptionDetailForGroupEvent(),this.groupService.group$]).pipe((0,y.q)(1)).subscribe(([r,i])=>{const a=this.modalService.open(Re);a.componentInstance.dialogMode=t,a.componentInstance.subscriptionDetail=r,a.componentInstance.group=i,a.result.then(d=>{s(d)},()=>{})})}selectCallback(t){(0,g.a)([this.eventIds$,this.groupService.savedGroupViews$]).pipe((0,y.q)(1),(0,f.w)(([s,r])=>{const i=function ne(n,o,t){const s=o.map(i=>({eventId:i,group:n})),r=t.map(i=>s.find(a=>a.eventId===i.eventId)||i);return[...new Set([...r,...s])].filter(i=>null!==i.group)}(t.id,s,r),a=function te(n,o){const t={Key:n,Value:JSON.stringify(o)},s=Object.assign({},(0,z.kl)());return s.Settings.push(t),s}("presenceControlGroupView",i);return this.settingsService.updateUserSettingsCst(a).pipe((0,w.h)(t.id))})).subscribe(s=>this.groupService.selectGroup(s))}assignCallback(t){(0,I.D)(this.selected.map(s=>this.subscriptionDetailService.update(t.id,s.detail))).subscribe(this.onSaveSuccess.bind(this))}onSaveSuccess(){this.groupService.reloadSubscriptionDetails(),this.selectionService.clear(),this.toastr.success(this.translate.instant("presence-control.groups.notifications.save-success"))}getSortDirectionCharacter(t,s){return t.primarySortKey!==s?"":t.ascending?"\u2193":"\u2191"}toggleSort(t){this.sortCriteriaSubject$.pipe((0,y.q)(1)).subscribe(s=>{this.sortCriteriaSubject$.next(s.primarySortKey===t?{primarySortKey:t,ascending:!s.ascending}:{primarySortKey:t,ascending:"name"===t})})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(S.gz),e.Y36(N),e.Y36(_),e.Y36(ge),e.Y36(le.j),e.Y36(dt),e.Y36(he._W),e.Y36(b.sK),e.Y36(m.FF))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-group"]],features:[e._Bn([_])],decls:5,vars:14,consts:[[4,"erzLet"],[1,"back","btn","btn-link","p-3",3,"routerLink","queryParams"],[1,"d-flex","align-items-center"],[1,"material-icons"],[1,"ml-3"],[1,"group-header","mb-2","d-flex","justify-content-between"],[1,"d-flex","align-items-baseline"],[1,"pl-3"],["type","button",1,"show","btn","btn-link",3,"click"],["aria-label","edit",1,"btn","btn-primary","mr-2",3,"click"],[1,"group-list"],[1,"group-list-header"],[3,"className","click",4,"ngFor","ngForOf"],[4,"ngIf","ngIfElse"],["loading",""],[3,"className","click"],[1,"sort-direction"],[4,"ngFor","ngForOf"],[1,"group-list-entry"],[1,"checkbox"],["type","checkbox",1,"form-check-input",3,"checked","change"],["checkbox",""],[1,"name","pr-2"],[1,"group"]],template:function(t,s){1&t&&(e.YNc(0,vt,28,24,"div",0),e.ALo(1,"async"),e.ALo(2,"async"),e.ALo(3,"async"),e.ALo(4,"async")),2&t&&e.Q6J("erzLet",e.l5B(9,Ct,e.lcZ(1,1,s.sortCriteria$),e.lcZ(2,3,s.sortedEntries$),e.lcZ(3,5,s.selectionService.selection$),e.lcZ(4,7,s.groupService.group$)))},directives:[Ze.e,S.yS,h.sg,h.O5,Se.O],pipes:[h.Ov,b.X$],styles:['.back[_ngcontent-%COMP%]{color:#33333d;text-decoration:none}.back[_ngcontent-%COMP%]:hover   span[_ngcontent-%COMP%], .back[_ngcontent-%COMP%]:active   span[_ngcontent-%COMP%]{text-decoration:underline}.group-list[_ngcontent-%COMP%]{padding-left:1.5rem;padding-right:1.5rem}.group-list-header[_ngcontent-%COMP%]{cursor:pointer;padding:1.5rem;display:grid;grid-template-areas:"name group";grid-template-columns:3fr 2fr;border-top:1px solid #dee2e6;border-bottom:2px solid #dee2e6}.group-list-entry[_ngcontent-%COMP%]{padding:1.5rem;border-bottom:1px solid #e9ecef;display:grid;grid-template-areas:"checkbox name group";grid-template-columns:min-content 3fr 2fr}.checkbox[_ngcontent-%COMP%]{grid-area:checkbox;margin:0;padding:.6rem .75rem 0 0}.checkbox[_ngcontent-%COMP%]   input.form-check-input[_ngcontent-%COMP%]{position:static!important;margin:0!important;display:block}.name[_ngcontent-%COMP%]{grid-area:name;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.group[_ngcontent-%COMP%]{grid-area:group}@media (max-width: 750px){.group-list[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.group-list-header[_ngcontent-%COMP%]{grid-template-columns:3fr 1fr}.group-list-entry[_ngcontent-%COMP%]{grid-template-columns:min-content 3fr 1fr}}'],changeDetection:0}),n})();var Pt=c(5255);function yt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",5),e.TgZ(1,"input",6),e.NdJ("change",function(){const i=e.CHM(t).$implicit;return i.selected=!i.selected}),e.qZA(),e.TgZ(2,"label",7),e._uU(3),e.ALo(4,"date"),e.ALo(5,"date"),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=o.index,r=e.oxw();e.xp6(1),e.MGl("id","lesson-presence-",s,""),e.Q6J("checked",t.selected),e.xp6(1),e.ekj("font-weight-bold",t.lessonPresence.LessonDateTimeFrom===r.entry.lessonPresence.LessonDateTimeFrom),e.MGl("for","lesson-presence-",s,""),e.xp6(1),e.lnq(" ",e.xi3(4,8,t.lessonPresence.LessonDateTimeFrom,"HH:mm"),"\u2013",e.xi3(5,11,t.lessonPresence.LessonDateTimeTo,"HH:mm")," ",t.lessonPresence.EventDesignation,"")}}let bt=(()=>{class n{constructor(t){this.activeModal=t,this.lessonPresenceOptions=[]}ngOnInit(){this.lessonPresenceOptions=this.blockLessonPresences.map(t=>this.createLessonPresenceOption(t))}getSelectedLessonPresences(){return this.lessonPresenceOptions.filter(t=>t.selected).map(t=>t.lessonPresence)}createLessonPresenceOption(t){return{lessonPresence:t,selected:!0}}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(m.Kz))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-block-lesson-component"]],inputs:{entry:"entry",blockLessonPresences:"blockLessonPresences"},decls:13,vars:11,consts:[[1,"modal-body"],["class","form-group form-check",4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"disabled","click"],[1,"form-group","form-check"],["type","checkbox",1,"form-check-input",3,"id","checked","change"],[1,"form-check-label","d-block","text-truncate",3,"for"]],template:function(t,s){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"p"),e._uU(2),e.ALo(3,"translate"),e.qZA(),e.TgZ(4,"form"),e.YNc(5,yt,6,14,"div",1),e.qZA(),e.qZA(),e.TgZ(6,"div",2),e.TgZ(7,"button",3),e.NdJ("click",function(){return s.activeModal.close()}),e._uU(8),e.ALo(9,"translate"),e.qZA(),e.TgZ(10,"button",4),e.NdJ("click",function(){return s.activeModal.close(s.getSelectedLessonPresences())}),e._uU(11),e.ALo(12,"translate"),e.qZA(),e.qZA()),2&t&&(e.xp6(2),e.hij(" ",e.lcZ(3,5,"presence-control.block-lesson.text")," "),e.xp6(3),e.Q6J("ngForOf",s.lessonPresenceOptions),e.xp6(3),e.hij(" ",e.lcZ(9,7,"presence-control.block-lesson.cancel")," "),e.xp6(2),e.Q6J("disabled",0===s.getSelectedLessonPresences().length),e.xp6(1),e.hij(" ",e.lcZ(12,9,"presence-control.block-lesson.save")," "))},directives:[T._Y,T.JL,T.F,h.sg],pipes:[b.X$,h.uU],encapsulation:2}),n})();var Tt=c(6316);function xt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",5),e.TgZ(1,"input",6),e.NdJ("change",function(){const i=e.CHM(t).$implicit;return e.oxw().onSelectionChange(i)}),e.qZA(),e.TgZ(2,"label",7),e._uU(3),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=o.index,r=e.oxw();e.xp6(1),e.MGl("id","incident-",s,""),e.Q6J("checked",t.id===r.selected.id)("value",t.id),e.xp6(1),e.MGl("for","incident-",s,""),e.xp6(1),e.hij(" ",t.label," ")}}let Lt=(()=>{class n{constructor(t,s){this.activeModal=t,this.translate=s,this.incidentOptions=[]}ngOnInit(){const t=this.createIncidentOption();this.incidentOptions=this.incidentTypes.map(s=>this.createIncidentOption(s)),this.incidentOptions.unshift(t),this.selected=this.incidentOptions.find(s=>{var r;return s.id===(null===(r=this.incident)||void 0===r?void 0:r.Id)})||t}createIncidentOption(t){return{id:t?t.Id:null,label:t?t.Designation:this.translate.instant("presence-control.incident.no-incident")}}onSelectionChange(t){this.selected=t}getSelectedIncident(){return this.incidentTypes.find(t=>{var s;return t.Id===(null===(s=this.selected)||void 0===s?void 0:s.id)})||null}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(m.Kz),e.Y36(b.sK))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-incident"]],inputs:{incident:"incident",incidentTypes:"incidentTypes"},decls:13,vars:10,consts:[[1,"modal-body"],["class","form-group form-check",4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-primary",3,"click"],[1,"form-group","form-check"],["type","radio","name","incident",1,"form-check-input",3,"id","checked","value","change"],[1,"form-check-label",3,"for"]],template:function(t,s){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"p"),e._uU(2),e.ALo(3,"translate"),e.qZA(),e.TgZ(4,"form"),e.YNc(5,xt,4,5,"div",1),e.qZA(),e.qZA(),e.TgZ(6,"div",2),e.TgZ(7,"button",3),e.NdJ("click",function(){return s.activeModal.dismiss()}),e._uU(8),e.ALo(9,"translate"),e.qZA(),e.TgZ(10,"button",4),e.NdJ("click",function(){return s.activeModal.close(s.getSelectedIncident())}),e._uU(11),e.ALo(12,"translate"),e.qZA(),e.qZA()),2&t&&(e.xp6(2),e.hij(" ",e.lcZ(3,4,"presence-control.incident.text")," "),e.xp6(3),e.Q6J("ngForOf",s.incidentOptions),e.xp6(3),e.hij(" ",e.lcZ(9,6,"presence-control.incident.cancel")," "),e.xp6(3),e.hij(" ",e.lcZ(12,8,"presence-control.incident.save")," "))},directives:[T._Y,T.JL,T.F,h.sg],pipes:[b.X$],styles:["form[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:first-child{padding-bottom:.75rem;border-bottom:1px solid #e9ecef}"]}),n})();var Oe=c(9646),Mt=c(5026),Zt=c(3099),Ae=c(8372),St=c(4351),Ot=c(262),$e=c(3367),Ie=c(6428),me=c(3978),At=c(1694),F=(()=>{return(n=F||(F={})).AddUpdateAction="ADD",n.RemoveUpdateAction="REMOVE",F;var n})();let we=(()=>{class n{constructor(t,s,r,i,a){this.toastr=t,this.translate=s,this.restService=r,this.presenceTypesService=i,this.settings=a,this.destroy$=new M.x,this.action$=new M.x,this.pendingUpdates$=this.action$.pipe((0,Mt.R)(this.reduceUpdates.bind(this),[]),(0,Zt.B)()),this.revertUpdates$=new M.x,this.performUpdates$=this.pendingUpdates$.pipe((0,Ae.b)(3e3),(0,V.h)((0,me.ff)(Ie.yD)),(0,St.b)(this.performUpdates.bind(this))),this.stateUpdates$=(0,j.T)(this.pendingUpdates$,this.revertUpdates$).pipe((0,Ae.b)(20),(0,V.h)((0,me.ff)(Ie.yD))),this.performUpdates$.pipe((0,D.R)(this.destroy$)).subscribe()}ngOnDestroy(){this.destroy$.next()}updatePresenceTypes(t,s=null){t.forEach(r=>this.dispatchAddUpdate(r,s))}performUpdates(t){const s=this.groupUpdates(t);return(0,g.a)(Object.keys(s).reduce((r,i)=>{const a=s[i];return Object.keys(a).forEach(d=>{r.push(this.performUpdateForGroup(a[d]))}),r},[])).pipe((0,w.h)(s))}performUpdateForGroup(t){return t.forEach(s=>this.dispatchRemoveUpdate(s.presence)),this.performLessonPresencesUpdatesByIds(t[0].presence.LessonRef.Id,t.map(s=>s.presence.StudentRef.Id),t[0].newPresenceTypeId).pipe((0,Ot.K)(s=>this.revertUpdatesAfterError(t,s)))}performLessonPresencesUpdatesByIds(t,s,r=null){return r?(r?this.presenceTypesService.getPresenceType(r):(0,Oe.of)(null)).pipe((0,f.w)(a=>this.restService.editLessonPresences([t],s,null==a?void 0:a.Id,(0,ce.LO)(a,this.settings)||void 0,(0,$e.I)({disableErrorHandling:!0})))):this.restService.removeLessonPresences([t],s,(0,$e.I)({disableErrorHandling:!0}))}revertUpdatesAfterError(t,s){return console.error("Bulk-update of lesson presences failed"),console.error(s),this.toastr.error(this.translate.instant("shared.lesson-presences-update.error")),this.revertUpdates$.next(t.map(r=>Object.assign(Object.assign({},r),{newPresenceTypeId:r.presence.TypeRef.Id}))),(0,Oe.of)(void 0)}groupUpdates(t){return t.reduce((s,r)=>{const i=String(r.newPresenceTypeId&&r.newPresenceTypeId);return s[i]||(s[i]={}),Array.isArray(s[i][r.presence.LessonRef.Id])||(s[i][r.presence.LessonRef.Id]=[]),s[i][r.presence.LessonRef.Id].push(r),s},{})}reduceUpdates(t,s){switch(s.type){case F.AddUpdateAction:const{presence:r,newPresenceTypeId:i}=s.payload,a=t.findIndex(De(r));return-1===a?[...t,{presence:r,newPresenceTypeId:i}]:[...t.slice(0,a),{presence:t[a].presence,newPresenceTypeId:i},...t.slice(a+1)];case F.RemoveUpdateAction:return t.filter((0,me.ff)(De(s.payload)));default:return t}}dispatchAddUpdate(t,s){this.action$.next({type:F.AddUpdateAction,payload:{presence:t,newPresenceTypeId:s}})}dispatchRemoveUpdate(t){this.action$.next({type:F.RemoveUpdateAction,payload:t})}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(he._W),e.LFG(b.sK),e.LFG(At.O),e.LFG(de.c),e.LFG(U.L))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();function De(n){return o=>o.presence.LessonRef.Id===n.LessonRef.Id&&o.presence.StudentRef.Id===n.StudentRef.Id}var wt=c(3657),Dt=c(6124),Ut=c(368);function Et(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",22),e.NdJ("click",function(){return e.CHM(t),e.oxw().lessonDropdown.toggle()}),e._uU(1),e.ALo(2,"date"),e.TgZ(3,"span",23),e._uU(4),e.ALo(5,"date"),e.qZA(),e.qZA()}if(2&n){const t=e.oxw();e.xp6(1),e.hij(" ",e.xi3(2,2,t.selectedLesson.LessonDateTimeFrom,"HH:mm"),"\u2013"),e.xp6(3),e.Oqu(e.xi3(5,5,t.selectedLesson.LessonDateTimeTo,"HH:mm"))}}function Ft(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",29),e.NdJ("click",function(){const i=e.CHM(t).$implicit;return e.oxw(2).selectLessonChange.emit(i)}),e.TgZ(1,"div",30),e.TgZ(2,"div"),e._uU(3),e.ALo(4,"date"),e.ALo(5,"date"),e.qZA(),e.TgZ(6,"div",26),e._uU(7),e.qZA(),e.TgZ(8,"div",26),e._uU(9),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=e.oxw(2);e.ekj("active",t.id===s.selectedLesson.id),e.xp6(3),e.AsE(" ",e.xi3(4,6,t.LessonDateTimeFrom,"HH:mm"),"\u2013",e.xi3(5,9,t.LessonDateTimeTo,"HH:mm")," "),e.xp6(4),e.Oqu(t.eventDesignations),e.xp6(2),e.Oqu(t.studyClassNumbers)}}function Rt(n,o){if(1&n&&(e.TgZ(0,"div",24),e.TgZ(1,"div",25),e.TgZ(2,"div",26),e._uU(3),e.qZA(),e.TgZ(4,"div",26),e._uU(5),e.qZA(),e.qZA(),e.TgZ(6,"div",27),e.YNc(7,Ft,10,12,"div",28),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(3),e.Oqu(t.selectedLesson.eventDesignations),e.xp6(2),e.Oqu(t.selectedLesson.studyClassNumbers),e.xp6(2),e.Q6J("ngForOf",t.lessons)}}function Gt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"button",31),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return null==r.lessonDropdown?null:r.lessonDropdown.toggle()}),e.TgZ(1,"i",3),e._uU(2),e.qZA(),e.qZA()}if(2&n){const t=e.oxw();e.xp6(2),e.hij(" ",null!=t.lessonDropdown&&t.lessonDropdown.isOpen()?"keyboard_arrow_up":"keyboard_arrow_down"," ")}}const kt=function(n){return["groups",n]},Nt=function(n){return{returnparams:n}};function jt(n,o){if(1&n&&(e.TgZ(0,"a",32),e.ALo(1,"async"),e.TgZ(2,"i",33),e._uU(3,"groups"),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.Q6J("routerLink",e.VKq(4,kt,t.selectedLesson.id))("queryParams",e.VKq(6,Nt,e.lcZ(1,2,t.state.queryParamsString$)))}}function Jt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"button",34),e.NdJ("click",function(){const i=e.CHM(t).$implicit;return e.oxw().viewModeChange.emit(i.viewMode)}),e.TgZ(1,"i",33),e._uU(2),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit,s=e.oxw();e.ekj("btn-secondary",t.viewMode===s.viewMode)("btn-link",t.viewMode!==s.viewMode)("active",t.viewMode===s.viewMode),e.Q6J("disabled",!s.selectedLesson),e.xp6(2),e.Oqu(t.icon)}}const qt=m.jt.prototype._positionMenu;m.jt.prototype._positionMenu=function(...o){var t;const s=qt.apply(this,o);if("lesson-dropdown"===this._anchor.nativeElement.id){const r=this._bodyContainer||this._menu.nativeElement,i=null===(t=r.style.transform)||void 0===t?void 0:t.match(/translate\(([0-9-\.]+)px, ([0-9-\.]+)px\)/);i&&parseFloat(i[1])<0&&(r.style.transform=`translate(0px, ${i[2]}px)`)}return s};let Bt=(()=>{class n{constructor(t){this.state=t,this.presentCount=null,this.absentCount=null,this.unapprovedCount=null,this.absentPrecedingCount=null,this.search="",this.selectLessonChange=new e.vpe,this.selectDateChange=new e.vpe,this.searchChange=new e.vpe,this.viewModeChange=new e.vpe,this.viewModeOptions=[{viewMode:L.List,icon:"list"},{viewMode:L.Grid,icon:"view_module"}]}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(N))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-header"]],viewQuery:function(t,s){if(1&t&&e.Gf(m.jt,5),2&t){let r;e.iGM(r=e.CRH())&&(s.lessonDropdown=r.first)}},inputs:{selectedLesson:"selectedLesson",lessons:"lessons",presentCount:"presentCount",absentCount:"absentCount",unapprovedCount:"unapprovedCount",absentPrecedingCount:"absentPrecedingCount",viewMode:"viewMode",selectDate:"selectDate",search:"search"},outputs:{selectLessonChange:"selectLessonChange",selectDateChange:"selectDateChange",searchChange:"searchChange",viewModeChange:"viewModeChange"},features:[e._Bn([{provide:m.DO,useClass:m.s5},{provide:m.NG,useClass:Dt.n}])],decls:40,vars:20,consts:[[1,"navigation"],[1,"lesson-date"],["type","button",1,"btn","btn-link",3,"click"],[1,"material-icons"],["placement","bottom","positionTarget",".lesson-date-input","ngbDatepicker","",1,"lesson-date-input",3,"ngModel","ngModelChange"],["d","ngbDatepicker"],["class","lesson-time",3,"click",4,"ngIf"],["ngbDropdown","","class","lesson-description","container","body","display","dynamic","placement","bottom",4,"ngIf"],["type","button","class","dropdown-caret btn btn-link",3,"click",4,"ngIf"],[1,"states"],[1,"state","present"],[1,"count"],[1,"state","absent"],[1,"state","unapproved"],[1,"state","previously-absent"],[1,"material-icons-outlined"],[1,"search-and-views"],[1,"search",3,"value","disabled","placeholder","label","valueChange"],[1,"group-and-views","d-flex"],["type","button","class","group btn btn-link pr-xs-0 pr-sm-4",3,"routerLink","queryParams",4,"ngIf"],[1,"views"],["type","button","class","view btn",3,"disabled","btn-secondary","btn-link","active","click",4,"ngFor","ngForOf"],[1,"lesson-time",3,"click"],[1,"lesson-time-to"],["ngbDropdown","","container","body","display","dynamic","placement","bottom",1,"lesson-description"],["id","lesson-dropdown","ngbDropdownToggle",""],[1,"text-truncate"],["ngbDropdownMenu","","aria-labelledby","lesson-dropdown"],["ngbDropdownItem","",3,"active","click",4,"ngFor","ngForOf"],["ngbDropdownItem","",3,"click"],[1,"lesson-entry"],["type","button",1,"dropdown-caret","btn","btn-link",3,"click"],["type","button",1,"group","btn","btn-link","pr-xs-0","pr-sm-4",3,"routerLink","queryParams"],[1,"material-icons","align-middle"],["type","button",1,"view","btn",3,"disabled","click"]],template:function(t,s){if(1&t){const r=e.EpF();e.TgZ(0,"div",0),e.TgZ(1,"div",1),e.TgZ(2,"button",2),e.NdJ("click",function(){return e.CHM(r),e.MAs(6).toggle()}),e.TgZ(3,"i",3),e._uU(4,"calendar_today"),e.qZA(),e.qZA(),e.TgZ(5,"input",4,5),e.NdJ("ngModelChange",function(a){return s.selectDateChange.emit(a)}),e.qZA(),e.qZA(),e.YNc(7,Et,6,8,"div",6),e.YNc(8,Rt,8,3,"div",7),e.YNc(9,Gt,3,1,"button",8),e.qZA(),e.TgZ(10,"div",9),e.TgZ(11,"div",10),e.TgZ(12,"i",3),e._uU(13,"check_circle"),e.qZA(),e.TgZ(14,"span",11),e._uU(15),e.qZA(),e.qZA(),e.TgZ(16,"div",12),e.TgZ(17,"i",3),e._uU(18,"cancel"),e.qZA(),e.TgZ(19,"span",11),e._uU(20),e.qZA(),e.qZA(),e.TgZ(21,"div",13),e.TgZ(22,"i",3),e._uU(23,"help"),e.qZA(),e.TgZ(24,"span",11),e._uU(25),e.qZA(),e.qZA(),e.TgZ(26,"div",14),e.TgZ(27,"i",15),e._uU(28,"info"),e.qZA(),e.TgZ(29,"span",11),e._uU(30),e.qZA(),e.qZA(),e.qZA(),e.TgZ(31,"div",16),e.TgZ(32,"erz-resettable-input",17),e.NdJ("valueChange",function(a){return s.searchChange.emit(a)}),e.ALo(33,"translate"),e.ALo(34,"translate"),e.qZA(),e.TgZ(35,"div",18),e.YNc(36,jt,4,8,"a",19),e.ALo(37,"async"),e.TgZ(38,"div",20),e.YNc(39,Jt,3,8,"button",21),e.qZA(),e.qZA(),e.qZA()}2&t&&(e.xp6(5),e.Q6J("ngModel",s.selectDate),e.xp6(2),e.Q6J("ngIf",s.selectedLesson),e.xp6(1),e.Q6J("ngIf",s.selectedLesson),e.xp6(1),e.Q6J("ngIf",s.lessons.length>0),e.xp6(6),e.Oqu(null!==s.presentCount?s.presentCount:"?"),e.xp6(5),e.Oqu(null!==s.absentCount?s.absentCount:"?"),e.xp6(5),e.Oqu(null!==s.unapprovedCount?s.unapprovedCount:"?"),e.xp6(5),e.Oqu(null!==s.absentPrecedingCount?s.absentPrecedingCount:"?"),e.xp6(2),e.Q6J("value",s.search)("disabled",!s.selectedLesson)("placeholder",e.lcZ(33,14,"presence-control.header.search-by-name"))("label",e.lcZ(34,16,"presence-control.header.search")),e.xp6(4),e.Q6J("ngIf",e.lcZ(37,18,s.selectedLesson&&s.state.groupsAvailability$)),e.xp6(3),e.Q6J("ngForOf",s.viewModeOptions))},directives:[m.J4,T.Fj,T.JJ,T.On,h.O5,m.jt,m.iD,m.Vi,h.sg,m.TH,Ut.w,S.yS],pipes:[h.uU,b.X$,h.Ov],styles:['[_nghost-%COMP%]{display:flex;flex-direction:column;padding:1.125rem 1.5rem}.navigation[_ngcontent-%COMP%]{display:grid;grid-template-areas:". date time dropdown-caret" ". description description dropdown-caret";grid-template-columns:1fr auto auto 1fr}.lesson-date[_ngcontent-%COMP%]{grid-area:date;justify-self:end;display:flex;align-items:center;justify-content:end}.lesson-date[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:0 .5ch 0 0}.lesson-date[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#33333d;position:relative;top:2px}.lesson-date-input[_ngcontent-%COMP%]{font-weight:600;background:transparent;border:none;width:11ch}.lesson-time[_ngcontent-%COMP%]{grid-area:time;cursor:pointer}.lesson-description[_ngcontent-%COMP%]{grid-area:description;overflow:hidden;text-align:center;cursor:pointer}.dropdown-toggle[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.dropdown-toggle[_ngcontent-%COMP%]:after{display:none}.dropdown-caret[_ngcontent-%COMP%]{grid-area:dropdown-caret;line-height:100%;text-align:left;color:#33333d}.dropdown-menu[_ngcontent-%COMP%]{width:50ch;padding:0;box-shadow:2px 2px 3px -1px #0003}@media (max-width: 800px){.dropdown-menu[_ngcontent-%COMP%]{width:100vw}}.dropdown-item[_ngcontent-%COMP%]{padding:1.5rem;border-bottom:1px solid #dee2e6}.states[_ngcontent-%COMP%]{margin:1.125rem 0;display:flex;justify-content:center}.state[_ngcontent-%COMP%]{margin-right:7%;display:flex}.state[_ngcontent-%COMP%]:last-child{margin-right:0}@media (min-width: 1000px){.state[_ngcontent-%COMP%]{margin-right:6rem}}.state.present[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#28a745}.state.absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#dc3545}.state.unapproved[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#ffa814}.state.previously-absent[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:#33333d80}.state[_ngcontent-%COMP%]   .count[_ngcontent-%COMP%]{margin-left:.3em;margin-top:1px}.search-and-views[_ngcontent-%COMP%]{padding-top:1.125rem;display:flex;justify-content:space-between;border-top:1px solid #e9ecef}.search[_ngcontent-%COMP%]{flex:auto;max-width:300px;margin-right:1.5rem}.views[_ngcontent-%COMP%]{display:flex}.view[_ngcontent-%COMP%]{padding:.25rem;color:#6c757d}.view.active[_ngcontent-%COMP%]{color:#33333d}.group[_ngcontent-%COMP%]{color:#6c757d}@media (max-width: 380px){[_nghost-%COMP%]{padding-left:.75rem;padding-right:.75rem}#search-addon[_ngcontent-%COMP%]{padding-left:.5rem;padding-right:.5rem}}@media (max-width: 365px){.lesson-time[_ngcontent-%COMP%]{line-height:1}.lesson-time-to[_ngcontent-%COMP%]{display:block}.dropdown-caret[_ngcontent-%COMP%]{padding-left:0}}']}),n})();var Yt=c(264);function Ht(n,o){if(1&n&&(e.TgZ(0,"div"),e._uU(1),e.ALo(2,"date"),e.ALo(3,"date"),e.ALo(4,"addSpace"),e.qZA()),2&n){const t=o.$implicit;e.xp6(1),e.xDo(" ",e.xi3(2,5,t.LessonRef.From,"HH:mm"),"\u2013",e.xi3(3,8,t.LessonRef.To,"HH:mm")," ",t.LessonRef.EventDesignation,"",e.xi3(4,11,":",":")," ",t.Type," ")}}let zt=(()=>{class n{constructor(t){this.activeModal=t}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(m.Kz))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-preceding-absence"]],inputs:{precedingAbsences:"precedingAbsences"},decls:9,vars:7,consts:[[1,"modal-body"],[4,"ngFor","ngForOf"],[1,"modal-footer"],["type","button",1,"btn","btn-secondary",3,"click"]],template:function(t,s){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"p"),e._uU(2),e.ALo(3,"translate"),e.qZA(),e.YNc(4,Ht,5,14,"div",1),e.qZA(),e.TgZ(5,"div",2),e.TgZ(6,"button",3),e.NdJ("click",function(){return s.activeModal.dismiss()}),e._uU(7),e.ALo(8,"translate"),e.qZA(),e.qZA()),2&t&&(e.xp6(2),e.hij(" ",e.lcZ(3,3,"presence-control.preceding-absence.text")," "),e.xp6(2),e.Q6J("ngForOf",s.precedingAbsences),e.xp6(3),e.hij(" ",e.lcZ(8,5,"presence-control.preceding-absence.cancel")," "))},directives:[h.sg],pipes:[b.X$,h.uU,Yt.u],styles:[""]}),n})();var Qt=c(7871);const Vt=function(n){return["/presence-control/student",n]};function Kt(n,o){if(1&n&&(e._UZ(0,"erz-avatar",9),e.ALo(1,"async")),2&n){const t=e.oxw();e.Q6J("studentId",e.lcZ(1,3,t.studentId$))("link",e.VKq(5,Vt,t.entry.lessonPresence.StudentRef.Id))("linkParams",t.profileReturnParams)}}function Wt(n,o){if(1&n&&(e.TgZ(0,"span"),e._uU(1),e.qZA()),2&n){const t=e.oxw(2);e.xp6(1),e.Oqu(null==t.entry.presenceType?null:t.entry.presenceType.Designation)}}function Xt(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"button",10),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return r.updatePresenceType(r.entry)}),e.YNc(1,Wt,2,1,"span",11),e.qZA()}if(2&n){const t=e.oxw();e.xp6(1),e.Q6J("ngIf",!(null!=t.entry.presenceType&&t.entry.presenceType.IsIncident))}}function en(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"button",12),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return r.showPrecedingAbsences(r.entry)}),e.TgZ(1,"i",13),e._uU(2,"info"),e.qZA(),e.qZA()}}function tn(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"a",14),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return r.updateIncident(r.entry)}),e.TgZ(1,"i",3),e._uU(2,"edit"),e.qZA(),e.TgZ(3,"span"),e._uU(4),e.ALo(5,"translate"),e.qZA(),e.qZA()}if(2&n){const t=e.oxw();e.xp6(4),e.Oqu(e.lcZ(5,1,(null==t.entry.presenceType?null:t.entry.presenceType.IsIncident)&&(null==t.entry.presenceType?null:t.entry.presenceType.Designation)||"presence-control.entry.incident"))}}const nn=function(n){return["student",n]};let sn=(()=>{class n{constructor(t,s,r){this.toastr=t,this.translate=s,this.modalService=r,this.hasUnconfirmedAbsences=!1,this.togglePresenceType=new e.vpe,this.changeIncident=new e.vpe,this.studentId$=new pe.t(1)}get classNames(){return[this.entry.presenceCategory,this.viewMode].join(" ")}ngOnChanges(t){t.entry&&this.studentId$.next(t.entry.currentValue.lessonPresence.StudentRef.Id)}get isListViewMode(){return this.viewMode===L.List}updatePresenceType(t){t.canChangePresenceType?this.togglePresenceType.emit(t):this.toastr.warning(this.translate.instant("presence-control.entry.update-warning"))}updateIncident(t){t.canChangeIncident&&this.changeIncident.emit(t)}showPrecedingAbsences(t){this.modalService.open(zt).componentInstance.precedingAbsences=t.precedingAbsences}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(he._W),e.Y36(b.sK),e.Y36(m.FF))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-entry"]],hostVars:2,hostBindings:function(t,s){2&t&&e.Tol(s.classNames)},inputs:{entry:"entry",hasUnconfirmedAbsences:"hasUnconfirmedAbsences",viewMode:"viewMode",profileReturnParams:"profileReturnParams"},outputs:{togglePresenceType:"togglePresenceType",changeIncident:"changeIncident"},features:[e.TTD],decls:13,vars:13,consts:[["class","avatar large",3,"studentId","link","linkParams",4,"ngIf"],["type","button","class","presence-category designation btn btn-link",3,"click",4,"ngIf"],["type","button",1,"presence-category","status","btn","btn-link",3,"click"],[1,"material-icons"],["type","button","class","previously-absent btn btn-link",3,"click",4,"ngIf"],[1,"student-name",3,"routerLink","queryParams"],[1,"text-truncate"],[1,"unconfirmed-absences"],["class","incident btn btn-link",3,"click",4,"ngIf"],[1,"avatar","large",3,"studentId","link","linkParams"],["type","button",1,"presence-category","designation","btn","btn-link",3,"click"],[4,"ngIf"],["type","button",1,"previously-absent","btn","btn-link",3,"click"],[1,"material-icons-outlined"],[1,"incident","btn","btn-link",3,"click"]],template:function(t,s){1&t&&(e.YNc(0,Kt,2,7,"erz-avatar",0),e.YNc(1,Xt,2,1,"button",1),e.TgZ(2,"button",2),e.NdJ("click",function(){return s.updatePresenceType(s.entry)}),e.TgZ(3,"i",3),e._uU(4),e.qZA(),e.qZA(),e.YNc(5,en,3,0,"button",4),e.TgZ(6,"a",5),e.TgZ(7,"span",6),e._uU(8),e.qZA(),e.TgZ(9,"span",7),e._uU(10),e.ALo(11,"translate"),e.qZA(),e.qZA(),e.YNc(12,tn,6,3,"a",8)),2&t&&(e.Q6J("ngIf",!s.isListViewMode),e.xp6(1),e.Q6J("ngIf",s.entry.showDesignation),e.xp6(3),e.Oqu(s.entry.presenceCategoryIcon),e.xp6(1),e.Q6J("ngIf",(null==s.entry.precedingAbsences?null:s.entry.precedingAbsences.length)>0),e.xp6(1),e.Q6J("routerLink",e.VKq(11,nn,s.entry.lessonPresence.StudentRef.Id))("queryParams",s.profileReturnParams),e.xp6(2),e.Oqu(s.entry.lessonPresence.StudentFullName),e.xp6(2),e.hij(" ",s.hasUnconfirmedAbsences?e.lcZ(11,9,"presence-control.entry.unconfirmed-absences"):""," "),e.xp6(2),e.Q6J("ngIf",s.entry.canChangeIncident))},directives:[h.O5,Qt.A,S.yS],pipes:[h.Ov,b.X$],styles:['[_nghost-%COMP%]{padding:3rem 1.5rem;background-color:#fff;display:grid;grid-template-areas:"avatar status designation previously-absent" "avatar student-name student-name student-name" "avatar incident incident incident";grid-template-columns:min-content min-content 3fr min-content}[_nghost-%COMP%] > *[_ngcontent-%COMP%]{align-self:center}.presence-category[_ngcontent-%COMP%]{text-decoration:none}.presence-category[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{top:.1875rem}.absent[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#dc3545}.present[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#28a745}.unapproved[_nghost-%COMP%]   .presence-category[_ngcontent-%COMP%]{color:#ffa814}.designation[_ngcontent-%COMP%], .student-name[_ngcontent-%COMP%], a.incident[_ngcontent-%COMP%], .incident[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.avatar[_ngcontent-%COMP%]{grid-area:avatar;margin-right:2.25rem}.status[_ngcontent-%COMP%]{grid-area:status}.status[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:2.75rem}.designation[_ngcontent-%COMP%]{grid-area:designation;text-align:left;line-height:3.125rem}.previously-absent[_ngcontent-%COMP%]{grid-area:previously-absent;text-decoration:none;color:#33333d80;justify-self:end}.student-name[_ngcontent-%COMP%]{color:#33333d;grid-area:student-name;display:flex;flex-direction:column}.unconfirmed-absences[_ngcontent-%COMP%]{color:#dc3545;font-size:1.1rem;line-height:1}.incident[_ngcontent-%COMP%]{color:#33333d80;padding-right:.75rem;grid-area:incident;display:flex}.incident[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{margin-right:.3em}.grid[_nghost-%COMP%]   .status[_ngcontent-%COMP%], .grid[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{align-self:start;margin-left:-.75rem;margin-top:-.375rem}.grid[_nghost-%COMP%]   .incident[_ngcontent-%COMP%]{align-self:end;margin-left:-.75rem;margin-bottom:-.375rem}.grid[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-right:0;align-self:start}.grid[_nghost-%COMP%]   .unconfirmed-absences[_ngcontent-%COMP%]{height:1.1rem}.list[_nghost-%COMP%]{grid-template-areas:"student-name status designation incident previously-absent";grid-template-columns:3fr min-content 3fr 2fr 3em;padding:.5rem .5rem .5rem 1rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{justify-self:start}@media (max-width: 750px){.list[_nghost-%COMP%]{grid-template-areas:"student-name student-name student-name previously-absent" "status incidentordesignation incidentordesignation incidentordesignation";grid-template-columns:min-content 1fr 1fr min-content;row-gap:1.5rem}.list[_nghost-%COMP%]   .status[_ngcontent-%COMP%]{padding-left:0;padding-right:0}.list[_nghost-%COMP%]   .incident[_ngcontent-%COMP%], .list[_nghost-%COMP%]   .designation[_ngcontent-%COMP%]{grid-area:incidentordesignation}.list[_nghost-%COMP%]   .incident[_ngcontent-%COMP%]{justify-self:end}.list[_nghost-%COMP%]   .previously-absent[_ngcontent-%COMP%]{padding-top:0;align-self:start}}']}),n})();const on=function(n){return{returnparams:n}};function rn(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"erz-presence-control-entry",7),e.NdJ("togglePresenceType",function(r){return e.CHM(t),e.oxw(5).togglePresenceType(r)})("changeIncident",function(r){return e.CHM(t),e.oxw(5).changeIncident(r)}),e.ALo(1,"async"),e.ALo(2,"async"),e.ALo(3,"async"),e.qZA()}if(2&n){const t=o.$implicit,s=e.oxw(5);e.Q6J("entry",t)("hasUnconfirmedAbsences",e.lcZ(1,4,s.state.hasUnconfirmedAbsences(t)))("viewMode",e.lcZ(2,6,s.state.viewMode$))("profileReturnParams",e.VKq(10,on,e.lcZ(3,8,s.state.queryParamsString$)))}}function cn(n,o){if(1&n&&(e.ynx(0),e.TgZ(1,"div"),e.ALo(2,"async"),e.YNc(3,rn,4,12,"erz-presence-control-entry",6),e.qZA(),e.BQk()),2&n){const t=e.oxw(3).erzLet,s=e.oxw();e.xp6(1),e.Gre("default-entries entries view-mode-",e.lcZ(2,4,s.state.viewMode$),""),e.xp6(2),e.Q6J("ngForOf",t.entries)}}function an(n,o){1&n&&(e.TgZ(0,"p",8),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(1),e.hij(" ",e.lcZ(2,1,"presence-control.no-lesson-presences")," "))}function ln(n,o){if(1&n&&(e.ynx(0),e.YNc(1,cn,4,6,"ng-container",1),e.YNc(2,an,3,3,"ng-template",null,5,e.W1O),e.BQk()),2&n){const t=e.MAs(3),s=e.oxw(2).erzLet;e.xp6(1),e.Q6J("ngIf",(null==s.entries?null:s.entries.length)>0)("ngIfElse",t)}}function dn(n,o){1&n&&(e.TgZ(0,"p",9),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&n&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"presence-control.no-lessons")))}function pn(n,o){if(1&n){const t=e.EpF();e.ynx(0),e.TgZ(1,"erz-presence-control-header",3),e.NdJ("searchChange",function(r){return e.CHM(t),e.oxw(2).search$.next(r)})("viewModeChange",function(r){return e.CHM(t),e.oxw(2).state.setViewMode(r)})("selectDateChange",function(r){return e.CHM(t),e.oxw(2).state.setDate(r)})("selectLessonChange",function(r){return e.CHM(t),e.oxw(2).state.setLesson(r)}),e.ALo(2,"async"),e.ALo(3,"async"),e.ALo(4,"async"),e.ALo(5,"async"),e.ALo(6,"async"),e.ALo(7,"async"),e.ALo(8,"async"),e.qZA(),e.YNc(9,ln,4,2,"ng-container",1),e.YNc(10,dn,3,3,"ng-template",null,4,e.W1O),e.BQk()}if(2&n){const t=e.MAs(11),s=e.oxw().erzLet,r=e.oxw();e.xp6(1),e.Q6J("selectedLesson",s.lesson)("lessons",s.lessons)("presentCount",e.lcZ(2,11,r.state.presentCount$))("absentCount",e.lcZ(3,13,r.state.absentCount$))("unapprovedCount",e.lcZ(4,15,r.state.unapprovedCount$))("absentPrecedingCount",e.lcZ(5,17,r.state.absentPrecedingCount$))("viewMode",e.lcZ(6,19,r.state.viewMode$))("selectDate",e.lcZ(7,21,r.state.selectedDate$))("search",e.lcZ(8,23,r.search$)),e.xp6(8),e.Q6J("ngIf",s.lesson)("ngIfElse",t)}}function un(n,o){1&n&&e._UZ(0,"erz-spinner")}function gn(n,o){if(1&n&&(e.ynx(0),e.YNc(1,pn,12,25,"ng-container",1),e.ALo(2,"async"),e.YNc(3,un,1,0,"ng-template",null,2,e.W1O),e.BQk()),2&n){const t=e.MAs(4),s=e.oxw();e.xp6(1),e.Q6J("ngIf",!1===e.lcZ(2,2,s.state.loading$))("ngIfElse",t)}}const hn=function(n,o,t){return{lesson:n,lessons:o,entries:t}};let mn=(()=>{class n{constructor(t,s,r,i,a,d){this.state=t,this.lessonPresencesUpdateService=s,this.presenceTypesService=r,this.modalService=i,this.scrollPosition=a,this.route=d,this.search$=new A.X(""),this.entries$=(0,g.a)([this.state.selectedPresenceControlEntriesByGroup$,this.search$]).pipe((0,l.U)((0,$.h)(Pt.P)),(0,P.d)(1)),this.destroy$=new M.x}ngOnInit(){this.route.queryParams.pipe((0,D.R)(this.destroy$)).subscribe(this.restoreStateFromParams.bind(this))}ngAfterViewInit(){this.scrollPosition.restore()}ngOnDestroy(){this.destroy$.next()}doTogglePresenceType(t,s){this.state.getNextPresenceType(t).subscribe(r=>this.lessonPresencesUpdateService.updatePresenceTypes(s||[t.lessonPresence],r?r.Id:null))}togglePresenceType(t){this.state.getBlockLessonPresences(t).pipe((0,y.q)(1)).subscribe(s=>{if(1===s.length)this.doTogglePresenceType(t);else{const r=this.modalService.open(bt);r.componentInstance.entry=t,r.componentInstance.blockLessonPresences=s,r.result.then(i=>{i&&this.doTogglePresenceType(t,i)},()=>{})}})}updateIncident(t,s){this.lessonPresencesUpdateService.updatePresenceTypes([t.lessonPresence],s)}changeIncident(t){this.presenceTypesService.incidentTypes$.subscribe(s=>{const r=this.modalService.open(Lt);r.componentInstance.incident=s.find(i=>{var a;return i.Id===(null===(a=t.presenceType)||void 0===a?void 0:a.Id)})||null,r.componentInstance.incidentTypes=s,r.result.then(i=>{this.updateIncident(t,(null==i?void 0:i.Id)||null)},()=>{})})}restoreStateFromParams(t){t.date&&this.state.setDate((0,Tt.nx)(t.date));const s=String(t.lesson);s&&this.state.lessons$.pipe((0,y.q)(1)).subscribe(r=>{const i=r.find(a=>a.id===s);i&&this.state.setLesson(i)}),t.viewMode&&lt.includes(t.viewMode)&&this.state.setViewMode(t.viewMode)}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(N),e.Y36(we),e.Y36(de.c),e.Y36(m.FF),e.Y36(wt.X),e.Y36(S.gz))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control-list"]],decls:4,vars:11,consts:[[4,"erzLet"],[4,"ngIf","ngIfElse"],["loading",""],[3,"selectedLesson","lessons","presentCount","absentCount","unapprovedCount","absentPrecedingCount","viewMode","selectDate","search","searchChange","viewModeChange","selectDateChange","selectLessonChange"],["noLessons",""],["noLessonPresences",""],[3,"entry","hasUnconfirmedAbsences","viewMode","profileReturnParams","togglePresenceType","changeIncident",4,"ngFor","ngForOf"],[3,"entry","hasUnconfirmedAbsences","viewMode","profileReturnParams","togglePresenceType","changeIncident"],[1,"mt-3","pl-3"],[1,"mt-3","px-3"]],template:function(t,s){1&t&&(e.YNc(0,gn,5,4,"ng-container",0),e.ALo(1,"async"),e.ALo(2,"async"),e.ALo(3,"async")),2&t&&e.Q6J("erzLet",e.kEZ(7,hn,e.lcZ(1,1,s.state.selectedLesson$),e.lcZ(2,3,s.state.lessons$),e.lcZ(3,5,s.entries$)))},directives:[Ze.e,h.O5,Bt,h.sg,sn,Se.O],pipes:[h.Ov,b.X$],styles:["erz-presence-control-entry[_ngcontent-%COMP%]{border-bottom:1px solid #e9ecef}.entries.view-mode-grid[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap}.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%}@media (min-width: 400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%;border-right:1px solid #e9ecef}}@media (min-width: 800px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:50%;border-right:1px solid #e9ecef}}@media (min-width: 1200px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:33.3333333333%;border-right:1px solid #e9ecef}}@media (min-width: 1600px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:25%;border-right:1px solid #e9ecef}}@media (min-width: 2000px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:20%;border-right:1px solid #e9ecef}}@media (min-width: 2400px){.entries.view-mode-grid[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:16.6666666667%;border-right:1px solid #e9ecef}}"],changeDetection:0}),n})();var fn=c(3509);const vn=[{path:"",component:(()=>{class n{constructor(t,s){this.state=t,this.lessonPresencesUpdateService=s,this.destroy$=new M.x}ngOnInit(){this.lessonPresencesUpdateService.stateUpdates$.pipe((0,D.R)(this.destroy$)).subscribe(t=>this.state.updateLessonPresencesTypes(t))}ngOnDestroy(){this.destroy$.next()}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(N),e.Y36(we))},n.\u0275cmp=e.Xpm({type:n,selectors:[["erz-presence-control"]],features:[e._Bn([N,ge,{provide:fn.m,useExisting:N}])],decls:1,vars:0,template:function(t,s){1&t&&e._UZ(0,"router-outlet")},directives:[S.lC],styles:[""],changeDetection:0}),n})(),children:[{path:"",component:mn,data:{restoreScrollPositionFrom:["/presence-control/student/:id"]}},X.H,{path:"groups/:id",component:_t}]}];let Cn=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[S.Bz.forChild(vn)],S.Bz]}),n})(),_n=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[R.m,Cn]]}),n})()},3657:(Ue,H,c)=>{c.d(H,{X:()=>te});var R=c(5357),S=c(7579),X=c(9646),A=c(9300),g=c(4004),I=c(5698),ee=c(5577),l=c(3900),y=c(3843),f=c(4782),w=c(2722),$=c(5684),G=c(5e3),z=c(9808);let te=(()=>{class _{constructor(p,v){this.router=p,this.viewportScroller=v,this.scrollPositions={},this.previousRoute=null,this.currentRoute=null,this.currentScrollPosition=[0,0],this.destroy$=new S.x,this.scrollPosition$=this.router.events.pipe((0,A.h)(se),(0,g.U)(this.getScrollPosition.bind(this))),this.activationEnd$=this.router.events.pipe((0,A.h)(ne)),this.navigationEnd$=this.router.events.pipe((0,A.h)(e)),this.route$=this.activationEnd$.pipe((0,I.q)(1)).pipe((0,ee.z)(O=>[(0,X.of)(O),this.navigationEnd$.pipe((0,l.w)(()=>this.activationEnd$.pipe((0,I.q)(1))))]),(0,y.B)(),(0,g.U)(O=>O.snapshot),(0,f.d)(1)),this.scrollPosition$.pipe((0,w.R)(this.destroy$)).subscribe(O=>this.currentScrollPosition=O),this.route$.pipe((0,w.R)(this.destroy$)).subscribe(O=>{this.previousRoute=this.currentRoute,this.currentRoute=O})}ngOnDestroy(){this.destroy$.next()}restore(){if(!this.currentRoute||!this.requiresStoring(this.currentRoute))return;if(this.previousRoute&&this.shouldStoreFor(this.currentRoute,this.previousRoute)){const v=this.getPath(this.currentRoute);this.scrollToPosition(this.scrollPositions[v]||[0,0])}const p=this.currentRoute;this.route$.pipe((0,$.T)(1),(0,I.q)(1),(0,w.R)(this.destroy$),(0,A.h)(v=>this.shouldStoreFor(p,v))).subscribe(()=>{const v=this.getPath(p);this.scrollPositions[v]=this.currentScrollPosition})}getScrollPosition(){return this.viewportScroller.getScrollPosition()}scrollToPosition(p){this.viewportScroller.scrollToPosition(p)}getPath(p){return p?"/"+p.pathFromRoot.map(v=>v.routeConfig&&v.routeConfig.path).filter(v=>v).join("/"):"/"}requiresStoring(p){return Boolean(p&&p.routeConfig&&p.routeConfig.data&&Array.isArray(p.routeConfig.data.restoreScrollPositionFrom)&&p.routeConfig.data.restoreScrollPositionFrom.length>0)}shouldStoreFor(p,v){return(p&&p.routeConfig&&p.routeConfig.data&&Array.isArray(p.routeConfig.data.restoreScrollPositionFrom)?p.routeConfig.data.restoreScrollPositionFrom:[]).includes(this.getPath(v))}}return _.\u0275fac=function(p){return new(p||_)(G.LFG(R.F0),G.LFG(z.EM))},_.\u0275prov=G.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})();function ne(_){return _ instanceof R.jw}function se(_){return _ instanceof R.OD}function e(_){return _ instanceof R.m2}}}]);